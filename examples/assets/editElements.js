var ke=Object.defineProperty;var Re=(l,t,e)=>t in l?ke(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var P=(l,t,e)=>(Re(l,typeof t!="symbol"?t+"":t,e),e);import{fW as De,V as h,cz as A,fX as $e,cr as fe,fY as Ce,fC as je,fZ as v,f_ as y,fB as ye,f$ as be,fH as o,g0 as oe,fK as k,g1 as U,fL as Ge,g2 as Oe,c as Te,g3 as Fe,fx as We,C as Ue,W as Be,fq as Ve,a as Ne,fr as Je,ft as Ke,fs as et,fI as tt,fV as ge,fJ as it,g4 as nt}from"./virtual-memory-controller-CejF-vhY.js";import{S as st}from"./stats.min-Cj8wREqt.js";import{a as ot,R as z,m as M}from"./index-CWj6LyOo.js";import{F as at}from"./index-ClKYDA-N.js";const j=new $e,b=new h,R=new h,m=new A,_e={X:new h(1,0,0),Y:new h(0,1,0),Z:new h(0,0,1)},pe={type:"change"},ve={type:"mouseDown",mode:null},Me={type:"mouseUp",mode:null},Se={type:"objectChange"};class xe extends De{constructor(t,e=null){super(void 0,e);const n=new pt(this);this._root=n;const s=new mt;this._gizmo=s,n.add(s);const r=new ut;this._plane=r,n.add(r);const i=this;function a(S,D){let F=D;Object.defineProperty(i,S,{get:function(){return F!==void 0?F:D},set:function($){F!==$&&(F=$,r[S]=$,s[S]=$,i.dispatchEvent({type:S+"-changed",value:$}),i.dispatchEvent(pe))}}),i[S]=D,r[S]=D,s[S]=D}a("camera",t),a("object",void 0),a("enabled",!0),a("axis",null),a("mode","translate"),a("translationSnap",null),a("rotationSnap",null),a("scaleSnap",null),a("space","world"),a("size",1),a("dragging",!1),a("showX",!0),a("showY",!0),a("showZ",!0),a("minX",-1/0),a("maxX",1/0),a("minY",-1/0),a("maxY",1/0),a("minZ",-1/0),a("maxZ",1/0);const c=new h,u=new h,g=new A,C=new A,Y=new h,ee=new A,O=new h,Q=new h,Z=new h,T=0,H=new h;a("worldPosition",c),a("worldPositionStart",u),a("worldQuaternion",g),a("worldQuaternionStart",C),a("cameraPosition",Y),a("cameraQuaternion",ee),a("pointStart",O),a("pointEnd",Q),a("rotationAxis",Z),a("rotationAngle",T),a("eye",H),this._offset=new h,this._startNorm=new h,this._endNorm=new h,this._cameraScale=new h,this._parentPosition=new h,this._parentQuaternion=new A,this._parentQuaternionInv=new A,this._parentScale=new h,this._worldScaleStart=new h,this._worldQuaternionInv=new A,this._worldScale=new h,this._positionStart=new h,this._quaternionStart=new A,this._scaleStart=new h,this._getPointer=rt.bind(this),this._onPointerDown=ct.bind(this),this._onPointerHover=lt.bind(this),this._onPointerMove=ht.bind(this),this._onPointerUp=dt.bind(this),e!==null&&this.connect(e)}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(this.object===void 0||this.dragging===!0)return;t!==null&&j.setFromCamera(t,this.camera);const e=me(this._gizmo.picker[this.mode],j);e?this.axis=e.object.name:this.axis=null}pointerDown(t){if(!(this.object===void 0||this.dragging===!0||t!=null&&t.button!==0)&&this.axis!==null){t!==null&&j.setFromCamera(t,this.camera);const e=me(this._plane,j,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,ve.mode=this.mode,this.dispatchEvent(ve)}}pointerMove(t){const e=this.axis,n=this.mode,s=this.object;let r=this.space;if(n==="scale"?r="local":(e==="E"||e==="XYZE"||e==="XYZ")&&(r="world"),s===void 0||e===null||this.dragging===!1||t!==null&&t.button!==-1)return;t!==null&&j.setFromCamera(t,this.camera);const i=me(this._plane,j,!0);if(i){if(this.pointEnd.copy(i.point).sub(this.worldPositionStart),n==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),r==="local"&&e!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),e.indexOf("X")===-1&&(this._offset.x=0),e.indexOf("Y")===-1&&(this._offset.y=0),e.indexOf("Z")===-1&&(this._offset.z=0),r==="local"&&e!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(r==="local"&&(s.position.applyQuaternion(m.copy(this._quaternionStart).invert()),e.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),r==="world"&&(s.parent&&s.position.add(b.setFromMatrixPosition(s.parent.matrixWorld)),e.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(b.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if(n==="scale"){if(e.search("XYZ")!==-1){let a=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(a*=-1),R.set(a,a,a)}else b.copy(this.pointStart),R.copy(this.pointEnd),b.applyQuaternion(this._worldQuaternionInv),R.applyQuaternion(this._worldQuaternionInv),R.divide(b),e.search("X")===-1&&(R.x=1),e.search("Y")===-1&&(R.y=1),e.search("Z")===-1&&(R.z=1);s.scale.copy(this._scaleStart).multiply(R),this.scaleSnap&&(e.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(n==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const a=20/this.worldPosition.distanceTo(b.setFromMatrixPosition(this.camera.matrixWorld));let c=!1;e==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(b.copy(this.rotationAxis).cross(this.eye))*a):(e==="X"||e==="Y"||e==="Z")&&(this.rotationAxis.copy(_e[e]),b.copy(_e[e]),r==="local"&&b.applyQuaternion(this.worldQuaternion),b.cross(this.eye),b.length()===0?c=!0:this.rotationAngle=this._offset.dot(b.normalize())*a),(e==="E"||c)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),r==="local"&&e!=="E"&&e!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(m.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(m.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(pe),this.dispatchEvent(Se)}}pointerUp(t){t!==null&&t.button!==0||(this.dragging&&this.axis!==null&&(Me.mode=this.mode,this.dispatchEvent(Me)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(pe),this.dispatchEvent(Se),this.pointStart.copy(this.pointEnd))}getRaycaster(){return j}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function rt(l){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:l.button};{const t=this.domElement.getBoundingClientRect();return{x:(l.clientX-t.left)/t.width*2-1,y:-(l.clientY-t.top)/t.height*2+1,button:l.button}}}function lt(l){if(this.enabled)switch(l.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(l));break}}function ct(l){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(l.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(l)),this.pointerDown(this._getPointer(l)))}function ht(l){this.enabled&&this.pointerMove(this._getPointer(l))}function dt(l){this.enabled&&(this.domElement.releasePointerCapture(l.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(l)))}function me(l,t,e){const n=t.intersectObject(l,!0);for(let s=0;s<n.length;s++)if(n[s].object.visible||e)return n[s];return!1}const ae=new Oe,d=new h(0,1,0),Pe=new h(0,0,0),Ee=new Te,re=new A,he=new A,X=new h,Ie=new Te,N=new h(1,0,0),G=new h(0,1,0),J=new h(0,0,1),le=new h,B=new h,V=new h;class pt extends fe{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const e=this.controls;e.object!==void 0&&(e.object.updateMatrixWorld(),e.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):e.object.parent.matrixWorld.decompose(e._parentPosition,e._parentQuaternion,e._parentScale),e.object.matrixWorld.decompose(e.worldPosition,e.worldQuaternion,e._worldScale),e._parentQuaternionInv.copy(e._parentQuaternion).invert(),e._worldQuaternionInv.copy(e.worldQuaternion).invert()),e.camera.updateMatrixWorld(),e.camera.matrixWorld.decompose(e.cameraPosition,e.cameraQuaternion,e._cameraScale),e.camera.isOrthographicCamera?e.camera.getWorldDirection(e.eye).negate():e.eye.copy(e.cameraPosition).sub(e.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}class mt extends fe{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new Ce({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new je({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),n=t.clone();n.opacity=.15;const s=e.clone();s.opacity=.5;const r=t.clone();r.color.setHex(16711680);const i=t.clone();i.color.setHex(65280);const a=t.clone();a.color.setHex(255);const c=t.clone();c.color.setHex(16711680),c.opacity=.5;const u=t.clone();u.color.setHex(65280),u.opacity=.5;const g=t.clone();g.color.setHex(255),g.opacity=.5;const C=t.clone();C.opacity=.25;const Y=t.clone();Y.color.setHex(16776960),Y.opacity=.25,t.clone().color.setHex(16776960);const O=t.clone();O.color.setHex(7895160);const Q=new v(0,.04,.1,12);Q.translate(0,.05,0);const Z=new y(.08,.08,.08);Z.translate(0,.04,0);const T=new ye;T.setAttribute("position",new be([0,0,0,1,0,0],3));const H=new v(.0075,.0075,.5,3);H.translate(0,.25,0);function S(x,te){const E=new U(x,.0075,3,64,te*Math.PI*2);return E.rotateY(Math.PI/2),E.rotateX(Math.PI/2),E}function D(){const x=new ye;return x.setAttribute("position",new be([0,0,0,1,1,1],3)),x}const F={X:[[new o(Q,r),[.5,0,0],[0,0,-Math.PI/2]],[new o(Q,r),[-.5,0,0],[0,0,Math.PI/2]],[new o(H,r),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new o(Q,i),[0,.5,0]],[new o(Q,i),[0,-.5,0],[Math.PI,0,0]],[new o(H,i)]],Z:[[new o(Q,a),[0,0,.5],[Math.PI/2,0,0]],[new o(Q,a),[0,0,-.5],[-Math.PI/2,0,0]],[new o(H,a),null,[Math.PI/2,0,0]]],XYZ:[[new o(new oe(.1,0),C.clone()),[0,0,0]]],XY:[[new o(new y(.15,.15,.01),g.clone()),[.15,.15,0]]],YZ:[[new o(new y(.15,.15,.01),c.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new y(.15,.15,.01),u.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},$={X:[[new o(new v(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new o(new v(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new o(new v(.2,0,.6,4),n),[0,.3,0]],[new o(new v(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new o(new v(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new o(new v(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new o(new oe(.2,0),n)]],XY:[[new o(new y(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new o(new y(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new y(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]]},Ae={START:[[new o(new oe(.01,2),s),null,null,null,"helper"]],END:[[new o(new oe(.01,2),s),null,null,null,"helper"]],DELTA:[[new k(D(),s),null,null,null,"helper"]],X:[[new k(T,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new k(T,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new k(T,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},Ye={XYZE:[[new o(S(.5,1),O),null,[0,Math.PI/2,0]]],X:[[new o(S(.5,.5),r)]],Y:[[new o(S(.5,.5),i),null,[0,0,-Math.PI/2]]],Z:[[new o(S(.5,.5),a),null,[0,Math.PI/2,0]]],E:[[new o(S(.75,1),Y),null,[0,Math.PI/2,0]]]},Qe={AXIS:[[new k(T,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},Ze={XYZE:[[new o(new Ge(.25,10,8),n)]],X:[[new o(new U(.5,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new o(new U(.5,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new o(new U(.5,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new o(new U(.75,.1,2,24),n)]]},He={X:[[new o(Z,r),[.5,0,0],[0,0,-Math.PI/2]],[new o(H,r),[0,0,0],[0,0,-Math.PI/2]],[new o(Z,r),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new o(Z,i),[0,.5,0]],[new o(H,i)],[new o(Z,i),[0,-.5,0],[0,0,Math.PI]]],Z:[[new o(Z,a),[0,0,.5],[Math.PI/2,0,0]],[new o(H,a),[0,0,0],[Math.PI/2,0,0]],[new o(Z,a),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new o(new y(.15,.15,.01),g),[.15,.15,0]]],YZ:[[new o(new y(.15,.15,.01),c),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new y(.15,.15,.01),u),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new o(new y(.1,.1,.1),C.clone())]]},qe={X:[[new o(new v(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new o(new v(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new o(new v(.2,0,.6,4),n),[0,.3,0]],[new o(new v(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new o(new v(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new o(new v(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new o(new y(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new o(new y(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new o(new y(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new o(new y(.2,.2,.2),n),[0,0,0]]]},ze={X:[[new k(T,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new k(T,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new k(T,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function q(x){const te=new fe;for(const E in x)for(let W=x[E].length;W--;){const _=x[E][W][0].clone(),ie=x[E][W][1],ne=x[E][W][2],se=x[E][W][3],Le=x[E][W][4];_.name=E,_.tag=Le,ie&&_.position.set(ie[0],ie[1],ie[2]),ne&&_.rotation.set(ne[0],ne[1],ne[2]),se&&_.scale.set(se[0],se[1],se[2]),_.updateMatrix();const we=_.geometry.clone();we.applyMatrix4(_.matrix),_.geometry=we,_.renderOrder=1/0,_.position.set(0,0,0),_.rotation.set(0,0,0),_.scale.set(1,1,1),te.add(_)}return te}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=q(F)),this.add(this.gizmo.rotate=q(Ye)),this.add(this.gizmo.scale=q(He)),this.add(this.picker.translate=q($)),this.add(this.picker.rotate=q(Ze)),this.add(this.picker.scale=q(qe)),this.add(this.helper.translate=q(Ae)),this.add(this.helper.rotate=q(Qe)),this.add(this.helper.scale=q(ze)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const n=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:he;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let r=0;r<s.length;r++){const i=s[r];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);let a;if(this.camera.isOrthographicCamera?a=(this.camera.top-this.camera.bottom)/this.camera.zoom:a=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),i.scale.set(1,1,1).multiplyScalar(a*this.size/4),i.tag==="helper"){i.visible=!1,i.name==="AXIS"?(i.visible=!!this.axis,this.axis==="X"&&(m.setFromEuler(ae.set(0,0,0)),i.quaternion.copy(n).multiply(m),Math.abs(d.copy(N).applyQuaternion(n).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="Y"&&(m.setFromEuler(ae.set(0,0,Math.PI/2)),i.quaternion.copy(n).multiply(m),Math.abs(d.copy(G).applyQuaternion(n).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="Z"&&(m.setFromEuler(ae.set(0,Math.PI/2,0)),i.quaternion.copy(n).multiply(m),Math.abs(d.copy(J).applyQuaternion(n).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="XYZE"&&(m.setFromEuler(ae.set(0,Math.PI/2,0)),d.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(Ee.lookAt(Pe,d,G)),i.quaternion.multiply(m),i.visible=this.dragging),this.axis==="E"&&(i.visible=!1)):i.name==="START"?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):i.name==="END"?(i.position.copy(this.worldPosition),i.visible=this.dragging):i.name==="DELTA"?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),b.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),b.applyQuaternion(this.worldQuaternionStart.clone().invert()),i.scale.copy(b),i.visible=this.dragging):(i.quaternion.copy(n),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=this.axis.search(i.name)!==-1));continue}i.quaternion.copy(n),this.mode==="translate"||this.mode==="scale"?(i.name==="X"&&Math.abs(d.copy(N).applyQuaternion(n).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="Y"&&Math.abs(d.copy(G).applyQuaternion(n).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="Z"&&Math.abs(d.copy(J).applyQuaternion(n).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="XY"&&Math.abs(d.copy(J).applyQuaternion(n).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="YZ"&&Math.abs(d.copy(N).applyQuaternion(n).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="XZ"&&Math.abs(d.copy(G).applyQuaternion(n).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1)):this.mode==="rotate"&&(re.copy(n),d.copy(this.eye).applyQuaternion(m.copy(n).invert()),i.name.search("E")!==-1&&i.quaternion.setFromRotationMatrix(Ee.lookAt(this.eye,Pe,G)),i.name==="X"&&(m.setFromAxisAngle(N,Math.atan2(-d.y,d.z)),m.multiplyQuaternions(re,m),i.quaternion.copy(m)),i.name==="Y"&&(m.setFromAxisAngle(G,Math.atan2(d.x,d.z)),m.multiplyQuaternions(re,m),i.quaternion.copy(m)),i.name==="Z"&&(m.setFromAxisAngle(J,Math.atan2(d.y,d.x)),m.multiplyQuaternions(re,m),i.quaternion.copy(m))),i.visible=i.visible&&(i.name.indexOf("X")===-1||this.showX),i.visible=i.visible&&(i.name.indexOf("Y")===-1||this.showY),i.visible=i.visible&&(i.name.indexOf("Z")===-1||this.showZ),i.visible=i.visible&&(i.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),i.material._color=i.material._color||i.material.color.clone(),i.material._opacity=i.material._opacity||i.material.opacity,i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled&&this.axis&&(i.name===this.axis||this.axis.split("").some(function(c){return i.name===c}))&&(i.material.color.setHex(16776960),i.material.opacity=1)}super.updateMatrixWorld(t)}}class ut extends o{constructor(){super(new Fe(1e5,1e5,2,2),new Ce({visible:!1,wireframe:!0,side:We,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),le.copy(N).applyQuaternion(e==="local"?this.worldQuaternion:he),B.copy(G).applyQuaternion(e==="local"?this.worldQuaternion:he),V.copy(J).applyQuaternion(e==="local"?this.worldQuaternion:he),d.copy(B),this.mode){case"translate":case"scale":switch(this.axis){case"X":d.copy(this.eye).cross(le),X.copy(le).cross(d);break;case"Y":d.copy(this.eye).cross(B),X.copy(B).cross(d);break;case"Z":d.copy(this.eye).cross(V),X.copy(V).cross(d);break;case"XY":X.copy(V);break;case"YZ":X.copy(le);break;case"XZ":d.copy(V),X.copy(B);break;case"XYZ":case"E":X.set(0,0,0);break}break;case"rotate":default:X.set(0,0,0)}X.length()===0?this.quaternion.copy(this.cameraQuaternion):(Ie.lookAt(b.set(0,0,0),X,d),this.quaternion.setFromRotationMatrix(Ie)),super.updateMatrixWorld(t)}}const K=new Ue,ft=K.get(Be),wt=document.getElementById("container"),p=ft.create();p.scene=new Ve(K);p.renderer=new Ne(K,wt);p.camera=new Je(K);K.init();p.scene.three.add(new Ke);p.camera.three.far=1e4;p.renderer.three.shadowMap.enabled=!0;p.renderer.three.shadowMap.type=et;p.scene.setup({shadows:{cascade:1,resolution:1024}});await p.scene.updateShadows();p.camera.controls.addEventListener("rest",async()=>{await p.scene.updateShadows()});const yt="https://thatopen.github.io/engine_fragment/resources/worker.mjs",bt=await fetch(yt),gt=await bt.blob(),_t=new File([gt],"worker.mjs",{type:"text/javascript"}),vt=URL.createObjectURL(_t),w=new at(vt);p.camera.controls.addEventListener("control",()=>w.update());w.models.materials.list.onItemSet.add(({value:l})=>{"isLodMaterial"in l&&l.isLodMaterial||(l.polygonOffset=!0,l.polygonOffsetUnits=1,l.polygonOffsetFactor=Math.random())});w.models.list.onItemSet.add(({value:l})=>{l.useCamera(p.camera.three),p.scene.three.add(l.object),l.tiles.onItemSet.add(({value:t})=>{"isMesh"in t&&t.material[0].opacity===1&&(t.castShadow=!0,t.receiveShadow=!0)})});const Mt=await fetch("https://thatopen.github.io/engine_fragment/resources/frags/school_arq.frag"),St=await Mt.arrayBuffer(),I=await w.load(St,{modelId:"medium_test",camera:p.camera.three});p.scene.three.add(I.object);await w.update(!0);class xt{constructor(t){P(this,"onUpdated",new ge);P(this,"sampleMaterialsUpdated",new ge);P(this,"_world");P(this,"_element",null);P(this,"_mesh",null);P(this,"_gControls");P(this,"_lControls",[]);P(this,"_controlType","global");P(this,"_materials",null);P(this,"_localTransformsIds",[]);P(this,"_geometriesIds",[]);this._world=t,this._gControls=new xe(t.camera.three,t.renderer.three.domElement),this.setupEvents()}get materials(){if(!this._materials)throw new Error("Editor not initialized");return this._materials}get localTransformsIds(){if(!this._localTransformsIds.length)throw new Error("Editor not initialized");return this._localTransformsIds}get geometriesIds(){if(!this._geometriesIds.length)throw new Error("Editor not initialized");return this._geometriesIds}get samples(){if(!this._element)throw new Error("No element selected");return this._element.core.samples}get elementSelected(){return this._element!==null}async init(){this._materials=await I.getMaterials();const t=await I.getLocalTransformsIds(),e=await I.getRepresentationsIds();this._localTransformsIds=[t[0],t[1]],this._geometriesIds=[e[0],e[1]]}get3dMaterials(){if(!this._mesh)return[];const t=new Map;return this._mesh.traverse(e=>{e instanceof o&&t.set(e.material.userData.localId,e.material)}),Array.from(t.values())}async setSampleMaterial(t,e){this._element&&(this._element.core.samples[t].material=e,await this.updateSamples(),this.sampleMaterialsUpdated.trigger())}async updateMaterials(){this._materials&&(this._materials=await I.getMaterials())}overrideGeometryWithCube(){this._mesh&&this._mesh.traverse(t=>{if(t instanceof o){const e=t.geometry,n=new y(1,1,1);e.setAttribute("position",n.attributes.position),e.setIndex(n.index),e.setAttribute("normal",n.attributes.normal)}})}async applyChanges(){if(!this._element||!this._mesh)return;await this._element.setMeshes(this._mesh),this.dispose();const t=this._element.getRequests();t&&await w.editor.edit(I.modelId,t),this._element.elementChanged||await this.setVisible(!0),await w.update(!0),this._element=null,this._mesh=null,this.onUpdated.trigger()}setControlsMode(t){this._gControls.setMode(t);for(const e of this._lControls)e.setMode(t)}setControlsTarget(t=this._controlType){const e=this._gControls.getHelper();if(t==="global"){this._world.scene.three.add(e),this._gControls.enabled=!0;for(const n of this._lControls)n.getHelper().removeFromParent(),n.enabled=!1}else{e.removeFromParent(),this._gControls.enabled=!1;for(const n of this._lControls){const s=n.getHelper();this._world.scene.three.add(s),n.enabled=!0}}this._controlType=t}async updateSamples(){if(!this._element||!this._mesh)return;const t=this._mesh.matrixWorld.clone();await this._element.updateSamples(),this.dispose(),this._mesh=await this._element.getMeshes(),this._world.scene.three.add(this._mesh),await this.createControls(),this._mesh.position.set(0,0,0),this._mesh.rotation.set(0,0,0),this._mesh.applyMatrix4(t)}async createControls(){if(this._mesh){this._gControls.attach(this._mesh);for(const t of this._mesh.children){const e=new xe(p.camera.three,p.renderer.three.domElement);e.attach(t),e.setMode(this._gControls.mode),this._lControls.push(e),e.addEventListener("dragging-changed",n=>{p.camera.hasCameraControls()&&(p.camera.controls.enabled=!n.value)})}this.setControlsTarget()}}dispose(){if(this._mesh&&this._element&&this._element.disposeMeshes(this._mesh),this._gControls.getHelper().removeFromParent(),this._gControls.detach(),!(!this._mesh||!this._element)){for(const e of this._lControls)e.detach(),e.dispose();this._lControls.length=0}}async setVisible(t){if(!this._element)return;const e=[];for(const[,n]of w.models.list){if(n.deltaModelId&&t===!0){const s=new Set(await n.getEditedElements());if(t&&s.has(this._element.localId))continue}e.push(n.setVisible([this._element.localId],t))}await Promise.all(e)}setupEvents(){this._gControls.addEventListener("dragging-changed",n=>{this._world.camera.hasCameraControls()&&(this._world.camera.controls.enabled=!n.value)});const t=new it;this._world.renderer.three.domElement.addEventListener("dblclick",async n=>{t.x=n.clientX,t.y=n.clientY;let s;for(const[,i]of w.models.list){const a=[];a.push(i.raycast({camera:p.camera.three,mouse:t,dom:p.renderer.three.domElement}));const c=await Promise.all(a);let u=1/0;for(const g of c)g&&g.distance<u&&(u=g.distance,s=g)}if(!s)return;this._element&&await this.setVisible(!0);const[r]=await w.editor.getElements(I.modelId,[s.localId]);this._element=r,r&&(this._mesh&&this.dispose(),await this.setVisible(!1),this._mesh=await r.getMeshes(),this._world.scene.three.add(this._mesh),await this.createControls(),await w.update(!0),this.onUpdated.trigger())}),window.addEventListener("keydown",async n=>{if(n.key==="Escape"){if(!this._element||!this._mesh)return;this._element.getRequests(),this.dispose(),this.setVisible(!0),await w.update(!0),this._element=null,this._mesh=null,this.onUpdated.trigger()}})}}const f=new xt(p);await f.init();ot.init();const[Pt,Et]=z.create(l=>{const t=new tt,e=[];if(f.elementSelected){const n=f.samples;for(const s in n){const r=n[s],i=z.create(()=>M`
             <bim-dropdown label="Material" @change=${async c=>{if(!c.target.value[0])return;const u=parseInt(s,10);await f.setSampleMaterial(u,c.target.value[0])}}>
            </bim-dropdown>
        `);f.updateMaterials().then(()=>{for(const[c,u]of f.materials){const{r:g,g:C,b:Y}=u;t.setRGB(g/255,C/255,Y/255);const ee=`#${t.getHexString()}`,O=z.create(()=>M`<bim-option icon="icon-park-outline:material" label=${c} ?checked=${r.material===c}>
            <div style="width: 1rem; height: 1rem; background-color: ${ee}"></div>
          </bim-option>`);i.appendChild(O)}});const a=z.create(()=>M`
          <div style="display: flex; gap: 0.5rem; flex-direction: column;">

            <div style="display: flex; gap: 0.5rem;">
              <bim-label icon="f7:cube" style="font-weight: bold;">Sample ${s}</bim-label>
            </div>

            ${i}

            <bim-dropdown label="Local Transform" @change=${async c=>{if(!c.target.value[0])return;const u=n[s];u&&(u.localTransform=c.target.value[0],await f.updateSamples())}}>

              ${[...new Set([...f.localTransformsIds,r.localTransform])].map(c=>M`<bim-option icon="iconoir:axes" label=${c} ?checked=${r.localTransform===c}>
                </bim-option>`)}
            </bim-dropdown>

            <bim-dropdown label="Geometry" @change=${async c=>{if(!c.target.value[0])return;const u=n[s];u&&(u.representation=c.target.value[0],await f.updateSamples())}}>

              ${[...new Set([...f.geometriesIds,r.representation])].map(c=>M`<bim-option icon="fluent:select-object-24-filled" label=${c} ?checked=${r.representation===c}>
                </bim-option>`)}
            </bim-dropdown>
          </div>
          `);e.push(a)}}return M`<bim-panel-section label="Samples">
  ${e.map(n=>n)}
  </bim-panel-section>`},{}),[It,Xe]=z.create(l=>{const t=f.get3dMaterials();return M`
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        ${t.map(e=>M`

          <div style="display: flex; gap: 0.5rem;">
          <bim-color-input color=#${e.color.getHexString()} label=${e.userData.localId} @input=${n=>{e.color.set(n.target.color)}}>
          </bim-color-input>

          <bim-number-input slider min=0 max=1 step=0.01 value=${e.opacity} @change=${n=>{e.opacity=n.target.value}}></bim-number-input>

          </div>`)}
        </div>
  `},{});f.sampleMaterialsUpdated.add(Xe);const ue=document.getElementById("history-menu");let ce=null;const Ct=async()=>{const{requests:l,undoneRequests:t}=await w.editor.getModelRequests(I.modelId),e=[...l,...t],n=[...ue.children];for(const r of n)ue.removeChild(r),r.remove();let s=null;for(let r=0;r<e.length;r++){const i=e[r],a=r<e.length-1,c=z.create(()=>M`
        <bim-button icon="solar:arrow-right-bold"></bim-button>
      `);(ce===r||ce===null&&!a)&&(c.classList.add("selected-request"),s=c);const C=r;c.addEventListener("click",async()=>{s&&s.classList.remove("selected-request"),s=c,c.classList.add("selected-request"),await w.editor.selectRequest(I.modelId,C),await I.setVisible(void 0,!0),ce=C,await w.editor.edit(I.modelId,[],{removeRedo:!1}),await w.update(!0)});const Y=z.create(()=>M`
      <div class="history-request">
        ${a?M`<div class="history-line"></div>`:""}
        ${c}
        <div>
          <bim-label class="history-request-title">${nt[i.type]}</bim-label>
          <bim-label class="history-request-subtitle">ID: ${i.localId}</bim-label>
        </div>
      </div>
      `);ue.appendChild(Y)}ce=null};w.editor.onEdit.add(Ct);const[de,Tt]=z.create(l=>{const t=M`<bim-button label="Change geometry" @click=${()=>{f.overrideGeometryWithCube()}}></bim-button>`;return Et(),Xe(),M`
    <bim-panel style="min-width: 25rem;" id="controls-panel" active label="Element Editor" class="options-menu">
      <bim-panel-section label="Controls">
        <bim-button data-name="arq" label="Apply changes" @click=${()=>f.applyChanges()}></bim-button>
        <bim-dropdown required label="Tranform Mode" 
            @change="${({target:e})=>{const n=e.value[0];f.setControlsMode(n)}}">
          <bim-option checked  label="translate"></bim-option>
          <bim-option label="rotate"></bim-option>
        </bim-dropdown>
        <bim-dropdown required label="Transform Target" 
            @change="${({target:e})=>{const n=e.value[0];f.setControlsTarget(n)}}">
          <bim-option checked  label="global"></bim-option>
          <bim-option label="local"></bim-option>
        </bim-dropdown>
        ${t}
        ${It}
      </bim-panel-section>
      ${Pt}
    </bim-panel>
  `},{});f.onUpdated.add(()=>{Tt()});document.body.append(de);const Xt=z.create(()=>M`
    <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
      @click=${()=>{de.classList.contains("options-menu-visible")?de.classList.remove("options-menu-visible"):de.classList.add("options-menu-visible")}}>
    </bim-button>
  `);document.body.append(Xt);window.dispatchEvent(new Event("resize"));const L=new st;L.showPanel(2);document.body.append(L.dom);L.dom.style.right="0px";L.dom.style.bottom="0px";L.dom.style.left="unset";L.dom.style.top="unset";L.dom.style.zIndex="unset";p.renderer.onBeforeUpdate.add(()=>L.begin());p.renderer.onAfterUpdate.add(()=>L.end());
