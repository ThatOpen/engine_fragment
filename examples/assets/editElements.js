var ke=Object.defineProperty;var Re=(r,t,e)=>t in r?ke(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var P=(r,t,e)=>(Re(r,typeof t!="symbol"?t+"":t,e),e);import{c_ as De,V as h,Q as X,c$ as $e,O as ue,d0 as Ce,cG as Ge,d1 as v,d2 as y,cF as we,d3 as ye,cL as a,d4 as oe,cO as L,d5 as U,cP as je,d6 as Oe,j as Te,d7 as We,cB as Fe,C as Ue,W as Be,cu as Ve,a as Ne,cv as Je,cx as Ke,cw as et,cM as tt,cZ as be,cN as it,d8 as nt}from"./virtual-memory-controller-ZSRKHGNY.js";import{S as st}from"./stats.min-Cj8wREqt.js";import{a as ot,R as q,m as M}from"./index-CWj6LyOo.js";import{F as at}from"./index-CqDgYQyW.js";const G=new $e,b=new h,k=new h,m=new X,_e={X:new h(1,0,0),Y:new h(0,1,0),Z:new h(0,0,1)},pe={type:"change"},ge={type:"mouseDown",mode:null},ve={type:"mouseUp",mode:null},Me={type:"objectChange"};class Se extends De{constructor(t,e=null){super(void 0,e);const n=new pt(this);this._root=n;const s=new mt;this._gizmo=s,n.add(s);const l=new ut;this._plane=l,n.add(l);const i=this;function o(S,D){let W=D;Object.defineProperty(i,S,{get:function(){return W!==void 0?W:D},set:function($){W!==$&&(W=$,l[S]=$,s[S]=$,i.dispatchEvent({type:S+"-changed",value:$}),i.dispatchEvent(pe))}}),i[S]=D,l[S]=D,s[S]=D}o("camera",t),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0),o("minX",-1/0),o("maxX",1/0),o("minY",-1/0),o("maxY",1/0),o("minZ",-1/0),o("maxZ",1/0);const c=new h,u=new h,w=new X,A=new X,R=new h,ee=new X,O=new h,Q=new h,Y=new h,C=0,Z=new h;o("worldPosition",c),o("worldPositionStart",u),o("worldQuaternion",w),o("worldQuaternionStart",A),o("cameraPosition",R),o("cameraQuaternion",ee),o("pointStart",O),o("pointEnd",Q),o("rotationAxis",Y),o("rotationAngle",C),o("eye",Z),this._offset=new h,this._startNorm=new h,this._endNorm=new h,this._cameraScale=new h,this._parentPosition=new h,this._parentQuaternion=new X,this._parentQuaternionInv=new X,this._parentScale=new h,this._worldScaleStart=new h,this._worldQuaternionInv=new X,this._worldScale=new h,this._positionStart=new h,this._quaternionStart=new X,this._scaleStart=new h,this._getPointer=rt.bind(this),this._onPointerDown=ct.bind(this),this._onPointerHover=lt.bind(this),this._onPointerMove=ht.bind(this),this._onPointerUp=dt.bind(this),e!==null&&this.connect(e)}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(t){if(this.object===void 0||this.dragging===!0)return;t!==null&&G.setFromCamera(t,this.camera);const e=me(this._gizmo.picker[this.mode],G);e?this.axis=e.object.name:this.axis=null}pointerDown(t){if(!(this.object===void 0||this.dragging===!0||t!=null&&t.button!==0)&&this.axis!==null){t!==null&&G.setFromCamera(t,this.camera);const e=me(this._plane,G,!0);e&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(e.point).sub(this.worldPositionStart)),this.dragging=!0,ge.mode=this.mode,this.dispatchEvent(ge)}}pointerMove(t){const e=this.axis,n=this.mode,s=this.object;let l=this.space;if(n==="scale"?l="local":(e==="E"||e==="XYZE"||e==="XYZ")&&(l="world"),s===void 0||e===null||this.dragging===!1||t!==null&&t.button!==-1)return;t!==null&&G.setFromCamera(t,this.camera);const i=me(this._plane,G,!0);if(i){if(this.pointEnd.copy(i.point).sub(this.worldPositionStart),n==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),l==="local"&&e!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),e.indexOf("X")===-1&&(this._offset.x=0),e.indexOf("Y")===-1&&(this._offset.y=0),e.indexOf("Z")===-1&&(this._offset.z=0),l==="local"&&e!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),s.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(l==="local"&&(s.position.applyQuaternion(m.copy(this._quaternionStart).invert()),e.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.position.applyQuaternion(this._quaternionStart)),l==="world"&&(s.parent&&s.position.add(b.setFromMatrixPosition(s.parent.matrixWorld)),e.search("X")!==-1&&(s.position.x=Math.round(s.position.x/this.translationSnap)*this.translationSnap),e.search("Y")!==-1&&(s.position.y=Math.round(s.position.y/this.translationSnap)*this.translationSnap),e.search("Z")!==-1&&(s.position.z=Math.round(s.position.z/this.translationSnap)*this.translationSnap),s.parent&&s.position.sub(b.setFromMatrixPosition(s.parent.matrixWorld)))),s.position.x=Math.max(this.minX,Math.min(this.maxX,s.position.x)),s.position.y=Math.max(this.minY,Math.min(this.maxY,s.position.y)),s.position.z=Math.max(this.minZ,Math.min(this.maxZ,s.position.z));else if(n==="scale"){if(e.search("XYZ")!==-1){let o=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(o*=-1),k.set(o,o,o)}else b.copy(this.pointStart),k.copy(this.pointEnd),b.applyQuaternion(this._worldQuaternionInv),k.applyQuaternion(this._worldQuaternionInv),k.divide(b),e.search("X")===-1&&(k.x=1),e.search("Y")===-1&&(k.y=1),e.search("Z")===-1&&(k.z=1);s.scale.copy(this._scaleStart).multiply(k),this.scaleSnap&&(e.search("X")!==-1&&(s.scale.x=Math.round(s.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Y")!==-1&&(s.scale.y=Math.round(s.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),e.search("Z")!==-1&&(s.scale.z=Math.round(s.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(n==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const o=20/this.worldPosition.distanceTo(b.setFromMatrixPosition(this.camera.matrixWorld));let c=!1;e==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(b.copy(this.rotationAxis).cross(this.eye))*o):(e==="X"||e==="Y"||e==="Z")&&(this.rotationAxis.copy(_e[e]),b.copy(_e[e]),l==="local"&&b.applyQuaternion(this.worldQuaternion),b.cross(this.eye),b.length()===0?c=!0:this.rotationAngle=this._offset.dot(b.normalize())*o),(e==="E"||c)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),l==="local"&&e!=="E"&&e!=="XYZE"?(s.quaternion.copy(this._quaternionStart),s.quaternion.multiply(m.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),s.quaternion.copy(m.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),s.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(pe),this.dispatchEvent(Me)}}pointerUp(t){t!==null&&t.button!==0||(this.dragging&&this.axis!==null&&(ve.mode=this.mode,this.dispatchEvent(ve)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(t){return this.object=t,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(pe),this.dispatchEvent(Me),this.pointStart.copy(this.pointEnd))}getRaycaster(){return G}getMode(){return this.mode}setMode(t){this.mode=t}setTranslationSnap(t){this.translationSnap=t}setRotationSnap(t){this.rotationSnap=t}setScaleSnap(t){this.scaleSnap=t}setSize(t){this.size=t}setSpace(t){this.space=t}}function rt(r){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:r.button};{const t=this.domElement.getBoundingClientRect();return{x:(r.clientX-t.left)/t.width*2-1,y:-(r.clientY-t.top)/t.height*2+1,button:r.button}}}function lt(r){if(this.enabled)switch(r.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(r));break}}function ct(r){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(r.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(r)),this.pointerDown(this._getPointer(r)))}function ht(r){this.enabled&&this.pointerMove(this._getPointer(r))}function dt(r){this.enabled&&(this.domElement.releasePointerCapture(r.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(r)))}function me(r,t,e){const n=t.intersectObject(r,!0);for(let s=0;s<n.length;s++)if(n[s].object.visible||e)return n[s];return!1}const ae=new Oe,d=new h(0,1,0),xe=new h(0,0,0),Pe=new Te,re=new X,he=new X,T=new h,Ee=new Te,N=new h(1,0,0),j=new h(0,1,0),J=new h(0,0,1),le=new h,B=new h,V=new h;class pt extends ue{constructor(t){super(),this.isTransformControlsRoot=!0,this.controls=t,this.visible=!1}updateMatrixWorld(t){const e=this.controls;e.object!==void 0&&(e.object.updateMatrixWorld(),e.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):e.object.parent.matrixWorld.decompose(e._parentPosition,e._parentQuaternion,e._parentScale),e.object.matrixWorld.decompose(e.worldPosition,e.worldQuaternion,e._worldScale),e._parentQuaternionInv.copy(e._parentQuaternion).invert(),e._worldQuaternionInv.copy(e.worldQuaternion).invert()),e.camera.updateMatrixWorld(),e.camera.matrixWorld.decompose(e.cameraPosition,e.cameraQuaternion,e._cameraScale),e.camera.isOrthographicCamera?e.camera.getWorldDirection(e.eye).negate():e.eye.copy(e.cameraPosition).sub(e.worldPosition).normalize(),super.updateMatrixWorld(t)}dispose(){this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})}}class mt extends ue{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const t=new Ce({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),e=new Ge({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),n=t.clone();n.opacity=.15;const s=e.clone();s.opacity=.5;const l=t.clone();l.color.setHex(16711680);const i=t.clone();i.color.setHex(65280);const o=t.clone();o.color.setHex(255);const c=t.clone();c.color.setHex(16711680),c.opacity=.5;const u=t.clone();u.color.setHex(65280),u.opacity=.5;const w=t.clone();w.color.setHex(255),w.opacity=.5;const A=t.clone();A.opacity=.25;const R=t.clone();R.color.setHex(16776960),R.opacity=.25,t.clone().color.setHex(16776960);const O=t.clone();O.color.setHex(7895160);const Q=new v(0,.04,.1,12);Q.translate(0,.05,0);const Y=new y(.08,.08,.08);Y.translate(0,.04,0);const C=new we;C.setAttribute("position",new ye([0,0,0,1,0,0],3));const Z=new v(.0075,.0075,.5,3);Z.translate(0,.25,0);function S(x,te){const E=new U(x,.0075,3,64,te*Math.PI*2);return E.rotateY(Math.PI/2),E.rotateX(Math.PI/2),E}function D(){const x=new we;return x.setAttribute("position",new ye([0,0,0,1,1,1],3)),x}const W={X:[[new a(Q,l),[.5,0,0],[0,0,-Math.PI/2]],[new a(Q,l),[-.5,0,0],[0,0,Math.PI/2]],[new a(Z,l),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new a(Q,i),[0,.5,0]],[new a(Q,i),[0,-.5,0],[Math.PI,0,0]],[new a(Z,i)]],Z:[[new a(Q,o),[0,0,.5],[Math.PI/2,0,0]],[new a(Q,o),[0,0,-.5],[-Math.PI/2,0,0]],[new a(Z,o),null,[Math.PI/2,0,0]]],XYZ:[[new a(new oe(.1,0),A.clone()),[0,0,0]]],XY:[[new a(new y(.15,.15,.01),w.clone()),[.15,.15,0]]],YZ:[[new a(new y(.15,.15,.01),c.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new y(.15,.15,.01),u.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},$={X:[[new a(new v(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new a(new v(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new a(new v(.2,0,.6,4),n),[0,.3,0]],[new a(new v(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new a(new v(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new a(new v(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new a(new oe(.2,0),n)]],XY:[[new a(new y(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new a(new y(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new y(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]]},Ae={START:[[new a(new oe(.01,2),s),null,null,null,"helper"]],END:[[new a(new oe(.01,2),s),null,null,null,"helper"]],DELTA:[[new L(D(),s),null,null,null,"helper"]],X:[[new L(C,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new L(C,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new L(C,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},Qe={XYZE:[[new a(S(.5,1),O),null,[0,Math.PI/2,0]]],X:[[new a(S(.5,.5),l)]],Y:[[new a(S(.5,.5),i),null,[0,0,-Math.PI/2]]],Z:[[new a(S(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new a(S(.75,1),R),null,[0,Math.PI/2,0]]]},Ye={AXIS:[[new L(C,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},Ze={XYZE:[[new a(new je(.25,10,8),n)]],X:[[new a(new U(.5,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new a(new U(.5,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new a(new U(.5,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new a(new U(.75,.1,2,24),n)]]},He={X:[[new a(Y,l),[.5,0,0],[0,0,-Math.PI/2]],[new a(Z,l),[0,0,0],[0,0,-Math.PI/2]],[new a(Y,l),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new a(Y,i),[0,.5,0]],[new a(Z,i)],[new a(Y,i),[0,-.5,0],[0,0,Math.PI]]],Z:[[new a(Y,o),[0,0,.5],[Math.PI/2,0,0]],[new a(Z,o),[0,0,0],[Math.PI/2,0,0]],[new a(Y,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new a(new y(.15,.15,.01),w),[.15,.15,0]]],YZ:[[new a(new y(.15,.15,.01),c),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new y(.15,.15,.01),u),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new a(new y(.1,.1,.1),A.clone())]]},qe={X:[[new a(new v(.2,0,.6,4),n),[.3,0,0],[0,0,-Math.PI/2]],[new a(new v(.2,0,.6,4),n),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new a(new v(.2,0,.6,4),n),[0,.3,0]],[new a(new v(.2,0,.6,4),n),[0,-.3,0],[0,0,Math.PI]]],Z:[[new a(new v(.2,0,.6,4),n),[0,0,.3],[Math.PI/2,0,0]],[new a(new v(.2,0,.6,4),n),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new a(new y(.2,.2,.01),n),[.15,.15,0]]],YZ:[[new a(new y(.2,.2,.01),n),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new a(new y(.2,.2,.01),n),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new a(new y(.2,.2,.2),n),[0,0,0]]]},ze={X:[[new L(C,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new L(C,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new L(C,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function H(x){const te=new ue;for(const E in x)for(let F=x[E].length;F--;){const g=x[E][F][0].clone(),ie=x[E][F][1],ne=x[E][F][2],se=x[E][F][3],Le=x[E][F][4];g.name=E,g.tag=Le,ie&&g.position.set(ie[0],ie[1],ie[2]),ne&&g.rotation.set(ne[0],ne[1],ne[2]),se&&g.scale.set(se[0],se[1],se[2]),g.updateMatrix();const fe=g.geometry.clone();fe.applyMatrix4(g.matrix),g.geometry=fe,g.renderOrder=1/0,g.position.set(0,0,0),g.rotation.set(0,0,0),g.scale.set(1,1,1),te.add(g)}return te}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=H(W)),this.add(this.gizmo.rotate=H(Qe)),this.add(this.gizmo.scale=H(He)),this.add(this.picker.translate=H($)),this.add(this.picker.rotate=H(Ze)),this.add(this.picker.scale=H(qe)),this.add(this.helper.translate=H(Ae)),this.add(this.helper.rotate=H(Ye)),this.add(this.helper.scale=H(ze)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(t){const n=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:he;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let l=0;l<s.length;l++){const i=s[l];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);let o;if(this.camera.isOrthographicCamera?o=(this.camera.top-this.camera.bottom)/this.camera.zoom:o=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),i.scale.set(1,1,1).multiplyScalar(o*this.size/4),i.tag==="helper"){i.visible=!1,i.name==="AXIS"?(i.visible=!!this.axis,this.axis==="X"&&(m.setFromEuler(ae.set(0,0,0)),i.quaternion.copy(n).multiply(m),Math.abs(d.copy(N).applyQuaternion(n).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="Y"&&(m.setFromEuler(ae.set(0,0,Math.PI/2)),i.quaternion.copy(n).multiply(m),Math.abs(d.copy(j).applyQuaternion(n).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="Z"&&(m.setFromEuler(ae.set(0,Math.PI/2,0)),i.quaternion.copy(n).multiply(m),Math.abs(d.copy(J).applyQuaternion(n).dot(this.eye))>.9&&(i.visible=!1)),this.axis==="XYZE"&&(m.setFromEuler(ae.set(0,Math.PI/2,0)),d.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(Pe.lookAt(xe,d,j)),i.quaternion.multiply(m),i.visible=this.dragging),this.axis==="E"&&(i.visible=!1)):i.name==="START"?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):i.name==="END"?(i.position.copy(this.worldPosition),i.visible=this.dragging):i.name==="DELTA"?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),b.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),b.applyQuaternion(this.worldQuaternionStart.clone().invert()),i.scale.copy(b),i.visible=this.dragging):(i.quaternion.copy(n),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=this.axis.search(i.name)!==-1));continue}i.quaternion.copy(n),this.mode==="translate"||this.mode==="scale"?(i.name==="X"&&Math.abs(d.copy(N).applyQuaternion(n).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="Y"&&Math.abs(d.copy(j).applyQuaternion(n).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="Z"&&Math.abs(d.copy(J).applyQuaternion(n).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="XY"&&Math.abs(d.copy(J).applyQuaternion(n).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="YZ"&&Math.abs(d.copy(N).applyQuaternion(n).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),i.name==="XZ"&&Math.abs(d.copy(j).applyQuaternion(n).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1)):this.mode==="rotate"&&(re.copy(n),d.copy(this.eye).applyQuaternion(m.copy(n).invert()),i.name.search("E")!==-1&&i.quaternion.setFromRotationMatrix(Pe.lookAt(this.eye,xe,j)),i.name==="X"&&(m.setFromAxisAngle(N,Math.atan2(-d.y,d.z)),m.multiplyQuaternions(re,m),i.quaternion.copy(m)),i.name==="Y"&&(m.setFromAxisAngle(j,Math.atan2(d.x,d.z)),m.multiplyQuaternions(re,m),i.quaternion.copy(m)),i.name==="Z"&&(m.setFromAxisAngle(J,Math.atan2(d.y,d.x)),m.multiplyQuaternions(re,m),i.quaternion.copy(m))),i.visible=i.visible&&(i.name.indexOf("X")===-1||this.showX),i.visible=i.visible&&(i.name.indexOf("Y")===-1||this.showY),i.visible=i.visible&&(i.name.indexOf("Z")===-1||this.showZ),i.visible=i.visible&&(i.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),i.material._color=i.material._color||i.material.color.clone(),i.material._opacity=i.material._opacity||i.material.opacity,i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled&&this.axis&&(i.name===this.axis||this.axis.split("").some(function(c){return i.name===c}))&&(i.material.color.setHex(16776960),i.material.opacity=1)}super.updateMatrixWorld(t)}}class ut extends a{constructor(){super(new We(1e5,1e5,2,2),new Ce({visible:!1,wireframe:!0,side:Fe,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(t){let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),le.copy(N).applyQuaternion(e==="local"?this.worldQuaternion:he),B.copy(j).applyQuaternion(e==="local"?this.worldQuaternion:he),V.copy(J).applyQuaternion(e==="local"?this.worldQuaternion:he),d.copy(B),this.mode){case"translate":case"scale":switch(this.axis){case"X":d.copy(this.eye).cross(le),T.copy(le).cross(d);break;case"Y":d.copy(this.eye).cross(B),T.copy(B).cross(d);break;case"Z":d.copy(this.eye).cross(V),T.copy(V).cross(d);break;case"XY":T.copy(V);break;case"YZ":T.copy(le);break;case"XZ":d.copy(V),T.copy(B);break;case"XYZ":case"E":T.set(0,0,0);break}break;case"rotate":default:T.set(0,0,0)}T.length()===0?this.quaternion.copy(this.cameraQuaternion):(Ee.lookAt(b.set(0,0,0),T,d),this.quaternion.setFromRotationMatrix(Ee)),super.updateMatrixWorld(t)}}const K=new Ue,ft=K.get(Be),wt=document.getElementById("container"),p=ft.create();p.scene=new Ve(K);p.renderer=new Ne(K,wt);p.camera=new Je(K);K.init();p.scene.three.add(new Ke);p.camera.three.far=1e4;p.renderer.three.shadowMap.enabled=!0;p.renderer.three.shadowMap.type=et;p.scene.setup({shadows:{cascade:1,resolution:1024}});await p.scene.updateShadows();p.camera.controls.addEventListener("rest",async()=>{await p.scene.updateShadows()});const yt="https://thatopen.github.io/engine_fragment/resources/worker.mjs",_=new at(yt);p.camera.controls.addEventListener("control",()=>_.update());_.models.list.onItemSet.add(({value:r})=>{r.useCamera(p.camera.three),p.scene.three.add(r.object),r.tiles.onItemSet.add(({value:t})=>{"isMesh"in t&&t.material[0].opacity===1&&(t.castShadow=!0,t.receiveShadow=!0)})});const bt=await fetch("https://thatopen.github.io/engine_fragment/resources/frags/school_arq.frag"),_t=await bt.arrayBuffer(),I=await _.load(_t,{modelId:"medium_test",camera:p.camera.three});p.scene.three.add(I.object);await _.update(!0);class gt{constructor(t){P(this,"onUpdated",new be);P(this,"sampleMaterialsUpdated",new be);P(this,"_world");P(this,"_element",null);P(this,"_mesh",null);P(this,"_gControls");P(this,"_lControls",[]);P(this,"_controlType","global");P(this,"_materials",null);P(this,"_localTransformsIds",[]);P(this,"_geometriesIds",[]);this._world=t,this._gControls=new Se(t.camera.three,t.renderer.three.domElement),this.setupEvents()}get materials(){if(!this._materials)throw new Error("Editor not initialized");return this._materials}get localTransformsIds(){if(!this._localTransformsIds.length)throw new Error("Editor not initialized");return this._localTransformsIds}get geometriesIds(){if(!this._geometriesIds.length)throw new Error("Editor not initialized");return this._geometriesIds}get samples(){if(!this._element)throw new Error("No element selected");return this._element.core.samples}get elementSelected(){return this._element!==null}async init(){this._materials=await I.getMaterials();const t=await I.getLocalTransformsIds(),e=await I.getRepresentationsIds();this._localTransformsIds=[t[0],t[1]],this._geometriesIds=[e[0],e[1]]}get3dMaterials(){if(!this._mesh)return[];const t=new Map;return this._mesh.traverse(e=>{e instanceof a&&t.set(e.material.userData.localId,e.material)}),Array.from(t.values())}async setSampleMaterial(t,e){this._element&&(this._element.core.samples[t].material=e,await this.updateSamples(),this.sampleMaterialsUpdated.trigger())}async updateMaterials(){this._materials&&(this._materials=await I.getMaterials())}overrideGeometryWithCube(){this._mesh&&this._mesh.traverse(t=>{if(t instanceof a){const e=t.geometry,n=new y(1,1,1);e.setAttribute("position",n.attributes.position),e.setIndex(n.index),e.setAttribute("normal",n.attributes.normal)}})}async applyChanges(){if(!this._element||!this._mesh)return;await this._element.setMeshes(this._mesh),this.dispose();const t=this._element.getRequests();t&&await _.editor.edit(I.modelId,t),this._element.elementChanged||await this.setVisible(!0),await _.update(!0),this._element=null,this._mesh=null,this.onUpdated.trigger()}setControlsMode(t){this._gControls.setMode(t);for(const e of this._lControls)e.setMode(t)}setControlsTarget(t=this._controlType){const e=this._gControls.getHelper();if(t==="global"){this._world.scene.three.add(e),this._gControls.enabled=!0;for(const n of this._lControls)n.getHelper().removeFromParent(),n.enabled=!1}else{e.removeFromParent(),this._gControls.enabled=!1;for(const n of this._lControls){const s=n.getHelper();this._world.scene.three.add(s),n.enabled=!0}}this._controlType=t}async updateSamples(){if(!this._element||!this._mesh)return;const t=this._mesh.matrixWorld.clone();await this._element.updateSamples(),this.dispose(),this._mesh=await this._element.getMeshes(),this._world.scene.three.add(this._mesh),await this.createControls(),this._mesh.position.set(0,0,0),this._mesh.rotation.set(0,0,0),this._mesh.applyMatrix4(t)}async createControls(){if(this._mesh){this._gControls.attach(this._mesh);for(const t of this._mesh.children){const e=new Se(p.camera.three,p.renderer.three.domElement);e.attach(t),e.setMode(this._gControls.mode),this._lControls.push(e),e.addEventListener("dragging-changed",n=>{p.camera.hasCameraControls()&&(p.camera.controls.enabled=!n.value)})}this.setControlsTarget()}}dispose(){if(this._mesh&&this._element&&this._element.disposeMeshes(this._mesh),this._gControls.getHelper().removeFromParent(),this._gControls.detach(),!(!this._mesh||!this._element)){for(const e of this._lControls)e.detach(),e.dispose();this._lControls.length=0}}async setVisible(t){if(!this._element)return;const e=[];for(const[,n]of _.models.list){if(n.deltaModelId&&t===!0){const s=new Set(await n.getEditedElements());if(t&&s.has(this._element.localId))continue}e.push(n.setVisible([this._element.localId],t))}await Promise.all(e)}setupEvents(){this._gControls.addEventListener("dragging-changed",n=>{this._world.camera.hasCameraControls()&&(this._world.camera.controls.enabled=!n.value)});const t=new it;this._world.renderer.three.domElement.addEventListener("dblclick",async n=>{t.x=n.clientX,t.y=n.clientY;let s;for(const[,i]of _.models.list){const o=[];o.push(i.raycast({camera:p.camera.three,mouse:t,dom:p.renderer.three.domElement}));const c=await Promise.all(o);let u=1/0;for(const w of c)w&&w.distance<u&&(u=w.distance,s=w)}if(!s)return;this._element&&await this.setVisible(!0);const[l]=await _.editor.getElements(I.modelId,[s.localId]);this._element=l,l&&(this._mesh&&this.dispose(),await this.setVisible(!1),this._mesh=await l.getMeshes(),this._world.scene.three.add(this._mesh),await this.createControls(),await _.update(!0),this.onUpdated.trigger())}),window.addEventListener("keydown",async n=>{if(n.key==="Escape"){if(!this._element||!this._mesh)return;this._element.getRequests(),this.dispose(),this.setVisible(!0),await _.update(!0),this._element=null,this._mesh=null,this.onUpdated.trigger()}})}}const f=new gt(p);await f.init();ot.init();const[vt,Mt]=q.create(r=>{const t=new tt,e=[];if(f.elementSelected){const n=f.samples;for(const s in n){const l=n[s],i=q.create(()=>M`
             <bim-dropdown label="Material" @change=${async c=>{if(!c.target.value[0])return;const u=parseInt(s,10);await f.setSampleMaterial(u,c.target.value[0])}}>
            </bim-dropdown>
        `);f.updateMaterials().then(()=>{for(const[c,u]of f.materials){const{r:w,g:A,b:R}=u;t.setRGB(w/255,A/255,R/255);const ee=`#${t.getHexString()}`,O=q.create(()=>M`<bim-option icon="icon-park-outline:material" label=${c} ?checked=${l.material===c}>
            <div style="width: 1rem; height: 1rem; background-color: ${ee}"></div>
          </bim-option>`);i.appendChild(O)}});const o=q.create(()=>M`
          <div style="display: flex; gap: 0.5rem; flex-direction: column;">

            <div style="display: flex; gap: 0.5rem;">
              <bim-label icon="f7:cube" style="font-weight: bold;">Sample ${s}</bim-label>
            </div>

            ${i}

            <bim-dropdown label="Local Transform" @change=${async c=>{if(!c.target.value[0])return;const u=n[s];u&&(u.localTransform=c.target.value[0],await f.updateSamples())}}>

              ${[...new Set([...f.localTransformsIds,l.localTransform])].map(c=>M`<bim-option icon="iconoir:axes" label=${c} ?checked=${l.localTransform===c}>
                </bim-option>`)}
            </bim-dropdown>

            <bim-dropdown label="Geometry" @change=${async c=>{if(!c.target.value[0])return;const u=n[s];u&&(u.representation=c.target.value[0],await f.updateSamples())}}>

              ${[...new Set([...f.geometriesIds,l.representation])].map(c=>M`<bim-option icon="fluent:select-object-24-filled" label=${c} ?checked=${l.representation===c}>
                </bim-option>`)}
            </bim-dropdown>
          </div>
          `);e.push(o)}}return M`<bim-panel-section label="Samples">
  ${e.map(n=>n)}
  </bim-panel-section>`},{}),[St,Xe]=q.create(r=>{const t=f.get3dMaterials();return M`
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        ${t.map(e=>M`

          <div style="display: flex; gap: 0.5rem;">
          <bim-color-input color=#${e.color.getHexString()} label=${e.userData.localId} @input=${n=>{e.color.set(n.target.color)}}>
          </bim-color-input>

          <bim-number-input slider min=0 max=1 step=0.01 value=${e.opacity} @change=${n=>{e.opacity=n.target.value}}></bim-number-input>

          </div>`)}
        </div>
  `},{});f.sampleMaterialsUpdated.add(Xe);const Ie=document.getElementById("history-menu");let ce=null;const xt=async()=>{const{requests:r,undoneRequests:t}=await _.editor.getModelRequests(I.modelId),e=[...r,...t];Ie.innerHTML="";let n=null;for(let s=0;s<e.length;s++){const l=e[s],i=s<e.length-1,o=q.create(()=>M`
        <bim-button icon="solar:arrow-right-bold"></bim-button>
      `);(ce===s||ce===null&&!i)&&(o.classList.add("selected-request"),n=o);const w=s;o.addEventListener("click",async()=>{n&&n.classList.remove("selected-request"),n=o,o.classList.add("selected-request"),await _.editor.selectRequest(I.modelId,w),await I.setVisible(void 0,!0),ce=w,await _.editor.edit(I.modelId,[],{removeRedo:!1}),await _.update(!0)});const A=q.create(()=>M`
      <div class="history-request">
        ${i?M`<div class="history-line"></div>`:""}
        ${o}
        <div>
          <bim-label class="history-request-title">${nt[l.type]}</bim-label>
          <bim-label class="history-request-subtitle">ID: ${l.localId}</bim-label>
        </div>
      </div>
      `);Ie.appendChild(A)}ce=null};_.editor.onEdit.add(xt);const[de,Pt]=q.create(r=>{const t=M`<bim-button label="Change geometry" @click=${()=>{f.overrideGeometryWithCube()}}></bim-button>`;return Mt(),Xe(),M`
    <bim-panel style="min-width: 25rem;" id="controls-panel" active label="Element Editor" class="options-menu">
      <bim-panel-section label="Controls">
        <bim-button data-name="arq" label="Apply changes" @click=${()=>f.applyChanges()}></bim-button>
        <bim-dropdown required label="Tranform Mode" 
            @change="${({target:e})=>{const n=e.value[0];f.setControlsMode(n)}}">
          <bim-option checked  label="translate"></bim-option>
          <bim-option label="rotate"></bim-option>
        </bim-dropdown>
        <bim-dropdown required label="Transform Target" 
            @change="${({target:e})=>{const n=e.value[0];f.setControlsTarget(n)}}">
          <bim-option checked  label="global"></bim-option>
          <bim-option label="local"></bim-option>
        </bim-dropdown>
        ${t}
        ${St}
      </bim-panel-section>
      ${vt}
    </bim-panel>
  `},{});f.onUpdated.add(()=>{Pt()});document.body.append(de);const Et=q.create(()=>M`
    <bim-button class="phone-menu-toggler" icon="solar:settings-bold"
      @click=${()=>{de.classList.contains("options-menu-visible")?de.classList.remove("options-menu-visible"):de.classList.add("options-menu-visible")}}>
    </bim-button>
  `);document.body.append(Et);window.dispatchEvent(new Event("resize"));const z=new st;z.showPanel(2);document.body.append(z.dom);z.dom.style.right="0px";z.dom.style.bottom="0px";z.dom.style.left="unset";z.dom.style.top="unset";z.dom.style.zIndex="unset";p.renderer.onBeforeUpdate.add(()=>z.begin());p.renderer.onAfterUpdate.add(()=>z.end());
