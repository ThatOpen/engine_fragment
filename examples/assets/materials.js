import{C as F,W as N,fq as O,a as B,fr as G,ft as k,fs as P,V as D,fI as q,fM as U,fA as z,fv as J,fN as K,fw as E,fy as V,fO as v,fF as A}from"./virtual-memory-controller-CFZpSOdq.js";import{R as W}from"./RGBELoader-C2k14OB1.js";import{F as H}from"./index-MzIC0kit.js";const Q=document.getElementById("container"),i=new F,X=i.get(N),e=X.create();e.scene=new O(i);e.renderer=new B(i,Q);e.camera=new G(i);i.init();const Y=new k(10);e.scene.three.add(Y);e.camera.controls.setLookAt(12,6,8,0,0,-10);e.renderer.three.shadowMap.enabled=!0;e.renderer.three.shadowMap.type=P;e.scene.setup({directionalLight:{color:new q(1,1,1),position:new D(5,10,5),intensity:4},shadows:{cascade:1,resolution:1024}});e.renderer.three.toneMapping=U;e.renderer.three.toneMappingExposure=1;await e.scene.updateShadows();e.camera.controls.addEventListener("rest",async()=>{await e.scene.updateShadows()});const Z=new W;Z.load("https://thatopen.github.io/engine_fragment/resources/textures/envmaps/san_giuseppe_bridge_2k.hdr",t=>{t.mapping=z,e.scene.three.environment=t});const $="https://thatopen.github.io/engine_fragment/resources/worker.mjs",o=new H($);e.camera.controls.addEventListener("control",()=>o.update());const h=t=>{t.wrapS=A,t.wrapT=A,t.repeat.set(.1,.1)},w=new J,b=w.load("https://thatopen.github.io/engine_fragment/resources/textures/concrete/Concrete012_2K-JPG_Color.jpg");b.colorSpace=K;h(b);const x=w.load("https://thatopen.github.io/engine_fragment/resources/textures/concrete/Concrete012_2K-JPG_NormalGL.jpg");h(x);const g=w.load("https://thatopen.github.io/engine_fragment/resources/textures/concrete/Concrete012_2K-JPG_Roughness.jpg");h(g);o.models.materials.list.onItemSet.add(({key:t,value:a})=>{if("map"in a){if(a.color.r===1&&a.color.g===0&&a.color.b===0){const l=new E({color:a.color,metalness:.9,roughnessMap:g,roughness:1});o.models.materials.list.set(t,l);return}const r=new E({color:a.color,map:b,normalMap:x,roughnessMap:g,roughness:1});o.models.materials.list.set(t,r)}});o.models.list.onItemSet.add(({value:t})=>{t.tiles.onItemSet.add(({value:a})=>{if(!("isLODGeometry"in a.geometry)){const r=a.geometry;a.castShadow=!0,a.receiveShadow=!0;const l=r.index.array,d=r.attributes.position.array,m=r.attributes.normal.array,n=new Float32Array(d.length/3*2);for(let p=0;p<l.length;p++){const s=l[p],I=d[s*3],S=d[s*3+1],_=d[s*3+2],L=m[s*3],R=m[s*3+1],j=m[s*3+2],u=Math.abs(L),f=Math.abs(R),C=Math.abs(j);u>f&&u>C?(n[s*2]=S,n[s*2+1]=_):f>u&&f>C?(n[s*2]=I,n[s*2+1]=_):(n[s*2]=I,n[s*2+1]=S)}const M=new V(n,2);M.onUpload(function(){delete this.array}),r.setAttribute("uv",M)}})});const ee=await fetch("https://thatopen.github.io/engine_fragment/resources/frags/school_str.frag"),te=await ee.arrayBuffer(),c=await o.load(te,{modelId:"test",camera:e.camera.three});e.scene.three.add(c.object);const ae=await c.getItemsOfCategories([/IFCCOLUMN/,/IFCBEAM/,/IFCMEMBER/]),se=Object.values(ae).flat(),T=new Set;for(const t of se)(await c.getItemsData([t],{attributes:["Name","NominalValue"],relations:{IsDefinedBy:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}}))[0].ObjectType.value.includes("Concrete")||T.add(t);const y=[],oe={r:255,g:0,b:0,a:255,renderedFaces:0,stroke:0};y.push({type:v.CREATE_MATERIAL,tempId:"new-material",data:oe});const re=new Set(await c.getGlobalTranformsIdsOfItems(Array.from(T))),ne=await c.getSamples();for(const[t,a]of ne)re.has(a.item)&&y.push({type:v.UPDATE_SAMPLE,localId:t,data:{...a,material:"new-material"}});await o.editor.edit(c.modelId,y);await o.update(!0);
