import{C as j,W as F,fq as k,a as B,fr as N,ft as U,fs as G,V as P,fI as D,fM as q,fA as z,fv as J,fN as K,fw as L,fy as V,fO as E,fF as v}from"./virtual-memory-controller-uf_sHEwD.js";import{R as W}from"./RGBELoader-C-f4ls_8.js";import{F as H}from"./index-UINVeUYY.js";const Q=document.getElementById("container"),i=new j,X=i.get(F),t=X.create();t.scene=new k(i);t.renderer=new B(i,Q);t.camera=new N(i);i.init();const Y=new U(10);t.scene.three.add(Y);t.camera.controls.setLookAt(12,6,8,0,0,-10);t.renderer.three.shadowMap.enabled=!0;t.renderer.three.shadowMap.type=G;t.scene.setup({directionalLight:{color:new D(1,1,1),position:new P(5,10,5),intensity:4},shadows:{cascade:1,resolution:1024}});t.renderer.three.toneMapping=q;t.renderer.three.toneMappingExposure=1;await t.scene.updateShadows();t.camera.controls.addEventListener("rest",async()=>{await t.scene.updateShadows()});const Z=new W;Z.load("https://thatopen.github.io/engine_fragment/resources/textures/envmaps/san_giuseppe_bridge_2k.hdr",e=>{e.mapping=z,t.scene.three.environment=e});const $="https://thatopen.github.io/engine_fragment/resources/worker.mjs",ee=await fetch($),te=await ee.blob(),ae=new File([te],"worker.mjs",{type:"text/javascript"}),oe=URL.createObjectURL(ae),s=new H(oe);t.camera.controls.addEventListener("control",()=>s.update());s.models.materials.list.onItemSet.add(({value:e})=>{"isLodMaterial"in e&&e.isLodMaterial||(e.polygonOffset=!0,e.polygonOffsetUnits=1,e.polygonOffsetFactor=Math.random())});const h=e=>{e.wrapS=v,e.wrapT=v,e.repeat.set(.1,.1)},w=new J,b=w.load("https://thatopen.github.io/engine_fragment/resources/textures/concrete/Concrete012_2K-JPG_Color.jpg");b.colorSpace=K;h(b);const x=w.load("https://thatopen.github.io/engine_fragment/resources/textures/concrete/Concrete012_2K-JPG_NormalGL.jpg");h(x);const g=w.load("https://thatopen.github.io/engine_fragment/resources/textures/concrete/Concrete012_2K-JPG_Roughness.jpg");h(g);s.models.materials.list.onItemSet.add(({key:e,value:a})=>{if("map"in a){if(a.color.r===1&&a.color.g===0&&a.color.b===0){const l=new L({color:a.color,metalness:.9,roughnessMap:g,roughness:1});s.models.materials.list.set(e,l);return}const r=new L({color:a.color,map:b,normalMap:x,roughnessMap:g,roughness:1});s.models.materials.list.set(e,r)}});s.models.list.onItemSet.add(({value:e})=>{e.tiles.onItemSet.add(({value:a})=>{if(!("isLODGeometry"in a.geometry)){const r=a.geometry;a.castShadow=!0,a.receiveShadow=!0;const l=r.index.array,d=r.attributes.position.array,u=r.attributes.normal.array,n=new Float32Array(d.length/3*2);for(let p=0;p<l.length;p++){const o=l[p],I=d[o*3],S=d[o*3+1],_=d[o*3+2],T=u[o*3],O=u[o*3+1],R=u[o*3+2],f=Math.abs(T),m=Math.abs(O),C=Math.abs(R);f>m&&f>C?(n[o*2]=S,n[o*2+1]=_):m>f&&m>C?(n[o*2]=I,n[o*2+1]=_):(n[o*2]=I,n[o*2+1]=S)}const M=new V(n,2);M.onUpload(function(){delete this.array}),r.setAttribute("uv",M)}})});const se=await fetch("https://thatopen.github.io/engine_fragment/resources/frags/school_str.frag"),re=await se.arrayBuffer(),c=await s.load(re,{modelId:"test",camera:t.camera.three});t.scene.three.add(c.object);const ne=await c.getItemsOfCategories([/IFCCOLUMN/,/IFCBEAM/,/IFCMEMBER/]),ce=Object.values(ne).flat(),A=new Set;for(const e of ce)(await c.getItemsData([e],{attributes:["Name","NominalValue"],relations:{IsDefinedBy:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}}))[0].ObjectType.value.includes("Concrete")||A.add(e);const y=[],ie={r:255,g:0,b:0,a:255,renderedFaces:0,stroke:0};y.push({type:E.CREATE_MATERIAL,tempId:"new-material",data:ie});const le=new Set(await c.getGlobalTranformsIdsOfItems(Array.from(A))),de=await c.getSamples();for(const[e,a]of de)le.has(a.item)&&y.push({type:E.UPDATE_SAMPLE,localId:e,data:{...a,material:"new-material"}});await s.editor.edit(c.modelId,y);await s.update(!0);
