import{V as L,fJ as Ce,g6 as ct,gj as lt,g5 as Ue,fX as Ar,c as Pe,gq as wn,gh as on,gg as dt,gf as an,gi as gs,gd as fs,gz as it,gA as be,gB as El,cb as Yr,gC as Sl,gD as Le,cy as oi,gE as ra,fB as rt,fH as ie,fI as fe,fY as vs,fx as Ft,gF as Cl,gG as Tl,fy as Rt,f$ as es,gH as oa,gm as Pl,gk as Al,fD as aa,fC as la,fE as pn,cc as Ml,gI as xt,gJ as ms,gK as Mr,g3 as Or,ge as Be,gp as Ol,go as ha,fZ as Je,cr as pi,gL as Dl,gM as Zr,gl as yi,gN as zl,g7 as kl,g9 as Il,ga as nr,gb as Ls,gc as Ll,gO as Nl,gv as Ul,f_ as qe,fK as Dt,fo as ca,gP as Bl,cz as bt,gQ as Rl,gu as Xr,fW as Fl,g0 as bi,g1 as Ws,fL as Vl,g2 as jl,gR as Hl,gS as Dr,gT as qr,fQ as Us,gU as Lt,gV as Wl,gW as xi,gX as Ei,gY as Qr,gZ as Kr,g_ as Gl,g$ as Yl,h0 as Zl,h1 as Xl,h2 as Bs,h3 as da,fF as fn,h4 as Jr,fU as Ut,h5 as ql,h6 as Ql,h7 as Kl,h8 as Jl,h9 as $l,ha as eh,hb as th,hc as sh,fM as ih,hd as nh}from"./virtual-memory-controller-uf_sHEwD.js";var rh=Object.defineProperty,oh=(a,e,t)=>e in a?rh(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,S=(a,e,t)=>(oh(a,typeof e!="symbol"?e+"":e,t),t),ah=Object.defineProperty,lh=(a,e,t)=>e in a?ah(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,E=(a,e,t)=>(lh(a,typeof e!="symbol"?e+"":e,t),t);let K=class{constructor(){E(this,"enabled",!0),E(this,"trigger",a=>{if(!this.enabled)return;const e=this.handlers.slice(0);for(const t of e)t(a)}),E(this,"handlers",[])}add(a){this.handlers.push(a)}remove(a){this.handlers=this.handlers.filter(e=>e!==a)}reset(){this.handlers.length=0}};class zr{constructor(e){E(this,"isDisposeable",()=>"dispose"in this&&"onDisposed"in this),E(this,"isResizeable",()=>"resize"in this&&"getSize"in this),E(this,"isUpdateable",()=>"onAfterUpdate"in this&&"onBeforeUpdate"in this&&"update"in this),E(this,"isHideable",()=>"visible"in this),E(this,"isConfigurable",()=>"setup"in this&&"config"in this&&"onSetup"in this),E(this,"isSerializable",()=>"import"in this&&"export"in this),this.components=e}}class xe extends zr{}class ua extends zr{constructor(e){super(e),E(this,"worlds",new be),E(this,"onWorldChanged",new K),E(this,"_currentWorld",null),this.onWorldChanged.add(({world:t,action:s})=>{s==="removed"&&this.worlds.delete(t.uuid)})}set currentWorld(e){this._currentWorld=e}get currentWorld(){return this._currentWorld}}class hh extends ua{constructor(){super(...arguments),E(this,"hasCameraControls",()=>"controls"in this)}}class ch extends ua{constructor(){super(...arguments),E(this,"onAfterUpdate",new K),E(this,"onBeforeUpdate",new K),E(this,"onDisposed",new K),E(this,"onResize",new K),E(this,"onClippingPlanesUpdated",new K),E(this,"clippingPlanes",[])}updateClippingPlanes(){this.onClippingPlanesUpdated.trigger()}setPlane(e,t,s){t.isLocal=s;const i=this.clippingPlanes.indexOf(t);e&&i===-1?this.clippingPlanes.push(t):!e&&i>-1&&this.clippingPlanes.splice(i,1),this.three.clippingPlanes=this.clippingPlanes.filter(n=>!n.isLocal)}}const pa=class rr extends xe{constructor(e){super(e),E(this,"_disposedComponents",new Set),E(this,"enabled",!0),e.add(rr.uuid,this)}get(){return this._disposedComponents}destroy(e,t=!0,s=!0){e.removeFromParent();const i=e;i.dispose&&i.dispose(),this.disposeGeometryAndMaterials(e,t),s&&i.children&&i.children.length&&this.disposeChildren(i),e.children.length=0}disposeGeometry(e){e.boundsTree&&e.disposeBoundsTree&&e.disposeBoundsTree(),e.dispose()}disposeGeometryAndMaterials(e,t){const s=e;s.geometry&&this.disposeGeometry(s.geometry),t&&s.material&&rr.disposeMaterial(s),s.material=[],s.geometry=null}disposeChildren(e){for(const t of e.children)this.destroy(t)}static disposeMaterial(e){if(e.material)if(Array.isArray(e.material))for(const t of e.material)t.dispose();else e.material.dispose()}};E(pa,"uuid","76e9cd8e-ad8f-4753-9ef6-cbc60f7247fe");let It=pa;const kr=class je{static create(){const e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,s=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return`${je._lut[e&255]+je._lut[e>>8&255]+je._lut[e>>16&255]+je._lut[e>>24&255]}-${je._lut[t&255]}${je._lut[t>>8&255]}-${je._lut[t>>16&15|64]}${je._lut[t>>24&255]}-${je._lut[s&63|128]}${je._lut[s>>8&255]}-${je._lut[s>>16&255]}${je._lut[s>>24&255]}${je._lut[i&255]}${je._lut[i>>8&255]}${je._lut[i>>16&255]}${je._lut[i>>24&255]}`.toLowerCase()}static validate(e){if(!je._pattern.test(e))throw new Error(`${e} is not a valid UUID v4.

- If you're the tool creator, you can take one from https://www.uuidgenerator.net/.

- If you're using a platform tool, verify the uuid isn't misspelled or contact the tool creator.`)}};E(kr,"_pattern",/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-4[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/);E(kr,"_lut",["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"]);let Ze=kr;var Si=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function dh(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var fa={},bn={};(function(a){const e=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",t=e+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",s="["+e+"]["+t+"]*",i=new RegExp("^"+s+"$"),n=function(o,l){const h=[];let c=l.exec(o);for(;c;){const d=[];d.startIndex=l.lastIndex-c[0].length;const p=c.length;for(let u=0;u<p;u++)d.push(c[u]);h.push(d),c=l.exec(o)}return h},r=function(o){const l=i.exec(o);return!(l===null||typeof l>"u")};a.isExist=function(o){return typeof o<"u"},a.isEmptyObject=function(o){return Object.keys(o).length===0},a.merge=function(o,l,h){if(l){const c=Object.keys(l),d=c.length;for(let p=0;p<d;p++)h==="strict"?o[c[p]]=[l[c[p]]]:o[c[p]]=l[c[p]]}},a.getValue=function(o){return a.isExist(o)?o:""},a.isName=r,a.getAllMatches=n,a.nameRegexp=s})(bn);const Ir=bn,uh={allowBooleanAttributes:!1,unpairedTags:[]};fa.validate=function(a,e){e=Object.assign({},uh,e);const t=[];let s=!1,i=!1;a[0]==="\uFEFF"&&(a=a.substr(1));for(let n=0;n<a.length;n++)if(a[n]==="<"&&a[n+1]==="?"){if(n+=2,n=eo(a,n),n.err)return n}else if(a[n]==="<"){let r=n;if(n++,a[n]==="!"){n=to(a,n);continue}else{let o=!1;a[n]==="/"&&(o=!0,n++);let l="";for(;n<a.length&&a[n]!==">"&&a[n]!==" "&&a[n]!=="	"&&a[n]!==`
`&&a[n]!=="\r";n++)l+=a[n];if(l=l.trim(),l[l.length-1]==="/"&&(l=l.substring(0,l.length-1),n--),!wh(l)){let d;return l.trim().length===0?d="Invalid space after '<'.":d="Tag '"+l+"' is an invalid name.",Ie("InvalidTag",d,$e(a,n))}const h=mh(a,n);if(h===!1)return Ie("InvalidAttr","Attributes for '"+l+"' have open quote.",$e(a,n));let c=h.value;if(n=h.index,c[c.length-1]==="/"){const d=n-c.length;c=c.substring(0,c.length-1);const p=so(c,e);if(p===!0)s=!0;else return Ie(p.err.code,p.err.msg,$e(a,d+p.err.line))}else if(o)if(h.tagClosed){if(c.trim().length>0)return Ie("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",$e(a,r));if(t.length===0)return Ie("InvalidTag","Closing tag '"+l+"' has not been opened.",$e(a,r));{const d=t.pop();if(l!==d.tagName){let p=$e(a,d.tagStartPos);return Ie("InvalidTag","Expected closing tag '"+d.tagName+"' (opened in line "+p.line+", col "+p.col+") instead of closing tag '"+l+"'.",$e(a,r))}t.length==0&&(i=!0)}}else return Ie("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",$e(a,n));else{const d=so(c,e);if(d!==!0)return Ie(d.err.code,d.err.msg,$e(a,n-c.length+d.err.line));if(i===!0)return Ie("InvalidXml","Multiple possible root nodes found.",$e(a,n));e.unpairedTags.indexOf(l)!==-1||t.push({tagName:l,tagStartPos:r}),s=!0}for(n++;n<a.length;n++)if(a[n]==="<")if(a[n+1]==="!"){n++,n=to(a,n);continue}else if(a[n+1]==="?"){if(n=eo(a,++n),n.err)return n}else break;else if(a[n]==="&"){const d=yh(a,n);if(d==-1)return Ie("InvalidChar","char '&' is not expected.",$e(a,n));n=d}else if(i===!0&&!$r(a[n]))return Ie("InvalidXml","Extra text at the end",$e(a,n));a[n]==="<"&&n--}}else{if($r(a[n]))continue;return Ie("InvalidChar","char '"+a[n]+"' is not expected.",$e(a,n))}if(s){if(t.length==1)return Ie("InvalidTag","Unclosed tag '"+t[0].tagName+"'.",$e(a,t[0].tagStartPos));if(t.length>0)return Ie("InvalidXml","Invalid '"+JSON.stringify(t.map(n=>n.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return Ie("InvalidXml","Start tag expected.",1);return!0};function $r(a){return a===" "||a==="	"||a===`
`||a==="\r"}function eo(a,e){const t=e;for(;e<a.length;e++)if(a[e]=="?"||a[e]==" "){const s=a.substr(t,e-t);if(e>5&&s==="xml")return Ie("InvalidXml","XML declaration allowed only at the start of the document.",$e(a,e));if(a[e]=="?"&&a[e+1]==">"){e++;break}else continue}return e}function to(a,e){if(a.length>e+5&&a[e+1]==="-"&&a[e+2]==="-"){for(e+=3;e<a.length;e++)if(a[e]==="-"&&a[e+1]==="-"&&a[e+2]===">"){e+=2;break}}else if(a.length>e+8&&a[e+1]==="D"&&a[e+2]==="O"&&a[e+3]==="C"&&a[e+4]==="T"&&a[e+5]==="Y"&&a[e+6]==="P"&&a[e+7]==="E"){let t=1;for(e+=8;e<a.length;e++)if(a[e]==="<")t++;else if(a[e]===">"&&(t--,t===0))break}else if(a.length>e+9&&a[e+1]==="["&&a[e+2]==="C"&&a[e+3]==="D"&&a[e+4]==="A"&&a[e+5]==="T"&&a[e+6]==="A"&&a[e+7]==="["){for(e+=8;e<a.length;e++)if(a[e]==="]"&&a[e+1]==="]"&&a[e+2]===">"){e+=2;break}}return e}const ph='"',fh="'";function mh(a,e){let t="",s="",i=!1;for(;e<a.length;e++){if(a[e]===ph||a[e]===fh)s===""?s=a[e]:s!==a[e]||(s="");else if(a[e]===">"&&s===""){i=!0;break}t+=a[e]}return s!==""?!1:{value:t,index:e,tagClosed:i}}const gh=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function so(a,e){const t=Ir.getAllMatches(a,gh),s={};for(let i=0;i<t.length;i++){if(t[i][1].length===0)return Ie("InvalidAttr","Attribute '"+t[i][2]+"' has no space in starting.",Gs(t[i]));if(t[i][3]!==void 0&&t[i][4]===void 0)return Ie("InvalidAttr","Attribute '"+t[i][2]+"' is without value.",Gs(t[i]));if(t[i][3]===void 0&&!e.allowBooleanAttributes)return Ie("InvalidAttr","boolean attribute '"+t[i][2]+"' is not allowed.",Gs(t[i]));const n=t[i][2];if(!_h(n))return Ie("InvalidAttr","Attribute '"+n+"' is an invalid name.",Gs(t[i]));if(!s.hasOwnProperty(n))s[n]=1;else return Ie("InvalidAttr","Attribute '"+n+"' is repeated.",Gs(t[i]))}return!0}function vh(a,e){let t=/\d/;for(a[e]==="x"&&(e++,t=/[\da-fA-F]/);e<a.length;e++){if(a[e]===";")return e;if(!a[e].match(t))break}return-1}function yh(a,e){if(e++,a[e]===";")return-1;if(a[e]==="#")return e++,vh(a,e);let t=0;for(;e<a.length;e++,t++)if(!(a[e].match(/\w/)&&t<20)){if(a[e]===";")break;return-1}return e}function Ie(a,e,t){return{err:{code:a,msg:e,line:t.line||t,col:t.col}}}function _h(a){return Ir.isName(a)}function wh(a){return Ir.isName(a)}function $e(a,e){const t=a.substring(0,e).split(/\r?\n/);return{line:t.length,col:t[t.length-1].length+1}}function Gs(a){return a.startIndex+a[1].length}var Lr={};const ma={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(a,e){return e},attributeValueProcessor:function(a,e){return e},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(a,e,t){return a}},bh=function(a){return Object.assign({},ma,a)};Lr.buildOptions=bh;Lr.defaultOptions=ma;class xh{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){e==="__proto__"&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){e.tagname==="__proto__"&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}var Eh=xh;const Sh=bn;function Ch(a,e){const t={};if(a[e+3]==="O"&&a[e+4]==="C"&&a[e+5]==="T"&&a[e+6]==="Y"&&a[e+7]==="P"&&a[e+8]==="E"){e=e+9;let s=1,i=!1,n=!1,r="";for(;e<a.length;e++)if(a[e]==="<"&&!n){if(i&&Ah(a,e))e+=7,[entityName,val,e]=Th(a,e+1),val.indexOf("&")===-1&&(t[zh(entityName)]={regx:RegExp(`&${entityName};`,"g"),val});else if(i&&Mh(a,e))e+=8;else if(i&&Oh(a,e))e+=8;else if(i&&Dh(a,e))e+=9;else if(Ph)n=!0;else throw new Error("Invalid DOCTYPE");s++,r=""}else if(a[e]===">"){if(n?a[e-1]==="-"&&a[e-2]==="-"&&(n=!1,s--):s--,s===0)break}else a[e]==="["?i=!0:r+=a[e];if(s!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:t,i:e}}function Th(a,e){let t="";for(;e<a.length&&a[e]!=="'"&&a[e]!=='"';e++)t+=a[e];if(t=t.trim(),t.indexOf(" ")!==-1)throw new Error("External entites are not supported");const s=a[e++];let i="";for(;e<a.length&&a[e]!==s;e++)i+=a[e];return[t,i,e]}function Ph(a,e){return a[e+1]==="!"&&a[e+2]==="-"&&a[e+3]==="-"}function Ah(a,e){return a[e+1]==="!"&&a[e+2]==="E"&&a[e+3]==="N"&&a[e+4]==="T"&&a[e+5]==="I"&&a[e+6]==="T"&&a[e+7]==="Y"}function Mh(a,e){return a[e+1]==="!"&&a[e+2]==="E"&&a[e+3]==="L"&&a[e+4]==="E"&&a[e+5]==="M"&&a[e+6]==="E"&&a[e+7]==="N"&&a[e+8]==="T"}function Oh(a,e){return a[e+1]==="!"&&a[e+2]==="A"&&a[e+3]==="T"&&a[e+4]==="T"&&a[e+5]==="L"&&a[e+6]==="I"&&a[e+7]==="S"&&a[e+8]==="T"}function Dh(a,e){return a[e+1]==="!"&&a[e+2]==="N"&&a[e+3]==="O"&&a[e+4]==="T"&&a[e+5]==="A"&&a[e+6]==="T"&&a[e+7]==="I"&&a[e+8]==="O"&&a[e+9]==="N"}function zh(a){if(Sh.isName(a))return a;throw new Error(`Invalid entity name ${a}`)}var kh=Ch;const Ih=/^[-+]?0x[a-fA-F0-9]+$/,Lh=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,Nh={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function Uh(a,e={}){if(e=Object.assign({},Nh,e),!a||typeof a!="string")return a;let t=a.trim();if(e.skipLike!==void 0&&e.skipLike.test(t))return a;if(a==="0")return 0;if(e.hex&&Ih.test(t))return Rh(t,16);if(t.search(/[eE]/)!==-1){const s=t.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(s){if(e.leadingZeros)t=(s[1]||"")+s[3];else if(!(s[2]==="0"&&s[3][0]==="."))return a;return e.eNotation?Number(t):a}else return a}else{const s=Lh.exec(t);if(s){const i=s[1],n=s[2];let r=Bh(s[3]);if(!e.leadingZeros&&n.length>0&&i&&t[2]!=="."||!e.leadingZeros&&n.length>0&&!i&&t[1]!==".")return a;if(e.leadingZeros&&n===a)return 0;{const o=Number(t),l=""+o;return l.search(/[eE]/)!==-1?e.eNotation?o:a:t.indexOf(".")!==-1?l==="0"&&r===""||l===r||i&&l==="-"+r?o:a:n?r===l||i+r===l?o:a:t===l||t===i+l?o:a}}else return a}}function Bh(a){return a&&a.indexOf(".")!==-1&&(a=a.replace(/0+$/,""),a==="."?a="0":a[0]==="."?a="0"+a:a[a.length-1]==="."&&(a=a.substr(0,a.length-1))),a}function Rh(a,e){if(parseInt)return parseInt(a,e);if(Number.parseInt)return Number.parseInt(a,e);if(window&&window.parseInt)return window.parseInt(a,e);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}var Fh=Uh;const ga=bn,Ys=Eh,Vh=kh,jh=Fh;let Hh=class{constructor(a){this.options=a,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCharCode(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCharCode(Number.parseInt(t,16))}},this.addExternalEntities=Wh,this.parseXml=qh,this.parseTextData=Gh,this.resolveNameSpace=Yh,this.buildAttributesMap=Xh,this.isItStopNode=$h,this.replaceEntitiesValue=Kh,this.readStopNodeData=tc,this.saveTextToParentTag=Jh,this.addChild=Qh}};function Wh(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const s=e[t];this.lastEntities[s]={regex:new RegExp("&"+s+";","g"),val:a[s]}}}function Gh(a,e,t,s,i,n,r){if(a!==void 0&&(this.options.trimValues&&!s&&(a=a.trim()),a.length>0)){r||(a=this.replaceEntitiesValue(a));const o=this.options.tagValueProcessor(e,a,t,i,n);return o==null?a:typeof o!=typeof a||o!==a?o:this.options.trimValues?ar(a,this.options.parseTagValue,this.options.numberParseOptions):a.trim()===a?ar(a,this.options.parseTagValue,this.options.numberParseOptions):a}}function Yh(a){if(this.options.removeNSPrefix){const e=a.split(":"),t=a.charAt(0)==="/"?"/":"";if(e[0]==="xmlns")return"";e.length===2&&(a=t+e[1])}return a}const Zh=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function Xh(a,e,t){if(!this.options.ignoreAttributes&&typeof a=="string"){const s=ga.getAllMatches(a,Zh),i=s.length,n={};for(let r=0;r<i;r++){const o=this.resolveNameSpace(s[r][1]);let l=s[r][4],h=this.options.attributeNamePrefix+o;if(o.length)if(this.options.transformAttributeName&&(h=this.options.transformAttributeName(h)),h==="__proto__"&&(h="#__proto__"),l!==void 0){this.options.trimValues&&(l=l.trim()),l=this.replaceEntitiesValue(l);const c=this.options.attributeValueProcessor(o,l,e);c==null?n[h]=l:typeof c!=typeof l||c!==l?n[h]=c:n[h]=ar(l,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[h]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const r={};return r[this.options.attributesGroupName]=n,r}return n}}const qh=function(a){a=a.replace(/\r\n?/g,`
`);const e=new Ys("!xml");let t=e,s="",i="";for(let n=0;n<a.length;n++)if(a[n]==="<")if(a[n+1]==="/"){const r=us(a,">",n,"Closing Tag is not closed.");let o=a.substring(n+2,r).trim();if(this.options.removeNSPrefix){const c=o.indexOf(":");c!==-1&&(o=o.substr(c+1))}this.options.transformTagName&&(o=this.options.transformTagName(o)),t&&(s=this.saveTextToParentTag(s,t,i));const l=i.substring(i.lastIndexOf(".")+1);if(o&&this.options.unpairedTags.indexOf(o)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${o}>`);let h=0;l&&this.options.unpairedTags.indexOf(l)!==-1?(h=i.lastIndexOf(".",i.lastIndexOf(".")-1),this.tagsNodeStack.pop()):h=i.lastIndexOf("."),i=i.substring(0,h),t=this.tagsNodeStack.pop(),s="",n=r}else if(a[n+1]==="?"){let r=or(a,n,!1,"?>");if(!r)throw new Error("Pi Tag is not closed.");if(s=this.saveTextToParentTag(s,t,i),!(this.options.ignoreDeclaration&&r.tagName==="?xml"||this.options.ignorePiTags)){const o=new Ys(r.tagName);o.add(this.options.textNodeName,""),r.tagName!==r.tagExp&&r.attrExpPresent&&(o[":@"]=this.buildAttributesMap(r.tagExp,i,r.tagName)),this.addChild(t,o,i)}n=r.closeIndex+1}else if(a.substr(n+1,3)==="!--"){const r=us(a,"-->",n+4,"Comment is not closed.");if(this.options.commentPropName){const o=a.substring(n+4,r-2);s=this.saveTextToParentTag(s,t,i),t.add(this.options.commentPropName,[{[this.options.textNodeName]:o}])}n=r}else if(a.substr(n+1,2)==="!D"){const r=Vh(a,n);this.docTypeEntities=r.entities,n=r.i}else if(a.substr(n+1,2)==="!["){const r=us(a,"]]>",n,"CDATA is not closed.")-2,o=a.substring(n+9,r);s=this.saveTextToParentTag(s,t,i);let l=this.parseTextData(o,t.tagname,i,!0,!1,!0,!0);l==null&&(l=""),this.options.cdataPropName?t.add(this.options.cdataPropName,[{[this.options.textNodeName]:o}]):t.add(this.options.textNodeName,l),n=r+2}else{let r=or(a,n,this.options.removeNSPrefix),o=r.tagName;const l=r.rawTagName;let h=r.tagExp,c=r.attrExpPresent,d=r.closeIndex;this.options.transformTagName&&(o=this.options.transformTagName(o)),t&&s&&t.tagname!=="!xml"&&(s=this.saveTextToParentTag(s,t,i,!1));const p=t;if(p&&this.options.unpairedTags.indexOf(p.tagname)!==-1&&(t=this.tagsNodeStack.pop(),i=i.substring(0,i.lastIndexOf("."))),o!==e.tagname&&(i+=i?"."+o:o),this.isItStopNode(this.options.stopNodes,i,o)){let u="";if(h.length>0&&h.lastIndexOf("/")===h.length-1)o[o.length-1]==="/"?(o=o.substr(0,o.length-1),i=i.substr(0,i.length-1),h=o):h=h.substr(0,h.length-1),n=r.closeIndex;else if(this.options.unpairedTags.indexOf(o)!==-1)n=r.closeIndex;else{const m=this.readStopNodeData(a,l,d+1);if(!m)throw new Error(`Unexpected end of ${l}`);n=m.i,u=m.tagContent}const g=new Ys(o);o!==h&&c&&(g[":@"]=this.buildAttributesMap(h,i,o)),u&&(u=this.parseTextData(u,o,i,!0,c,!0,!0)),i=i.substr(0,i.lastIndexOf(".")),g.add(this.options.textNodeName,u),this.addChild(t,g,i)}else{if(h.length>0&&h.lastIndexOf("/")===h.length-1){o[o.length-1]==="/"?(o=o.substr(0,o.length-1),i=i.substr(0,i.length-1),h=o):h=h.substr(0,h.length-1),this.options.transformTagName&&(o=this.options.transformTagName(o));const u=new Ys(o);o!==h&&c&&(u[":@"]=this.buildAttributesMap(h,i,o)),this.addChild(t,u,i),i=i.substr(0,i.lastIndexOf("."))}else{const u=new Ys(o);this.tagsNodeStack.push(t),o!==h&&c&&(u[":@"]=this.buildAttributesMap(h,i,o)),this.addChild(t,u,i),t=u}s="",n=d}}else s+=a[n];return e.child};function Qh(a,e,t){const s=this.options.updateTag(e.tagname,t,e[":@"]);s===!1||(typeof s=="string"&&(e.tagname=s),a.addChild(e))}const Kh=function(a){if(this.options.processEntities){for(let e in this.docTypeEntities){const t=this.docTypeEntities[e];a=a.replace(t.regx,t.val)}for(let e in this.lastEntities){const t=this.lastEntities[e];a=a.replace(t.regex,t.val)}if(this.options.htmlEntities)for(let e in this.htmlEntities){const t=this.htmlEntities[e];a=a.replace(t.regex,t.val)}a=a.replace(this.ampEntity.regex,this.ampEntity.val)}return a};function Jh(a,e,t,s){return a&&(s===void 0&&(s=Object.keys(e.child).length===0),a=this.parseTextData(a,e.tagname,t,!1,e[":@"]?Object.keys(e[":@"]).length!==0:!1,s),a!==void 0&&a!==""&&e.add(this.options.textNodeName,a),a=""),a}function $h(a,e,t){const s="*."+t;for(const i in a){const n=a[i];if(s===n||e===n)return!0}return!1}function ec(a,e,t=">"){let s,i="";for(let n=e;n<a.length;n++){let r=a[n];if(s)r===s&&(s="");else if(r==='"'||r==="'")s=r;else if(r===t[0])if(t[1]){if(a[n+1]===t[1])return{data:i,index:n}}else return{data:i,index:n};else r==="	"&&(r=" ");i+=r}}function us(a,e,t,s){const i=a.indexOf(e,t);if(i===-1)throw new Error(s);return i+e.length-1}function or(a,e,t,s=">"){const i=ec(a,e+1,s);if(!i)return;let n=i.data;const r=i.index,o=n.search(/\s/);let l=n,h=!0;o!==-1&&(l=n.substring(0,o),n=n.substring(o+1).trimStart());const c=l;if(t){const d=l.indexOf(":");d!==-1&&(l=l.substr(d+1),h=l!==i.data.substr(d+1))}return{tagName:l,tagExp:n,closeIndex:r,attrExpPresent:h,rawTagName:c}}function tc(a,e,t){const s=t;let i=1;for(;t<a.length;t++)if(a[t]==="<")if(a[t+1]==="/"){const n=us(a,">",t,`${e} is not closed`);if(a.substring(t+2,n).trim()===e&&(i--,i===0))return{tagContent:a.substring(s,t),i:n};t=n}else if(a[t+1]==="?")t=us(a,"?>",t+1,"StopNode is not closed.");else if(a.substr(t+1,3)==="!--")t=us(a,"-->",t+3,"StopNode is not closed.");else if(a.substr(t+1,2)==="![")t=us(a,"]]>",t,"StopNode is not closed.")-2;else{const n=or(a,t,">");n&&((n&&n.tagName)===e&&n.tagExp[n.tagExp.length-1]!=="/"&&i++,t=n.closeIndex)}}function ar(a,e,t){if(e&&typeof a=="string"){const s=a.trim();return s==="true"?!0:s==="false"?!1:jh(a,t)}else return ga.isExist(a)?a:""}var sc=Hh,va={};function ic(a,e){return ya(a,e)}function ya(a,e,t){let s;const i={};for(let n=0;n<a.length;n++){const r=a[n],o=nc(r);let l="";if(t===void 0?l=o:l=t+"."+o,o===e.textNodeName)s===void 0?s=r[o]:s+=""+r[o];else{if(o===void 0)continue;if(r[o]){let h=ya(r[o],e,l);const c=oc(h,e);r[":@"]?rc(h,r[":@"],l,e):Object.keys(h).length===1&&h[e.textNodeName]!==void 0&&!e.alwaysCreateTextNode?h=h[e.textNodeName]:Object.keys(h).length===0&&(e.alwaysCreateTextNode?h[e.textNodeName]="":h=""),i[o]!==void 0&&i.hasOwnProperty(o)?(Array.isArray(i[o])||(i[o]=[i[o]]),i[o].push(h)):e.isArray(o,l,c)?i[o]=[h]:i[o]=h}}}return typeof s=="string"?s.length>0&&(i[e.textNodeName]=s):s!==void 0&&(i[e.textNodeName]=s),i}function nc(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const s=e[t];if(s!==":@")return s}}function rc(a,e,t,s){if(e){const i=Object.keys(e),n=i.length;for(let r=0;r<n;r++){const o=i[r];s.isArray(o,t+"."+o,!0,!0)?a[o]=[e[o]]:a[o]=e[o]}}}function oc(a,e){const{textNodeName:t}=e,s=Object.keys(a).length;return!!(s===0||s===1&&(a[t]||typeof a[t]=="boolean"||a[t]===0))}va.prettify=ic;const{buildOptions:ac}=Lr,lc=sc,{prettify:hc}=va,cc=fa;let dc=class{constructor(a){this.externalEntities={},this.options=ac(a)}parse(a,e){if(typeof a!="string")if(a.toString)a=a.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(e){e===!0&&(e={});const i=cc.validate(a,e);if(i!==!0)throw Error(`${i.err.msg}:${i.err.line}:${i.err.col}`)}const t=new lc(this.options);t.addExternalEntities(this.externalEntities);const s=t.parseXml(a);return this.options.preserveOrder||s===void 0?s:hc(s,this.options)}addEntity(a,e){if(e.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(a.indexOf("&")!==-1||a.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(e==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[a]=e}};var uc=dc;const pc=`
`;function fc(a,e){let t="";return e.format&&e.indentBy.length>0&&(t=pc),_a(a,e,"",t)}function _a(a,e,t,s){let i="",n=!1;for(let r=0;r<a.length;r++){const o=a[r],l=mc(o);if(l===void 0)continue;let h="";if(t.length===0?h=l:h=`${t}.${l}`,l===e.textNodeName){let g=o[l];gc(h,e)||(g=e.tagValueProcessor(l,g),g=wa(g,e)),n&&(i+=s),i+=g,n=!1;continue}else if(l===e.cdataPropName){n&&(i+=s),i+=`<![CDATA[${o[l][0][e.textNodeName]}]]>`,n=!1;continue}else if(l===e.commentPropName){i+=s+`<!--${o[l][0][e.textNodeName]}-->`,n=!0;continue}else if(l[0]==="?"){const g=io(o[":@"],e),m=l==="?xml"?"":s;let v=o[l][0][e.textNodeName];v=v.length!==0?" "+v:"",i+=m+`<${l}${v}${g}?>`,n=!0;continue}let c=s;c!==""&&(c+=e.indentBy);const d=io(o[":@"],e),p=s+`<${l}${d}`,u=_a(o[l],e,h,c);e.unpairedTags.indexOf(l)!==-1?e.suppressUnpairedNode?i+=p+">":i+=p+"/>":(!u||u.length===0)&&e.suppressEmptyNode?i+=p+"/>":u&&u.endsWith(">")?i+=p+`>${u}${s}</${l}>`:(i+=p+">",u&&s!==""&&(u.includes("/>")||u.includes("</"))?i+=s+e.indentBy+u+s:i+=u,i+=`</${l}>`),n=!0}return i}function mc(a){const e=Object.keys(a);for(let t=0;t<e.length;t++){const s=e[t];if(a.hasOwnProperty(s)&&s!==":@")return s}}function io(a,e){let t="";if(a&&!e.ignoreAttributes)for(let s in a){if(!a.hasOwnProperty(s))continue;let i=e.attributeValueProcessor(s,a[s]);i=wa(i,e),i===!0&&e.suppressBooleanAttributes?t+=` ${s.substr(e.attributeNamePrefix.length)}`:t+=` ${s.substr(e.attributeNamePrefix.length)}="${i}"`}return t}function gc(a,e){a=a.substr(0,a.length-e.textNodeName.length-1);let t=a.substr(a.lastIndexOf(".")+1);for(let s in e.stopNodes)if(e.stopNodes[s]===a||e.stopNodes[s]==="*."+t)return!0;return!1}function wa(a,e){if(a&&a.length>0&&e.processEntities)for(let t=0;t<e.entities.length;t++){const s=e.entities[t];a=a.replace(s.regex,s.val)}return a}var vc=fc;const yc=vc,_c={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(a,e){return e},attributeValueProcessor:function(a,e){return e},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function is(a){this.options=Object.assign({},_c,a),this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=xc),this.processTextOrObjNode=wc,this.options.format?(this.indentate=bc,this.tagEndChar=`>
`,this.newLine=`
`):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}is.prototype.build=function(a){return this.options.preserveOrder?yc(a,this.options):(Array.isArray(a)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(a={[this.options.arrayNodeName]:a}),this.j2x(a,0).val)};is.prototype.j2x=function(a,e){let t="",s="";for(let i in a)if(Object.prototype.hasOwnProperty.call(a,i))if(typeof a[i]>"u")this.isAttribute(i)&&(s+="");else if(a[i]===null)this.isAttribute(i)?s+="":i[0]==="?"?s+=this.indentate(e)+"<"+i+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+i+"/"+this.tagEndChar;else if(a[i]instanceof Date)s+=this.buildTextValNode(a[i],i,"",e);else if(typeof a[i]!="object"){const n=this.isAttribute(i);if(n)t+=this.buildAttrPairStr(n,""+a[i]);else if(i===this.options.textNodeName){let r=this.options.tagValueProcessor(i,""+a[i]);s+=this.replaceEntitiesValue(r)}else s+=this.buildTextValNode(a[i],i,"",e)}else if(Array.isArray(a[i])){const n=a[i].length;let r="",o="";for(let l=0;l<n;l++){const h=a[i][l];if(!(typeof h>"u"))if(h===null)i[0]==="?"?s+=this.indentate(e)+"<"+i+"?"+this.tagEndChar:s+=this.indentate(e)+"<"+i+"/"+this.tagEndChar;else if(typeof h=="object")if(this.options.oneListGroup){const c=this.j2x(h,e+1);r+=c.val,this.options.attributesGroupName&&h.hasOwnProperty(this.options.attributesGroupName)&&(o+=c.attrStr)}else r+=this.processTextOrObjNode(h,i,e);else if(this.options.oneListGroup){let c=this.options.tagValueProcessor(i,h);c=this.replaceEntitiesValue(c),r+=c}else r+=this.buildTextValNode(h,i,"",e)}this.options.oneListGroup&&(r=this.buildObjectNode(r,i,o,e)),s+=r}else if(this.options.attributesGroupName&&i===this.options.attributesGroupName){const n=Object.keys(a[i]),r=n.length;for(let o=0;o<r;o++)t+=this.buildAttrPairStr(n[o],""+a[i][n[o]])}else s+=this.processTextOrObjNode(a[i],i,e);return{attrStr:t,val:s}};is.prototype.buildAttrPairStr=function(a,e){return e=this.options.attributeValueProcessor(a,""+e),e=this.replaceEntitiesValue(e),this.options.suppressBooleanAttributes&&e==="true"?" "+a:" "+a+'="'+e+'"'};function wc(a,e,t){const s=this.j2x(a,t+1);return a[this.options.textNodeName]!==void 0&&Object.keys(a).length===1?this.buildTextValNode(a[this.options.textNodeName],e,s.attrStr,t):this.buildObjectNode(s.val,e,s.attrStr,t)}is.prototype.buildObjectNode=function(a,e,t,s){if(a==="")return e[0]==="?"?this.indentate(s)+"<"+e+t+"?"+this.tagEndChar:this.indentate(s)+"<"+e+t+this.closeTag(e)+this.tagEndChar;{let i="</"+e+this.tagEndChar,n="";return e[0]==="?"&&(n="?",i=""),(t||t==="")&&a.indexOf("<")===-1?this.indentate(s)+"<"+e+t+n+">"+a+i:this.options.commentPropName!==!1&&e===this.options.commentPropName&&n.length===0?this.indentate(s)+`<!--${a}-->`+this.newLine:this.indentate(s)+"<"+e+t+n+this.tagEndChar+a+this.indentate(s)+i}};is.prototype.closeTag=function(a){let e="";return this.options.unpairedTags.indexOf(a)!==-1?this.options.suppressUnpairedNode||(e="/"):this.options.suppressEmptyNode?e="/":e=`></${a}`,e};is.prototype.buildTextValNode=function(a,e,t,s){if(this.options.cdataPropName!==!1&&e===this.options.cdataPropName)return this.indentate(s)+`<![CDATA[${a}]]>`+this.newLine;if(this.options.commentPropName!==!1&&e===this.options.commentPropName)return this.indentate(s)+`<!--${a}-->`+this.newLine;if(e[0]==="?")return this.indentate(s)+"<"+e+t+"?"+this.tagEndChar;{let i=this.options.tagValueProcessor(e,a);return i=this.replaceEntitiesValue(i),i===""?this.indentate(s)+"<"+e+t+this.closeTag(e)+this.tagEndChar:this.indentate(s)+"<"+e+t+">"+i+"</"+e+this.tagEndChar}};is.prototype.replaceEntitiesValue=function(a){if(a&&a.length>0&&this.options.processEntities)for(let e=0;e<this.options.entities.length;e++){const t=this.options.entities[e];a=a.replace(t.regex,t.val)}return a};function bc(a){return this.options.indentBy.repeat(a)}function xc(a){return a.startsWith(this.options.attributeNamePrefix)&&a!==this.options.textNodeName?a.substr(this.attrPrefixLen):!1}var Ec=is;const Sc=uc,Cc=Ec;var xn={XMLParser:Sc,XMLBuilder:Cc};class En{}E(En,"parser",new xn.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));E(En,"builder",new xn.XMLBuilder({attributeNamePrefix:"$",ignoreAttributes:!1,suppressBooleanAttributes:!1}));class ve{static join(e){const t={};for(const s of e)for(const i in s)if(!t[i])t[i]=new Set(s[i]);else for(const n of s[i])t[i].add(n);return t}static intersect(e){if(e.length===0)return{};let t=ve.clone(e[0]);for(let s=1;s<e.length;s++){const i=e[s],n={};for(const r in t)if(i[r]){const o=new Set;for(const l of t[r])i[r].has(l)&&o.add(l);o.size>0&&(n[r]=o)}t=n}return t}static clone(e){const t={};for(const s in e)t[s]=new Set(e[s]);return t}static remove(e,t,s=!1){s&&(e=ve.clone(e));for(const i in t)if(e[i]){for(const n of t[i])e[i].delete(n);e[i].size===0&&delete e[i]}}static add(e,t,s=!1){s&&(e=ve.clone(e));for(const i in t)if(!e[i])e[i]=new Set(t[i]);else for(const n of t[i])e[i].add(n)}static append(e,t,...s){let i=e[t];i||(i=new Set,e[t]=i);for(const n of s)i.add(n)}static isEqual(e,t){const s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(const n of s){if(!t[n]||e[n].size!==t[n].size)return!1;for(const r of e[n])if(!t[n].has(r))return!1}return!0}static isEmpty(e){return Object.values(e).reduce((t,s)=>t+s.size,0)===0}static toRaw(e){const t={};for(const s in e)t[s]=Array.from(e[s]);return t}static fromRaw(e){const t={};for(const s in e)t[s]=new Set(e[s]);return t}}class Mn{static isEntry(e){return new Set(["Boolean","Color","Text","Number","Select","Vector3","TextSet","None"]).has(e.type)}static copySchema(e,t={}){for(const s in e){const i=e[s];this.isEntry(i)?t[s]=this.copyEntry(i):(t[s]={},this.copySchema(i,t[s]))}return t}static copyEntry(e){if(e.type==="Boolean"){const t=e;return{type:t.type,value:t.value}}if(e.type==="Color"){const t=e;return{type:t.type,value:t.value.clone()}}if(e.type==="Text"){const t=e;return{type:t.type,value:t.value}}if(e.type==="Number"){const t=e;return{type:t.type,value:t.value,min:t.min,max:t.max,interpolable:t.interpolable}}if(e.type==="Select"){const t=e;return{type:t.type,value:t.value,multiple:t.multiple,options:new Set(t.options)}}if(e.type==="Vector3"){const t=e;return{type:t.type,value:t.value.clone()}}if(e.type==="TextSet"){const t=e;return{type:t.type,value:new Set(t.value)}}if(e.type==="None"){const t=e;return{type:t.type,value:t.value}}throw new Error("Invalid entry!")}}class Tc{constructor(){E(this,"list",new Set)}add(e){for(const t of e)this.list.add(t)}remove(e){for(const t of e)this.list.delete(t)}set(e){for(const t of this.list)t.enabled=e}reset(){for(const e of this.list)e.reset()}}class Sn{constructor(e,t,s,i){E(this,"_component"),E(this,"name"),E(this,"uuid"),this._component=e,this.name=s,this.uuid=i??Ze.create(),t.get(Nr).list.set(this.uuid,this)}get controls(){return Mn.copySchema(this._config)}set(e){for(const t in e)if(t in this){const s=t;this[s]=e[t].value}}export(e=this._config,t={}){for(const s in e){const i=e[s];if(Mn.isEntry(i))if(i.type==="Color"){const{r:n,g:r,b:o}=i.value;t[s]={...i,value:{r:n,g:r,b:o}}}else if(i.type==="Vector3"){const{x:n,y:r,z:o}=i.value;t[s]={...i,value:{x:n,y:r,z:o}}}else if(i.type==="TextSet"){const n=Array.from(i.value);t[s]={...i,value:n}}else if(i.type==="Select"){const n=Array.from(i.options);t[s]={...i,options:n}}else t[s]={...i};else t[s]={},this.export(i,t[s])}return t}import(e,t={},s=!0){for(const i in e){const n=e[i];if(Mn.isEntry(n))if(n.type==="Color"){const{r,g:o,b:l}=n.value;t[i]={...n,value:new fe(r,o,l)}}else if(n.type==="Vector3"){const{x:r,y:o,z:l}=n.value;t[i]={...n,value:new L(r,o,l)}}else n.type==="TextSet"?t[i]={...n,value:new Set(n.value)}:n.type==="Select"?t[i]={...n,options:new Set(n.options)}:t[i]={...n};else t[i]={},this.import(n,t[i],!1)}s&&this.set(t)}}const ba=class xa extends xe{constructor(e){super(e),E(this,"list",new be),E(this,"enabled",!0),e.add(xa.uuid,this)}};E(ba,"uuid","b8c764e0-6b24-4e77-9a32-35fa728ee5b4");let Nr=ba;class Ea{constructor(e){E(this,"_event"),E(this,"_position",new Ce),E(this,"onDisposed",new K),E(this,"updateMouseInfo",t=>{this._event=t}),this.dom=e,this.setupEvents(!0)}get position(){return this.updatePosition(!1),this._position.clone()}get rawPosition(){return this.updatePosition(!0),this._position.clone()}dispose(){this.setupEvents(!1),this.onDisposed.trigger(),this.onDisposed.reset()}updatePosition(e){if(this._event){const t=this.dom.getBoundingClientRect();this._position.x=this.getPositionX(t,this._event,e),this._position.y=this.getPositionY(t,this._event,e)}}getPositionY(e,t,s){const i=this.getDataObject(t);return s?i.clientY:-((i.clientY-e.top)/(e.bottom-e.top))*2+1}getPositionX(e,t,s){const i=this.getDataObject(t);return s?i.clientX:(i.clientX-e.left)/(e.right-e.left)*2-1}getDataObject(e){return e instanceof MouseEvent?e:e.touches[0]}setupEvents(e){e?(this.dom.addEventListener("pointermove",this.updateMouseInfo),this.dom.addEventListener("touchstart",this.updateMouseInfo)):(this.dom.removeEventListener("pointermove",this.updateMouseInfo),this.dom.removeEventListener("touchstart",this.updateMouseInfo))}}const Sa=class Ca extends xe{constructor(e){super(e),E(this,"onDisposed",new K),E(this,"onBeforeDispose",new K),E(this,"onFragmentsLoaded",new K),E(this,"baseCoordinationModel",""),E(this,"baseCoordinationMatrix",new Pe),E(this,"enabled",!0),E(this,"_core"),this.components.add(Ca.uuid,this)}get initialized(){return!!this._core}get list(){return this.core.models.list}get core(){if(!this._core)throw new Error("FragmentsManager not initialized. Call init() first.");return this._core}get _hasCoordinationModel(){return this.baseCoordinationModel!==""}dispose(){this.onBeforeDispose.trigger(),this._core&&(this.core.dispose(),this._core=void 0),this.baseCoordinationModel="",this.onFragmentsLoaded.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}init(e){this._core=new El(e),this.core.onModelLoaded.add(async()=>{if(this._hasCoordinationModel)return;const t=[...this.list.values()][0];t&&(this.baseCoordinationModel=t.modelId,this.baseCoordinationMatrix=await t.getCoordinationMatrix())}),this.list.onItemDeleted.add(()=>{this.list.size>0||(this.baseCoordinationModel="",this.baseCoordinationMatrix=new Pe)})}async raycast(e){const t=[];for(const n of this.core.models.list.values())if(e.snappingClasses&&e.snappingClasses.length>0){const r=await n.raycastWithSnapping(e);if(r&&r.length>0)t.push(r[0]);else{const o=await n.raycast(e);o&&t.push(o)}}else{const r=await n.raycast(e);r&&t.push(r)}if(await Promise.all(t),t.length===0)return;let s=t[0],i=s.distance;for(let n=1;n<t.length;n++)t[n].distance<i&&(i=t[n].distance,s=t[n]);return s}async getPositions(e){const t=[],s=async(n,r)=>{const o=await n.getPositions(r);for(const l of o)t.push(l)},i=[];for(const n in e){const r=this.core.models.list.get(n);r&&i.push(s(r,Array.from(e[n])))}return await Promise.all(i),t}async getBBoxes(e){const t=[],s=async(n,r)=>{const o=await n.getBoxes(r);if(o)for(const l of o)t.push(l)},i=[];for(const n in e){const r=this.core.models.list.get(n);r&&i.push(s(r,Array.from(e[n])))}return await Promise.all(i),t}async highlight(e,t){await this.forEachModel(t,"highlight",e)}async getData(e,t){const s={};for(const[i,n]of Object.entries(e)){const r=this.list.get(i);if(!r)continue;if(n.size===0){s[i]=[];continue}const o=await r.getItemsData([...n],t);s[i]=o}return s}async resetHighlight(e){await this.forEachModel(e,"resetHighlight")}async forEachModel(e,t,...s){const i={};if(e)for(const r in e){const o=e[r];i[r]=Array.from(o)}else for(const r of this.core.models.list.keys())i[r]=void 0;const n=[];for(const r in i){const o=this.core.models.list.get(r);if(o){const l=i[r],h=o[t](l,...s);n.push(h)}}await Promise.all(n)}async guidsToModelIdMap(e){const t={};for(const[s,i]of this.list){const n=(await i.getLocalIdsByGuids([...e])).filter(r=>r!==null);t[s]=new Set(n)}return t}async modelIdMapToGuids(e){const t=[];for(const[s,i]of Object.entries(e)){const n=this.list.get(s);if(!n)continue;const r=(await n.getGuidsByLocalIds([...i])).filter(o=>o!==null);t.push(...r)}return t}applyBaseCoordinateSystem(e,t){const s=new Pe;return t&&s.copy(t.clone()).invert(),s.multiply(this.baseCoordinationMatrix),e.applyMatrix4(s),s}};E(Sa,"uuid","fef46874-46a3-461b-8c44-2922ab77c806");let le=Sa;class Pc{constructor(){E(this,"wasm",{path:"",absolute:!1,logLevel:Ml.LOG_LEVEL_OFF}),E(this,"webIfc",{COORDINATE_TO_ORIGIN:!0}),E(this,"autoSetWasm",!0),E(this,"customLocateFileHandler",null)}}const Ac=class lr extends xe{constructor(e){super(e),E(this,"onDisposed",new K),E(this,"onIfcStartedLoading",new K),E(this,"onIfcImporterInitialized",new K),E(this,"onSetup",new K),E(this,"settings",new Pc),E(this,"webIfc",new Yr),E(this,"enabled",!0),this.components.add(lr.uuid,this)}dispose(){this.webIfc=null,this.onDisposed.trigger(lr.uuid),this.onDisposed.reset()}async setup(e){this.settings={...this.settings,...e},this.settings.autoSetWasm&&await this.autoSetWasm(),this.onSetup.trigger()}async load(e,t,s,i){const n=this.components.get(le);if(!n.initialized)throw new Error("You need to initialize fragments first.");this.settings.autoSetWasm&&await this.autoSetWasm(),n.core.settings.autoCoordinate=t;const r=new Sl;r.wasm.path=this.settings.wasm.path,r.wasm.absolute=this.settings.wasm.absolute,r.webIfcSettings=this.settings.webIfc,this.onIfcImporterInitialized.trigger(r),i!=null&&i.instanceCallback&&i.instanceCallback(r);const o=await r.process({...i==null?void 0:i.processData,bytes:e});return await n.core.load(o,{modelId:s,userData:i==null?void 0:i.userData})}async readIfcFile(e){const{path:t,absolute:s,logLevel:i}=this.settings.wasm;return this.webIfc.SetWasmPath(t,s),await this.webIfc.Init(this.settings.customLocateFileHandler||void 0),i&&this.webIfc.SetLogLevel(i),this.webIfc.OpenModel(e,this.settings.webIfc)}cleanUp(){try{this.webIfc.Dispose()}catch{console.log("Web-ifc wasn't disposed.")}this.webIfc=null,this.webIfc=new Yr}async autoSetWasm(){const e=await fetch(`https://unpkg.com/@thatopen/components@${Xa.release}/package.json`);if(!e.ok){console.warn("Couldn't get openbim-components package.json. Set wasm settings manually.");return}const t=await e.json();if(!("web-ifc"in t.peerDependencies))console.warn("Couldn't get web-ifc from peer dependencies in openbim-components. Set wasm settings manually.");else{const s=t.peerDependencies["web-ifc"];this.settings.wasm.path=`https://unpkg.com/web-ifc@${s}/`,this.settings.wasm.absolute=!0}}};E(Ac,"uuid","a659add7-1418-4771-a0d6-7d4d438e4624");const Ta=class Pa extends xe{constructor(e){super(e),E(this,"enabled",!0),this.components.add(Pa.uuid,this)}async set(e,t){const s=this.components.get(le),i=[];if(t)for(const[n,r]of Object.entries(t)){const o=s.list.get(n);o&&i.push(o.setVisible([...r],e))}else for(const n of s.list.values())i.push(n.setVisible(void 0,e));await Promise.all(i),await s.core.update(!0)}async isolate(e){await Promise.all([this.set(!1),this.set(!0,e)])}async toggle(e){const t=[],s=this.components.get(le);for(const[i,n]of Object.entries(e)){const r=s.list.get(i);r&&t.push(r.toggleVisible([...n]))}await Promise.all(t),await s.core.update(!0)}async getVisibilityMap(e,t){const s=[],i=[],n=this.components.get(le);if(t)for(const l of t){const h=n.list.get(l);h&&(s.push(h.modelId),i.push(h.getItemsByVisibility(e)))}else for(const l of n.list.values())s.push(l.modelId),i.push(l.getItemsByVisibility(e));const r=await Promise.all(i),o={};for(const[l,h]of s.entries())o[h]=r[l];return o}};E(Ta,"uuid","dd9ccf2d-8a21-4821-b7f6-2949add16a29");let Mc=Ta;const Aa=class hr extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"onDisposed",new K),E(this,"list",new Le),this.components.add(hr.uuid,this)}dispose(e=!0){this.list.clear(),this.onDisposed.trigger(hr.uuid),e&&(this.onDisposed.reset(),this.list.eventsEnabled=!1,this.list.dispose())}get(){const e=new Ue;for(const t of this.list)e.union(t);return e}async addFromModelIdMap(e){const t=this.components.get(le),s=new Ue;for(const[i,n]of Object.entries(e)){const r=t.list.get(i);if(!r)continue;const o=await r.getMergedBox([...n]);s.union(o)}this.list.add(s)}addFromModels(e){const t=this.components.get(le);for(const[s,i]of t.list)e&&!e.some(n=>n.test(s))||this.list.add(i.box)}async getCenter(e){this.list.clear(),await this.addFromModelIdMap(e);const t=this.get();this.list.clear();const s=new L;return t.getCenter(s),s}async getCameraOrientation(e,t=1){const s=this.components.get(le);this.list.clear();for(const[h,c]of s.list)this.list.add(c.box);const i=this.get();this.list.clear();const n=new L;i.getCenter(n);const r=new L;i.getSize(r);const o=Math.max(r.x,r.y,r.z)*t,l=new L;switch(e){case"front":l.set(n.x,n.y,n.z+o);break;case"back":l.set(n.x,n.y,n.z-o);break;case"left":l.set(n.x-o,n.y,n.z);break;case"right":l.set(n.x+o,n.y,n.z);break;case"top":l.set(n.x,n.y+o,n.z);break;case"bottom":l.set(n.x,n.y-o,n.z);break;default:l.set(n.x,n.y,n.z+o)}return{position:l,target:n}}};E(Aa,"uuid","d1444724-dba6-4cdd-a0c7-68ee1450d166");let mn=Aa;class Oc{constructor(e,t){E(this,"name","Query"),E(this,"customData",{}),E(this,"_components"),E(this,"_queries",[]),E(this,"_aggregation","exclusive"),E(this,"result",null),E(this,"cache",!0),E(this,"serializeQueryParameters",s=>{var i;return{categories:(i=s.categories)==null?void 0:i.map(n=>n.source),attributes:s.attributes?{aggregation:s.attributes.aggregation,queries:s.attributes.queries.map(this.serializeAttributeQuery)}:void 0,relation:s.relation?{name:s.relation.name,query:s.relation.query?this.serializeQueryParameters(s.relation.query):void 0}:void 0}}),E(this,"deserializeQueryParameters",s=>{var i;return{categories:(i=s.categories)==null?void 0:i.map(n=>new RegExp(n)),attributes:s.attributes?{aggregation:s.attributes.aggregation,queries:s.attributes.queries.map(this.deserializeAttributeQuery)}:void 0,relation:s.relation?{name:s.relation.name,query:s.relation.query?this.deserializeQueryParameters(s.relation.query):void 0}:void 0}}),this._components=e,this.queries=t}set queries(e){this._queries=e,this.clearCache()}get queries(){return this._queries}set aggregation(e){e!==this._aggregation&&this.clearCache(),this._aggregation=e}get aggregation(){return this._aggregation}async test(e){const{modelIds:t,force:s}={force:!1,...e};if(this.result&&!s)return this.result;const i=await this._components.get(di).getItems(this.queries,{modelIds:t,aggregation:this.aggregation});return this.cache&&(this.result=i),i}clearCache(){this.result=null}serializeAttributeQuery(e){let t;return Array.isArray(e.value)?t=e.value.map(s=>s.source):e.value instanceof RegExp?t=e.value.source:t=e.value,{name:e.name.source,value:t,type:e.type instanceof RegExp?e.type.source:e.type,negate:e.negate,itemIds:e.itemIds}}toJSON(){return{guid:this._components.get(di).list.getKey(this)??Ze.create(),name:this.name,customData:this.customData,queries:this.queries.map(this.serializeQueryParameters),aggregation:this.aggregation,cache:this.cache}}deserializeAttributeQuery(e){let t;return Array.isArray(e.value)?t=e.value.map(s=>new RegExp(s)):typeof e.value=="string"?t=new RegExp(e.value):t=e.value,{name:new RegExp(e.name),value:t,type:e.type?new RegExp(e.type):void 0,negate:e.negate,itemIds:e.itemIds}}fromJSON(e){return this.name=e.name,this.customData=e.customData,this.aggregation=e.aggregation,this.cache=e.cache,this.queries=e.queries.map(this.deserializeQueryParameters),this}}const Ma=class Oa extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"list",new be),e.add(Oa.uuid,this)}async getItems(e,t){let s;if(t){const{modelIds:o,items:l}=t;if(l){const h=Object.keys(l);h.length>0&&(s=h.map(c=>new RegExp(`^${c}$`)))}else o&&(s=o)}const i=(t==null?void 0:t.aggregation)??"exclusive",n=this.components.get(le),r=await Promise.all(e.map(async o=>{const l={};return await Promise.all(Array.from(n.list).map(async([h,c])=>{var d;if(s&&!s.some(g=>g.test(h)))return;const p=(d=t==null?void 0:t.items)==null?void 0:d[h],u=await c.getItemsByQuery(o,{localIds:p?[...p]:void 0});l[h]=new Set(u)})),l}));return i==="inclusive"?ve.join(r):ve.intersect(r)}create(e,t){const s=new Oc(this.components,t);return this.list.set(e,s),s}async addFromCategories(e){const t=new Set,s=this.components.get(le);for(const[i,n]of s.list){if(e&&!e.some(l=>l.test(i)))continue;const r=(await n.getItemsWithGeometryCategories()).filter(l=>l!==null),o=new Set(r);for(const l of o)this.list.has(l)||(this.create(l,[{categories:[new RegExp(`^${l}$`)]}]),t.add(l))}return[...t]}import(e){const{data:t}=e,s=[];if(!t)return s;for(const i of t){const n=this.create(i.guid,[]);n.fromJSON(i),s.push(n)}return s}export(){const e=[];for(const[t,s]of this.list.entries()){const i={...s.toJSON(),name:t};e.push(i)}return{data:e}}};E(Ma,"uuid","0da7ad77-f734-42ca-942f-a074adfd1e3a");let di=Ma;const Da=class za extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"onDisposed",new K),E(this,"list",new be),E(this,"defaultSaveFunction",t=>"value"in t.Name?t.Name.value:null),E(this,"onBeforeFragmentsDispose",async t=>{const{key:s,value:i}=t,n=await i.getLocalIds(),r={[s]:new Set(n)};this.removeItems(r)}),e.add(za.uuid,this),this.setupEvents(),e.get(le).list.onBeforeDelete.add(this.onBeforeFragmentsDispose)}setupEvents(){this.list.onBeforeDelete.add(({value:e})=>e.dispose())}getClassificationGroups(e){let t=this.list.get(e);return t||(t=new be,this.list.set(e,t)),t}getModelItems(e,t,s){const{map:i}=this.getGroupData(e,t);let n=i[s];return n||(n=new Set,i[s]=n),n}getGroupData(e,t){const s=this.components.get(di),i=this.getClassificationGroups(e);let n=i.get(t);return n||(n={map:{},get(){return new Promise(r=>{if(!n){r({});return}if(n.query){const{name:o,config:l}=n.query,h=s.list.get(o);if(!h)throw new Error("Classifier: the query name associated with the group doesn't exist in the ItemsFinder component");h.test(l).then(c=>{if(!n){r({});return}const d=ve.join([c,n.map]);r(d)})}else r(n.map)})}},i.set(t,n)),n}async aggregateItems(e,t,s){const i=(s==null?void 0:s.data)??void 0,n=(s==null?void 0:s.aggregationCallback)??this.defaultSaveFunction,r=this.components.get(le),o=await this.components.get(di).getItems([t],{modelIds:s==null?void 0:s.modelIds});for(const[l,h]of Object.entries(o)){const c=r.list.get(l);if(!c)continue;const d=(u,...g)=>{const m=this.getModelItems(e,u,l);for(const v of g)m.add(v)},p=await c.getItemsData([...h],i);for(const u of p)n(u,d)}}addGroupItems(e,t,s){const{map:i}=this.getGroupData(e,t);ve.add(i,s)}setGroupQuery(e,t,s){const i=this.getGroupData(e,t);i.query=s}async find(e){const t=[];for(const[s,i]of Object.entries(e)){const n=[],r=this.list.get(s);if(!r)continue;for(const l of i){const h=r.get(l);if(!h)continue;const c=await h.get();n.push(c)}const o=ve.join(n);t.push(o)}return ve.intersect(t)}async aggregateItemRelations(e,t,s,i){const n=(i==null?void 0:i.attribute)??"Name",r={relations:{[s]:{attributes:!0,relations:!1}}};await this.aggregateItems(e,t,{modelIds:i==null?void 0:i.modelIds,data:r,aggregationCallback:(o,l)=>{if(!(o!=null&&o[n]))return;const h=o[n];if(!("value"in h))return;const c=o[s];if(Array.isArray(c))for(const d of c)"value"in d._localId&&l(h.value,d._localId.value)}})}async byIfcBuildingStorey(e){await this.aggregateItemRelations((e==null?void 0:e.classificationName)??"Storeys",{categories:[/BUILDINGSTOREY/]},"ContainsElements",{modelIds:e==null?void 0:e.modelIds})}async byCategory(e){const t=await this.components.get(di).addFromCategories(e==null?void 0:e.modelIds);for(const s of t)this.setGroupQuery((e==null?void 0:e.classificationName)??"Categories",s,{name:s})}dispose(){this.list.clear(),this.components.get(le).list.onBeforeDelete.remove(this.onBeforeFragmentsDispose),this.onDisposed.trigger()}removeItems(e,t){if(t&&t.classificationName){const s=this.list.get(t.classificationName);if(!s||t.groupName&&!s.get(t.groupName))return;for(const[,i]of s)ve.remove(i.map,e);return}for(const[,s]of this.list.entries())for(const[,i]of s)ve.remove(i.map,e)}async byModel(e){const t=this.components.get(le),s=(e==null?void 0:e.classificationName)??"Models";for(const[i,n]of t.list){if(e&&e.modelIds&&!e.modelIds.some(l=>l.test(i)))continue;const r=await n.getItemsIdsWithGeometry(),o={[i]:new Set(r)};this.getGroupData(s,i),this.addGroupItems(s,i,o)}}};E(Da,"uuid","e25a7f3c-46c4-4a14-9d3d-5115f24ebeb7");let Dc=Da;class zc{constructor(e,t){E(this,"enabled",!0),E(this,"components"),E(this,"onDisposed",new K),E(this,"mouse"),E(this,"world"),E(this,"debugMode",!1),E(this,"colorToModelId",new Map),E(this,"modelIdToColor",new Map),E(this,"renderTarget"),E(this,"renderTargetSize",new Ce),E(this,"debugCanvas"),E(this,"debugContainer"),E(this,"colorMaterials",new Map),E(this,"originalMaterials",new Map),E(this,"originalLodColors",new Map),E(this,"colorsNeedUpdate",!0);const s=t.renderer;if(!s)throw new Error("A renderer is needed for the FastModelPicker to work!");this.world=t,this.mouse=new Ea(s.three.domElement),this.components=e,this.setupRenderTarget(),this.setupFragmentListeners()}setupFragmentListeners(){const e=this.components.get(le);e.list.onItemSet.add(()=>{this.colorsNeedUpdate=!0}),e.list.onItemDeleted.add(()=>{this.colorsNeedUpdate=!0})}setupRenderTarget(){const e=this.world.renderer.three.getSize(new Ce);this.renderTargetSize.copy(e),this.renderTarget=new xt(e.x,e.y),this.renderTarget.texture.format=ms,this.renderTarget.texture.type=Mr,this.debugMode&&this.setupDebugCanvas(),this.world.renderer.onResize.add(t=>{this.renderTargetSize.copy(t),this.renderTarget.setSize(t.x,t.y),this.debugCanvas&&(this.debugCanvas.width=t.x,this.debugCanvas.height=t.y)})}setupDebugCanvas(){if(this.debugCanvas)return;const e=this.world.renderer.three.getSize(new Ce);this.debugContainer=document.createElement("div"),this.debugContainer.style.position="fixed",this.debugContainer.style.top="10px",this.debugContainer.style.right="10px",this.debugContainer.style.width="300px",this.debugContainer.style.height="300px",this.debugContainer.style.border="2px solid #fff",this.debugContainer.style.backgroundColor="#000",this.debugContainer.style.zIndex="10000",this.debugContainer.style.pointerEvents="none",this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=e.x,this.debugCanvas.height=e.y,this.debugCanvas.style.width="100%",this.debugCanvas.style.height="100%",this.debugCanvas.style.imageRendering="pixelated",this.debugContainer.appendChild(this.debugCanvas),document.body.appendChild(this.debugContainer)}generateColorForModel(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o),t&=t;let s=Math.abs(t)%16777215;s===0&&(s=1);const i=s>>16&255||1,n=s>>8&255||1,r=s&255||1;return new fe(i/255,n/255,r/255)}colorToId(e){const t=Math.round(e.r*255),s=Math.round(e.g*255),i=Math.round(e.b*255);return t<<16|s<<8|i}assignColors(){const e=this.components.get(le);if(e.initialized){if(!this.colorsNeedUpdate){const t=new Set(e.list.keys()),s=new Set(this.modelIdToColor.keys());(t.size!==s.size||[...t].some(i=>!s.has(i)))&&(this.colorsNeedUpdate=!0)}if(this.colorsNeedUpdate){this.colorToModelId.clear(),this.modelIdToColor.clear();for(const t of this.colorMaterials.values())t.dispose();this.colorMaterials.clear();for(const[t]of e.list){const s=this.generateColorForModel(t),i=this.colorToId(s);this.colorToModelId.set(i,t),this.modelIdToColor.set(t,s);const n=new vs({color:s,depthTest:!0,depthWrite:!0});this.colorMaterials.set(t,n)}this.colorsNeedUpdate=!1}}}applyColorMaterials(){const e=this.components.get(le);if(e.initialized)for(const[t,s]of e.list){const i=this.colorMaterials.get(t);i&&s.object.traverse(n=>{if(n instanceof ie){if("isLODGeometry"in n.geometry){const r=n.material[0].uniforms.lodColor;this.originalLodColors.has(r)||this.originalLodColors.set(r,r.value),r.value=i.color;return}this.originalMaterials.has(n)||this.originalMaterials.set(n,n.material),n.material=i}})}}restoreOriginalMaterials(){for(const[e,t]of this.originalMaterials)e.material=t;for(const[e,t]of this.originalLodColors)e.value=t;this.originalMaterials.clear()}renderColorCoded(){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const e=this.world.renderer.three,t=this.world.scene.three,s=this.world.camera.three,i=e.getRenderTarget(),n=e.autoClear,r=new fe,o=e.getClearAlpha();e.getClearColor(r),this.applyColorMaterials(),e.setRenderTarget(this.renderTarget),e.autoClear=!0,e.setClearColor(0,1),e.clear(!0,!0,!1),e.render(t,s),e.setRenderTarget(i),e.autoClear=n,e.setClearColor(r,o),this.restoreOriginalMaterials(),this.debugMode&&this.debugCanvas&&this.updateDebugCanvas()}updateDebugCanvas(){if(!this.debugCanvas||!this.renderTarget||!this.world.renderer)return;const e=this.world.renderer.three,t=this.renderTargetSize,s=new Uint8Array(t.x*t.y*4);e.readRenderTargetPixels(this.renderTarget,0,0,t.x,t.y,s);const i=this.debugCanvas.getContext("2d");if(!i)return;const n=i.createImageData(t.x,t.y),r=t.x*4;for(let o=0;o<t.y;o++){const l=o,h=t.y-1-o,c=l*r,d=h*r;n.data.set(s.subarray(c,c+r),d)}i.putImageData(n,0,0)}async getModelAt(e){if(!this.renderTarget||!this.world.renderer)throw new Error("Render target not initialized!");const t=this.components.get(le);if(!t.initialized||t.list.size===0)return null;this.assignColors(),this.renderColorCoded();const s=e||this.mouse.position,i=this.renderTargetSize,n=Math.floor((s.x+1)*.5*i.x),r=Math.floor((s.y+1)*.5*(i.y-1)),o=Math.max(0,Math.min(i.x-1,n)),l=Math.max(0,Math.min(i.y-1,r)),h=this.world.renderer.three,c=new Uint8Array(4);h.readRenderTargetPixels(this.renderTarget,o,l,1,1,c);const d=c[0],p=c[1],u=c[2],g=d<<16|p<<8|u;return this.colorToModelId.get(g)||null}setDebugMode(e){this.debugMode=e,e?this.setupDebugCanvas():this.removeDebugCanvas()}removeDebugCanvas(){this.debugContainer&&(this.debugContainer.remove(),this.debugContainer=void 0,this.debugCanvas=void 0)}dispose(){this.mouse.dispose(),this.removeDebugCanvas();for(const e of this.colorMaterials.values())e.dispose();this.colorMaterials.clear(),this.renderTarget&&this.renderTarget.dispose(),this.colorToModelId.clear(),this.modelIdToColor.clear(),this.originalMaterials.clear(),this.originalLodColors.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}}const ka=class Ia extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"list",new Map),E(this,"onDisposed",new K),e.add(Ia.uuid,this)}get(e){if(this.list.has(e.uuid))return this.list.get(e.uuid);const t=new zc(this.components,e);return this.list.set(e.uuid,t),e.onDisposed.add(()=>{this.delete(e)}),t}delete(e){const t=this.list.get(e.uuid);t&&t.dispose(),this.list.delete(e.uuid)}dispose(){for(const[e,t]of this.list)t.dispose();this.list.clear(),this.onDisposed.trigger()}};E(ka,"uuid","4a82430c-7ff2-49ea-9401-60807502dad6");let kc=ka;class Ic{constructor(e,t){E(this,"enabled",!0),E(this,"components"),E(this,"onDisposed",new K),E(this,"mouse"),E(this,"three",new Ar),E(this,"world"),E(this,"useFastModelPicking",!1);const s=t.renderer;if(!s)throw new Error("A renderer is needed for the raycaster to work!");this.world=t,this.mouse=new Ea(s.three.domElement),this.components=e}dispose(){this.mouse.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}castRayToObjects(e=Array.from(this.world.meshes),t=this.mouse.position){if(!this.world)throw new Error("A world is needed to cast rays!");const s=this.world.camera.three;return this.three.setFromCamera(t,s),this.intersect(e)}async castRay(e){const t=e==null?void 0:e.snappingClasses,s=(e==null?void 0:e.items)??Array.from(this.world.meshes),i=(e==null?void 0:e.position)??this.mouse.position;if(!this.world)throw new Error("A world is needed to cast rays!");const n=this.world.camera.three,r=this.components.get(le),o=this.world.renderer.three.domElement,l=this.mouse.rawPosition;let h=null;if(r.initialized){if(this.useFastModelPicking){const d=await this.components.get(kc).get(this.world).getModelAt(i);if(d){const p=r.list.get(d);if(p)if(t&&t.length>0){const u=await p.raycastWithSnapping({camera:n,dom:o,mouse:l,snappingClasses:t});u&&u.length>0?h=u[0]:h=await p.raycast({camera:n,dom:o,mouse:l})}else h=await p.raycast({camera:n,dom:o,mouse:l})}}else h=await r.raycast({camera:n,dom:o,mouse:l,snappingClasses:t});if(s.length===0)return h}this.three.setFromCamera(i,n);const c=this.intersect(s);return h?c&&c.distance<h.distance?c:h:c}castRayFromVector(e,t,s=Array.from(this.world.meshes)){return this.three.set(e,t),this.intersect(s)}intersect(e=Array.from(this.world.meshes)){const t=this.three.intersectObjects(e),s=this.filterClippingPlanes(t);return s.length>0?s[0]:null}filterClippingPlanes(e){if(!this.world.renderer)throw new Error("Renderer not found!");const t=this.world.renderer.three;if(!t.clippingPlanes)return e;const s=t.clippingPlanes;return e.length<=0||!s||(s==null?void 0:s.length)<=0?e:e.filter(i=>s.every(n=>n.distanceToPoint(i.point)>0))}}const La=class Na extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"list",new Map),E(this,"onDisposed",new K),e.add(Na.uuid,this)}get(e){if(this.list.has(e.uuid))return this.list.get(e.uuid);const t=new Ic(this.components,e);return this.list.set(e.uuid,t),e.onDisposed.add(()=>{this.delete(e)}),t}delete(e){const t=this.list.get(e.uuid);t&&t.dispose(),this.list.delete(e.uuid)}dispose(){for(const[e,t]of this.list)t.dispose();this.list.clear(),this.onDisposed.trigger()}};E(La,"uuid","d5d8bdf0-db25-4952-b951-b643af207ace");let et=La;class Lc extends zr{constructor(){super(...arguments),E(this,"onCameraChanged",new K),E(this,"meshes",new Set),E(this,"onAfterUpdate",new K),E(this,"onBeforeUpdate",new K),E(this,"onDisposed",new K),E(this,"isDisposing",!1),E(this,"enabled",!0),E(this,"_dynamicAnchor",!1),E(this,"uuid",Ze.create()),E(this,"name"),E(this,"_scene"),E(this,"_camera"),E(this,"_renderer",null),E(this,"onPointerDown",async e=>{if(!this.camera.hasCameraControls())throw new Error("World: can't set dynamic anchor if the camera doesn't have controls.");const t=await this.components.get(et).get(this).castRay();t&&t.point&&e.button===0&&this.camera.controls.setOrbitPoint(t.point.x,t.point.y,t.point.z)}),E(this,"_defaultCamera")}set dynamicAnchor(e){var t;const s=(t=this.renderer)==null?void 0:t.three.domElement.parentElement;if(!s)throw new Error("World: the renderer must have a parentElement to set dynamic anchoring.");e?(this.camera.controls&&(this.camera.controls.minDistance=.01),s.addEventListener("pointerdown",this.onPointerDown)):s.removeEventListener("pointerdown",this.onPointerDown)}get dynamicAnchor(){return this._dynamicAnchor}get defaultCamera(){if(!this._defaultCamera)throw new Error("World: there is no default camera defined.");return this._defaultCamera}set defaultCamera(e){this._defaultCamera=e}get scene(){if(!this._scene)throw new Error("No scene initialized!");return this._scene}set scene(e){this._scene=e,e.worlds.set(this.uuid,this),e.currentWorld=this,e.onWorldChanged.trigger({world:this,action:"added"})}get camera(){if(!this._camera)throw new Error("No camera initialized!");return this._camera}set camera(e){this._camera||(this.defaultCamera=e),this._camera=e,e.currentWorld=this,this.onCameraChanged.trigger(e)}get renderer(){return this._renderer}set renderer(e){this._renderer=e,e&&(e.worlds.set(this.uuid,this),e.currentWorld=this,e.onWorldChanged.trigger({world:this,action:"added"}))}useDefaultCamera(){this.camera=this.defaultCamera}update(e){this.enabled&&(!this._scene||!this._camera||(this.scene.currentWorld=this,this.camera.currentWorld=this,this.renderer&&(this.renderer.currentWorld=this),this.onBeforeUpdate.trigger(),this.scene.isUpdateable()&&this.scene.update(e),this.camera.isUpdateable()&&this.camera.update(e),this.renderer&&this.renderer.update(e),this.onAfterUpdate.trigger()))}dispose(e=!0){if(this.enabled=!1,this.isDisposing=!0,this.scene.onWorldChanged.trigger({world:this,action:"removed"}),this.camera.onWorldChanged.trigger({world:this,action:"removed"}),this.renderer&&this.renderer.onWorldChanged.trigger({world:this,action:"removed"}),e){const t=this.components.get(It);this.scene.dispose(),this.camera.isDisposeable()&&this.camera.dispose(),this.renderer&&this.renderer.dispose();for(const s of this.meshes)t.destroy(s);this.meshes.clear()}this._scene=null,this._camera=null,this._renderer=null,this.components.get(Fa).list.delete(this.uuid),this.onDisposed.trigger(),this.onDisposed.reset()}}var ln=(a=>(a[a.MANUAL=0]="MANUAL",a[a.AUTO=1]="AUTO",a))(ln||{});class Nc extends ch{constructor(e,t,s){super(e),E(this,"enabled",!0),E(this,"container"),E(this,"three"),E(this,"mode",1),E(this,"needsUpdate",!1),E(this,"_canvas"),E(this,"_parameters"),E(this,"_resizeObserver",null),E(this,"onContainerUpdated",new K),E(this,"_resizing",!1),E(this,"resize",r=>{if(this._resizing)return;this._resizing=!0,this.onContainerUpdated.trigger();const o=r?r.x:this.container.clientWidth,l=r?r.y:this.container.clientHeight;this.three.setSize(o,l),this.onResize.trigger(new Ce(o,l)),this._resizing=!1}),E(this,"resizeEvent",()=>{this.resize()}),E(this,"onContextLost",r=>{r.preventDefault(),this.enabled=!1}),E(this,"onContextBack",()=>{this.three.setRenderTarget(null),this.three.dispose(),this.three=new qr({canvas:this._canvas,antialias:!0,alpha:!0,...this._parameters}),this.enabled=!0}),this.container=t,this._parameters=s,this.three=new qr({antialias:!0,alpha:!0,...s}),this.three.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.setupRenderer(),this.setupEvents(!0),this.resize(),this._canvas=this.three.domElement;const i=this.three.getContext(),{canvas:n}=i;n.addEventListener("webglcontextlost",this.onContextLost,!1),n.addEventListener("webglcontextrestored",this.onContextBack,!1)}update(){if(!this.enabled||!this.currentWorld||this.mode===0&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger(this);const e=this.currentWorld.scene.three,t=this.currentWorld.camera.three;this.three.render(e,t),this.onAfterUpdate.trigger(this)}dispose(){this.enabled=!1,this.setupEvents(!1),this.three.domElement.remove(),this.three.forceContextLoss(),this.three.dispose(),this.onResize.reset(),this.onAfterUpdate.reset(),this.onBeforeUpdate.reset(),this.onDisposed.trigger(),this.onDisposed.reset()}getSize(){return new Ce(this.three.domElement.clientWidth,this.three.domElement.clientHeight)}setupEvents(e){const t=this.three.domElement.parentElement;if(!t)throw new Error("This renderer needs to have an HTML container!");this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),window.removeEventListener("resize",this.resizeEvent),e&&(this._resizeObserver=new ResizeObserver(this.resizeEvent),this._resizeObserver.observe(t),window.addEventListener("resize",this.resizeEvent))}setupRenderer(){this.three.localClippingEnabled=!0,this.container&&this.container.appendChild(this.three.domElement),this.onContainerUpdated.trigger()}}/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const De={LEFT:1,RIGHT:2,MIDDLE:4},j=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),_s={NONE:0,IN:1,OUT:-1};function ls(a){return a.isPerspectiveCamera}function Zt(a){return a.isOrthographicCamera}const ws=Math.PI*2,no=Math.PI/2,Ua=1e-5,Zs=Math.PI/180;function _t(a,e,t){return Math.max(e,Math.min(t,a))}function Te(a,e=Ua){return Math.abs(a)<e}function _e(a,e,t=Ua){return Te(a-e,t)}function ro(a,e){return Math.round(a/e)*e}function Xs(a){return isFinite(a)?a:a<0?-Number.MAX_VALUE:Number.MAX_VALUE}function qs(a){return Math.abs(a)<Number.MAX_VALUE?a:a*(1/0)}function Ci(a,e,t,s,i=1/0,n){s=Math.max(1e-4,s);const r=2/s,o=r*n,l=1/(1+o+.48*o*o+.235*o*o*o);let h=a-e;const c=e,d=i*s;h=_t(h,-d,d),e=a-h;const p=(t.value+r*h)*n;t.value=(t.value-r*p)*l;let u=e+(h+p)*l;return c-a>0==u>c&&(u=c,t.value=(u-c)/n),u}function oo(a,e,t,s,i=1/0,n,r){s=Math.max(1e-4,s);const o=2/s,l=o*n,h=1/(1+l+.48*l*l+.235*l*l*l);let c=e.x,d=e.y,p=e.z,u=a.x-c,g=a.y-d,m=a.z-p;const v=c,f=d,y=p,_=i*s,x=_*_,C=u*u+g*g+m*m;if(C>x){const B=Math.sqrt(C);u=u/B*_,g=g/B*_,m=m/B*_}c=a.x-u,d=a.y-g,p=a.z-m;const P=(t.x+o*u)*n,A=(t.y+o*g)*n,k=(t.z+o*m)*n;t.x=(t.x-o*P)*h,t.y=(t.y-o*A)*h,t.z=(t.z-o*k)*h,r.x=c+(u+P)*h,r.y=d+(g+A)*h,r.z=p+(m+k)*h;const M=v-a.x,I=f-a.y,R=y-a.z,T=r.x-v,z=r.y-f,b=r.z-y;return M*T+I*z+R*b>0&&(r.x=v,r.y=f,r.z=y,t.x=(r.x-v)/n,t.y=(r.y-f)/n,t.z=(r.z-y)/n),r}function On(a,e){e.set(0,0),a.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=a.length,e.y/=a.length}function Dn(a,e){return Zt(a)?(console.warn(`${e} is not supported in OrthographicCamera`),!0):!1}class Uc{constructor(){this._listeners={}}addEventListener(e,t){const s=this._listeners;s[e]===void 0&&(s[e]=[]),s[e].indexOf(t)===-1&&s[e].push(t)}hasEventListener(e,t){const s=this._listeners;return s[e]!==void 0&&s[e].indexOf(t)!==-1}removeEventListener(e,t){const s=this._listeners[e];if(s!==void 0){const i=s.indexOf(t);i!==-1&&s.splice(i,1)}}removeAllEventListeners(e){if(!e){this._listeners={};return}Array.isArray(this._listeners[e])&&(this._listeners[e].length=0)}dispatchEvent(e){const t=this._listeners[e.type];if(t!==void 0){e.target=this;const s=t.slice(0);for(let i=0,n=s.length;i<n;i++)s[i].call(this,e)}}}var zn;const Bc="2.10.1",Ti=1/8,Rc=/Mac/.test((zn=globalThis==null?void 0:globalThis.navigator)===null||zn===void 0?void 0:zn.platform);let he,ao,Pi,kn,st,de,me,bs,Qs,Ct,Tt,hs,lo,ho,ht,Ks,xs,co,In,uo,Ln,Nn,Ai;class Ke extends Uc{static install(e){he=e.THREE,ao=Object.freeze(new he.Vector3(0,0,0)),Pi=Object.freeze(new he.Vector3(0,1,0)),kn=Object.freeze(new he.Vector3(0,0,1)),st=new he.Vector2,de=new he.Vector3,me=new he.Vector3,bs=new he.Vector3,Qs=new he.Vector3,Ct=new he.Vector3,Tt=new he.Vector3,hs=new he.Vector3,lo=new he.Vector3,ho=new he.Vector3,ht=new he.Spherical,Ks=new he.Spherical,xs=new he.Box3,co=new he.Box3,In=new he.Sphere,uo=new he.Quaternion,Ln=new he.Quaternion,Nn=new he.Matrix4,Ai=new he.Raycaster}static get ACTION(){return j}set verticalDragToForward(e){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=j.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=_s.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new he.Vector3,this._focalOffsetVelocity=new he.Vector3,this._zoomVelocity={value:0},this._truckInternal=(f,y,_,x)=>{let C,P;if(ls(this._camera)){const A=de.copy(this._camera.position).sub(this._target),k=this._camera.getEffectiveFOV()*Zs,M=A.length()*Math.tan(k*.5);C=this.truckSpeed*f*M/this._elementRect.height,P=this.truckSpeed*y*M/this._elementRect.height}else if(Zt(this._camera)){const A=this._camera;C=this.truckSpeed*f*(A.right-A.left)/A.zoom/this._elementRect.width,P=this.truckSpeed*y*(A.top-A.bottom)/A.zoom/this._elementRect.height}else return;x?(_?this.setFocalOffset(this._focalOffsetEnd.x+C,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(C,0,!0),this.forward(-P,!0)):_?this.setFocalOffset(this._focalOffsetEnd.x+C,this._focalOffsetEnd.y+P,this._focalOffsetEnd.z,!0):this.truck(C,P,!0)},this._rotateInternal=(f,y)=>{const _=ws*this.azimuthRotateSpeed*f/this._elementRect.height,x=ws*this.polarRotateSpeed*y/this._elementRect.height;this.rotate(_,x,!0)},this._dollyInternal=(f,y,_)=>{const x=Math.pow(.95,-f*this.dollySpeed),C=this._sphericalEnd.radius,P=this._sphericalEnd.radius*x,A=_t(P,this.minDistance,this.maxDistance),k=A-P;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(P,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(k,!0),this._dollyToNoClamp(A,!0)):this._dollyToNoClamp(A,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?P:A)-C,this._dollyControlCoord.set(y,_)),this._lastDollyDirection=Math.sign(-f)},this._zoomInternal=(f,y,_)=>{const x=Math.pow(.95,f*this.dollySpeed),C=this._zoom,P=this._zoom*x;this.zoomTo(P,!0),this.dollyToCursor&&(this._changedZoom+=P-C,this._dollyControlCoord.set(y,_))},typeof he>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=new he.Quaternion().setFromUnitVectors(this._camera.up,Pi),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=j.NONE,this._target=new he.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new he.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new he.Spherical().setFromVector3(de.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new he.Vector3,new he.Vector3,new he.Vector3,new he.Vector3],this._updateNearPlaneCorners(),this._boundary=new he.Box3(new he.Vector3(-1/0,-1/0,-1/0),new he.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new he.Vector2,this.mouseButtons={left:j.ROTATE,middle:j.DOLLY,right:j.TRUCK,wheel:ls(this._camera)?j.DOLLY:Zt(this._camera)?j.ZOOM:j.NONE},this.touches={one:j.TOUCH_ROTATE,two:ls(this._camera)?j.TOUCH_DOLLY_TRUCK:Zt(this._camera)?j.TOUCH_ZOOM_TRUCK:j.NONE,three:j.TOUCH_TRUCK};const s=new he.Vector2,i=new he.Vector2,n=new he.Vector2,r=f=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const x=this._domElement.getBoundingClientRect(),C=f.clientX/x.width,P=f.clientY/x.height;if(C<this._interactiveArea.left||C>this._interactiveArea.right||P<this._interactiveArea.top||P>this._interactiveArea.bottom)return}const y=f.pointerType!=="mouse"?null:(f.buttons&De.LEFT)===De.LEFT?De.LEFT:(f.buttons&De.MIDDLE)===De.MIDDLE?De.MIDDLE:(f.buttons&De.RIGHT)===De.RIGHT?De.RIGHT:null;if(y!==null){const x=this._findPointerByMouseButton(y);x&&this._disposePointer(x)}if((f.buttons&De.LEFT)===De.LEFT&&this._lockedPointer)return;const _={pointerId:f.pointerId,clientX:f.clientX,clientY:f.clientY,deltaX:0,deltaY:0,mouseButton:y};this._activePointers.push(_),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),this._isDragging=!0,p(f)},o=f=>{f.cancelable&&f.preventDefault();const y=f.pointerId,_=this._lockedPointer||this._findPointerById(y);if(_){if(_.clientX=f.clientX,_.clientY=f.clientY,_.deltaX=f.movementX,_.deltaY=f.movementY,this._state=0,f.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(f.buttons&De.LEFT)===De.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(f.buttons&De.MIDDLE)===De.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(f.buttons&De.RIGHT)===De.RIGHT&&(this._state=this._state|this.mouseButtons.right);u()}},l=f=>{const y=this._findPointerById(f.pointerId);if(!(y&&y===this._lockedPointer)){if(y&&this._disposePointer(y),f.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=j.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=j.NONE;g()}};let h=-1;const c=f=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===j.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const P=this._domElement.getBoundingClientRect(),A=f.clientX/P.width,k=f.clientY/P.height;if(A<this._interactiveArea.left||A>this._interactiveArea.right||k<this._interactiveArea.top||k>this._interactiveArea.bottom)return}if(f.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===j.ROTATE||this.mouseButtons.wheel===j.TRUCK){const P=performance.now();h-P<1e3&&this._getClientRect(this._elementRect),h=P}const y=Rc?-1:-3,_=f.deltaMode===1||f.ctrlKey?f.deltaY/y:f.deltaY/(y*10),x=this.dollyToCursor?(f.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,C=this.dollyToCursor?(f.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case j.ROTATE:{this._rotateInternal(f.deltaX,f.deltaY),this._isUserControllingRotate=!0;break}case j.TRUCK:{this._truckInternal(f.deltaX,f.deltaY,!1,!1),this._isUserControllingTruck=!0;break}case j.SCREEN_PAN:{this._truckInternal(f.deltaX,f.deltaY,!1,!0),this._isUserControllingTruck=!0;break}case j.OFFSET:{this._truckInternal(f.deltaX,f.deltaY,!0,!1),this._isUserControllingOffset=!0;break}case j.DOLLY:{this._dollyInternal(-_,x,C),this._isUserControllingDolly=!0;break}case j.ZOOM:{this._zoomInternal(-_,x,C),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},d=f=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===Ke.ACTION.NONE){const y=f instanceof PointerEvent?f.pointerId:0,_=this._findPointerById(y);_&&this._disposePointer(_),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l);return}f.preventDefault()}},p=f=>{if(this._enabled){if(On(this._activePointers,st),this._getClientRect(this._elementRect),s.copy(st),i.copy(st),this._activePointers.length>=2){const y=st.x-this._activePointers[1].clientX,_=st.y-this._activePointers[1].clientY,x=Math.sqrt(y*y+_*_);n.set(0,x);const C=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,P=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;i.set(C,P)}if(this._state=0,!f)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in f&&f.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(f.buttons&De.LEFT)===De.LEFT&&(this._state=this._state|this.mouseButtons.left),(f.buttons&De.MIDDLE)===De.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(f.buttons&De.RIGHT)===De.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&j.ROTATE)===j.ROTATE||(this._state&j.TOUCH_ROTATE)===j.TOUCH_ROTATE||(this._state&j.TOUCH_DOLLY_ROTATE)===j.TOUCH_DOLLY_ROTATE||(this._state&j.TOUCH_ZOOM_ROTATE)===j.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&j.TRUCK)===j.TRUCK||(this._state&j.SCREEN_PAN)===j.SCREEN_PAN||(this._state&j.TOUCH_TRUCK)===j.TOUCH_TRUCK||(this._state&j.TOUCH_SCREEN_PAN)===j.TOUCH_SCREEN_PAN||(this._state&j.TOUCH_DOLLY_TRUCK)===j.TOUCH_DOLLY_TRUCK||(this._state&j.TOUCH_DOLLY_SCREEN_PAN)===j.TOUCH_DOLLY_SCREEN_PAN||(this._state&j.TOUCH_ZOOM_TRUCK)===j.TOUCH_ZOOM_TRUCK||(this._state&j.TOUCH_ZOOM_SCREEN_PAN)===j.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&j.DOLLY)===j.DOLLY||(this._state&j.TOUCH_DOLLY)===j.TOUCH_DOLLY||(this._state&j.TOUCH_DOLLY_TRUCK)===j.TOUCH_DOLLY_TRUCK||(this._state&j.TOUCH_DOLLY_SCREEN_PAN)===j.TOUCH_DOLLY_SCREEN_PAN||(this._state&j.TOUCH_DOLLY_OFFSET)===j.TOUCH_DOLLY_OFFSET||(this._state&j.TOUCH_DOLLY_ROTATE)===j.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&j.ZOOM)===j.ZOOM||(this._state&j.TOUCH_ZOOM)===j.TOUCH_ZOOM||(this._state&j.TOUCH_ZOOM_TRUCK)===j.TOUCH_ZOOM_TRUCK||(this._state&j.TOUCH_ZOOM_SCREEN_PAN)===j.TOUCH_ZOOM_SCREEN_PAN||(this._state&j.TOUCH_ZOOM_OFFSET)===j.TOUCH_ZOOM_OFFSET||(this._state&j.TOUCH_ZOOM_ROTATE)===j.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&j.OFFSET)===j.OFFSET||(this._state&j.TOUCH_OFFSET)===j.TOUCH_OFFSET||(this._state&j.TOUCH_DOLLY_OFFSET)===j.TOUCH_DOLLY_OFFSET||(this._state&j.TOUCH_ZOOM_OFFSET)===j.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})}},u=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,On(this._activePointers,st);const f=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,y=f?-f.deltaX:i.x-st.x,_=f?-f.deltaY:i.y-st.y;if(i.copy(st),((this._state&j.ROTATE)===j.ROTATE||(this._state&j.TOUCH_ROTATE)===j.TOUCH_ROTATE||(this._state&j.TOUCH_DOLLY_ROTATE)===j.TOUCH_DOLLY_ROTATE||(this._state&j.TOUCH_ZOOM_ROTATE)===j.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(y,_),this._isUserControllingRotate=!0),(this._state&j.DOLLY)===j.DOLLY||(this._state&j.ZOOM)===j.ZOOM){const x=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,C=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0,P=this.dollyDragInverted?-1:1;(this._state&j.DOLLY)===j.DOLLY?(this._dollyInternal(P*_*Ti,x,C),this._isUserControllingDolly=!0):(this._zoomInternal(P*_*Ti,x,C),this._isUserControllingZoom=!0)}if((this._state&j.TOUCH_DOLLY)===j.TOUCH_DOLLY||(this._state&j.TOUCH_ZOOM)===j.TOUCH_ZOOM||(this._state&j.TOUCH_DOLLY_TRUCK)===j.TOUCH_DOLLY_TRUCK||(this._state&j.TOUCH_ZOOM_TRUCK)===j.TOUCH_ZOOM_TRUCK||(this._state&j.TOUCH_DOLLY_SCREEN_PAN)===j.TOUCH_DOLLY_SCREEN_PAN||(this._state&j.TOUCH_ZOOM_SCREEN_PAN)===j.TOUCH_ZOOM_SCREEN_PAN||(this._state&j.TOUCH_DOLLY_OFFSET)===j.TOUCH_DOLLY_OFFSET||(this._state&j.TOUCH_ZOOM_OFFSET)===j.TOUCH_ZOOM_OFFSET||(this._state&j.TOUCH_DOLLY_ROTATE)===j.TOUCH_DOLLY_ROTATE||(this._state&j.TOUCH_ZOOM_ROTATE)===j.TOUCH_ZOOM_ROTATE){const x=st.x-this._activePointers[1].clientX,C=st.y-this._activePointers[1].clientY,P=Math.sqrt(x*x+C*C),A=n.y-P;n.set(0,P);const k=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,M=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&j.TOUCH_DOLLY)===j.TOUCH_DOLLY||(this._state&j.TOUCH_DOLLY_ROTATE)===j.TOUCH_DOLLY_ROTATE||(this._state&j.TOUCH_DOLLY_TRUCK)===j.TOUCH_DOLLY_TRUCK||(this._state&j.TOUCH_DOLLY_SCREEN_PAN)===j.TOUCH_DOLLY_SCREEN_PAN||(this._state&j.TOUCH_DOLLY_OFFSET)===j.TOUCH_DOLLY_OFFSET?(this._dollyInternal(A*Ti,k,M),this._isUserControllingDolly=!0):(this._zoomInternal(A*Ti,k,M),this._isUserControllingZoom=!0)}((this._state&j.TRUCK)===j.TRUCK||(this._state&j.TOUCH_TRUCK)===j.TOUCH_TRUCK||(this._state&j.TOUCH_DOLLY_TRUCK)===j.TOUCH_DOLLY_TRUCK||(this._state&j.TOUCH_ZOOM_TRUCK)===j.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(y,_,!1,!1),this._isUserControllingTruck=!0),((this._state&j.SCREEN_PAN)===j.SCREEN_PAN||(this._state&j.TOUCH_SCREEN_PAN)===j.TOUCH_SCREEN_PAN||(this._state&j.TOUCH_DOLLY_SCREEN_PAN)===j.TOUCH_DOLLY_SCREEN_PAN||(this._state&j.TOUCH_ZOOM_SCREEN_PAN)===j.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(y,_,!1,!0),this._isUserControllingTruck=!0),((this._state&j.OFFSET)===j.OFFSET||(this._state&j.TOUCH_OFFSET)===j.TOUCH_OFFSET||(this._state&j.TOUCH_DOLLY_OFFSET)===j.TOUCH_DOLLY_OFFSET||(this._state&j.TOUCH_ZOOM_OFFSET)===j.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(y,_,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},g=()=>{On(this._activePointers,st),i.copy(st),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",m),this._domElement.ownerDocument.addEventListener("pointerlockerror",v),this._domElement.ownerDocument.addEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),p())},this.unlockPointer=()=>{var f,y,_;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(f=this._domElement)===null||f===void 0||f.ownerDocument.exitPointerLock(),(y=this._domElement)===null||y===void 0||y.ownerDocument.removeEventListener("pointerlockchange",m),(_=this._domElement)===null||_===void 0||_.ownerDocument.removeEventListener("pointerlockerror",v),this.cancel()};const m=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},v=()=>{this.unlockPointer()};this._addAllEventListeners=f=>{this._domElement=f,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",r),this._domElement.addEventListener("pointercancel",l),this._domElement.addEventListener("wheel",c,{passive:!1}),this._domElement.addEventListener("contextmenu",d)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",r),this._domElement.removeEventListener("pointercancel",l),this._domElement.removeEventListener("wheel",c,{passive:!1}),this._domElement.removeEventListener("contextmenu",d),this._domElement.ownerDocument.removeEventListener("pointermove",o,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.removeEventListener("pointerlockchange",m),this._domElement.ownerDocument.removeEventListener("pointerlockerror",v))},this.cancel=()=>{this._state!==j.NONE&&(this._state=j.NONE,this._activePointers.length=0,g())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=_t(e.width,0,1),this._interactiveArea.height=_t(e.height,0,1),this._interactiveArea.x=_t(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=_t(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,s=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,s)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,s=!1){this._isUserControllingRotate=!1;const i=_t(e,this.minAzimuthAngle,this.maxAzimuthAngle),n=_t(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=i,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,s||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const r=!s||_e(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&_e(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(r)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=_s.NONE,this._changedDolly=0,this._dollyToNoClamp(_t(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const s=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const n=this._collisionTest(),r=_e(n,this._spherical.radius);if(!(s>e)&&r)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,n)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const i=!t||_e(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(i)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(Qs).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const s=!t||_e(this._target.x,this._targetEnd.x,this.restThreshold)&&_e(this._target.y,this._targetEnd.y,this.restThreshold)&&_e(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=_t(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const s=!t||_e(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(s)}pan(e,t,s=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,s)}truck(e,t,s=!1){this._camera.updateMatrix(),Ct.setFromMatrixColumn(this._camera.matrix,0),Tt.setFromMatrixColumn(this._camera.matrix,1),Ct.multiplyScalar(e),Tt.multiplyScalar(-t);const i=de.copy(Ct).add(Tt),n=me.copy(this._targetEnd).add(i);return this.moveTo(n.x,n.y,n.z,s)}forward(e,t=!1){de.setFromMatrixColumn(this._camera.matrix,0),de.crossVectors(this._camera.up,de),de.multiplyScalar(e);const s=me.copy(this._targetEnd).add(de);return this.moveTo(s.x,s.y,s.z,t)}elevate(e,t=!1){return de.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+de.x,this._targetEnd.y+de.y,this._targetEnd.z+de.z,t)}moveTo(e,t,s,i=!1){this._isUserControllingTruck=!1;const n=de.set(e,t,s).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,i||this._target.copy(this._targetEnd);const r=!i||_e(this._target.x,this._targetEnd.x,this.restThreshold)&&_e(this._target.y,this._targetEnd.y,this.restThreshold)&&_e(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}lookInDirectionOf(e,t,s,i=!1){const n=de.set(e,t,s).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(n.x,n.y,n.z,i)}fitToBox(e,t,{cover:s=!1,paddingLeft:i=0,paddingRight:n=0,paddingBottom:r=0,paddingTop:o=0}={}){const l=[],h=e.isBox3?xs.copy(e):xs.setFromObject(e);h.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const c=ro(this._sphericalEnd.theta,no),d=ro(this._sphericalEnd.phi,no);l.push(this.rotateTo(c,d,t));const p=de.setFromSpherical(this._sphericalEnd).normalize(),u=uo.setFromUnitVectors(p,kn),g=_e(Math.abs(p.y),1);g&&u.multiply(Ln.setFromAxisAngle(Pi,c)),u.multiply(this._yAxisUpSpaceInverse);const m=co.makeEmpty();me.copy(h.min).applyQuaternion(u),m.expandByPoint(me),me.copy(h.min).setX(h.max.x).applyQuaternion(u),m.expandByPoint(me),me.copy(h.min).setY(h.max.y).applyQuaternion(u),m.expandByPoint(me),me.copy(h.max).setZ(h.min.z).applyQuaternion(u),m.expandByPoint(me),me.copy(h.min).setZ(h.max.z).applyQuaternion(u),m.expandByPoint(me),me.copy(h.max).setY(h.min.y).applyQuaternion(u),m.expandByPoint(me),me.copy(h.max).setX(h.min.x).applyQuaternion(u),m.expandByPoint(me),me.copy(h.max).applyQuaternion(u),m.expandByPoint(me),m.min.x-=i,m.min.y-=r,m.max.x+=n,m.max.y+=o,u.setFromUnitVectors(kn,p),g&&u.premultiply(Ln.invert()),u.premultiply(this._yAxisUpSpace);const v=m.getSize(de),f=m.getCenter(me).applyQuaternion(u);if(ls(this._camera)){const y=this.getDistanceToFitBox(v.x,v.y,v.z,s);l.push(this.moveTo(f.x,f.y,f.z,t)),l.push(this.dollyTo(y,t)),l.push(this.setFocalOffset(0,0,0,t))}else if(Zt(this._camera)){const y=this._camera,_=y.right-y.left,x=y.top-y.bottom,C=s?Math.max(_/v.x,x/v.y):Math.min(_/v.x,x/v.y);l.push(this.moveTo(f.x,f.y,f.z,t)),l.push(this.zoomTo(C,t)),l.push(this.setFocalOffset(0,0,0,t))}return Promise.all(l)}fitToSphere(e,t){const s=[],i="isObject3D"in e?Ke.createBoundingSphere(e,In):In.copy(e);if(s.push(this.moveTo(i.center.x,i.center.y,i.center.z,t)),ls(this._camera)){const n=this.getDistanceToFitSphere(i.radius);s.push(this.dollyTo(n,t))}else if(Zt(this._camera)){const n=this._camera.right-this._camera.left,r=this._camera.top-this._camera.bottom,o=2*i.radius,l=Math.min(n/o,r/o);s.push(this.zoomTo(l,t))}return s.push(this.setFocalOffset(0,0,0,t)),Promise.all(s)}setLookAt(e,t,s,i,n,r,o=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=_s.NONE,this._changedDolly=0;const l=me.set(i,n,r),h=de.set(e,t,s);this._targetEnd.copy(l),this._sphericalEnd.setFromVector3(h.sub(l).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,o||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const c=!o||_e(this._target.x,this._targetEnd.x,this.restThreshold)&&_e(this._target.y,this._targetEnd.y,this.restThreshold)&&_e(this._target.z,this._targetEnd.z,this.restThreshold)&&_e(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&_e(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&_e(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(c)}lerpLookAt(e,t,s,i,n,r,o,l,h,c,d,p,u,g=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=_s.NONE,this._changedDolly=0;const m=de.set(i,n,r),v=me.set(e,t,s);ht.setFromVector3(v.sub(m).applyQuaternion(this._yAxisUpSpace));const f=bs.set(c,d,p),y=me.set(o,l,h);Ks.setFromVector3(y.sub(f).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(m.lerp(f,u));const _=Ks.theta-ht.theta,x=Ks.phi-ht.phi,C=Ks.radius-ht.radius;this._sphericalEnd.set(ht.radius+C*u,ht.phi+x*u,ht.theta+_*u),this.normalizeRotations(),this._needsUpdate=!0,g||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const P=!g||_e(this._target.x,this._targetEnd.x,this.restThreshold)&&_e(this._target.y,this._targetEnd.y,this.restThreshold)&&_e(this._target.z,this._targetEnd.z,this.restThreshold)&&_e(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&_e(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&_e(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(P)}setPosition(e,t,s,i=!1){return this.setLookAt(e,t,s,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,i)}setTarget(e,t,s,i=!1){const n=this.getPosition(de),r=this.setLookAt(n.x,n.y,n.z,e,t,s,i);return this._sphericalEnd.phi=_t(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),r}setFocalOffset(e,t,s,i=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,s),this._needsUpdate=!0,i||this._focalOffset.copy(this._focalOffsetEnd);const n=!i||_e(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&_e(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&_e(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(e,t,s){this._camera.updateMatrixWorld(),Ct.setFromMatrixColumn(this._camera.matrixWorldInverse,0),Tt.setFromMatrixColumn(this._camera.matrixWorldInverse,1),hs.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const i=de.set(e,t,s),n=i.distanceTo(this._camera.position),r=i.sub(this._camera.position);Ct.multiplyScalar(r.x),Tt.multiplyScalar(r.y),hs.multiplyScalar(r.z),de.copy(Ct).add(Tt).add(hs),de.z=de.z+n,this.dollyTo(n,!1),this.setFocalOffset(-de.x,de.y,-de.z,!1),this.moveTo(e,t,s,!1)}setBoundary(e){if(!e){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,s,i){if(e===null){this._viewport=null;return}this._viewport=this._viewport||new he.Vector4,typeof e=="number"?this._viewport.set(e,t,s,i):this._viewport.copy(e)}getDistanceToFitBox(e,t,s,i=!1){if(Dn(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=e/t,r=this._camera.getEffectiveFOV()*Zs,o=this._camera.aspect;return((i?n>o:n<o)?t:e/o)*.5/Math.tan(r*.5)+s*.5}getDistanceToFitSphere(e){if(Dn(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*Zs,s=Math.atan(Math.tan(t*.5)*this._camera.aspect)*2,i=1<this._camera.aspect?t:s;return e/Math.sin(i*.5)}getTarget(e,t=!0){return(e&&e.isVector3?e:new he.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new he.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new he.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new he.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%ws,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=ws),this._spherical.theta+=ws*Math.round((this._sphericalEnd.theta-this._spherical.theta)/ws)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!_e(this._camera.up.x,this._cameraUp0.x)||!_e(this._camera.up.y,this._cameraUp0.y)||!_e(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const s=this.getPosition(de);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,Pi),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=de.subVectors(this._target,this._camera.position).normalize(),t=me.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const s=this.getPosition(de);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,s=this._sphericalEnd.phi-this._spherical.phi,i=this._sphericalEnd.radius-this._spherical.radius,n=lo.subVectors(this._targetEnd,this._target),r=ho.subVectors(this._focalOffsetEnd,this._focalOffset),o=this._zoomEnd-this._zoom;if(Te(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const c=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=Ci(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,c,1/0,e),this._needsUpdate=!0}if(Te(s))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const c=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=Ci(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,c,1/0,e),this._needsUpdate=!0}if(Te(i))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const c=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=Ci(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,c,this.maxSpeed,e),this._needsUpdate=!0}if(Te(n.x)&&Te(n.y)&&Te(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const c=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;oo(this._target,this._targetEnd,this._targetVelocity,c,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(Te(r.x)&&Te(r.y)&&Te(r.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const c=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;oo(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,c,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(Te(o))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const c=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=Ci(this._zoom,this._zoomEnd,this._zoomVelocity,c,1/0,e)}if(this.dollyToCursor){if(ls(this._camera)&&this._changedDolly!==0){const c=this._spherical.radius-this._lastDistance,d=this._camera,p=this._getCameraDirection(Qs),u=de.copy(p).cross(d.up).normalize();u.lengthSq()===0&&(u.x=1);const g=me.crossVectors(u,p),m=this._sphericalEnd.radius*Math.tan(d.getEffectiveFOV()*Zs*.5),v=(this._sphericalEnd.radius-c-this._sphericalEnd.radius)/this._sphericalEnd.radius,f=bs.copy(this._targetEnd).add(u.multiplyScalar(this._dollyControlCoord.x*m*d.aspect)).add(g.multiplyScalar(this._dollyControlCoord.y*m)),y=de.copy(this._targetEnd).lerp(f,v),_=this._lastDollyDirection===_s.IN&&this._spherical.radius<=this.minDistance,x=this._lastDollyDirection===_s.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(_||x)){this._sphericalEnd.radius-=c,this._spherical.radius-=c;const P=me.copy(p).multiplyScalar(-c);y.add(P)}this._boundary.clampPoint(y,y);const C=me.subVectors(y,this._targetEnd);this._targetEnd.copy(y),this._target.add(C),this._changedDolly-=c,Te(this._changedDolly)&&(this._changedDolly=0)}else if(Zt(this._camera)&&this._changedZoom!==0){const c=this._zoom-this._lastZoom,d=this._camera,p=de.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(d.near+d.far)/(d.near-d.far)).unproject(d),u=me.set(0,0,-1).applyQuaternion(d.quaternion),g=bs.copy(p).add(u.multiplyScalar(-p.dot(d.up))),m=-(this._zoom-c-this._zoom)/this._zoom,v=this._getCameraDirection(Qs),f=this._targetEnd.dot(v),y=de.copy(this._targetEnd).lerp(g,m),_=y.dot(v),x=v.multiplyScalar(_-f);y.sub(x),this._boundary.clampPoint(y,y);const C=me.subVectors(y,this._targetEnd);this._targetEnd.copy(y),this._target.add(C),this._changedZoom-=c,Te(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const l=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,l),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!Te(this._focalOffset.x)||!Te(this._focalOffset.y)||!Te(this._focalOffset.z))&&(Ct.setFromMatrixColumn(this._camera.matrix,0),Tt.setFromMatrixColumn(this._camera.matrix,1),hs.setFromMatrixColumn(this._camera.matrix,2),Ct.multiplyScalar(this._focalOffset.x),Tt.multiplyScalar(-this._focalOffset.y),hs.multiplyScalar(this._focalOffset.z),de.copy(Ct).add(Tt).add(hs),this._camera.position.add(de),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),de.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const h=this._needsUpdate;return h&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):h?(this.dispatchEvent({type:"update"}),Te(t,this.restThreshold)&&Te(s,this.restThreshold)&&Te(i,this.restThreshold)&&Te(n.x,this.restThreshold)&&Te(n.y,this.restThreshold)&&Te(n.z,this.restThreshold)&&Te(r.x,this.restThreshold)&&Te(r.y,this.restThreshold)&&Te(r.z,this.restThreshold)&&Te(o,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!h&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=h,this._needsUpdate=!1,h}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:Xs(this.maxDistance),minZoom:this.minZoom,maxZoom:Xs(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:Xs(this.maxPolarAngle),minAzimuthAngle:Xs(this.minAzimuthAngle),maxAzimuthAngle:Xs(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:de.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const s=JSON.parse(e);this.enabled=s.enabled,this.minDistance=s.minDistance,this.maxDistance=qs(s.maxDistance),this.minZoom=s.minZoom,this.maxZoom=qs(s.maxZoom),this.minPolarAngle=s.minPolarAngle,this.maxPolarAngle=qs(s.maxPolarAngle),this.minAzimuthAngle=qs(s.minAzimuthAngle),this.maxAzimuthAngle=qs(s.maxAzimuthAngle),this.smoothTime=s.smoothTime,this.draggingSmoothTime=s.draggingSmoothTime,this.dollySpeed=s.dollySpeed,this.truckSpeed=s.truckSpeed,this.dollyToCursor=s.dollyToCursor,this._target0.fromArray(s.target0),this._position0.fromArray(s.position0),this._zoom0=s.zoom0,this._focalOffset0.fromArray(s.focalOffset0),this.moveTo(s.target[0],s.target[1],s.target[2],t),ht.setFromVector3(de.fromArray(s.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(ht.theta,ht.phi,t),this.dollyTo(ht.radius,t),this.zoomTo(s.zoom,t),this.setFocalOffset(s.focalOffset[0],s.focalOffset[1],s.focalOffset[2],t),this._needsUpdate=!0}connect(e){if(this._domElement){console.warn("camera-controls is already connected.");return}e.setAttribute("data-camera-controls-version",Bc),this._addAllEventListeners(e),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find(t=>t.pointerId===e)}_findPointerByMouseButton(e){return this._activePointers.find(t=>t.mouseButton===e)}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,s){const i=t.lengthSq();if(i===0)return e;const n=me.copy(t).add(e),r=this._boundary.clampPoint(n,bs).sub(n),o=r.lengthSq();if(o===0)return e.add(t);if(o===i)return e;if(s===0)return e.add(t).add(r);{const l=1+s*o/t.dot(r);return e.add(me.copy(t).multiplyScalar(l)).add(r.multiplyScalar(1-s))}}_updateNearPlaneCorners(){if(ls(this._camera)){const e=this._camera,t=e.near,s=e.getEffectiveFOV()*Zs,i=Math.tan(s*.5)*t,n=i*e.aspect;this._nearPlaneCorners[0].set(-n,-i,0),this._nearPlaneCorners[1].set(n,-i,0),this._nearPlaneCorners[2].set(n,i,0),this._nearPlaneCorners[3].set(-n,i,0)}else if(Zt(this._camera)){const e=this._camera,t=1/e.zoom,s=e.left*t,i=e.right*t,n=e.top*t,r=e.bottom*t;this._nearPlaneCorners[0].set(s,n,0),this._nearPlaneCorners[1].set(i,n,0),this._nearPlaneCorners[2].set(i,r,0),this._nearPlaneCorners[3].set(s,r,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1)||Dn(this._camera,"_collisionTest"))return e;const t=this._getTargetDirection(Qs);Nn.lookAt(ao,t,this._camera.up);for(let s=0;s<4;s++){const i=me.copy(this._nearPlaneCorners[s]);i.applyMatrix4(Nn);const n=bs.addVectors(this._target,i);Ai.set(n,t),Ai.far=this._spherical.radius+1;const r=Ai.intersectObjects(this.colliderMeshes);r.length!==0&&r[0].distance<e&&(e=r[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const s=()=>{this.removeEventListener("rest",s),t()};this.addEventListener("rest",s)}))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new he.Sphere){const s=t,i=s.center;xs.makeEmpty(),e.traverseVisible(r=>{r.isMesh&&xs.expandByObject(r)}),xs.getCenter(i);let n=0;return e.traverseVisible(r=>{if(!r.isMesh)return;const o=r;if(!o.geometry)return;const l=o.geometry.clone();l.applyMatrix4(o.matrixWorld);const h=l.attributes.position;for(let c=0,d=h.count;c<d;c++)de.fromBufferAttribute(h,c),n=Math.max(n,i.distanceToSquared(de))}),s.radius=Math.sqrt(n),s}}class fi extends hh{constructor(e){super(e),E(this,"onBeforeUpdate",new K),E(this,"onAfterUpdate",new K),E(this,"onAspectUpdated",new K),E(this,"onDisposed",new K),E(this,"three"),E(this,"_allControls",new Map),E(this,"updateAspect",()=>{var t;if(!(!this.currentWorld||!this.currentWorld.renderer)){if(this.three instanceof wn){this.onAspectUpdated.trigger();return}if((t=this.currentWorld.renderer)!=null&&t.isResizeable()){const s=this.currentWorld.renderer.getSize();this.three.aspect=s.width/s.height,this.three.updateProjectionMatrix(),this.onAspectUpdated.trigger()}}}),this.three=this.setupCamera(),this.setupEvents(!0),this.worlds.onItemSet.add(({value:t})=>{const s=this.newCameraControls();this._allControls.set(t.uuid,s)}),this.worlds.onBeforeDelete.add(({value:t})=>{const s=this._allControls.get(t.uuid);s&&(s.dispose(),this._allControls.delete(t.uuid))})}get controls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");const e=this._allControls.get(this.currentWorld.uuid);if(!e)throw new Error("Controls not found!");return e}get enabled(){return this.currentWorld===null?!1:this.controls.enabled}set enabled(e){this.currentWorld!==null&&(this.controls.enabled=e)}set currentWorld(e){super.currentWorld=e,e&&(this.worlds.get(e.uuid)||this.worlds.set(e.uuid,e))}get currentWorld(){return this._currentWorld}dispose(){this.setupEvents(!1),this.onAspectUpdated.reset(),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.three.removeFromParent(),this.onDisposed.trigger(),this.onDisposed.reset();for(const[e,t]of this._allControls)t.dispose();this.worlds.clear()}async fitToItems(e){const t=await this.getItemsBounding(e);await this.controls.fitToSphere(t,!0)}async setOrbitToItems(e){const t=await this.getItemsBounding(e);this.controls.setOrbitPoint(t.center.x,t.center.y,t.center.z)}update(e){this.enabled&&(this.onBeforeUpdate.trigger(this),this.controls.update(e),this.onAfterUpdate.trigger(this))}async getItemsBounding(e){const t=this.components.get(le),s=this.components.get(mn);s.list.clear();const i=new fs;if(e)await s.addFromModelIdMap(e);else for(const[,n]of t.list)s.list.add(n.box);return s.get().getBoundingSphere(i),s.list.clear(),i}setupCamera(){const e=window.innerWidth/window.innerHeight,t=new ha(60,e,1,1e3);return t.position.set(50,50,50),t.lookAt(new L(0,0,0)),t}newCameraControls(){if(!this.currentWorld)throw new Error("This camera needs a world to work!");if(!this.currentWorld.renderer)throw new Error("This camera needs a renderer to work!");Ke.install({THREE:fi.getSubsetOfThree()});const{domElement:e}=this.currentWorld.renderer.three,t=new Ke(this.three,e);return t.smoothTime=.2,t.dollyToCursor=!0,t.infinityDolly=!0,t.minDistance=6,t}setupEvents(e){e?window.addEventListener("resize",this.updateAspect):window.removeEventListener("resize",this.updateAspect)}static getSubsetOfThree(){return{MOUSE:Rl,Vector2:Ce,Vector3:L,Vector4:gs,Quaternion:bt,Matrix4:Pe,Spherical:Bl,Box3:Ue,Sphere:fs,Raycaster:Ar,MathUtils:ca}}}const Ba=class Ra extends xe{constructor(e){super(e),E(this,"onAfterUpdate",new K),E(this,"onBeforeUpdate",new K),E(this,"onDisposed",new K),E(this,"list",new be),E(this,"enabled",!0),e.add(Ra.uuid,this)}create(){const e=new Lc(this.components),t=e.uuid;if(this.list.has(t))throw new Error("There is already a world with this name!");return this.list.set(t,e),e}delete(e){if(!this.list.has(e.uuid))throw new Error("The provided world is not found in the list!");this.list.delete(e.uuid),e.dispose()}dispose(){this.enabled=!1;for(const[e,t]of this.list)t.dispose();this.list.clear(),this.onDisposed.trigger()}update(e){if(this.enabled)for(const[t,s]of this.list)s.update(e)}};E(Ba,"uuid","fdb61dc4-2ec1-4966-b83d-54ea795fad4a");let Fa=Ba;class Fc extends Sn{constructor(){super(...arguments),E(this,"_config",{visible:{value:!0,type:"Boolean"},color:{value:new fe,type:"Color"},primarySize:{type:"Number",interpolable:!0,value:1,min:0,max:1e3},secondarySize:{type:"Number",interpolable:!0,value:10,min:0,max:1e3},distance:{type:"Number",interpolable:!0,value:500,min:0,max:500}})}get visible(){return this._config.visible.value}set visible(e){this._config.visible.value=e,this._component.visible=e}get color(){return this._config.color.value}set color(e){this._config.color.value=e,this._component.material.uniforms.uColor.value=e,this._component.material.uniformsNeedUpdate=!0}get primarySize(){return this._config.primarySize.value}set primarySize(e){this._config.primarySize.value=e,this._component.material.uniforms.uSize1.value=e,this._component.material.uniformsNeedUpdate=!0}get secondarySize(){return this._config.secondarySize.value}set secondarySize(e){this._config.secondarySize.value=e,this._component.material.uniforms.uSize2.value=e,this._component.material.uniformsNeedUpdate=!0}get distance(){return this._config.distance.value}set distance(e){this._config.distance.value=e,this._component.material.uniforms.uDistance.value=e,this._component.material.uniformsNeedUpdate=!0}}class Vc{constructor(e,t){E(this,"onDisposed",new K),E(this,"onSetup",new K),E(this,"isSetup",!1),E(this,"world"),E(this,"components"),E(this,"config"),E(this,"_defaultConfig",{visible:!0,color:new fe(12303291),primarySize:1,secondarySize:10,distance:500}),E(this,"three"),E(this,"_fade",3),E(this,"updateZoom",()=>{this.world.camera instanceof fi&&(this.material.uniforms.uZoom.value=this.world.camera.three.zoom)}),this.world=t;const{color:s,primarySize:i,secondarySize:n,distance:r}=this._defaultConfig;this.components=e,this.config=new Fc(this,this.components,"Grid");const o=new Or(2,2,1,1),l=new Be({side:Ft,uniforms:{uSize1:{value:i},uSize2:{value:n},uColor:{value:s},uDistance:{value:r},uFade:{value:this._fade},uZoom:{value:1}},transparent:!0,vertexShader:`
            
            varying vec3 worldPosition;
            
            uniform float uDistance;
            
            void main() {
            
                    vec3 pos = position.xzy * uDistance;
                    pos.xz += cameraPosition.xz;
                    
                    worldPosition = pos;
                    
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
            
            }
            `,fragmentShader:`
            
            varying vec3 worldPosition;
            
            uniform float uZoom;
            uniform float uFade;
            uniform float uSize1;
            uniform float uSize2;
            uniform vec3 uColor;
            uniform float uDistance;
                
                
                
                float getGrid(float size) {
                
                    vec2 r = worldPosition.xz / size;
                    
                    
                    vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
                    float line = min(grid.x, grid.y);
                    
                
                    return 1.0 - min(line, 1.0);
                }
                
            void main() {
            
                    
                    float d = 1.0 - min(distance(cameraPosition.xz, worldPosition.xz) / uDistance, 1.0);
                    
                    float g1 = getGrid(uSize1);
                    float g2 = getGrid(uSize2);
                    
                    // Ortho camera fades the grid away when zooming out
                    float minZoom = step(0.2, uZoom);
                    float zoomFactor = pow(min(uZoom, 1.), 2.) * minZoom;
                    
                    gl_FragColor = vec4(uColor.rgb, mix(g2, g1, g1) * pow(d, uFade));
                    gl_FragColor.a = mix(0.5 * gl_FragColor.a, gl_FragColor.a, g2) * zoomFactor;
                    
                    if ( gl_FragColor.a <= 0.0 ) discard;
                    
            
            }
            
            `,extensions:{derivatives:!0}});this.three=new ie(o,l),this.three.frustumCulled=!1,t.scene.three.add(this.three),this.setupEvents(!0)}get visible(){return this.three.visible}set visible(e){this.three.visible=e,e?this.world.scene.three.add(this.three):this.three.removeFromParent()}get material(){return this.three.material}get fade(){return this._fade===3}set fade(e){this._fade=e?3:0,this.material.uniforms.uFade.value=this._fade}setup(e){const t={...this._defaultConfig,...e};this.config.visible=!0,this.config.color=t.color,this.config.primarySize=t.primarySize,this.config.secondarySize=t.secondarySize,this.config.distance=t.distance,this.isSetup=!0,this.onSetup.trigger()}dispose(){this.setupEvents(!1),this.components.get(Nr).list.delete(this.config.uuid),this.components.get(It).destroy(this.three),this.onDisposed.trigger(),this.onDisposed.reset(),this.world=null,this.components=null}setupEvents(e){if(this.world.isDisposing||!(this.world.camera instanceof fi))return;const t=this.world.camera.controls;e?t.addEventListener("update",this.updateZoom):t.removeEventListener("update",this.updateZoom)}}const jc=class Va extends xe{constructor(e){super(e),E(this,"list",new Map),E(this,"onDisposed",new K),E(this,"enabled",!0),e.add(Va.uuid,this)}create(e){if(this.list.has(e.uuid))throw new Error("This world already has a grid!");const t=new Vc(this.components,e);return this.list.set(e.uuid,t),e.onDisposed.add(()=>{this.delete(e)}),t}delete(e){const t=this.list.get(e.uuid);t&&t.dispose(),this.list.delete(e.uuid)}dispose(){for(const[e,t]of this.list)t.dispose();this.list.clear(),this.onDisposed.trigger(),this.onDisposed.reset()}};E(jc,"uuid","d1e814d5-b81c-4452-87a2-f039375e0489");const ja=0,Hc=1,Wc=2,po=2,Un=1.25,fo=1,hn=6*4+4+4,Cn=65535,Gc=Math.pow(2,-24),Bn=Symbol("SKIP_GENERATION");function Yc(a){return a.index?a.index.count:a.attributes.position.count}function Fs(a){return Yc(a)/3}function Zc(a,e=ArrayBuffer){return a>65535?new Uint32Array(new e(4*a)):new Uint16Array(new e(2*a))}function Xc(a,e){if(!a.index){const t=a.attributes.position.count,s=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,i=Zc(t,s);a.setIndex(new Rt(i,1));for(let n=0;n<t;n++)i[n]=n}}function Ha(a){const e=Fs(a),t=a.drawRange,s=t.start/3,i=(t.start+t.count)/3,n=Math.max(0,s),r=Math.min(e,i)-n;return[{offset:Math.floor(n),count:Math.floor(r)}]}function Wa(a){if(!a.groups||!a.groups.length)return Ha(a);const e=[],t=new Set,s=a.drawRange,i=s.start/3,n=(s.start+s.count)/3;for(const o of a.groups){const l=o.start/3,h=(o.start+o.count)/3;t.add(Math.max(i,l)),t.add(Math.min(n,h))}const r=Array.from(t.values()).sort((o,l)=>o-l);for(let o=0;o<r.length-1;o++){const l=r[o],h=r[o+1];e.push({offset:Math.floor(l),count:Math.floor(h-l)})}return e}function qc(a){if(a.groups.length===0)return!1;const e=Fs(a),t=Wa(a).sort((n,r)=>n.offset-r.offset),s=t[t.length-1];s.count=Math.min(e-s.offset,s.count);let i=0;return t.forEach(({count:n})=>i+=n),e!==i}function ze(a,e,t){return t.min.x=e[a],t.min.y=e[a+1],t.min.z=e[a+2],t.max.x=e[a+3],t.max.y=e[a+4],t.max.z=e[a+5],t}function Qc(a){a[0]=a[1]=a[2]=1/0,a[3]=a[4]=a[5]=-1/0}function mo(a){let e=-1,t=-1/0;for(let s=0;s<3;s++){const i=a[s+3]-a[s];i>t&&(t=i,e=s)}return e}function go(a,e){e.set(a)}function vo(a,e,t){let s,i;for(let n=0;n<3;n++){const r=n+3;s=a[n],i=e[n],t[n]=s<i?s:i,s=a[r],i=e[r],t[r]=s>i?s:i}}function Mi(a,e,t){for(let s=0;s<3;s++){const i=e[a+2*s],n=e[a+2*s+1],r=i-n,o=i+n;r<t[s]&&(t[s]=r),o>t[s+3]&&(t[s+3]=o)}}function Js(a){const e=a[3]-a[0],t=a[4]-a[1],s=a[5]-a[2];return 2*(e*t+t*s+s*e)}function Rn(a,e,t,s,i=null){let n=1/0,r=1/0,o=1/0,l=-1/0,h=-1/0,c=-1/0,d=1/0,p=1/0,u=1/0,g=-1/0,m=-1/0,v=-1/0;const f=i!==null;for(let y=e*6,_=(e+t)*6;y<_;y+=6){const x=a[y+0],C=a[y+1],P=x-C,A=x+C;P<n&&(n=P),A>l&&(l=A),f&&x<d&&(d=x),f&&x>g&&(g=x);const k=a[y+2],M=a[y+3],I=k-M,R=k+M;I<r&&(r=I),R>h&&(h=R),f&&k<p&&(p=k),f&&k>m&&(m=k);const T=a[y+4],z=a[y+5],b=T-z,B=T+z;b<o&&(o=b),B>c&&(c=B),f&&T<u&&(u=T),f&&T>v&&(v=T)}s[0]=n,s[1]=r,s[2]=o,s[3]=l,s[4]=h,s[5]=c,f&&(i[0]=d,i[1]=p,i[2]=u,i[3]=g,i[4]=m,i[5]=v)}function Kc(a,e,t,s){let i=1/0,n=1/0,r=1/0,o=-1/0,l=-1/0,h=-1/0;for(let c=e*6,d=(e+t)*6;c<d;c+=6){const p=a[c+0];p<i&&(i=p),p>o&&(o=p);const u=a[c+2];u<n&&(n=u),u>l&&(l=u);const g=a[c+4];g<r&&(r=g),g>h&&(h=g)}s[0]=i,s[1]=n,s[2]=r,s[3]=o,s[4]=l,s[5]=h}function Jc(a,e){Qc(e);const t=a.attributes.position,s=a.index?a.index.array:null,i=Fs(a),n=new Float32Array(i*6),r=t.normalized,o=t.array,l=t.offset||0;let h=3;t.isInterleavedBufferAttribute&&(h=t.data.stride);const c=["getX","getY","getZ"];for(let d=0;d<i;d++){const p=d*3,u=d*6;let g=p+0,m=p+1,v=p+2;s&&(g=s[g],m=s[m],v=s[v]),r||(g=g*h+l,m=m*h+l,v=v*h+l);for(let f=0;f<3;f++){let y,_,x;r?(y=t[c[f]](g),_=t[c[f]](m),x=t[c[f]](v)):(y=o[g+f],_=o[m+f],x=o[v+f]);let C=y;_<C&&(C=_),x<C&&(C=x);let P=y;_>P&&(P=_),x>P&&(P=x);const A=(P-C)/2,k=f*2;n[u+k+0]=C+A,n[u+k+1]=A+(Math.abs(C)+A)*Gc,C<e[f]&&(e[f]=C),P>e[f+3]&&(e[f+3]=P)}}return n}const Nt=32,$c=(a,e)=>a.candidate-e.candidate,Gt=new Array(Nt).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Oi=new Float32Array(6);function ed(a,e,t,s,i,n){let r=-1,o=0;if(n===ja)r=mo(e),r!==-1&&(o=(e[r]+e[r+3])/2);else if(n===Hc)r=mo(a),r!==-1&&(o=td(t,s,i,r));else if(n===Wc){const l=Js(a);let h=Un*i;const c=s*6,d=(s+i)*6;for(let p=0;p<3;p++){const u=e[p],g=(e[p+3]-u)/Nt;if(i<Nt/4){const m=[...Gt];m.length=i;let v=0;for(let y=c;y<d;y+=6,v++){const _=m[v];_.candidate=t[y+2*p],_.count=0;const{bounds:x,leftCacheBounds:C,rightCacheBounds:P}=_;for(let A=0;A<3;A++)P[A]=1/0,P[A+3]=-1/0,C[A]=1/0,C[A+3]=-1/0,x[A]=1/0,x[A+3]=-1/0;Mi(y,t,x)}m.sort($c);let f=i;for(let y=0;y<f;y++){const _=m[y];for(;y+1<f&&m[y+1].candidate===_.candidate;)m.splice(y+1,1),f--}for(let y=c;y<d;y+=6){const _=t[y+2*p];for(let x=0;x<f;x++){const C=m[x];_>=C.candidate?Mi(y,t,C.rightCacheBounds):(Mi(y,t,C.leftCacheBounds),C.count++)}}for(let y=0;y<f;y++){const _=m[y],x=_.count,C=i-_.count,P=_.leftCacheBounds,A=_.rightCacheBounds;let k=0;x!==0&&(k=Js(P)/l);let M=0;C!==0&&(M=Js(A)/l);const I=fo+Un*(k*x+M*C);I<h&&(r=p,h=I,o=_.candidate)}}else{for(let f=0;f<Nt;f++){const y=Gt[f];y.count=0,y.candidate=u+g+f*g;const _=y.bounds;for(let x=0;x<3;x++)_[x]=1/0,_[x+3]=-1/0}for(let f=c;f<d;f+=6){let y=~~((t[f+2*p]-u)/g);y>=Nt&&(y=Nt-1);const _=Gt[y];_.count++,Mi(f,t,_.bounds)}const m=Gt[Nt-1];go(m.bounds,m.rightCacheBounds);for(let f=Nt-2;f>=0;f--){const y=Gt[f],_=Gt[f+1];vo(y.bounds,_.rightCacheBounds,y.rightCacheBounds)}let v=0;for(let f=0;f<Nt-1;f++){const y=Gt[f],_=y.count,x=y.bounds,C=Gt[f+1].rightCacheBounds;_!==0&&(v===0?go(x,Oi):vo(x,Oi,Oi)),v+=_;let P=0,A=0;v!==0&&(P=Js(Oi)/l);const k=i-v;k!==0&&(A=Js(C)/l);const M=fo+Un*(P*v+A*k);M<h&&(r=p,h=M,o=y.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${n} used.`);return{axis:r,pos:o}}function td(a,e,t,s){let i=0;for(let n=e,r=e+t;n<r;n++)i+=a[n*6+s*2];return i/t}class Di{constructor(){}}function sd(a,e,t,s,i,n){let r=s,o=s+i-1;const l=n.pos,h=n.axis*2;for(;;){for(;r<=o&&t[r*6+h]<l;)r++;for(;r<=o&&t[o*6+h]>=l;)o--;if(r<o){for(let c=0;c<3;c++){let d=e[r*3+c];e[r*3+c]=e[o*3+c],e[o*3+c]=d}for(let c=0;c<6;c++){let d=t[r*6+c];t[r*6+c]=t[o*6+c],t[o*6+c]=d}r++,o--}else return r}}function id(a,e,t,s,i,n){let r=s,o=s+i-1;const l=n.pos,h=n.axis*2;for(;;){for(;r<=o&&t[r*6+h]<l;)r++;for(;r<=o&&t[o*6+h]>=l;)o--;if(r<o){let c=a[r];a[r]=a[o],a[o]=c;for(let d=0;d<6;d++){let p=t[r*6+d];t[r*6+d]=t[o*6+d],t[o*6+d]=p}r++,o--}else return r}}function nd(a,e){const t=(a.index?a.index.count:a.attributes.position.count)/3,s=t>2**16,i=s?4:2,n=e?new SharedArrayBuffer(t*i):new ArrayBuffer(t*i),r=s?new Uint32Array(n):new Uint16Array(n);for(let o=0,l=r.length;o<l;o++)r[o]=o;return r}function rd(a,e){const t=a.geometry,s=t.index?t.index.array:null,i=e.maxDepth,n=e.verbose,r=e.maxLeafTris,o=e.strategy,l=e.onProgress,h=Fs(t),c=a._indirectBuffer;let d=!1;const p=new Float32Array(6),u=new Float32Array(6),g=Jc(t,p),m=e.indirect?id:sd,v=[],f=e.indirect?Ha(t):Wa(t);if(f.length===1){const x=f[0],C=new Di;C.boundingData=p,Kc(g,x.offset,x.count,u),_(C,x.offset,x.count,u),v.push(C)}else for(let x of f){const C=new Di;C.boundingData=new Float32Array(6),Rn(g,x.offset,x.count,C.boundingData,u),_(C,x.offset,x.count,u),v.push(C)}return v;function y(x){l&&l(x/h)}function _(x,C,P,A=null,k=0){if(!d&&k>=i&&(d=!0,n&&(console.warn(`MeshBVH: Max depth of ${i} reached when generating BVH. Consider increasing maxDepth.`),console.warn(t))),P<=r||k>=i)return y(C+P),x.offset=C,x.count=P,x;const M=ed(x.boundingData,A,g,C,P,o);if(M.axis===-1)return y(C+P),x.offset=C,x.count=P,x;const I=m(c,s,g,C,P,M);if(I===C||I===C+P)y(C+P),x.offset=C,x.count=P;else{x.splitAxis=M.axis;const R=new Di,T=C,z=I-C;x.left=R,R.boundingData=new Float32Array(6),Rn(g,T,z,R.boundingData,u),_(R,T,z,u,k+1);const b=new Di,B=I,q=P-z;x.right=b,b.boundingData=new Float32Array(6),Rn(g,B,q,b.boundingData,u),_(b,B,q,u,k+1)}return x}}function od(a,e){const t=a.geometry;e.indirect&&(a._indirectBuffer=nd(t,e.useSharedArrayBuffer),qc(t)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),a._indirectBuffer||Xc(t,e);const s=rd(a,e);let i,n,r;const o=[],l=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let d=0;d<s.length;d++){const p=s[d];let u=h(p);const g=new l(hn*u);i=new Float32Array(g),n=new Uint32Array(g),r=new Uint16Array(g),c(0,p),o.push(g)}a._roots=o;return;function h(d){return d.count?1:1+h(d.left)+h(d.right)}function c(d,p){const u=d/4,g=d/2,m=!!p.count,v=p.boundingData;for(let f=0;f<6;f++)i[u+f]=v[f];if(m){const f=p.offset,y=p.count;return n[u+6]=f,r[g+14]=y,r[g+15]=Cn,d+hn}else{const f=p.left,y=p.right,_=p.splitAxis;let x;if(x=c(d+hn,f),x/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return n[u+6]=x/4,x=c(x,y),n[u+7]=_,x}}}class Vt{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let s=1/0,i=-1/0;for(let n=0,r=e.length;n<r;n++){const o=e[n][t];s=o<s?o:s,i=o>i?o:i}this.min=s,this.max=i}setFromPoints(e,t){let s=1/0,i=-1/0;for(let n=0,r=t.length;n<r;n++){const o=t[n],l=e.dot(o);s=l<s?l:s,i=l>i?l:i}this.min=s,this.max=i}isSeparated(e){return this.min>e.max||e.min>this.max}}Vt.prototype.setFromBox=function(){const a=new L;return function(e,t){const s=t.min,i=t.max;let n=1/0,r=-1/0;for(let o=0;o<=1;o++)for(let l=0;l<=1;l++)for(let h=0;h<=1;h++){a.x=s.x*o+i.x*(1-o),a.y=s.y*l+i.y*(1-l),a.z=s.z*h+i.z*(1-h);const c=e.dot(a);n=Math.min(c,n),r=Math.max(c,r)}this.min=n,this.max=r}}();const ad=function(){const a=new L,e=new L,t=new L;return function(s,i,n){const r=s.start,o=a,l=i.start,h=e;t.subVectors(r,l),a.subVectors(s.end,s.start),e.subVectors(i.end,i.start);const c=t.dot(h),d=h.dot(o),p=h.dot(h),u=t.dot(o),g=o.dot(o)*p-d*d;let m,v;g!==0?m=(c*d-u*p)/g:m=0,v=(c+m*d)/p,n.x=m,n.y=v}}(),Ur=function(){const a=new Ce,e=new L,t=new L;return function(s,i,n,r){ad(s,i,a);let o=a.x,l=a.y;if(o>=0&&o<=1&&l>=0&&l<=1){s.at(o,n),i.at(l,r);return}else if(o>=0&&o<=1){l<0?i.at(0,r):i.at(1,r),s.closestPointToPoint(r,!0,n);return}else if(l>=0&&l<=1){o<0?s.at(0,n):s.at(1,n),i.closestPointToPoint(n,!0,r);return}else{let h;o<0?h=s.start:h=s.end;let c;l<0?c=i.start:c=i.end;const d=e,p=t;if(s.closestPointToPoint(c,!0,e),i.closestPointToPoint(h,!0,t),d.distanceToSquared(c)<=p.distanceToSquared(h)){n.copy(d),r.copy(c);return}else{n.copy(h),r.copy(p);return}}}}(),ld=function(){const a=new L,e=new L,t=new ct,s=new lt;return function(i,n){const{radius:r,center:o}=i,{a:l,b:h,c}=n;if(s.start=l,s.end=h,s.closestPointToPoint(o,!0,a).distanceTo(o)<=r||(s.start=l,s.end=c,s.closestPointToPoint(o,!0,a).distanceTo(o)<=r)||(s.start=h,s.end=c,s.closestPointToPoint(o,!0,a).distanceTo(o)<=r))return!0;const d=n.getPlane(t);if(Math.abs(d.distanceToPoint(o))<=r){const p=d.projectPoint(o,e);if(n.containsPoint(p))return!0}return!1}}(),hd=1e-15;function Fn(a){return Math.abs(a)<hd}class Et extends oi{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new L),this.satBounds=new Array(4).fill().map(()=>new Vt),this.points=[this.a,this.b,this.c],this.sphere=new fs,this.plane=new ct,this.needsUpdate=!0}intersectsSphere(e){return ld(e,this)}update(){const e=this.a,t=this.b,s=this.c,i=this.points,n=this.satAxes,r=this.satBounds,o=n[0],l=r[0];this.getNormal(o),l.setFromPoints(o,i);const h=n[1],c=r[1];h.subVectors(e,t),c.setFromPoints(h,i);const d=n[2],p=r[2];d.subVectors(t,s),p.setFromPoints(d,i);const u=n[3],g=r[3];u.subVectors(s,e),g.setFromPoints(u,i),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}}Et.prototype.closestPointToSegment=function(){const a=new L,e=new L,t=new lt;return function(s,i=null,n=null){const{start:r,end:o}=s,l=this.points;let h,c=1/0;for(let d=0;d<3;d++){const p=(d+1)%3;t.start.copy(l[d]),t.end.copy(l[p]),Ur(t,s,a,e),h=a.distanceToSquared(e),h<c&&(c=h,i&&i.copy(a),n&&n.copy(e))}return this.closestPointToPoint(r,a),h=r.distanceToSquared(a),h<c&&(c=h,i&&i.copy(a),n&&n.copy(r)),this.closestPointToPoint(o,a),h=o.distanceToSquared(a),h<c&&(c=h,i&&i.copy(a),n&&n.copy(o)),Math.sqrt(c)}}();Et.prototype.intersectsTriangle=function(){const a=new Et,e=new Array(3),t=new Array(3),s=new Vt,i=new Vt,n=new L,r=new L,o=new L,l=new L,h=new L,c=new lt,d=new lt,p=new lt,u=new L;function g(m,v,f){const y=m.points;let _=0,x=-1;for(let C=0;C<3;C++){const{start:P,end:A}=c;P.copy(y[C]),A.copy(y[(C+1)%3]),c.delta(r);const k=Fn(v.distanceToPoint(P));if(Fn(v.normal.dot(r))&&k){f.copy(c),_=2;break}const M=v.intersectLine(c,u);if(!M&&k&&u.copy(P),(M||k)&&!Fn(u.distanceTo(A))){if(_<=1)(_===1?f.start:f.end).copy(u),k&&(x=_);else if(_>=2){(x===1?f.start:f.end).copy(u),_=2;break}if(_++,_===2&&x===-1)break}}return _}return function(m,v=null,f=!1){this.needsUpdate&&this.update(),m.isExtendedTriangle?m.needsUpdate&&m.update():(a.copy(m),a.update(),m=a);const y=this.plane,_=m.plane;if(Math.abs(y.normal.dot(_.normal))>1-1e-10){const x=this.satBounds,C=this.satAxes;t[0]=m.a,t[1]=m.b,t[2]=m.c;for(let k=0;k<4;k++){const M=x[k],I=C[k];if(s.setFromPoints(I,t),M.isSeparated(s))return!1}const P=m.satBounds,A=m.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let k=0;k<4;k++){const M=P[k],I=A[k];if(s.setFromPoints(I,e),M.isSeparated(s))return!1}for(let k=0;k<4;k++){const M=C[k];for(let I=0;I<4;I++){const R=A[I];if(n.crossVectors(M,R),s.setFromPoints(n,e),i.setFromPoints(n,t),s.isSeparated(i))return!1}}return v&&(f||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),v.start.set(0,0,0),v.end.set(0,0,0)),!0}else{const x=g(this,_,d);if(x===1&&m.containsPoint(d.end))return v&&(v.start.copy(d.end),v.end.copy(d.end)),!0;if(x!==2)return!1;const C=g(m,y,p);if(C===1&&this.containsPoint(p.end))return v&&(v.start.copy(p.end),v.end.copy(p.end)),!0;if(C!==2)return!1;if(d.delta(o),p.delta(l),o.dot(l)<0){let T=p.start;p.start=p.end,p.end=T}const P=d.start.dot(o),A=d.end.dot(o),k=p.start.dot(o),M=p.end.dot(o),I=A<k,R=P<M;return P!==M&&k!==A&&I===R?!1:(v&&(h.subVectors(d.start,p.start),h.dot(o)>0?v.start.copy(d.start):v.start.copy(p.start),h.subVectors(d.end,p.end),h.dot(o)<0?v.end.copy(d.end):v.end.copy(p.end)),!0)}}}();Et.prototype.distanceToPoint=function(){const a=new L;return function(e){return this.closestPointToPoint(e,a),e.distanceTo(a)}}();Et.prototype.distanceToTriangle=function(){const a=new L,e=new L,t=["a","b","c"],s=new lt,i=new lt;return function(n,r=null,o=null){const l=r||o?s:null;if(this.intersectsTriangle(n,l))return(r||o)&&(r&&l.getCenter(r),o&&l.getCenter(o)),0;let h=1/0;for(let c=0;c<3;c++){let d;const p=t[c],u=n[p];this.closestPointToPoint(u,a),d=u.distanceToSquared(a),d<h&&(h=d,r&&r.copy(a),o&&o.copy(u));const g=this[p];n.closestPointToPoint(g,a),d=g.distanceToSquared(a),d<h&&(h=d,r&&r.copy(g),o&&o.copy(a))}for(let c=0;c<3;c++){const d=t[c],p=t[(c+1)%3];s.set(this[d],this[p]);for(let u=0;u<3;u++){const g=t[u],m=t[(u+1)%3];i.set(n[g],n[m]),Ur(s,i,a,e);const v=a.distanceToSquared(e);v<h&&(h=v,r&&r.copy(a),o&&o.copy(e))}}return Math.sqrt(h)}}();class tt{constructor(e,t,s){this.isOrientedBox=!0,this.min=new L,this.max=new L,this.matrix=new Pe,this.invMatrix=new Pe,this.points=new Array(8).fill().map(()=>new L),this.satAxes=new Array(3).fill().map(()=>new L),this.satBounds=new Array(3).fill().map(()=>new Vt),this.alignedSatBounds=new Array(3).fill().map(()=>new Vt),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),s&&this.matrix.copy(s)}set(e,t,s){this.min.copy(e),this.max.copy(t),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}tt.prototype.update=function(){return function(){const a=this.matrix,e=this.min,t=this.max,s=this.points;for(let l=0;l<=1;l++)for(let h=0;h<=1;h++)for(let c=0;c<=1;c++){const d=1*l|2*h|4*c,p=s[d];p.x=l?t.x:e.x,p.y=h?t.y:e.y,p.z=c?t.z:e.z,p.applyMatrix4(a)}const i=this.satBounds,n=this.satAxes,r=s[0];for(let l=0;l<3;l++){const h=n[l],c=i[l],d=1<<l,p=s[d];h.subVectors(r,p),c.setFromPoints(h,s)}const o=this.alignedSatBounds;o[0].setFromPointsField(s,"x"),o[1].setFromPointsField(s,"y"),o[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();tt.prototype.intersectsBox=function(){const a=new Vt;return function(e){this.needsUpdate&&this.update();const t=e.min,s=e.max,i=this.satBounds,n=this.satAxes,r=this.alignedSatBounds;if(a.min=t.x,a.max=s.x,r[0].isSeparated(a)||(a.min=t.y,a.max=s.y,r[1].isSeparated(a))||(a.min=t.z,a.max=s.z,r[2].isSeparated(a)))return!1;for(let o=0;o<3;o++){const l=n[o],h=i[o];if(a.setFromBox(l,e),h.isSeparated(a))return!1}return!0}}();tt.prototype.intersectsTriangle=function(){const a=new Et,e=new Array(3),t=new Vt,s=new Vt,i=new L;return function(n){this.needsUpdate&&this.update(),n.isExtendedTriangle?n.needsUpdate&&n.update():(a.copy(n),a.update(),n=a);const r=this.satBounds,o=this.satAxes;e[0]=n.a,e[1]=n.b,e[2]=n.c;for(let d=0;d<3;d++){const p=r[d],u=o[d];if(t.setFromPoints(u,e),p.isSeparated(t))return!1}const l=n.satBounds,h=n.satAxes,c=this.points;for(let d=0;d<3;d++){const p=l[d],u=h[d];if(t.setFromPoints(u,c),p.isSeparated(t))return!1}for(let d=0;d<3;d++){const p=o[d];for(let u=0;u<4;u++){const g=h[u];if(i.crossVectors(p,g),t.setFromPoints(i,e),s.setFromPoints(i,c),t.isSeparated(s))return!1}}return!0}}();tt.prototype.closestPointToPoint=function(){return function(a,e){return this.needsUpdate&&this.update(),e.copy(a).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),e}}();tt.prototype.distanceToPoint=function(){const a=new L;return function(e){return this.closestPointToPoint(e,a),e.distanceTo(a)}}();tt.prototype.distanceToBox=function(){const a=["x","y","z"],e=new Array(12).fill().map(()=>new lt),t=new Array(12).fill().map(()=>new lt),s=new L,i=new L;return function(n,r=0,o=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(n))return(o||l)&&(n.getCenter(i),this.closestPointToPoint(i,s),n.closestPointToPoint(s,i),o&&o.copy(s),l&&l.copy(i)),0;const h=r*r,c=n.min,d=n.max,p=this.points;let u=1/0;for(let m=0;m<8;m++){const v=p[m];i.copy(v).clamp(c,d);const f=v.distanceToSquared(i);if(f<u&&(u=f,o&&o.copy(v),l&&l.copy(i),f<h))return Math.sqrt(f)}let g=0;for(let m=0;m<3;m++)for(let v=0;v<=1;v++)for(let f=0;f<=1;f++){const y=(m+1)%3,_=(m+2)%3,x=v<<y|f<<_,C=1<<m|v<<y|f<<_,P=p[x],A=p[C];e[g].set(P,A);const k=a[m],M=a[y],I=a[_],R=t[g],T=R.start,z=R.end;T[k]=c[k],T[M]=v?c[M]:d[M],T[I]=f?c[I]:d[M],z[k]=d[k],z[M]=v?c[M]:d[M],z[I]=f?c[I]:d[M],g++}for(let m=0;m<=1;m++)for(let v=0;v<=1;v++)for(let f=0;f<=1;f++){i.x=m?d.x:c.x,i.y=v?d.y:c.y,i.z=f?d.z:c.z,this.closestPointToPoint(i,s);const y=i.distanceToSquared(s);if(y<u&&(u=y,o&&o.copy(s),l&&l.copy(i),y<h))return Math.sqrt(y)}for(let m=0;m<12;m++){const v=e[m];for(let f=0;f<12;f++){const y=t[f];Ur(v,y,s,i);const _=s.distanceToSquared(i);if(_<u&&(u=_,o&&o.copy(s),l&&l.copy(i),_<h))return Math.sqrt(_)}}return Math.sqrt(u)}}();class Br{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class cd extends Br{constructor(){super(()=>new Et)}}const ut=new cd;function ot(a,e){return e[a+15]===65535}function at(a,e){return e[a+6]}function pt(a,e){return e[a+14]}function ft(a){return a+8}function mt(a,e){return e[a+6]}function Ga(a,e){return e[a+7]}class dd{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=s=>{t&&e.push(t),t=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const Ae=new dd;let Kt,Ns;const Es=[],zi=new Br(()=>new Ue);function ud(a,e,t,s,i,n){Kt=zi.getPrimitive(),Ns=zi.getPrimitive(),Es.push(Kt,Ns),Ae.setBuffer(a._roots[e]);const r=cr(0,a.geometry,t,s,i,n);Ae.clearBuffer(),zi.releasePrimitive(Kt),zi.releasePrimitive(Ns),Es.pop(),Es.pop();const o=Es.length;return o>0&&(Ns=Es[o-1],Kt=Es[o-2]),r}function cr(a,e,t,s,i=null,n=0,r=0){const{float32Array:o,uint16Array:l,uint32Array:h}=Ae;let c=a*2;if(ot(c,l)){const d=at(a,h),p=pt(c,l);return ze(a,o,Kt),s(d,p,!1,r,n+a,Kt)}else{let d=function(R){const{uint16Array:T,uint32Array:z}=Ae;let b=R*2;for(;!ot(b,T);)R=ft(R),b=R*2;return at(R,z)},p=function(R){const{uint16Array:T,uint32Array:z}=Ae;let b=R*2;for(;!ot(b,T);)R=mt(R,z),b=R*2;return at(R,z)+pt(b,T)};const u=ft(a),g=mt(a,h);let m=u,v=g,f,y,_,x;if(i&&(_=Kt,x=Ns,ze(m,o,_),ze(v,o,x),f=i(_),y=i(x),y<f)){m=g,v=u;const R=f;f=y,y=R,_=x}_||(_=Kt,ze(m,o,_));const C=ot(m*2,l),P=t(_,C,f,r+1,n+m);let A;if(P===po){const R=d(m),T=p(m)-R;A=s(R,T,!0,r+1,n+m,_)}else A=P&&cr(m,e,t,s,i,n,r+1);if(A)return!0;x=Ns,ze(v,o,x);const k=ot(v*2,l),M=t(x,k,y,r+1,n+v);let I;if(M===po){const R=d(v),T=p(v)-R;I=s(R,T,!0,r+1,n+v,x)}else I=M&&cr(v,e,t,s,i,n,r+1);return!!I}}const $s=new L,Vn=new L;function pd(a,e,t={},s=0,i=1/0){const n=s*s,r=i*i;let o=1/0,l=null;if(a.shapecast({boundsTraverseOrder:c=>($s.copy(e).clamp(c.min,c.max),$s.distanceToSquared(e)),intersectsBounds:(c,d,p)=>p<o&&p<r,intersectsTriangle:(c,d)=>{c.closestPointToPoint(e,$s);const p=e.distanceToSquared($s);return p<o&&(Vn.copy($s),o=p,l=d),p<n}}),o===1/0)return null;const h=Math.sqrt(o);return t.point?t.point.copy(Vn):t.point=Vn.clone(),t.distance=h,t.faceIndex=l,t}const Ss=new L,Cs=new L,Ts=new L,ki=new Ce,Ii=new Ce,Li=new Ce,yo=new L,_o=new L,wo=new L,Ni=new L;function fd(a,e,t,s,i,n){let r;return n===Hl?r=a.intersectTriangle(s,t,e,!0,i):r=a.intersectTriangle(e,t,s,n!==Ft,i),r===null?null:{distance:a.origin.distanceTo(i),point:i.clone()}}function md(a,e,t,s,i,n,r,o,l){Ss.fromBufferAttribute(e,n),Cs.fromBufferAttribute(e,r),Ts.fromBufferAttribute(e,o);const h=fd(a,Ss,Cs,Ts,Ni,l);if(h){s&&(ki.fromBufferAttribute(s,n),Ii.fromBufferAttribute(s,r),Li.fromBufferAttribute(s,o),h.uv=oi.getInterpolation(Ni,Ss,Cs,Ts,ki,Ii,Li,new Ce)),i&&(ki.fromBufferAttribute(i,n),Ii.fromBufferAttribute(i,r),Li.fromBufferAttribute(i,o),h.uv1=oi.getInterpolation(Ni,Ss,Cs,Ts,ki,Ii,Li,new Ce)),t&&(yo.fromBufferAttribute(t,n),_o.fromBufferAttribute(t,r),wo.fromBufferAttribute(t,o),h.normal=oi.getInterpolation(Ni,Ss,Cs,Ts,yo,_o,wo,new L),h.normal.dot(a.direction)>0&&h.normal.multiplyScalar(-1));const c={a:n,b:r,c:o,normal:new L,materialIndex:0};oi.getNormal(Ss,Cs,Ts,c.normal),h.face=c,h.faceIndex=n}return h}function Tn(a,e,t,s,i){const n=s*3;let r=n+0,o=n+1,l=n+2;const h=a.index;a.index&&(r=h.getX(r),o=h.getX(o),l=h.getX(l));const{position:c,normal:d,uv:p,uv1:u}=a.attributes,g=md(t,c,d,p,u,r,o,l,e);return g?(g.faceIndex=s,i&&i.push(g),g):null}function Re(a,e,t,s){const i=a.a,n=a.b,r=a.c;let o=e,l=e+1,h=e+2;t&&(o=t.getX(o),l=t.getX(l),h=t.getX(h)),i.x=s.getX(o),i.y=s.getY(o),i.z=s.getZ(o),n.x=s.getX(l),n.y=s.getY(l),n.z=s.getZ(l),r.x=s.getX(h),r.y=s.getY(h),r.z=s.getZ(h)}function gd(a,e,t,s,i,n){const{geometry:r,_indirectBuffer:o}=a;for(let l=s,h=s+i;l<h;l++)Tn(r,e,t,l,n)}function vd(a,e,t,s,i){const{geometry:n,_indirectBuffer:r}=a;let o=1/0,l=null;for(let h=s,c=s+i;h<c;h++){let d;d=Tn(n,e,t,h),d&&d.distance<o&&(l=d,o=d.distance)}return l}function yd(a,e,t,s,i,n,r){const{geometry:o}=t,{index:l}=o,h=o.attributes.position;for(let c=a,d=e+a;c<d;c++){let p;if(p=c,Re(r,p*3,l,h),r.needsUpdate=!0,s(r,p,i,n))return!0}return!1}function _d(a,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=a.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let n,r,o,l,h=0;const c=a._roots;for(let p=0,u=c.length;p<u;p++)n=c[p],r=new Uint32Array(n),o=new Uint16Array(n),l=new Float32Array(n),d(0,h),h+=n.byteLength;function d(p,u,g=!1){const m=p*2;if(o[m+15]===Cn){const v=r[p+6],f=o[m+14];let y=1/0,_=1/0,x=1/0,C=-1/0,P=-1/0,A=-1/0;for(let k=3*v,M=3*(v+f);k<M;k++){let I=s[k];const R=i.getX(I),T=i.getY(I),z=i.getZ(I);R<y&&(y=R),R>C&&(C=R),T<_&&(_=T),T>P&&(P=T),z<x&&(x=z),z>A&&(A=z)}return l[p+0]!==y||l[p+1]!==_||l[p+2]!==x||l[p+3]!==C||l[p+4]!==P||l[p+5]!==A?(l[p+0]=y,l[p+1]=_,l[p+2]=x,l[p+3]=C,l[p+4]=P,l[p+5]=A,!0):!1}else{const v=p+8,f=r[p+6],y=v+u,_=f+u;let x=g,C=!1,P=!1;e?x||(C=e.has(y),P=e.has(_),x=!C&&!P):(C=!0,P=!0);const A=x||C,k=x||P;let M=!1;A&&(M=d(v,u,x));let I=!1;k&&(I=d(f,u,x));const R=M||I;if(R)for(let T=0;T<3;T++){const z=v+T,b=f+T,B=l[z],q=l[z+3],G=l[b],te=l[b+3];l[p+T]=B<G?B:G,l[p+T+3]=q>te?q:te}return R}}}const bo=new Ue;function ts(a,e,t,s){return ze(a,e,bo),t.intersectBox(bo,s)}function wd(a,e,t,s,i,n){const{geometry:r,_indirectBuffer:o}=a;for(let l=s,h=s+i;l<h;l++){let c=o?o[l]:l;Tn(r,e,t,c,n)}}function bd(a,e,t,s,i){const{geometry:n,_indirectBuffer:r}=a;let o=1/0,l=null;for(let h=s,c=s+i;h<c;h++){let d;d=Tn(n,e,t,r?r[h]:h),d&&d.distance<o&&(l=d,o=d.distance)}return l}function xd(a,e,t,s,i,n,r){const{geometry:o}=t,{index:l}=o,h=o.attributes.position;for(let c=a,d=e+a;c<d;c++){let p;if(p=t.resolveTriangleIndex(c),Re(r,p*3,l,h),r.needsUpdate=!0,s(r,p,i,n))return!0}return!1}const xo=new L;function Ed(a,e,t,s,i){Ae.setBuffer(a._roots[e]),dr(0,a,t,s,i),Ae.clearBuffer()}function dr(a,e,t,s,i){const{float32Array:n,uint16Array:r,uint32Array:o}=Ae,l=a*2;if(ot(l,r)){const h=at(a,o),c=pt(l,r);gd(e,t,s,h,c,i)}else{const h=ft(a);ts(h,n,s,xo)&&dr(h,e,t,s,i);const c=mt(a,o);ts(c,n,s,xo)&&dr(c,e,t,s,i)}}const Eo=new L,Sd=["x","y","z"];function Cd(a,e,t,s){Ae.setBuffer(a._roots[e]);const i=ur(0,a,t,s);return Ae.clearBuffer(),i}function ur(a,e,t,s){const{float32Array:i,uint16Array:n,uint32Array:r}=Ae;let o=a*2;if(ot(o,n)){const l=at(a,r),h=pt(o,n);return vd(e,t,s,l,h)}else{const l=Ga(a,r),h=Sd[l],c=s.direction[h]>=0;let d,p;c?(d=ft(a),p=mt(a,r)):(d=mt(a,r),p=ft(a));const u=ts(d,i,s,Eo)?ur(d,e,t,s):null;if(u){const m=u.point[h];if(c?m<=i[p+l]:m>=i[p+l+3])return u}const g=ts(p,i,s,Eo)?ur(p,e,t,s):null;return u&&g?u.distance<=g.distance?u:g:u||g||null}}const Ui=new Ue,Ps=new Et,As=new Et,ei=new Pe,So=new tt,Bi=new tt;function Td(a,e,t,s){Ae.setBuffer(a._roots[e]);const i=pr(0,a,t,s);return Ae.clearBuffer(),i}function pr(a,e,t,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:o}=Ae;let l=a*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),So.set(t.boundingBox.min,t.boundingBox.max,s),i=So),ot(l,r)){const h=e.geometry,c=h.index,d=h.attributes.position,p=t.index,u=t.attributes.position,g=at(a,o),m=pt(l,r);if(ei.copy(s).invert(),t.boundsTree)return ze(a,n,Bi),Bi.matrix.copy(ei),Bi.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>Bi.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(s),v.b.applyMatrix4(s),v.c.applyMatrix4(s),v.needsUpdate=!0;for(let f=g*3,y=(m+g)*3;f<y;f+=3)if(Re(As,f,c,d),As.needsUpdate=!0,v.intersectsTriangle(As))return!0;return!1}});for(let v=g*3,f=(m+g)*3;v<f;v+=3){Re(Ps,v,c,d),Ps.a.applyMatrix4(ei),Ps.b.applyMatrix4(ei),Ps.c.applyMatrix4(ei),Ps.needsUpdate=!0;for(let y=0,_=p.count;y<_;y+=3)if(Re(As,y,p,u),As.needsUpdate=!0,Ps.intersectsTriangle(As))return!0}}else{const h=a+8,c=o[a+6];return ze(h,n,Ui),!!(i.intersectsBox(Ui)&&pr(h,e,t,s,i)||(ze(c,n,Ui),i.intersectsBox(Ui)&&pr(c,e,t,s,i)))}}const Ri=new Pe,jn=new tt,ti=new tt,Pd=new L,Ad=new L,Md=new L,Od=new L;function Dd(a,e,t,s={},i={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),jn.set(e.boundingBox.min,e.boundingBox.max,t),jn.needsUpdate=!0;const o=a.geometry,l=o.attributes.position,h=o.index,c=e.attributes.position,d=e.index,p=ut.getPrimitive(),u=ut.getPrimitive();let g=Pd,m=Ad,v=null,f=null;i&&(v=Md,f=Od);let y=1/0,_=null,x=null;return Ri.copy(t).invert(),ti.matrix.copy(Ri),a.shapecast({boundsTraverseOrder:C=>jn.distanceToBox(C),intersectsBounds:(C,P,A)=>A<y&&A<r?(P&&(ti.min.copy(C.min),ti.max.copy(C.max),ti.needsUpdate=!0),!0):!1,intersectsRange:(C,P)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:A=>ti.distanceToBox(A),intersectsBounds:(A,k,M)=>M<y&&M<r,intersectsRange:(A,k)=>{for(let M=A,I=A+k;M<I;M++){Re(u,3*M,d,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let R=C,T=C+P;R<T;R++){Re(p,3*R,h,l),p.needsUpdate=!0;const z=p.distanceToTriangle(u,g,v);if(z<y&&(m.copy(g),f&&f.copy(v),y=z,_=R,x=M),z<n)return!0}}}});{const A=Fs(e);for(let k=0,M=A;k<M;k++){Re(u,3*k,d,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let I=C,R=C+P;I<R;I++){Re(p,3*I,h,l),p.needsUpdate=!0;const T=p.distanceToTriangle(u,g,v);if(T<y&&(m.copy(g),f&&f.copy(v),y=T,_=I,x=k),T<n)return!0}}}}}),ut.releasePrimitive(p),ut.releasePrimitive(u),y===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=y,s.faceIndex=_,i&&(i.point?i.point.copy(f):i.point=f.clone(),i.point.applyMatrix4(Ri),m.applyMatrix4(Ri),i.distance=m.sub(i.point).length(),i.faceIndex=x),s)}function zd(a,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=a.geometry,s=t.index?t.index.array:null,i=t.attributes.position;let n,r,o,l,h=0;const c=a._roots;for(let p=0,u=c.length;p<u;p++)n=c[p],r=new Uint32Array(n),o=new Uint16Array(n),l=new Float32Array(n),d(0,h),h+=n.byteLength;function d(p,u,g=!1){const m=p*2;if(o[m+15]===Cn){const v=r[p+6],f=o[m+14];let y=1/0,_=1/0,x=1/0,C=-1/0,P=-1/0,A=-1/0;for(let k=v,M=v+f;k<M;k++){const I=3*a.resolveTriangleIndex(k);for(let R=0;R<3;R++){let T=I+R;T=s?s[T]:T;const z=i.getX(T),b=i.getY(T),B=i.getZ(T);z<y&&(y=z),z>C&&(C=z),b<_&&(_=b),b>P&&(P=b),B<x&&(x=B),B>A&&(A=B)}}return l[p+0]!==y||l[p+1]!==_||l[p+2]!==x||l[p+3]!==C||l[p+4]!==P||l[p+5]!==A?(l[p+0]=y,l[p+1]=_,l[p+2]=x,l[p+3]=C,l[p+4]=P,l[p+5]=A,!0):!1}else{const v=p+8,f=r[p+6],y=v+u,_=f+u;let x=g,C=!1,P=!1;e?x||(C=e.has(y),P=e.has(_),x=!C&&!P):(C=!0,P=!0);const A=x||C,k=x||P;let M=!1;A&&(M=d(v,u,x));let I=!1;k&&(I=d(f,u,x));const R=M||I;if(R)for(let T=0;T<3;T++){const z=v+T,b=f+T,B=l[z],q=l[z+3],G=l[b],te=l[b+3];l[p+T]=B<G?B:G,l[p+T+3]=q>te?q:te}return R}}}const Co=new L;function kd(a,e,t,s,i){Ae.setBuffer(a._roots[e]),fr(0,a,t,s,i),Ae.clearBuffer()}function fr(a,e,t,s,i){const{float32Array:n,uint16Array:r,uint32Array:o}=Ae,l=a*2;if(ot(l,r)){const h=at(a,o),c=pt(l,r);wd(e,t,s,h,c,i)}else{const h=ft(a);ts(h,n,s,Co)&&fr(h,e,t,s,i);const c=mt(a,o);ts(c,n,s,Co)&&fr(c,e,t,s,i)}}const To=new L,Id=["x","y","z"];function Ld(a,e,t,s){Ae.setBuffer(a._roots[e]);const i=mr(0,a,t,s);return Ae.clearBuffer(),i}function mr(a,e,t,s){const{float32Array:i,uint16Array:n,uint32Array:r}=Ae;let o=a*2;if(ot(o,n)){const l=at(a,r),h=pt(o,n);return bd(e,t,s,l,h)}else{const l=Ga(a,r),h=Id[l],c=s.direction[h]>=0;let d,p;c?(d=ft(a),p=mt(a,r)):(d=mt(a,r),p=ft(a));const u=ts(d,i,s,To)?mr(d,e,t,s):null;if(u){const m=u.point[h];if(c?m<=i[p+l]:m>=i[p+l+3])return u}const g=ts(p,i,s,To)?mr(p,e,t,s):null;return u&&g?u.distance<=g.distance?u:g:u||g||null}}const Fi=new Ue,Ms=new Et,Os=new Et,si=new Pe,Po=new tt,Vi=new tt;function Nd(a,e,t,s){Ae.setBuffer(a._roots[e]);const i=gr(0,a,t,s);return Ae.clearBuffer(),i}function gr(a,e,t,s,i=null){const{float32Array:n,uint16Array:r,uint32Array:o}=Ae;let l=a*2;if(i===null&&(t.boundingBox||t.computeBoundingBox(),Po.set(t.boundingBox.min,t.boundingBox.max,s),i=Po),ot(l,r)){const h=e.geometry,c=h.index,d=h.attributes.position,p=t.index,u=t.attributes.position,g=at(a,o),m=pt(l,r);if(si.copy(s).invert(),t.boundsTree)return ze(a,n,Vi),Vi.matrix.copy(si),Vi.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>Vi.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(s),v.b.applyMatrix4(s),v.c.applyMatrix4(s),v.needsUpdate=!0;for(let f=g,y=m+g;f<y;f++)if(Re(Os,3*e.resolveTriangleIndex(f),c,d),Os.needsUpdate=!0,v.intersectsTriangle(Os))return!0;return!1}});for(let v=g,f=m+g;v<f;v++){const y=e.resolveTriangleIndex(v);Re(Ms,3*y,c,d),Ms.a.applyMatrix4(si),Ms.b.applyMatrix4(si),Ms.c.applyMatrix4(si),Ms.needsUpdate=!0;for(let _=0,x=p.count;_<x;_+=3)if(Re(Os,_,p,u),Os.needsUpdate=!0,Ms.intersectsTriangle(Os))return!0}}else{const h=a+8,c=o[a+6];return ze(h,n,Fi),!!(i.intersectsBox(Fi)&&gr(h,e,t,s,i)||(ze(c,n,Fi),i.intersectsBox(Fi)&&gr(c,e,t,s,i)))}}const ji=new Pe,Hn=new tt,ii=new tt,Ud=new L,Bd=new L,Rd=new L,Fd=new L;function Vd(a,e,t,s={},i={},n=0,r=1/0){e.boundingBox||e.computeBoundingBox(),Hn.set(e.boundingBox.min,e.boundingBox.max,t),Hn.needsUpdate=!0;const o=a.geometry,l=o.attributes.position,h=o.index,c=e.attributes.position,d=e.index,p=ut.getPrimitive(),u=ut.getPrimitive();let g=Ud,m=Bd,v=null,f=null;i&&(v=Rd,f=Fd);let y=1/0,_=null,x=null;return ji.copy(t).invert(),ii.matrix.copy(ji),a.shapecast({boundsTraverseOrder:C=>Hn.distanceToBox(C),intersectsBounds:(C,P,A)=>A<y&&A<r?(P&&(ii.min.copy(C.min),ii.max.copy(C.max),ii.needsUpdate=!0),!0):!1,intersectsRange:(C,P)=>{if(e.boundsTree){const A=e.boundsTree;return A.shapecast({boundsTraverseOrder:k=>ii.distanceToBox(k),intersectsBounds:(k,M,I)=>I<y&&I<r,intersectsRange:(k,M)=>{for(let I=k,R=k+M;I<R;I++){const T=A.resolveTriangleIndex(I);Re(u,3*T,d,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let z=C,b=C+P;z<b;z++){const B=a.resolveTriangleIndex(z);Re(p,3*B,h,l),p.needsUpdate=!0;const q=p.distanceToTriangle(u,g,v);if(q<y&&(m.copy(g),f&&f.copy(v),y=q,_=z,x=I),q<n)return!0}}}})}else{const A=Fs(e);for(let k=0,M=A;k<M;k++){Re(u,3*k,d,c),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let I=C,R=C+P;I<R;I++){const T=a.resolveTriangleIndex(I);Re(p,3*T,h,l),p.needsUpdate=!0;const z=p.distanceToTriangle(u,g,v);if(z<y&&(m.copy(g),f&&f.copy(v),y=z,_=I,x=k),z<n)return!0}}}}}),ut.releasePrimitive(p),ut.releasePrimitive(u),y===1/0?null:(s.point?s.point.copy(m):s.point=m.clone(),s.distance=y,s.faceIndex=_,i&&(i.point?i.point.copy(f):i.point=f.clone(),i.point.applyMatrix4(ji),m.applyMatrix4(ji),i.distance=m.sub(i.point).length(),i.faceIndex=x),s)}function jd(){return typeof SharedArrayBuffer<"u"}const ui=new Ae.constructor,gn=new Ae.constructor,qt=new Br(()=>new Ue),Ds=new Ue,zs=new Ue,Wn=new Ue,Gn=new Ue;let Yn=!1;function Hd(a,e,t,s){if(Yn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Yn=!0;const i=a._roots,n=e._roots;let r,o=0,l=0;const h=new Pe().copy(t).invert();for(let c=0,d=i.length;c<d;c++){ui.setBuffer(i[c]),l=0;const p=qt.getPrimitive();ze(0,ui.float32Array,p),p.applyMatrix4(h);for(let u=0,g=n.length;u<g&&(gn.setBuffer(n[c]),r=wt(0,0,t,h,s,o,l,0,0,p),gn.clearBuffer(),l+=n[u].length,!r);u++);if(qt.releasePrimitive(p),ui.clearBuffer(),o+=i[c].length,r)break}return Yn=!1,r}function wt(a,e,t,s,i,n=0,r=0,o=0,l=0,h=null,c=!1){let d,p;c?(d=gn,p=ui):(d=ui,p=gn);const u=d.float32Array,g=d.uint32Array,m=d.uint16Array,v=p.float32Array,f=p.uint32Array,y=p.uint16Array,_=a*2,x=e*2,C=ot(_,m),P=ot(x,y);let A=!1;if(P&&C)c?A=i(at(e,f),pt(e*2,y),at(a,g),pt(a*2,m),l,r+e,o,n+a):A=i(at(a,g),pt(a*2,m),at(e,f),pt(e*2,y),o,n+a,l,r+e);else if(P){const k=qt.getPrimitive();ze(e,v,k),k.applyMatrix4(t);const M=ft(a),I=mt(a,g);ze(M,u,Ds),ze(I,u,zs);const R=k.intersectsBox(Ds),T=k.intersectsBox(zs);A=R&&wt(e,M,s,t,i,r,n,l,o+1,k,!c)||T&&wt(e,I,s,t,i,r,n,l,o+1,k,!c),qt.releasePrimitive(k)}else{const k=ft(e),M=mt(e,f);ze(k,v,Wn),ze(M,v,Gn);const I=h.intersectsBox(Wn),R=h.intersectsBox(Gn);if(I&&R)A=wt(a,k,t,s,i,n,r,o,l+1,h,c)||wt(a,M,t,s,i,n,r,o,l+1,h,c);else if(I)if(C)A=wt(a,k,t,s,i,n,r,o,l+1,h,c);else{const T=qt.getPrimitive();T.copy(Wn).applyMatrix4(t);const z=ft(a),b=mt(a,g);ze(z,u,Ds),ze(b,u,zs);const B=T.intersectsBox(Ds),q=T.intersectsBox(zs);A=B&&wt(k,z,s,t,i,r,n,l,o+1,T,!c)||q&&wt(k,b,s,t,i,r,n,l,o+1,T,!c),qt.releasePrimitive(T)}else if(R)if(C)A=wt(a,M,t,s,i,n,r,o,l+1,h,c);else{const T=qt.getPrimitive();T.copy(Gn).applyMatrix4(t);const z=ft(a),b=mt(a,g);ze(z,u,Ds),ze(b,u,zs);const B=T.intersectsBox(Ds),q=T.intersectsBox(zs);A=B&&wt(M,z,s,t,i,r,n,l,o+1,T,!c)||q&&wt(M,b,s,t,i,r,n,l,o+1,T,!c),qt.releasePrimitive(T)}}return A}const Hi=new tt,Ao=new Ue;class Rr{static serialize(e,t={}){t={cloneBuffers:!0,...t};const s=e.geometry,i=e._roots,n=e._indirectBuffer,r=s.getIndex();let o;return t.cloneBuffers?o={roots:i.map(l=>l.slice()),index:r.array.slice(),indirectBuffer:n?n.slice():null}:o={roots:i,index:r.array,indirectBuffer:n},o}static deserialize(e,t,s={}){s={setIndex:!0,indirect:!!e.indirectBuffer,...s};const{index:i,roots:n,indirectBuffer:r}=e,o=new Rr(t,{...s,[Bn]:!0});if(o._roots=n,o._indirectBuffer=r||null,s.setIndex){const l=t.getIndex();if(l===null){const h=new Rt(e.index,1,!1);t.setIndex(h)}else l.array!==i&&(l.array.set(i),l.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({strategy:ja,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[Bn]:!1},t),t.useSharedArrayBuffer&&!jd())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[Bn]||(od(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Ue)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=t.indirect?i=>s[i]:i=>i}refit(e=null){return(this.indirect?zd:_d)(this,e)}traverse(e,t=0){const s=this._roots[t],i=new Uint32Array(s),n=new Uint16Array(s);r(0);function r(o,l=0){const h=o*2,c=n[h+15]===Cn;if(c){const d=i[o+6],p=n[h+14];e(l,c,new Float32Array(s,o*4,6),d,p)}else{const d=o+hn/4,p=i[o+6],u=i[o+7];e(l,c,new Float32Array(s,o*4,6),u)||(r(d,l+1),r(p,l+1))}}}raycast(e,t=Xr){const s=this._roots,i=this.geometry,n=[],r=t.isMaterial,o=Array.isArray(t),l=i.groups,h=r?t.side:t,c=this.indirect?kd:Ed;for(let d=0,p=s.length;d<p;d++){const u=o?t[l[d].materialIndex].side:h,g=n.length;if(c(this,d,u,e,n),o){const m=l[d].materialIndex;for(let v=g,f=n.length;v<f;v++)n[v].face.materialIndex=m}}return n}raycastFirst(e,t=Xr){const s=this._roots,i=this.geometry,n=t.isMaterial,r=Array.isArray(t);let o=null;const l=i.groups,h=n?t.side:t,c=this.indirect?Ld:Cd;for(let d=0,p=s.length;d<p;d++){const u=r?t[l[d].materialIndex].side:h,g=c(this,d,u,e);g!=null&&(o==null||g.distance<o.distance)&&(o=g,r&&(g.face.materialIndex=l[d].materialIndex))}return o}intersectsGeometry(e,t){let s=!1;const i=this._roots,n=this.indirect?Nd:Td;for(let r=0,o=i.length;r<o&&(s=n(this,r,e,t),!s);r++);return s}shapecast(e){const t=ut.getPrimitive(),s=this.indirect?xd:yd;let{boundsTraverseOrder:i,intersectsBounds:n,intersectsRange:r,intersectsTriangle:o}=e;if(r&&o){const d=r;r=(p,u,g,m,v)=>d(p,u,g,m,v)?!0:s(p,u,this,o,g,m,t)}else r||(o?r=(d,p,u,g)=>s(d,p,this,o,u,g,t):r=(d,p,u)=>u);let l=!1,h=0;const c=this._roots;for(let d=0,p=c.length;d<p;d++){const u=c[d];if(l=ud(this,d,n,r,i,h),l)break;h+=u.byteLength}return ut.releasePrimitive(t),l}bvhcast(e,t,s){let{intersectsRanges:i,intersectsTriangles:n}=s;const r=ut.getPrimitive(),o=this.geometry.index,l=this.geometry.attributes.position,h=this.indirect?g=>{const m=this.resolveTriangleIndex(g);Re(r,m*3,o,l)}:g=>{Re(r,g*3,o,l)},c=ut.getPrimitive(),d=e.geometry.index,p=e.geometry.attributes.position,u=e.indirect?g=>{const m=e.resolveTriangleIndex(g);Re(c,m*3,d,p)}:g=>{Re(c,g*3,d,p)};if(n){const g=(m,v,f,y,_,x,C,P)=>{for(let A=f,k=f+y;A<k;A++){u(A),c.a.applyMatrix4(t),c.b.applyMatrix4(t),c.c.applyMatrix4(t),c.needsUpdate=!0;for(let M=m,I=m+v;M<I;M++)if(h(M),r.needsUpdate=!0,n(r,c,M,A,_,x,C,P))return!0}return!1};if(i){const m=i;i=function(v,f,y,_,x,C,P,A){return m(v,f,y,_,x,C,P,A)?!0:g(v,f,y,_,x,C,P,A)}}else i=g}return Hd(this,e,t,i)}intersectsBox(e,t){return Hi.set(e.min,e.max,t),Hi.needsUpdate=!0,this.shapecast({intersectsBounds:s=>Hi.intersectsBox(s),intersectsTriangle:s=>Hi.intersectsTriangle(s)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,s={},i={},n=0,r=1/0){return(this.indirect?Vd:Dd)(this,e,t,s,i,n,r)}closestPointToPoint(e,t={},s=0,i=1/0){return pd(this,e,t,s,i)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(t=>{ze(0,new Float32Array(t),Ao),e.union(Ao)}),e}}function Mo(a,e,t){return a===null||(a.point.applyMatrix4(e.matrixWorld),a.distance=a.point.distanceTo(t.ray.origin),a.object=e,a.distance<t.near||a.distance>t.far)?null:a}const Zn=new Ol,Oo=new Pe,Wd=ie.prototype.raycast;function Gd(a,e){if(this.geometry.boundsTree){if(this.material===void 0)return;Oo.copy(this.matrixWorld).invert(),Zn.copy(a.ray).applyMatrix4(Oo);const t=this.geometry.boundsTree;if(a.firstHitOnly===!0){const s=Mo(t.raycastFirst(Zn,this.material),this,a);s&&e.push(s)}else{const s=t.raycast(Zn,this.material);for(let i=0,n=s.length;i<n;i++){const r=Mo(s[i],this,a);r&&e.push(r)}}}else Wd.call(this,a,e)}function Yd(a){return this.boundsTree=new Rr(this,a),this.boundsTree}function Zd(){this.boundsTree=null}const Ya=class Za{constructor(){E(this,"onDisposed",new K),E(this,"list",new be),E(this,"enabled",!1),E(this,"_clock"),E(this,"onInit",new K),E(this,"update",()=>{if(!this.enabled)return;const e=this._clock.getDelta();for(const[t,s]of this.list)s.enabled&&s.isUpdateable()&&s.update(e);requestAnimationFrame(this.update)}),this._clock=new ra,Za.setupBVH()}add(e,t){if(this.list.has(e))throw new Error("You're trying to add a component that already exists in the components instance. Use Components.get() instead.");Ze.validate(e),this.list.set(e,t)}get(e){var t;const s=e.uuid;if(!this.list.has(s)){const i=new e(this);return(t=i.isDisposeable)!=null&&t.call(i)&&i.onDisposed.add(()=>this.list.delete(s)),this.list.has(s)||this.add(s,i),i}return this.list.get(s)}init(){this.enabled=!0;for(const[e,t]of this.list.entries())t.enabled=!0;this._clock.start(),this.update(),this.onInit.trigger()}dispose(){this.enabled=!1;let e;for(const[t,s]of this.list){if(s.enabled=!1,t===le.uuid){e=s;continue}s.isDisposeable()&&s.dispose()}e==null||e.dispose(),this._clock.stop(),this.onDisposed.trigger()}static setupBVH(){rt.prototype.computeBoundsTree=Yd,rt.prototype.disposeBoundsTree=Zd,ie.prototype.raycast=Gd}};E(Ya,"release","2.4.3");let Xa=Ya;class Xd{constructor(e){E(this,"enabled",!1),E(this,"id","FirstPerson"),this.camera=e}set(e){if(this.enabled=e,e){if(this.camera.projection.current!=="Perspective"){this.camera.set("Orbit");return}this.setupFirstPersonCamera()}}setupFirstPersonCamera(){const e=this.camera.controls,t=new L;e.distance--,e.getPosition(t),e.minDistance=1,e.maxDistance=1,e.distance=1,e.moveTo(t.x,t.y,t.z),e.truckSpeed=50,e.mouseButtons.wheel=Ke.ACTION.DOLLY,e.touches.two=Ke.ACTION.TOUCH_ZOOM_TRUCK}}class qd{constructor(e){E(this,"enabled",!0),E(this,"id","Orbit"),this.camera=e,this.activateOrbitControls()}set(e){this.enabled=e,e&&this.activateOrbitControls()}activateOrbitControls(){const e=this.camera.controls;e.minDistance=1,e.maxDistance=300;const t=new L;e.getPosition(t);const s=t.length();e.distance=s,e.truckSpeed=2;const{rotation:i}=this.camera.three,n=new L(0,0,-1).applyEuler(i),r=t.addScaledVector(n,s);e.moveTo(r.x,r.y,r.z)}}class Qd{constructor(e){E(this,"enabled",!1),E(this,"id","Plan"),E(this,"mouseAction1"),E(this,"mouseAction2"),E(this,"mouseInitialized",!1),E(this,"defaultAzimuthSpeed"),E(this,"defaultPolarSpeed"),this.camera=e,this.defaultAzimuthSpeed=e.controls.azimuthRotateSpeed,this.defaultPolarSpeed=e.controls.polarRotateSpeed}set(e){this.enabled=e;const t=this.camera.controls;t.azimuthRotateSpeed=e?0:this.defaultAzimuthSpeed,t.polarRotateSpeed=e?0:this.defaultPolarSpeed,this.mouseInitialized||(this.mouseAction1=t.touches.one,this.mouseAction2=t.touches.two,this.mouseInitialized=!0),e?(t.mouseButtons.left=Ke.ACTION.TRUCK,t.touches.one=Ke.ACTION.TOUCH_TRUCK,t.touches.two=Ke.ACTION.TOUCH_ZOOM):(t.mouseButtons.left=Ke.ACTION.ROTATE,t.touches.one=this.mouseAction1,t.touches.two=this.mouseAction2)}}class Kd{constructor(e){E(this,"onChanged",new K),E(this,"current","Perspective"),E(this,"camera"),E(this,"matchOrthoDistanceEnabled",!1),E(this,"_component"),E(this,"_previousDistance",-1),this._component=e,this.camera=e.three}async set(e){this.current!==e&&(e==="Orthographic"?this.setOrthoCamera():await this.setPerspectiveCamera(),this.onChanged.trigger(this.camera))}async toggle(){const e=this.current==="Perspective"?"Orthographic":"Perspective";await this.set(e)}setOrthoCamera(){if(this._component.mode===null||this._component.mode.id==="FirstPerson")return;this._previousDistance=this._component.controls.distance,this._component.controls.distance=200;const e=this.getPerspectiveDims();if(!e)return;const{width:t,height:s}=e;this.setupOrthoCamera(s,t),this.camera=this._component.threeOrtho,this.current="Orthographic"}getPerspectiveDims(){const e=this._component.currentWorld;if(!e||!e.renderer)return null;const t=new L;this._component.threePersp.getWorldDirection(t);const s=new L;this._component.controls.getTarget(s);const i=s.clone().sub(this._component.threePersp.position).dot(t),n=e.renderer.getSize(),r=n.x/n.y,o=this._component.threePersp,l=i*2*Math.atan(o.fov*(Math.PI/180)/2);return{width:l*r,height:l}}setupOrthoCamera(e,t){this._component.controls.mouseButtons.wheel=Ke.ACTION.ZOOM,this._component.controls.mouseButtons.middle=Ke.ACTION.ZOOM;const s=this._component.threePersp,i=this._component.threeOrtho;i.zoom=1,i.left=t/-2,i.right=t/2,i.top=e/2,i.bottom=e/-2,i.updateProjectionMatrix(),i.position.copy(s.position),i.quaternion.copy(s.quaternion),this._component.controls.camera=i}getDistance(){const e=this._component.threePersp,t=this._component.threeOrtho;return(t.top-t.bottom)/t.zoom/(2*Math.atan(e.fov*(Math.PI/180)/2))}async setPerspectiveCamera(){this._component.controls.mouseButtons.wheel=Ke.ACTION.DOLLY,this._component.controls.mouseButtons.middle=Ke.ACTION.DOLLY;const e=this._component.threePersp,t=this._component.threeOrtho;e.position.copy(t.position),e.quaternion.copy(t.quaternion),this._component.controls.mouseButtons.wheel=Ke.ACTION.DOLLY,this.matchOrthoDistanceEnabled?this._component.controls.distance=this.getDistance():this._component.controls.distance=this._previousDistance,await this._component.controls.zoomTo(1),e.updateProjectionMatrix(),this._component.controls.camera=e,this.camera=e,this.current="Perspective"}}class qa extends fi{constructor(e){super(e),E(this,"projection"),E(this,"threeOrtho"),E(this,"threePersp"),E(this,"_userInputButtons",{}),E(this,"_frustumSize",50),E(this,"_navigationModes",new Map),E(this,"_mode",null),E(this,"previousSize",null),this.threePersp=this.three,this.threeOrtho=this.newOrthoCamera(),this.projection=new Kd(this),this.onAspectUpdated.add(()=>{this.setOrthoPerspCameraAspect()}),this.projection.onChanged.add(t=>{this.three=t,this.updateAspect()}),this.worlds.onItemSet.add(()=>{this._navigationModes.clear(),this._navigationModes.set("Orbit",new qd(this)),this._navigationModes.set("FirstPerson",new Xd(this)),this._navigationModes.set("Plan",new Qd(this)),this._mode=this._navigationModes.get("Orbit"),this.mode.set(!0,{preventTargetAdjustment:!0}),this.currentWorld&&this.currentWorld.renderer&&(this.previousSize=this.currentWorld.renderer.getSize().clone())}),this.worlds.onItemDeleted.add(()=>{this._navigationModes.clear()})}get mode(){if(!this._mode)throw new Error("Mode not found, camera not initialized");return this._mode}dispose(){super.dispose(),this.threeOrtho.removeFromParent()}set(e){if(this.mode!==null&&this.mode.id!==e){if(this.mode.set(!1),!this._navigationModes.has(e))throw new Error("The specified mode does not exist!");this._mode=this._navigationModes.get(e),this.mode.set(!0)}}async fit(e,t=1.5){if(!this.enabled)return;const s=Number.MAX_VALUE,i=Number.MIN_VALUE,n=new L(s,s,s),r=new L(i,i,i);for(const u of e){const g=new Ue().setFromObject(u);g.min.x<n.x&&(n.x=g.min.x),g.min.y<n.y&&(n.y=g.min.y),g.min.z<n.z&&(n.z=g.min.z),g.max.x>r.x&&(r.x=g.max.x),g.max.y>r.y&&(r.y=g.max.y),g.max.z>r.z&&(r.z=g.max.z)}const o=new Ue(n,r),l=this.components.get(le);if(l.initialized)for(const[,u]of l.list){const g=u.box;g.min.x<n.x&&(n.x=g.min.x),g.min.y<n.y&&(n.y=g.min.y),g.min.z<n.z&&(n.z=g.min.z),g.max.x>r.x&&(r.x=g.max.x),g.max.y>r.y&&(r.y=g.max.y),g.max.z>r.z&&(r.z=g.max.z)}const h=new L;o.getSize(h);const c=new L;o.getCenter(c);const d=Math.max(h.x,h.y,h.z)*t,p=new fs(c,d);await this.controls.fitToSphere(p,!0)}setUserInput(e){e?this.enableUserInput():this.disableUserInput()}addCustomNavigationMode(e){this._navigationModes.set(e.id,e)}disableUserInput(){this._userInputButtons.left=this.controls.mouseButtons.left,this._userInputButtons.right=this.controls.mouseButtons.right,this._userInputButtons.middle=this.controls.mouseButtons.middle,this._userInputButtons.wheel=this.controls.mouseButtons.wheel,this.controls.mouseButtons.left=0,this.controls.mouseButtons.right=0,this.controls.mouseButtons.middle=0,this.controls.mouseButtons.wheel=0}enableUserInput(){Object.keys(this._userInputButtons).length!==0&&(this.controls.mouseButtons.left=this._userInputButtons.left,this.controls.mouseButtons.right=this._userInputButtons.right,this.controls.mouseButtons.middle=this._userInputButtons.middle,this.controls.mouseButtons.wheel=this._userInputButtons.wheel)}newOrthoCamera(){const e=window.innerWidth/window.innerHeight;return new wn(this._frustumSize*e/-2,this._frustumSize*e/2,this._frustumSize/2,this._frustumSize/-2,.1,1e3)}setOrthoPerspCameraAspect(){if(!this.currentWorld||!this.currentWorld.renderer||!this.previousSize)return;const e=this.currentWorld.renderer.getSize(),t=this.threeOrtho.top,s=this.threeOrtho.right,i=e.y/this.previousSize.y,n=e.x/this.previousSize.x,r=t*i,o=s*n;this.threeOrtho.left=-o,this.threeOrtho.right=o,this.threeOrtho.top=r,this.threeOrtho.bottom=-r,this.threeOrtho.updateProjectionMatrix(),this.previousSize.copy(e)}}function Wi(a){throw new Error('Could not dynamically require "'+a+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Qa={exports:{}};/*!

JSZip v3.10.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/main/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/main/LICENSE
*/(function(a,e){(function(t){a.exports=t()})(function(){return function t(s,i,n){function r(h,c){if(!i[h]){if(!s[h]){var d=typeof Wi=="function"&&Wi;if(!c&&d)return d(h,!0);if(o)return o(h,!0);var p=new Error("Cannot find module '"+h+"'");throw p.code="MODULE_NOT_FOUND",p}var u=i[h]={exports:{}};s[h][0].call(u.exports,function(g){var m=s[h][1][g];return r(m||g)},u,u.exports,t,s,i,n)}return i[h].exports}for(var o=typeof Wi=="function"&&Wi,l=0;l<n.length;l++)r(n[l]);return r}({1:[function(t,s,i){var n=t("./utils"),r=t("./support"),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";i.encode=function(l){for(var h,c,d,p,u,g,m,v=[],f=0,y=l.length,_=y,x=n.getTypeOf(l)!=="string";f<l.length;)_=y-f,d=x?(h=l[f++],c=f<y?l[f++]:0,f<y?l[f++]:0):(h=l.charCodeAt(f++),c=f<y?l.charCodeAt(f++):0,f<y?l.charCodeAt(f++):0),p=h>>2,u=(3&h)<<4|c>>4,g=1<_?(15&c)<<2|d>>6:64,m=2<_?63&d:64,v.push(o.charAt(p)+o.charAt(u)+o.charAt(g)+o.charAt(m));return v.join("")},i.decode=function(l){var h,c,d,p,u,g,m=0,v=0,f="data:";if(l.substr(0,f.length)===f)throw new Error("Invalid base64 input, it looks like a data url.");var y,_=3*(l=l.replace(/[^A-Za-z0-9+/=]/g,"")).length/4;if(l.charAt(l.length-1)===o.charAt(64)&&_--,l.charAt(l.length-2)===o.charAt(64)&&_--,_%1!=0)throw new Error("Invalid base64 input, bad content length.");for(y=r.uint8array?new Uint8Array(0|_):new Array(0|_);m<l.length;)h=o.indexOf(l.charAt(m++))<<2|(p=o.indexOf(l.charAt(m++)))>>4,c=(15&p)<<4|(u=o.indexOf(l.charAt(m++)))>>2,d=(3&u)<<6|(g=o.indexOf(l.charAt(m++))),y[v++]=h,u!==64&&(y[v++]=c),g!==64&&(y[v++]=d);return y}},{"./support":30,"./utils":32}],2:[function(t,s,i){var n=t("./external"),r=t("./stream/DataWorker"),o=t("./stream/Crc32Probe"),l=t("./stream/DataLengthProbe");function h(c,d,p,u,g){this.compressedSize=c,this.uncompressedSize=d,this.crc32=p,this.compression=u,this.compressedContent=g}h.prototype={getContentWorker:function(){var c=new r(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new l("data_length")),d=this;return c.on("end",function(){if(this.streamInfo.data_length!==d.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),c},getCompressedWorker:function(){return new r(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},h.createWorkerFrom=function(c,d,p){return c.pipe(new o).pipe(new l("uncompressedSize")).pipe(d.compressWorker(p)).pipe(new l("compressedSize")).withStreamInfo("compression",d)},s.exports=h},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,s,i){var n=t("./stream/GenericWorker");i.STORE={magic:"\0\0",compressWorker:function(){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},i.DEFLATE=t("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,s,i){var n=t("./utils"),r=function(){for(var o,l=[],h=0;h<256;h++){o=h;for(var c=0;c<8;c++)o=1&o?3988292384^o>>>1:o>>>1;l[h]=o}return l}();s.exports=function(o,l){return o!==void 0&&o.length?n.getTypeOf(o)!=="string"?function(h,c,d,p){var u=r,g=p+d;h^=-1;for(var m=p;m<g;m++)h=h>>>8^u[255&(h^c[m])];return-1^h}(0|l,o,o.length,0):function(h,c,d,p){var u=r,g=p+d;h^=-1;for(var m=p;m<g;m++)h=h>>>8^u[255&(h^c.charCodeAt(m))];return-1^h}(0|l,o,o.length,0):0}},{"./utils":32}],5:[function(t,s,i){i.base64=!1,i.binary=!1,i.dir=!1,i.createFolders=!0,i.date=null,i.compression=null,i.compressionOptions=null,i.comment=null,i.unixPermissions=null,i.dosPermissions=null},{}],6:[function(t,s,i){var n=null;n=typeof Promise<"u"?Promise:t("lie"),s.exports={Promise:n}},{lie:37}],7:[function(t,s,i){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Uint32Array<"u",r=t("pako"),o=t("./utils"),l=t("./stream/GenericWorker"),h=n?"uint8array":"array";function c(d,p){l.call(this,"FlateWorker/"+d),this._pako=null,this._pakoAction=d,this._pakoOptions=p,this.meta={}}i.magic="\b\0",o.inherits(c,l),c.prototype.processChunk=function(d){this.meta=d.meta,this._pako===null&&this._createPako(),this._pako.push(o.transformTo(h,d.data),!1)},c.prototype.flush=function(){l.prototype.flush.call(this),this._pako===null&&this._createPako(),this._pako.push([],!0)},c.prototype.cleanUp=function(){l.prototype.cleanUp.call(this),this._pako=null},c.prototype._createPako=function(){this._pako=new r[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var d=this;this._pako.onData=function(p){d.push({data:p,meta:d.meta})}},i.compressWorker=function(d){return new c("Deflate",d)},i.uncompressWorker=function(){return new c("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,s,i){function n(u,g){var m,v="";for(m=0;m<g;m++)v+=String.fromCharCode(255&u),u>>>=8;return v}function r(u,g,m,v,f,y){var _,x,C=u.file,P=u.compression,A=y!==h.utf8encode,k=o.transformTo("string",y(C.name)),M=o.transformTo("string",h.utf8encode(C.name)),I=C.comment,R=o.transformTo("string",y(I)),T=o.transformTo("string",h.utf8encode(I)),z=M.length!==C.name.length,b=T.length!==I.length,B="",q="",G="",te=C.dir,W=C.date,se={crc32:0,compressedSize:0,uncompressedSize:0};g&&!m||(se.crc32=u.crc32,se.compressedSize=u.compressedSize,se.uncompressedSize=u.uncompressedSize);var F=0;g&&(F|=8),A||!z&&!b||(F|=2048);var U=0,ne=0;te&&(U|=16),f==="UNIX"?(ne=798,U|=function(J,pe){var ge=J;return J||(ge=pe?16893:33204),(65535&ge)<<16}(C.unixPermissions,te)):(ne=20,U|=function(J){return 63&(J||0)}(C.dosPermissions)),_=W.getUTCHours(),_<<=6,_|=W.getUTCMinutes(),_<<=5,_|=W.getUTCSeconds()/2,x=W.getUTCFullYear()-1980,x<<=4,x|=W.getUTCMonth()+1,x<<=5,x|=W.getUTCDate(),z&&(q=n(1,1)+n(c(k),4)+M,B+="up"+n(q.length,2)+q),b&&(G=n(1,1)+n(c(R),4)+T,B+="uc"+n(G.length,2)+G);var ee="";return ee+=`
\0`,ee+=n(F,2),ee+=P.magic,ee+=n(_,2),ee+=n(x,2),ee+=n(se.crc32,4),ee+=n(se.compressedSize,4),ee+=n(se.uncompressedSize,4),ee+=n(k.length,2),ee+=n(B.length,2),{fileRecord:d.LOCAL_FILE_HEADER+ee+k+B,dirRecord:d.CENTRAL_FILE_HEADER+n(ne,2)+ee+n(R.length,2)+"\0\0\0\0"+n(U,4)+n(v,4)+k+B+R}}var o=t("../utils"),l=t("../stream/GenericWorker"),h=t("../utf8"),c=t("../crc32"),d=t("../signature");function p(u,g,m,v){l.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=g,this.zipPlatform=m,this.encodeFileName=v,this.streamFiles=u,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}o.inherits(p,l),p.prototype.push=function(u){var g=u.meta.percent||0,m=this.entriesCount,v=this._sources.length;this.accumulate?this.contentBuffer.push(u):(this.bytesWritten+=u.data.length,l.prototype.push.call(this,{data:u.data,meta:{currentFile:this.currentFile,percent:m?(g+100*(m-v-1))/m:100}}))},p.prototype.openedSource=function(u){this.currentSourceOffset=this.bytesWritten,this.currentFile=u.file.name;var g=this.streamFiles&&!u.file.dir;if(g){var m=r(u,g,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:m.fileRecord,meta:{percent:0}})}else this.accumulate=!0},p.prototype.closedSource=function(u){this.accumulate=!1;var g=this.streamFiles&&!u.file.dir,m=r(u,g,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(m.dirRecord),g)this.push({data:function(v){return d.DATA_DESCRIPTOR+n(v.crc32,4)+n(v.compressedSize,4)+n(v.uncompressedSize,4)}(u),meta:{percent:100}});else for(this.push({data:m.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},p.prototype.flush=function(){for(var u=this.bytesWritten,g=0;g<this.dirRecords.length;g++)this.push({data:this.dirRecords[g],meta:{percent:100}});var m=this.bytesWritten-u,v=function(f,y,_,x,C){var P=o.transformTo("string",C(x));return d.CENTRAL_DIRECTORY_END+"\0\0\0\0"+n(f,2)+n(f,2)+n(y,4)+n(_,4)+n(P.length,2)+P}(this.dirRecords.length,m,u,this.zipComment,this.encodeFileName);this.push({data:v,meta:{percent:100}})},p.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},p.prototype.registerPrevious=function(u){this._sources.push(u);var g=this;return u.on("data",function(m){g.processChunk(m)}),u.on("end",function(){g.closedSource(g.previous.streamInfo),g._sources.length?g.prepareNextSource():g.end()}),u.on("error",function(m){g.error(m)}),this},p.prototype.resume=function(){return!!l.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},p.prototype.error=function(u){var g=this._sources;if(!l.prototype.error.call(this,u))return!1;for(var m=0;m<g.length;m++)try{g[m].error(u)}catch{}return!0},p.prototype.lock=function(){l.prototype.lock.call(this);for(var u=this._sources,g=0;g<u.length;g++)u[g].lock()},s.exports=p},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,s,i){var n=t("../compressions"),r=t("./ZipFileWorker");i.generateWorker=function(o,l,h){var c=new r(l.streamFiles,h,l.platform,l.encodeFileName),d=0;try{o.forEach(function(p,u){d++;var g=function(y,_){var x=y||_,C=n[x];if(!C)throw new Error(x+" is not a valid compression method !");return C}(u.options.compression,l.compression),m=u.options.compressionOptions||l.compressionOptions||{},v=u.dir,f=u.date;u._compressWorker(g,m).withStreamInfo("file",{name:p,dir:v,date:f,comment:u.comment||"",unixPermissions:u.unixPermissions,dosPermissions:u.dosPermissions}).pipe(c)}),c.entriesCount=d}catch(p){c.error(p)}return c}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,s,i){function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files=Object.create(null),this.comment=null,this.root="",this.clone=function(){var r=new n;for(var o in this)typeof this[o]!="function"&&(r[o]=this[o]);return r}}(n.prototype=t("./object")).loadAsync=t("./load"),n.support=t("./support"),n.defaults=t("./defaults"),n.version="3.10.1",n.loadAsync=function(r,o){return new n().loadAsync(r,o)},n.external=t("./external"),s.exports=n},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,s,i){var n=t("./utils"),r=t("./external"),o=t("./utf8"),l=t("./zipEntries"),h=t("./stream/Crc32Probe"),c=t("./nodejsUtils");function d(p){return new r.Promise(function(u,g){var m=p.decompressed.getContentWorker().pipe(new h);m.on("error",function(v){g(v)}).on("end",function(){m.streamInfo.crc32!==p.decompressed.crc32?g(new Error("Corrupted zip : CRC32 mismatch")):u()}).resume()})}s.exports=function(p,u){var g=this;return u=n.extend(u||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),c.isNode&&c.isStream(p)?r.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",p,!0,u.optimizedBinaryString,u.base64).then(function(m){var v=new l(u);return v.load(m),v}).then(function(m){var v=[r.Promise.resolve(m)],f=m.files;if(u.checkCRC32)for(var y=0;y<f.length;y++)v.push(d(f[y]));return r.Promise.all(v)}).then(function(m){for(var v=m.shift(),f=v.files,y=0;y<f.length;y++){var _=f[y],x=_.fileNameStr,C=n.resolve(_.fileNameStr);g.file(C,_.decompressed,{binary:!0,optimizedBinaryString:!0,date:_.date,dir:_.dir,comment:_.fileCommentStr.length?_.fileCommentStr:null,unixPermissions:_.unixPermissions,dosPermissions:_.dosPermissions,createFolders:u.createFolders}),_.dir||(g.file(C).unsafeOriginalName=x)}return v.zipComment.length&&(g.comment=v.zipComment),g})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,s,i){var n=t("../utils"),r=t("../stream/GenericWorker");function o(l,h){r.call(this,"Nodejs stream input adapter for "+l),this._upstreamEnded=!1,this._bindStream(h)}n.inherits(o,r),o.prototype._bindStream=function(l){var h=this;(this._stream=l).pause(),l.on("data",function(c){h.push({data:c,meta:{percent:0}})}).on("error",function(c){h.isPaused?this.generatedError=c:h.error(c)}).on("end",function(){h.isPaused?h._upstreamEnded=!0:h.end()})},o.prototype.pause=function(){return!!r.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},s.exports=o},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,s,i){var n=t("readable-stream").Readable;function r(o,l,h){n.call(this,l),this._helper=o;var c=this;o.on("data",function(d,p){c.push(d)||c._helper.pause(),h&&h(p)}).on("error",function(d){c.emit("error",d)}).on("end",function(){c.push(null)})}t("../utils").inherits(r,n),r.prototype._read=function(){this._helper.resume()},s.exports=r},{"../utils":32,"readable-stream":16}],14:[function(t,s,i){s.exports={isNode:typeof Buffer<"u",newBufferFrom:function(n,r){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(n,r);if(typeof n=="number")throw new Error('The "data" argument must not be a number');return new Buffer(n,r)},allocBuffer:function(n){if(Buffer.alloc)return Buffer.alloc(n);var r=new Buffer(n);return r.fill(0),r},isBuffer:function(n){return Buffer.isBuffer(n)},isStream:function(n){return n&&typeof n.on=="function"&&typeof n.pause=="function"&&typeof n.resume=="function"}}},{}],15:[function(t,s,i){function n(C,P,A){var k,M=o.getTypeOf(P),I=o.extend(A||{},c);I.date=I.date||new Date,I.compression!==null&&(I.compression=I.compression.toUpperCase()),typeof I.unixPermissions=="string"&&(I.unixPermissions=parseInt(I.unixPermissions,8)),I.unixPermissions&&16384&I.unixPermissions&&(I.dir=!0),I.dosPermissions&&16&I.dosPermissions&&(I.dir=!0),I.dir&&(C=f(C)),I.createFolders&&(k=v(C))&&y.call(this,k,!0);var R=M==="string"&&I.binary===!1&&I.base64===!1;A&&A.binary!==void 0||(I.binary=!R),(P instanceof d&&P.uncompressedSize===0||I.dir||!P||P.length===0)&&(I.base64=!1,I.binary=!0,P="",I.compression="STORE",M="string");var T=null;T=P instanceof d||P instanceof l?P:g.isNode&&g.isStream(P)?new m(C,P):o.prepareContent(C,P,I.binary,I.optimizedBinaryString,I.base64);var z=new p(C,T,I);this.files[C]=z}var r=t("./utf8"),o=t("./utils"),l=t("./stream/GenericWorker"),h=t("./stream/StreamHelper"),c=t("./defaults"),d=t("./compressedObject"),p=t("./zipObject"),u=t("./generate"),g=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),v=function(C){C.slice(-1)==="/"&&(C=C.substring(0,C.length-1));var P=C.lastIndexOf("/");return 0<P?C.substring(0,P):""},f=function(C){return C.slice(-1)!=="/"&&(C+="/"),C},y=function(C,P){return P=P!==void 0?P:c.createFolders,C=f(C),this.files[C]||n.call(this,C,null,{dir:!0,createFolders:P}),this.files[C]};function _(C){return Object.prototype.toString.call(C)==="[object RegExp]"}var x={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(C){var P,A,k;for(P in this.files)k=this.files[P],(A=P.slice(this.root.length,P.length))&&P.slice(0,this.root.length)===this.root&&C(A,k)},filter:function(C){var P=[];return this.forEach(function(A,k){C(A,k)&&P.push(k)}),P},file:function(C,P,A){if(arguments.length!==1)return C=this.root+C,n.call(this,C,P,A),this;if(_(C)){var k=C;return this.filter(function(I,R){return!R.dir&&k.test(I)})}var M=this.files[this.root+C];return M&&!M.dir?M:null},folder:function(C){if(!C)return this;if(_(C))return this.filter(function(M,I){return I.dir&&C.test(M)});var P=this.root+C,A=y.call(this,P),k=this.clone();return k.root=A.name,k},remove:function(C){C=this.root+C;var P=this.files[C];if(P||(C.slice(-1)!=="/"&&(C+="/"),P=this.files[C]),P&&!P.dir)delete this.files[C];else for(var A=this.filter(function(M,I){return I.name.slice(0,C.length)===C}),k=0;k<A.length;k++)delete this.files[A[k].name];return this},generate:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(C){var P,A={};try{if((A=o.extend(C||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:r.utf8encode})).type=A.type.toLowerCase(),A.compression=A.compression.toUpperCase(),A.type==="binarystring"&&(A.type="string"),!A.type)throw new Error("No output type specified.");o.checkSupport(A.type),A.platform!=="darwin"&&A.platform!=="freebsd"&&A.platform!=="linux"&&A.platform!=="sunos"||(A.platform="UNIX"),A.platform==="win32"&&(A.platform="DOS");var k=A.comment||this.comment||"";P=u.generateWorker(this,A,k)}catch(M){(P=new l("error")).error(M)}return new h(P,A.type||"string",A.mimeType)},generateAsync:function(C,P){return this.generateInternalStream(C).accumulate(P)},generateNodeStream:function(C,P){return(C=C||{}).type||(C.type="nodebuffer"),this.generateInternalStream(C).toNodejsStream(P)}};s.exports=x},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,s,i){s.exports=t("stream")},{stream:void 0}],17:[function(t,s,i){var n=t("./DataReader");function r(o){n.call(this,o);for(var l=0;l<this.data.length;l++)o[l]=255&o[l]}t("../utils").inherits(r,n),r.prototype.byteAt=function(o){return this.data[this.zero+o]},r.prototype.lastIndexOfSignature=function(o){for(var l=o.charCodeAt(0),h=o.charCodeAt(1),c=o.charCodeAt(2),d=o.charCodeAt(3),p=this.length-4;0<=p;--p)if(this.data[p]===l&&this.data[p+1]===h&&this.data[p+2]===c&&this.data[p+3]===d)return p-this.zero;return-1},r.prototype.readAndCheckSignature=function(o){var l=o.charCodeAt(0),h=o.charCodeAt(1),c=o.charCodeAt(2),d=o.charCodeAt(3),p=this.readData(4);return l===p[0]&&h===p[1]&&c===p[2]&&d===p[3]},r.prototype.readData=function(o){if(this.checkOffset(o),o===0)return[];var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./DataReader":18}],18:[function(t,s,i){var n=t("../utils");function r(o){this.data=o,this.length=o.length,this.index=0,this.zero=0}r.prototype={checkOffset:function(o){this.checkIndex(this.index+o)},checkIndex:function(o){if(this.length<this.zero+o||o<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+o+"). Corrupted zip ?")},setIndex:function(o){this.checkIndex(o),this.index=o},skip:function(o){this.setIndex(this.index+o)},byteAt:function(){},readInt:function(o){var l,h=0;for(this.checkOffset(o),l=this.index+o-1;l>=this.index;l--)h=(h<<8)+this.byteAt(l);return this.index+=o,h},readString:function(o){return n.transformTo("string",this.readData(o))},readData:function(){},lastIndexOfSignature:function(){},readAndCheckSignature:function(){},readDate:function(){var o=this.readInt(4);return new Date(Date.UTC(1980+(o>>25&127),(o>>21&15)-1,o>>16&31,o>>11&31,o>>5&63,(31&o)<<1))}},s.exports=r},{"../utils":32}],19:[function(t,s,i){var n=t("./Uint8ArrayReader");function r(o){n.call(this,o)}t("../utils").inherits(r,n),r.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,s,i){var n=t("./DataReader");function r(o){n.call(this,o)}t("../utils").inherits(r,n),r.prototype.byteAt=function(o){return this.data.charCodeAt(this.zero+o)},r.prototype.lastIndexOfSignature=function(o){return this.data.lastIndexOf(o)-this.zero},r.prototype.readAndCheckSignature=function(o){return o===this.readData(4)},r.prototype.readData=function(o){this.checkOffset(o);var l=this.data.slice(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./DataReader":18}],21:[function(t,s,i){var n=t("./ArrayReader");function r(o){n.call(this,o)}t("../utils").inherits(r,n),r.prototype.readData=function(o){if(this.checkOffset(o),o===0)return new Uint8Array(0);var l=this.data.subarray(this.zero+this.index,this.zero+this.index+o);return this.index+=o,l},s.exports=r},{"../utils":32,"./ArrayReader":17}],22:[function(t,s,i){var n=t("../utils"),r=t("../support"),o=t("./ArrayReader"),l=t("./StringReader"),h=t("./NodeBufferReader"),c=t("./Uint8ArrayReader");s.exports=function(d){var p=n.getTypeOf(d);return n.checkSupport(p),p!=="string"||r.uint8array?p==="nodebuffer"?new h(d):r.uint8array?new c(n.transformTo("uint8array",d)):new o(n.transformTo("array",d)):new l(d)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,s,i){i.LOCAL_FILE_HEADER="PK",i.CENTRAL_FILE_HEADER="PK",i.CENTRAL_DIRECTORY_END="PK",i.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK\x07",i.ZIP64_CENTRAL_DIRECTORY_END="PK",i.DATA_DESCRIPTOR="PK\x07\b"},{}],24:[function(t,s,i){var n=t("./GenericWorker"),r=t("../utils");function o(l){n.call(this,"ConvertWorker to "+l),this.destType=l}r.inherits(o,n),o.prototype.processChunk=function(l){this.push({data:r.transformTo(this.destType,l.data),meta:l.meta})},s.exports=o},{"../utils":32,"./GenericWorker":28}],25:[function(t,s,i){var n=t("./GenericWorker"),r=t("../crc32");function o(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}t("../utils").inherits(o,n),o.prototype.processChunk=function(l){this.streamInfo.crc32=r(l.data,this.streamInfo.crc32||0),this.push(l)},s.exports=o},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,s,i){var n=t("../utils"),r=t("./GenericWorker");function o(l){r.call(this,"DataLengthProbe for "+l),this.propName=l,this.withStreamInfo(l,0)}n.inherits(o,r),o.prototype.processChunk=function(l){if(l){var h=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=h+l.data.length}r.prototype.processChunk.call(this,l)},s.exports=o},{"../utils":32,"./GenericWorker":28}],27:[function(t,s,i){var n=t("../utils"),r=t("./GenericWorker");function o(l){r.call(this,"DataWorker");var h=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,l.then(function(c){h.dataIsReady=!0,h.data=c,h.max=c&&c.length||0,h.type=n.getTypeOf(c),h.isPaused||h._tickAndRepeat()},function(c){h.error(c)})}n.inherits(o,r),o.prototype.cleanUp=function(){r.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!r.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var l=null,h=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":l=this.data.substring(this.index,h);break;case"uint8array":l=this.data.subarray(this.index,h);break;case"array":case"nodebuffer":l=this.data.slice(this.index,h)}return this.index=h,this.push({data:l,meta:{percent:this.max?this.index/this.max*100:0}})},s.exports=o},{"../utils":32,"./GenericWorker":28}],28:[function(t,s,i){function n(r){this.name=r||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(r){this.emit("data",r)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(r){this.emit("error",r)}return!0},error:function(r){return!this.isFinished&&(this.isPaused?this.generatedError=r:(this.isFinished=!0,this.emit("error",r),this.previous&&this.previous.error(r),this.cleanUp()),!0)},on:function(r,o){return this._listeners[r].push(o),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(r,o){if(this._listeners[r])for(var l=0;l<this._listeners[r].length;l++)this._listeners[r][l].call(this,o)},pipe:function(r){return r.registerPrevious(this)},registerPrevious:function(r){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=r.streamInfo,this.mergeStreamInfo(),this.previous=r;var o=this;return r.on("data",function(l){o.processChunk(l)}),r.on("end",function(){o.end()}),r.on("error",function(l){o.error(l)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;var r=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),r=!0),this.previous&&this.previous.resume(),!r},flush:function(){},processChunk:function(r){this.push(r)},withStreamInfo:function(r,o){return this.extraStreamInfo[r]=o,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var r in this.extraStreamInfo)Object.prototype.hasOwnProperty.call(this.extraStreamInfo,r)&&(this.streamInfo[r]=this.extraStreamInfo[r])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var r="Worker "+this.name;return this.previous?this.previous+" -> "+r:r}},s.exports=n},{}],29:[function(t,s,i){var n=t("../utils"),r=t("./ConvertWorker"),o=t("./GenericWorker"),l=t("../base64"),h=t("../support"),c=t("../external"),d=null;if(h.nodestream)try{d=t("../nodejs/NodejsStreamOutputAdapter")}catch{}function p(g,m){return new c.Promise(function(v,f){var y=[],_=g._internalType,x=g._outputType,C=g._mimeType;g.on("data",function(P,A){y.push(P),m&&m(A)}).on("error",function(P){y=[],f(P)}).on("end",function(){try{var P=function(A,k,M){switch(A){case"blob":return n.newBlob(n.transformTo("arraybuffer",k),M);case"base64":return l.encode(k);default:return n.transformTo(A,k)}}(x,function(A,k){var M,I=0,R=null,T=0;for(M=0;M<k.length;M++)T+=k[M].length;switch(A){case"string":return k.join("");case"array":return Array.prototype.concat.apply([],k);case"uint8array":for(R=new Uint8Array(T),M=0;M<k.length;M++)R.set(k[M],I),I+=k[M].length;return R;case"nodebuffer":return Buffer.concat(k);default:throw new Error("concat : unsupported type '"+A+"'")}}(_,y),C);v(P)}catch(A){f(A)}y=[]}).resume()})}function u(g,m,v){var f=m;switch(m){case"blob":case"arraybuffer":f="uint8array";break;case"base64":f="string"}try{this._internalType=f,this._outputType=m,this._mimeType=v,n.checkSupport(f),this._worker=g.pipe(new r(f)),g.lock()}catch(y){this._worker=new o("error"),this._worker.error(y)}}u.prototype={accumulate:function(g){return p(this,g)},on:function(g,m){var v=this;return g==="data"?this._worker.on(g,function(f){m.call(v,f.data,f.meta)}):this._worker.on(g,function(){n.delay(m,arguments,v)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(g){if(n.checkSupport("nodestream"),this._outputType!=="nodebuffer")throw new Error(this._outputType+" is not supported by this method");return new d(this,{objectMode:this._outputType!=="nodebuffer"},g)}},s.exports=u},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,s,i){if(i.base64=!0,i.array=!0,i.string=!0,i.arraybuffer=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",i.nodebuffer=typeof Buffer<"u",i.uint8array=typeof Uint8Array<"u",typeof ArrayBuffer>"u")i.blob=!1;else{var n=new ArrayBuffer(0);try{i.blob=new Blob([n],{type:"application/zip"}).size===0}catch{try{var r=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);r.append(n),i.blob=r.getBlob("application/zip").size===0}catch{i.blob=!1}}}try{i.nodestream=!!t("readable-stream").Readable}catch{i.nodestream=!1}},{"readable-stream":16}],31:[function(t,s,i){for(var n=t("./utils"),r=t("./support"),o=t("./nodejsUtils"),l=t("./stream/GenericWorker"),h=new Array(256),c=0;c<256;c++)h[c]=252<=c?6:248<=c?5:240<=c?4:224<=c?3:192<=c?2:1;h[254]=h[254]=1;function d(){l.call(this,"utf-8 decode"),this.leftOver=null}function p(){l.call(this,"utf-8 encode")}i.utf8encode=function(u){return r.nodebuffer?o.newBufferFrom(u,"utf-8"):function(g){var m,v,f,y,_,x=g.length,C=0;for(y=0;y<x;y++)(64512&(v=g.charCodeAt(y)))==55296&&y+1<x&&(64512&(f=g.charCodeAt(y+1)))==56320&&(v=65536+(v-55296<<10)+(f-56320),y++),C+=v<128?1:v<2048?2:v<65536?3:4;for(m=r.uint8array?new Uint8Array(C):new Array(C),y=_=0;_<C;y++)(64512&(v=g.charCodeAt(y)))==55296&&y+1<x&&(64512&(f=g.charCodeAt(y+1)))==56320&&(v=65536+(v-55296<<10)+(f-56320),y++),v<128?m[_++]=v:(v<2048?m[_++]=192|v>>>6:(v<65536?m[_++]=224|v>>>12:(m[_++]=240|v>>>18,m[_++]=128|v>>>12&63),m[_++]=128|v>>>6&63),m[_++]=128|63&v);return m}(u)},i.utf8decode=function(u){return r.nodebuffer?n.transformTo("nodebuffer",u).toString("utf-8"):function(g){var m,v,f,y,_=g.length,x=new Array(2*_);for(m=v=0;m<_;)if((f=g[m++])<128)x[v++]=f;else if(4<(y=h[f]))x[v++]=65533,m+=y-1;else{for(f&=y===2?31:y===3?15:7;1<y&&m<_;)f=f<<6|63&g[m++],y--;1<y?x[v++]=65533:f<65536?x[v++]=f:(f-=65536,x[v++]=55296|f>>10&1023,x[v++]=56320|1023&f)}return x.length!==v&&(x.subarray?x=x.subarray(0,v):x.length=v),n.applyFromCharCode(x)}(u=n.transformTo(r.uint8array?"uint8array":"array",u))},n.inherits(d,l),d.prototype.processChunk=function(u){var g=n.transformTo(r.uint8array?"uint8array":"array",u.data);if(this.leftOver&&this.leftOver.length){if(r.uint8array){var m=g;(g=new Uint8Array(m.length+this.leftOver.length)).set(this.leftOver,0),g.set(m,this.leftOver.length)}else g=this.leftOver.concat(g);this.leftOver=null}var v=function(y,_){var x;for((_=_||y.length)>y.length&&(_=y.length),x=_-1;0<=x&&(192&y[x])==128;)x--;return x<0||x===0?_:x+h[y[x]]>_?x:_}(g),f=g;v!==g.length&&(r.uint8array?(f=g.subarray(0,v),this.leftOver=g.subarray(v,g.length)):(f=g.slice(0,v),this.leftOver=g.slice(v,g.length))),this.push({data:i.utf8decode(f),meta:u.meta})},d.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:i.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},i.Utf8DecodeWorker=d,n.inherits(p,l),p.prototype.processChunk=function(u){this.push({data:i.utf8encode(u.data),meta:u.meta})},i.Utf8EncodeWorker=p},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,s,i){var n=t("./support"),r=t("./base64"),o=t("./nodejsUtils"),l=t("./external");function h(m){return m}function c(m,v){for(var f=0;f<m.length;++f)v[f]=255&m.charCodeAt(f);return v}t("setimmediate"),i.newBlob=function(m,v){i.checkSupport("blob");try{return new Blob([m],{type:v})}catch{try{var f=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return f.append(m),f.getBlob(v)}catch{throw new Error("Bug : can't construct the Blob.")}}};var d={stringifyByChunk:function(m,v,f){var y=[],_=0,x=m.length;if(x<=f)return String.fromCharCode.apply(null,m);for(;_<x;)v==="array"||v==="nodebuffer"?y.push(String.fromCharCode.apply(null,m.slice(_,Math.min(_+f,x)))):y.push(String.fromCharCode.apply(null,m.subarray(_,Math.min(_+f,x)))),_+=f;return y.join("")},stringifyByChar:function(m){for(var v="",f=0;f<m.length;f++)v+=String.fromCharCode(m[f]);return v},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&String.fromCharCode.apply(null,new Uint8Array(1)).length===1}catch{return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&String.fromCharCode.apply(null,o.allocBuffer(1)).length===1}catch{return!1}}()}};function p(m){var v=65536,f=i.getTypeOf(m),y=!0;if(f==="uint8array"?y=d.applyCanBeUsed.uint8array:f==="nodebuffer"&&(y=d.applyCanBeUsed.nodebuffer),y)for(;1<v;)try{return d.stringifyByChunk(m,f,v)}catch{v=Math.floor(v/2)}return d.stringifyByChar(m)}function u(m,v){for(var f=0;f<m.length;f++)v[f]=m[f];return v}i.applyFromCharCode=p;var g={};g.string={string:h,array:function(m){return c(m,new Array(m.length))},arraybuffer:function(m){return g.string.uint8array(m).buffer},uint8array:function(m){return c(m,new Uint8Array(m.length))},nodebuffer:function(m){return c(m,o.allocBuffer(m.length))}},g.array={string:p,array:h,arraybuffer:function(m){return new Uint8Array(m).buffer},uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(m)}},g.arraybuffer={string:function(m){return p(new Uint8Array(m))},array:function(m){return u(new Uint8Array(m),new Array(m.byteLength))},arraybuffer:h,uint8array:function(m){return new Uint8Array(m)},nodebuffer:function(m){return o.newBufferFrom(new Uint8Array(m))}},g.uint8array={string:p,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return m.buffer},uint8array:h,nodebuffer:function(m){return o.newBufferFrom(m)}},g.nodebuffer={string:p,array:function(m){return u(m,new Array(m.length))},arraybuffer:function(m){return g.nodebuffer.uint8array(m).buffer},uint8array:function(m){return u(m,new Uint8Array(m.length))},nodebuffer:h},i.transformTo=function(m,v){if(v=v||"",!m)return v;i.checkSupport(m);var f=i.getTypeOf(v);return g[f][m](v)},i.resolve=function(m){for(var v=m.split("/"),f=[],y=0;y<v.length;y++){var _=v[y];_==="."||_===""&&y!==0&&y!==v.length-1||(_===".."?f.pop():f.push(_))}return f.join("/")},i.getTypeOf=function(m){return typeof m=="string"?"string":Object.prototype.toString.call(m)==="[object Array]"?"array":n.nodebuffer&&o.isBuffer(m)?"nodebuffer":n.uint8array&&m instanceof Uint8Array?"uint8array":n.arraybuffer&&m instanceof ArrayBuffer?"arraybuffer":void 0},i.checkSupport=function(m){if(!n[m.toLowerCase()])throw new Error(m+" is not supported by this platform")},i.MAX_VALUE_16BITS=65535,i.MAX_VALUE_32BITS=-1,i.pretty=function(m){var v,f,y="";for(f=0;f<(m||"").length;f++)y+="\\x"+((v=m.charCodeAt(f))<16?"0":"")+v.toString(16).toUpperCase();return y},i.delay=function(m,v,f){setImmediate(function(){m.apply(f||null,v||[])})},i.inherits=function(m,v){function f(){}f.prototype=v.prototype,m.prototype=new f},i.extend=function(){var m,v,f={};for(m=0;m<arguments.length;m++)for(v in arguments[m])Object.prototype.hasOwnProperty.call(arguments[m],v)&&f[v]===void 0&&(f[v]=arguments[m][v]);return f},i.prepareContent=function(m,v,f,y,_){return l.Promise.resolve(v).then(function(x){return n.blob&&(x instanceof Blob||["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(x))!==-1)&&typeof FileReader<"u"?new l.Promise(function(C,P){var A=new FileReader;A.onload=function(k){C(k.target.result)},A.onerror=function(k){P(k.target.error)},A.readAsArrayBuffer(x)}):x}).then(function(x){var C=i.getTypeOf(x);return C?(C==="arraybuffer"?x=i.transformTo("uint8array",x):C==="string"&&(_?x=r.decode(x):f&&y!==!0&&(x=function(P){return c(P,n.uint8array?new Uint8Array(P.length):new Array(P.length))}(x))),x):l.Promise.reject(new Error("Can't read the data of '"+m+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,setimmediate:54}],33:[function(t,s,i){var n=t("./reader/readerFor"),r=t("./utils"),o=t("./signature"),l=t("./zipEntry"),h=t("./support");function c(d){this.files=[],this.loadOptions=d}c.prototype={checkSignature:function(d){if(!this.reader.readAndCheckSignature(d)){this.reader.index-=4;var p=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+r.pretty(p)+", expected "+r.pretty(d)+")")}},isSignature:function(d,p){var u=this.reader.index;this.reader.setIndex(d);var g=this.reader.readString(4)===p;return this.reader.setIndex(u),g},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var d=this.reader.readData(this.zipCommentLength),p=h.uint8array?"uint8array":"array",u=r.transformTo(p,d);this.zipComment=this.loadOptions.decodeFileName(u)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var d,p,u,g=this.zip64EndOfCentralSize-44;0<g;)d=this.reader.readInt(2),p=this.reader.readInt(4),u=this.reader.readData(p),this.zip64ExtensibleData[d]={id:d,length:p,value:u}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var d,p;for(d=0;d<this.files.length;d++)p=this.files[d],this.reader.setIndex(p.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),p.readLocalPart(this.reader),p.handleUTF8(),p.processAttributes()},readCentralDir:function(){var d;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(d=new l({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(d);if(this.centralDirRecords!==this.files.length&&this.centralDirRecords!==0&&this.files.length===0)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var d=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(d<0)throw this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Corrupted zip: can't find end of central directory"):new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html");this.reader.setIndex(d);var p=d;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===r.MAX_VALUE_16BITS||this.diskWithCentralDirStart===r.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===r.MAX_VALUE_16BITS||this.centralDirRecords===r.MAX_VALUE_16BITS||this.centralDirSize===r.MAX_VALUE_32BITS||this.centralDirOffset===r.MAX_VALUE_32BITS){if(this.zip64=!0,(d=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(d),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var u=this.centralDirOffset+this.centralDirSize;this.zip64&&(u+=20,u+=12+this.zip64EndOfCentralSize);var g=p-u;if(0<g)this.isSignature(p,o.CENTRAL_FILE_HEADER)||(this.reader.zero=g);else if(g<0)throw new Error("Corrupted zip: missing "+Math.abs(g)+" bytes.")},prepareReader:function(d){this.reader=n(d)},load:function(d){this.prepareReader(d),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},s.exports=c},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utils":32,"./zipEntry":34}],34:[function(t,s,i){var n=t("./reader/readerFor"),r=t("./utils"),o=t("./compressedObject"),l=t("./crc32"),h=t("./utf8"),c=t("./compressions"),d=t("./support");function p(u,g){this.options=u,this.loadOptions=g}p.prototype={isEncrypted:function(){return(1&this.bitFlag)==1},useUTF8:function(){return(2048&this.bitFlag)==2048},readLocalPart:function(u){var g,m;if(u.skip(22),this.fileNameLength=u.readInt(2),m=u.readInt(2),this.fileName=u.readData(this.fileNameLength),u.skip(m),this.compressedSize===-1||this.uncompressedSize===-1)throw new Error("Bug or corrupted zip : didn't get enough information from the central directory (compressedSize === -1 || uncompressedSize === -1)");if((g=function(v){for(var f in c)if(Object.prototype.hasOwnProperty.call(c,f)&&c[f].magic===v)return c[f];return null}(this.compressionMethod))===null)throw new Error("Corrupted zip : compression "+r.pretty(this.compressionMethod)+" unknown (inner file : "+r.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,g,u.readData(this.compressedSize))},readCentralPart:function(u){this.versionMadeBy=u.readInt(2),u.skip(2),this.bitFlag=u.readInt(2),this.compressionMethod=u.readString(2),this.date=u.readDate(),this.crc32=u.readInt(4),this.compressedSize=u.readInt(4),this.uncompressedSize=u.readInt(4);var g=u.readInt(2);if(this.extraFieldsLength=u.readInt(2),this.fileCommentLength=u.readInt(2),this.diskNumberStart=u.readInt(2),this.internalFileAttributes=u.readInt(2),this.externalFileAttributes=u.readInt(4),this.localHeaderOffset=u.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");u.skip(g),this.readExtraFields(u),this.parseZIP64ExtraField(u),this.fileComment=u.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var u=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),u==0&&(this.dosPermissions=63&this.externalFileAttributes),u==3&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||this.fileNameStr.slice(-1)!=="/"||(this.dir=!0)},parseZIP64ExtraField:function(){if(this.extraFields[1]){var u=n(this.extraFields[1].value);this.uncompressedSize===r.MAX_VALUE_32BITS&&(this.uncompressedSize=u.readInt(8)),this.compressedSize===r.MAX_VALUE_32BITS&&(this.compressedSize=u.readInt(8)),this.localHeaderOffset===r.MAX_VALUE_32BITS&&(this.localHeaderOffset=u.readInt(8)),this.diskNumberStart===r.MAX_VALUE_32BITS&&(this.diskNumberStart=u.readInt(4))}},readExtraFields:function(u){var g,m,v,f=u.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});u.index+4<f;)g=u.readInt(2),m=u.readInt(2),v=u.readData(m),this.extraFields[g]={id:g,length:m,value:v};u.setIndex(f)},handleUTF8:function(){var u=d.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=h.utf8decode(this.fileName),this.fileCommentStr=h.utf8decode(this.fileComment);else{var g=this.findExtraFieldUnicodePath();if(g!==null)this.fileNameStr=g;else{var m=r.transformTo(u,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(m)}var v=this.findExtraFieldUnicodeComment();if(v!==null)this.fileCommentStr=v;else{var f=r.transformTo(u,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(f)}}},findExtraFieldUnicodePath:function(){var u=this.extraFields[28789];if(u){var g=n(u.value);return g.readInt(1)!==1||l(this.fileName)!==g.readInt(4)?null:h.utf8decode(g.readData(u.length-5))}return null},findExtraFieldUnicodeComment:function(){var u=this.extraFields[25461];if(u){var g=n(u.value);return g.readInt(1)!==1||l(this.fileComment)!==g.readInt(4)?null:h.utf8decode(g.readData(u.length-5))}return null}},s.exports=p},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,s,i){function n(g,m,v){this.name=g,this.dir=v.dir,this.date=v.date,this.comment=v.comment,this.unixPermissions=v.unixPermissions,this.dosPermissions=v.dosPermissions,this._data=m,this._dataBinary=v.binary,this.options={compression:v.compression,compressionOptions:v.compressionOptions}}var r=t("./stream/StreamHelper"),o=t("./stream/DataWorker"),l=t("./utf8"),h=t("./compressedObject"),c=t("./stream/GenericWorker");n.prototype={internalStream:function(g){var m=null,v="string";try{if(!g)throw new Error("No output type specified.");var f=(v=g.toLowerCase())==="string"||v==="text";v!=="binarystring"&&v!=="text"||(v="string"),m=this._decompressWorker();var y=!this._dataBinary;y&&!f&&(m=m.pipe(new l.Utf8EncodeWorker)),!y&&f&&(m=m.pipe(new l.Utf8DecodeWorker))}catch(_){(m=new c("error")).error(_)}return new r(m,v,"")},async:function(g,m){return this.internalStream(g).accumulate(m)},nodeStream:function(g,m){return this.internalStream(g||"nodebuffer").toNodejsStream(m)},_compressWorker:function(g,m){if(this._data instanceof h&&this._data.compression.magic===g.magic)return this._data.getCompressedWorker();var v=this._decompressWorker();return this._dataBinary||(v=v.pipe(new l.Utf8EncodeWorker)),h.createWorkerFrom(v,g,m)},_decompressWorker:function(){return this._data instanceof h?this._data.getContentWorker():this._data instanceof c?this._data:new o(this._data)}};for(var d=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],p=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},u=0;u<d.length;u++)n.prototype[d[u]]=p;s.exports=n},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,s,i){(function(n){var r,o,l=n.MutationObserver||n.WebKitMutationObserver;if(l){var h=0,c=new l(g),d=n.document.createTextNode("");c.observe(d,{characterData:!0}),r=function(){d.data=h=++h%2}}else if(n.setImmediate||n.MessageChannel===void 0)r="document"in n&&"onreadystatechange"in n.document.createElement("script")?function(){var m=n.document.createElement("script");m.onreadystatechange=function(){g(),m.onreadystatechange=null,m.parentNode.removeChild(m),m=null},n.document.documentElement.appendChild(m)}:function(){setTimeout(g,0)};else{var p=new n.MessageChannel;p.port1.onmessage=g,r=function(){p.port2.postMessage(0)}}var u=[];function g(){var m,v;o=!0;for(var f=u.length;f;){for(v=u,u=[],m=-1;++m<f;)v[m]();f=u.length}o=!1}s.exports=function(m){u.push(m)!==1||o||r()}}).call(this,typeof Si<"u"?Si:typeof self<"u"?self:typeof window<"u"?window:{})},{}],37:[function(t,s,i){var n=t("immediate");function r(){}var o={},l=["REJECTED"],h=["FULFILLED"],c=["PENDING"];function d(f){if(typeof f!="function")throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,f!==r&&m(this,f)}function p(f,y,_){this.promise=f,typeof y=="function"&&(this.onFulfilled=y,this.callFulfilled=this.otherCallFulfilled),typeof _=="function"&&(this.onRejected=_,this.callRejected=this.otherCallRejected)}function u(f,y,_){n(function(){var x;try{x=y(_)}catch(C){return o.reject(f,C)}x===f?o.reject(f,new TypeError("Cannot resolve promise with itself")):o.resolve(f,x)})}function g(f){var y=f&&f.then;if(f&&(typeof f=="object"||typeof f=="function")&&typeof y=="function")return function(){y.apply(f,arguments)}}function m(f,y){var _=!1;function x(A){_||(_=!0,o.reject(f,A))}function C(A){_||(_=!0,o.resolve(f,A))}var P=v(function(){y(C,x)});P.status==="error"&&x(P.value)}function v(f,y){var _={};try{_.value=f(y),_.status="success"}catch(x){_.status="error",_.value=x}return _}(s.exports=d).prototype.finally=function(f){if(typeof f!="function")return this;var y=this.constructor;return this.then(function(_){return y.resolve(f()).then(function(){return _})},function(_){return y.resolve(f()).then(function(){throw _})})},d.prototype.catch=function(f){return this.then(null,f)},d.prototype.then=function(f,y){if(typeof f!="function"&&this.state===h||typeof y!="function"&&this.state===l)return this;var _=new this.constructor(r);return this.state!==c?u(_,this.state===h?f:y,this.outcome):this.queue.push(new p(_,f,y)),_},p.prototype.callFulfilled=function(f){o.resolve(this.promise,f)},p.prototype.otherCallFulfilled=function(f){u(this.promise,this.onFulfilled,f)},p.prototype.callRejected=function(f){o.reject(this.promise,f)},p.prototype.otherCallRejected=function(f){u(this.promise,this.onRejected,f)},o.resolve=function(f,y){var _=v(g,y);if(_.status==="error")return o.reject(f,_.value);var x=_.value;if(x)m(f,x);else{f.state=h,f.outcome=y;for(var C=-1,P=f.queue.length;++C<P;)f.queue[C].callFulfilled(y)}return f},o.reject=function(f,y){f.state=l,f.outcome=y;for(var _=-1,x=f.queue.length;++_<x;)f.queue[_].callRejected(y);return f},d.resolve=function(f){return f instanceof this?f:o.resolve(new this(r),f)},d.reject=function(f){var y=new this(r);return o.reject(y,f)},d.all=function(f){var y=this;if(Object.prototype.toString.call(f)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=f.length,x=!1;if(!_)return this.resolve([]);for(var C=new Array(_),P=0,A=-1,k=new this(r);++A<_;)M(f[A],A);return k;function M(I,R){y.resolve(I).then(function(T){C[R]=T,++P!==_||x||(x=!0,o.resolve(k,C))},function(T){x||(x=!0,o.reject(k,T))})}},d.race=function(f){var y=this;if(Object.prototype.toString.call(f)!=="[object Array]")return this.reject(new TypeError("must be an array"));var _=f.length,x=!1;if(!_)return this.resolve([]);for(var C=-1,P=new this(r);++C<_;)A=f[C],y.resolve(A).then(function(k){x||(x=!0,o.resolve(P,k))},function(k){x||(x=!0,o.reject(P,k))});var A;return P}},{immediate:36}],38:[function(t,s,i){var n={};(0,t("./lib/utils/common").assign)(n,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),s.exports=n},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,s,i){var n=t("./zlib/deflate"),r=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/messages"),h=t("./zlib/zstream"),c=Object.prototype.toString,d=0,p=-1,u=0,g=8;function m(f){if(!(this instanceof m))return new m(f);this.options=r.assign({level:p,method:g,chunkSize:16384,windowBits:15,memLevel:8,strategy:u,to:""},f||{});var y=this.options;y.raw&&0<y.windowBits?y.windowBits=-y.windowBits:y.gzip&&0<y.windowBits&&y.windowBits<16&&(y.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var _=n.deflateInit2(this.strm,y.level,y.method,y.windowBits,y.memLevel,y.strategy);if(_!==d)throw new Error(l[_]);if(y.header&&n.deflateSetHeader(this.strm,y.header),y.dictionary){var x;if(x=typeof y.dictionary=="string"?o.string2buf(y.dictionary):c.call(y.dictionary)==="[object ArrayBuffer]"?new Uint8Array(y.dictionary):y.dictionary,(_=n.deflateSetDictionary(this.strm,x))!==d)throw new Error(l[_]);this._dict_set=!0}}function v(f,y){var _=new m(y);if(_.push(f,!0),_.err)throw _.msg||l[_.err];return _.result}m.prototype.push=function(f,y){var _,x,C=this.strm,P=this.options.chunkSize;if(this.ended)return!1;x=y===~~y?y:y===!0?4:0,typeof f=="string"?C.input=o.string2buf(f):c.call(f)==="[object ArrayBuffer]"?C.input=new Uint8Array(f):C.input=f,C.next_in=0,C.avail_in=C.input.length;do{if(C.avail_out===0&&(C.output=new r.Buf8(P),C.next_out=0,C.avail_out=P),(_=n.deflate(C,x))!==1&&_!==d)return this.onEnd(_),!(this.ended=!0);C.avail_out!==0&&(C.avail_in!==0||x!==4&&x!==2)||(this.options.to==="string"?this.onData(o.buf2binstring(r.shrinkBuf(C.output,C.next_out))):this.onData(r.shrinkBuf(C.output,C.next_out)))}while((0<C.avail_in||C.avail_out===0)&&_!==1);return x===4?(_=n.deflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===d):x!==2||(this.onEnd(d),!(C.avail_out=0))},m.prototype.onData=function(f){this.chunks.push(f)},m.prototype.onEnd=function(f){f===d&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg},i.Deflate=m,i.deflate=v,i.deflateRaw=function(f,y){return(y=y||{}).raw=!0,v(f,y)},i.gzip=function(f,y){return(y=y||{}).gzip=!0,v(f,y)}},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,s,i){var n=t("./zlib/inflate"),r=t("./utils/common"),o=t("./utils/strings"),l=t("./zlib/constants"),h=t("./zlib/messages"),c=t("./zlib/zstream"),d=t("./zlib/gzheader"),p=Object.prototype.toString;function u(m){if(!(this instanceof u))return new u(m);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},m||{});var v=this.options;v.raw&&0<=v.windowBits&&v.windowBits<16&&(v.windowBits=-v.windowBits,v.windowBits===0&&(v.windowBits=-15)),!(0<=v.windowBits&&v.windowBits<16)||m&&m.windowBits||(v.windowBits+=32),15<v.windowBits&&v.windowBits<48&&!(15&v.windowBits)&&(v.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new c,this.strm.avail_out=0;var f=n.inflateInit2(this.strm,v.windowBits);if(f!==l.Z_OK)throw new Error(h[f]);this.header=new d,n.inflateGetHeader(this.strm,this.header)}function g(m,v){var f=new u(v);if(f.push(m,!0),f.err)throw f.msg||h[f.err];return f.result}u.prototype.push=function(m,v){var f,y,_,x,C,P,A=this.strm,k=this.options.chunkSize,M=this.options.dictionary,I=!1;if(this.ended)return!1;y=v===~~v?v:v===!0?l.Z_FINISH:l.Z_NO_FLUSH,typeof m=="string"?A.input=o.binstring2buf(m):p.call(m)==="[object ArrayBuffer]"?A.input=new Uint8Array(m):A.input=m,A.next_in=0,A.avail_in=A.input.length;do{if(A.avail_out===0&&(A.output=new r.Buf8(k),A.next_out=0,A.avail_out=k),(f=n.inflate(A,l.Z_NO_FLUSH))===l.Z_NEED_DICT&&M&&(P=typeof M=="string"?o.string2buf(M):p.call(M)==="[object ArrayBuffer]"?new Uint8Array(M):M,f=n.inflateSetDictionary(this.strm,P)),f===l.Z_BUF_ERROR&&I===!0&&(f=l.Z_OK,I=!1),f!==l.Z_STREAM_END&&f!==l.Z_OK)return this.onEnd(f),!(this.ended=!0);A.next_out&&(A.avail_out!==0&&f!==l.Z_STREAM_END&&(A.avail_in!==0||y!==l.Z_FINISH&&y!==l.Z_SYNC_FLUSH)||(this.options.to==="string"?(_=o.utf8border(A.output,A.next_out),x=A.next_out-_,C=o.buf2string(A.output,_),A.next_out=x,A.avail_out=k-x,x&&r.arraySet(A.output,A.output,_,x,0),this.onData(C)):this.onData(r.shrinkBuf(A.output,A.next_out)))),A.avail_in===0&&A.avail_out===0&&(I=!0)}while((0<A.avail_in||A.avail_out===0)&&f!==l.Z_STREAM_END);return f===l.Z_STREAM_END&&(y=l.Z_FINISH),y===l.Z_FINISH?(f=n.inflateEnd(this.strm),this.onEnd(f),this.ended=!0,f===l.Z_OK):y!==l.Z_SYNC_FLUSH||(this.onEnd(l.Z_OK),!(A.avail_out=0))},u.prototype.onData=function(m){this.chunks.push(m)},u.prototype.onEnd=function(m){m===l.Z_OK&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=m,this.msg=this.strm.msg},i.Inflate=u,i.inflate=g,i.inflateRaw=function(m,v){return(v=v||{}).raw=!0,g(m,v)},i.ungzip=g},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,s,i){var n=typeof Uint8Array<"u"&&typeof Uint16Array<"u"&&typeof Int32Array<"u";i.assign=function(l){for(var h=Array.prototype.slice.call(arguments,1);h.length;){var c=h.shift();if(c){if(typeof c!="object")throw new TypeError(c+"must be non-object");for(var d in c)c.hasOwnProperty(d)&&(l[d]=c[d])}}return l},i.shrinkBuf=function(l,h){return l.length===h?l:l.subarray?l.subarray(0,h):(l.length=h,l)};var r={arraySet:function(l,h,c,d,p){if(h.subarray&&l.subarray)l.set(h.subarray(c,c+d),p);else for(var u=0;u<d;u++)l[p+u]=h[c+u]},flattenChunks:function(l){var h,c,d,p,u,g;for(h=d=0,c=l.length;h<c;h++)d+=l[h].length;for(g=new Uint8Array(d),h=p=0,c=l.length;h<c;h++)u=l[h],g.set(u,p),p+=u.length;return g}},o={arraySet:function(l,h,c,d,p){for(var u=0;u<d;u++)l[p+u]=h[c+u]},flattenChunks:function(l){return[].concat.apply([],l)}};i.setTyped=function(l){l?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,r)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,o))},i.setTyped(n)},{}],42:[function(t,s,i){var n=t("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch{r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{o=!1}for(var l=new n.Buf8(256),h=0;h<256;h++)l[h]=252<=h?6:248<=h?5:240<=h?4:224<=h?3:192<=h?2:1;function c(d,p){if(p<65537&&(d.subarray&&o||!d.subarray&&r))return String.fromCharCode.apply(null,n.shrinkBuf(d,p));for(var u="",g=0;g<p;g++)u+=String.fromCharCode(d[g]);return u}l[254]=l[254]=1,i.string2buf=function(d){var p,u,g,m,v,f=d.length,y=0;for(m=0;m<f;m++)(64512&(u=d.charCodeAt(m)))==55296&&m+1<f&&(64512&(g=d.charCodeAt(m+1)))==56320&&(u=65536+(u-55296<<10)+(g-56320),m++),y+=u<128?1:u<2048?2:u<65536?3:4;for(p=new n.Buf8(y),m=v=0;v<y;m++)(64512&(u=d.charCodeAt(m)))==55296&&m+1<f&&(64512&(g=d.charCodeAt(m+1)))==56320&&(u=65536+(u-55296<<10)+(g-56320),m++),u<128?p[v++]=u:(u<2048?p[v++]=192|u>>>6:(u<65536?p[v++]=224|u>>>12:(p[v++]=240|u>>>18,p[v++]=128|u>>>12&63),p[v++]=128|u>>>6&63),p[v++]=128|63&u);return p},i.buf2binstring=function(d){return c(d,d.length)},i.binstring2buf=function(d){for(var p=new n.Buf8(d.length),u=0,g=p.length;u<g;u++)p[u]=d.charCodeAt(u);return p},i.buf2string=function(d,p){var u,g,m,v,f=p||d.length,y=new Array(2*f);for(u=g=0;u<f;)if((m=d[u++])<128)y[g++]=m;else if(4<(v=l[m]))y[g++]=65533,u+=v-1;else{for(m&=v===2?31:v===3?15:7;1<v&&u<f;)m=m<<6|63&d[u++],v--;1<v?y[g++]=65533:m<65536?y[g++]=m:(m-=65536,y[g++]=55296|m>>10&1023,y[g++]=56320|1023&m)}return c(y,g)},i.utf8border=function(d,p){var u;for((p=p||d.length)>d.length&&(p=d.length),u=p-1;0<=u&&(192&d[u])==128;)u--;return u<0||u===0?p:u+l[d[u]]>p?u:p}},{"./common":41}],43:[function(t,s,i){s.exports=function(n,r,o,l){for(var h=65535&n|0,c=n>>>16&65535|0,d=0;o!==0;){for(o-=d=2e3<o?2e3:o;c=c+(h=h+r[l++]|0)|0,--d;);h%=65521,c%=65521}return h|c<<16|0}},{}],44:[function(t,s,i){s.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],45:[function(t,s,i){var n=function(){for(var r,o=[],l=0;l<256;l++){r=l;for(var h=0;h<8;h++)r=1&r?3988292384^r>>>1:r>>>1;o[l]=r}return o}();s.exports=function(r,o,l,h){var c=n,d=h+l;r^=-1;for(var p=h;p<d;p++)r=r>>>8^c[255&(r^o[p])];return-1^r}},{}],46:[function(t,s,i){var n,r=t("../utils/common"),o=t("./trees"),l=t("./adler32"),h=t("./crc32"),c=t("./messages"),d=0,p=4,u=0,g=-2,m=-1,v=4,f=2,y=8,_=9,x=286,C=30,P=19,A=2*x+1,k=15,M=3,I=258,R=I+M+1,T=42,z=113,b=1,B=2,q=3,G=4;function te(w,Y){return w.msg=c[Y],Y}function W(w){return(w<<1)-(4<w?9:0)}function se(w){for(var Y=w.length;0<=--Y;)w[Y]=0}function F(w){var Y=w.state,H=Y.pending;H>w.avail_out&&(H=w.avail_out),H!==0&&(r.arraySet(w.output,Y.pending_buf,Y.pending_out,H,w.next_out),w.next_out+=H,Y.pending_out+=H,w.total_out+=H,w.avail_out-=H,Y.pending-=H,Y.pending===0&&(Y.pending_out=0))}function U(w,Y){o._tr_flush_block(w,0<=w.block_start?w.block_start:-1,w.strstart-w.block_start,Y),w.block_start=w.strstart,F(w.strm)}function ne(w,Y){w.pending_buf[w.pending++]=Y}function ee(w,Y){w.pending_buf[w.pending++]=Y>>>8&255,w.pending_buf[w.pending++]=255&Y}function J(w,Y){var H,D,O=w.max_chain_length,N=w.strstart,Z=w.prev_length,X=w.nice_match,V=w.strstart>w.w_size-R?w.strstart-(w.w_size-R):0,Q=w.window,re=w.w_mask,$=w.prev,oe=w.strstart+I,ye=Q[N+Z-1],ue=Q[N+Z];w.prev_length>=w.good_match&&(O>>=2),X>w.lookahead&&(X=w.lookahead);do if(Q[(H=Y)+Z]===ue&&Q[H+Z-1]===ye&&Q[H]===Q[N]&&Q[++H]===Q[N+1]){N+=2,H++;do;while(Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&Q[++N]===Q[++H]&&N<oe);if(D=I-(oe-N),N=oe-I,Z<D){if(w.match_start=Y,X<=(Z=D))break;ye=Q[N+Z-1],ue=Q[N+Z]}}while((Y=$[Y&re])>V&&--O!=0);return Z<=w.lookahead?Z:w.lookahead}function pe(w){var Y,H,D,O,N,Z,X,V,Q,re,$=w.w_size;do{if(O=w.window_size-w.lookahead-w.strstart,w.strstart>=$+($-R)){for(r.arraySet(w.window,w.window,$,$,0),w.match_start-=$,w.strstart-=$,w.block_start-=$,Y=H=w.hash_size;D=w.head[--Y],w.head[Y]=$<=D?D-$:0,--H;);for(Y=H=$;D=w.prev[--Y],w.prev[Y]=$<=D?D-$:0,--H;);O+=$}if(w.strm.avail_in===0)break;if(Z=w.strm,X=w.window,V=w.strstart+w.lookahead,Q=O,re=void 0,re=Z.avail_in,Q<re&&(re=Q),H=re===0?0:(Z.avail_in-=re,r.arraySet(X,Z.input,Z.next_in,re,V),Z.state.wrap===1?Z.adler=l(Z.adler,X,re,V):Z.state.wrap===2&&(Z.adler=h(Z.adler,X,re,V)),Z.next_in+=re,Z.total_in+=re,re),w.lookahead+=H,w.lookahead+w.insert>=M)for(N=w.strstart-w.insert,w.ins_h=w.window[N],w.ins_h=(w.ins_h<<w.hash_shift^w.window[N+1])&w.hash_mask;w.insert&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[N+M-1])&w.hash_mask,w.prev[N&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=N,N++,w.insert--,!(w.lookahead+w.insert<M)););}while(w.lookahead<R&&w.strm.avail_in!==0)}function ge(w,Y){for(var H,D;;){if(w.lookahead<R){if(pe(w),w.lookahead<R&&Y===d)return b;if(w.lookahead===0)break}if(H=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,H=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),H!==0&&w.strstart-H<=w.w_size-R&&(w.match_length=J(w,H)),w.match_length>=M)if(D=o._tr_tally(w,w.strstart-w.match_start,w.match_length-M),w.lookahead-=w.match_length,w.match_length<=w.max_lazy_match&&w.lookahead>=M){for(w.match_length--;w.strstart++,w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,H=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart,--w.match_length!=0;);w.strstart++}else w.strstart+=w.match_length,w.match_length=0,w.ins_h=w.window[w.strstart],w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+1])&w.hash_mask;else D=o._tr_tally(w,0,w.window[w.strstart]),w.lookahead--,w.strstart++;if(D&&(U(w,!1),w.strm.avail_out===0))return b}return w.insert=w.strstart<M-1?w.strstart:M-1,Y===p?(U(w,!0),w.strm.avail_out===0?q:G):w.last_lit&&(U(w,!1),w.strm.avail_out===0)?b:B}function ae(w,Y){for(var H,D,O;;){if(w.lookahead<R){if(pe(w),w.lookahead<R&&Y===d)return b;if(w.lookahead===0)break}if(H=0,w.lookahead>=M&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,H=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),w.prev_length=w.match_length,w.prev_match=w.match_start,w.match_length=M-1,H!==0&&w.prev_length<w.max_lazy_match&&w.strstart-H<=w.w_size-R&&(w.match_length=J(w,H),w.match_length<=5&&(w.strategy===1||w.match_length===M&&4096<w.strstart-w.match_start)&&(w.match_length=M-1)),w.prev_length>=M&&w.match_length<=w.prev_length){for(O=w.strstart+w.lookahead-M,D=o._tr_tally(w,w.strstart-1-w.prev_match,w.prev_length-M),w.lookahead-=w.prev_length-1,w.prev_length-=2;++w.strstart<=O&&(w.ins_h=(w.ins_h<<w.hash_shift^w.window[w.strstart+M-1])&w.hash_mask,H=w.prev[w.strstart&w.w_mask]=w.head[w.ins_h],w.head[w.ins_h]=w.strstart),--w.prev_length!=0;);if(w.match_available=0,w.match_length=M-1,w.strstart++,D&&(U(w,!1),w.strm.avail_out===0))return b}else if(w.match_available){if((D=o._tr_tally(w,0,w.window[w.strstart-1]))&&U(w,!1),w.strstart++,w.lookahead--,w.strm.avail_out===0)return b}else w.match_available=1,w.strstart++,w.lookahead--}return w.match_available&&(D=o._tr_tally(w,0,w.window[w.strstart-1]),w.match_available=0),w.insert=w.strstart<M-1?w.strstart:M-1,Y===p?(U(w,!0),w.strm.avail_out===0?q:G):w.last_lit&&(U(w,!1),w.strm.avail_out===0)?b:B}function ce(w,Y,H,D,O){this.good_length=w,this.max_lazy=Y,this.nice_length=H,this.max_chain=D,this.func=O}function Ee(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=y,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(2*A),this.dyn_dtree=new r.Buf16(2*(2*C+1)),this.bl_tree=new r.Buf16(2*(2*P+1)),se(this.dyn_ltree),se(this.dyn_dtree),se(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(k+1),this.heap=new r.Buf16(2*x+1),se(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(2*x+1),se(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function we(w){var Y;return w&&w.state?(w.total_in=w.total_out=0,w.data_type=f,(Y=w.state).pending=0,Y.pending_out=0,Y.wrap<0&&(Y.wrap=-Y.wrap),Y.status=Y.wrap?T:z,w.adler=Y.wrap===2?0:1,Y.last_flush=d,o._tr_init(Y),u):te(w,g)}function Fe(w){var Y=we(w);return Y===u&&function(H){H.window_size=2*H.w_size,se(H.head),H.max_lazy_match=n[H.level].max_lazy,H.good_match=n[H.level].good_length,H.nice_match=n[H.level].nice_length,H.max_chain_length=n[H.level].max_chain,H.strstart=0,H.block_start=0,H.lookahead=0,H.insert=0,H.match_length=H.prev_length=M-1,H.match_available=0,H.ins_h=0}(w.state),Y}function ke(w,Y,H,D,O,N){if(!w)return g;var Z=1;if(Y===m&&(Y=6),D<0?(Z=0,D=-D):15<D&&(Z=2,D-=16),O<1||_<O||H!==y||D<8||15<D||Y<0||9<Y||N<0||v<N)return te(w,g);D===8&&(D=9);var X=new Ee;return(w.state=X).strm=w,X.wrap=Z,X.gzhead=null,X.w_bits=D,X.w_size=1<<X.w_bits,X.w_mask=X.w_size-1,X.hash_bits=O+7,X.hash_size=1<<X.hash_bits,X.hash_mask=X.hash_size-1,X.hash_shift=~~((X.hash_bits+M-1)/M),X.window=new r.Buf8(2*X.w_size),X.head=new r.Buf16(X.hash_size),X.prev=new r.Buf16(X.w_size),X.lit_bufsize=1<<O+6,X.pending_buf_size=4*X.lit_bufsize,X.pending_buf=new r.Buf8(X.pending_buf_size),X.d_buf=1*X.lit_bufsize,X.l_buf=3*X.lit_bufsize,X.level=Y,X.strategy=N,X.method=H,Fe(w)}n=[new ce(0,0,0,0,function(w,Y){var H=65535;for(H>w.pending_buf_size-5&&(H=w.pending_buf_size-5);;){if(w.lookahead<=1){if(pe(w),w.lookahead===0&&Y===d)return b;if(w.lookahead===0)break}w.strstart+=w.lookahead,w.lookahead=0;var D=w.block_start+H;if((w.strstart===0||w.strstart>=D)&&(w.lookahead=w.strstart-D,w.strstart=D,U(w,!1),w.strm.avail_out===0)||w.strstart-w.block_start>=w.w_size-R&&(U(w,!1),w.strm.avail_out===0))return b}return w.insert=0,Y===p?(U(w,!0),w.strm.avail_out===0?q:G):(w.strstart>w.block_start&&(U(w,!1),w.strm.avail_out),b)}),new ce(4,4,8,4,ge),new ce(4,5,16,8,ge),new ce(4,6,32,32,ge),new ce(4,4,16,16,ae),new ce(8,16,32,32,ae),new ce(8,16,128,128,ae),new ce(8,32,128,256,ae),new ce(32,128,258,1024,ae),new ce(32,258,258,4096,ae)],i.deflateInit=function(w,Y){return ke(w,Y,y,15,8,0)},i.deflateInit2=ke,i.deflateReset=Fe,i.deflateResetKeep=we,i.deflateSetHeader=function(w,Y){return w&&w.state?w.state.wrap!==2?g:(w.state.gzhead=Y,u):g},i.deflate=function(w,Y){var H,D,O,N;if(!w||!w.state||5<Y||Y<0)return w?te(w,g):g;if(D=w.state,!w.output||!w.input&&w.avail_in!==0||D.status===666&&Y!==p)return te(w,w.avail_out===0?-5:g);if(D.strm=w,H=D.last_flush,D.last_flush=Y,D.status===T)if(D.wrap===2)w.adler=0,ne(D,31),ne(D,139),ne(D,8),D.gzhead?(ne(D,(D.gzhead.text?1:0)+(D.gzhead.hcrc?2:0)+(D.gzhead.extra?4:0)+(D.gzhead.name?8:0)+(D.gzhead.comment?16:0)),ne(D,255&D.gzhead.time),ne(D,D.gzhead.time>>8&255),ne(D,D.gzhead.time>>16&255),ne(D,D.gzhead.time>>24&255),ne(D,D.level===9?2:2<=D.strategy||D.level<2?4:0),ne(D,255&D.gzhead.os),D.gzhead.extra&&D.gzhead.extra.length&&(ne(D,255&D.gzhead.extra.length),ne(D,D.gzhead.extra.length>>8&255)),D.gzhead.hcrc&&(w.adler=h(w.adler,D.pending_buf,D.pending,0)),D.gzindex=0,D.status=69):(ne(D,0),ne(D,0),ne(D,0),ne(D,0),ne(D,0),ne(D,D.level===9?2:2<=D.strategy||D.level<2?4:0),ne(D,3),D.status=z);else{var Z=y+(D.w_bits-8<<4)<<8;Z|=(2<=D.strategy||D.level<2?0:D.level<6?1:D.level===6?2:3)<<6,D.strstart!==0&&(Z|=32),Z+=31-Z%31,D.status=z,ee(D,Z),D.strstart!==0&&(ee(D,w.adler>>>16),ee(D,65535&w.adler)),w.adler=1}if(D.status===69)if(D.gzhead.extra){for(O=D.pending;D.gzindex<(65535&D.gzhead.extra.length)&&(D.pending!==D.pending_buf_size||(D.gzhead.hcrc&&D.pending>O&&(w.adler=h(w.adler,D.pending_buf,D.pending-O,O)),F(w),O=D.pending,D.pending!==D.pending_buf_size));)ne(D,255&D.gzhead.extra[D.gzindex]),D.gzindex++;D.gzhead.hcrc&&D.pending>O&&(w.adler=h(w.adler,D.pending_buf,D.pending-O,O)),D.gzindex===D.gzhead.extra.length&&(D.gzindex=0,D.status=73)}else D.status=73;if(D.status===73)if(D.gzhead.name){O=D.pending;do{if(D.pending===D.pending_buf_size&&(D.gzhead.hcrc&&D.pending>O&&(w.adler=h(w.adler,D.pending_buf,D.pending-O,O)),F(w),O=D.pending,D.pending===D.pending_buf_size)){N=1;break}N=D.gzindex<D.gzhead.name.length?255&D.gzhead.name.charCodeAt(D.gzindex++):0,ne(D,N)}while(N!==0);D.gzhead.hcrc&&D.pending>O&&(w.adler=h(w.adler,D.pending_buf,D.pending-O,O)),N===0&&(D.gzindex=0,D.status=91)}else D.status=91;if(D.status===91)if(D.gzhead.comment){O=D.pending;do{if(D.pending===D.pending_buf_size&&(D.gzhead.hcrc&&D.pending>O&&(w.adler=h(w.adler,D.pending_buf,D.pending-O,O)),F(w),O=D.pending,D.pending===D.pending_buf_size)){N=1;break}N=D.gzindex<D.gzhead.comment.length?255&D.gzhead.comment.charCodeAt(D.gzindex++):0,ne(D,N)}while(N!==0);D.gzhead.hcrc&&D.pending>O&&(w.adler=h(w.adler,D.pending_buf,D.pending-O,O)),N===0&&(D.status=103)}else D.status=103;if(D.status===103&&(D.gzhead.hcrc?(D.pending+2>D.pending_buf_size&&F(w),D.pending+2<=D.pending_buf_size&&(ne(D,255&w.adler),ne(D,w.adler>>8&255),w.adler=0,D.status=z)):D.status=z),D.pending!==0){if(F(w),w.avail_out===0)return D.last_flush=-1,u}else if(w.avail_in===0&&W(Y)<=W(H)&&Y!==p)return te(w,-5);if(D.status===666&&w.avail_in!==0)return te(w,-5);if(w.avail_in!==0||D.lookahead!==0||Y!==d&&D.status!==666){var X=D.strategy===2?function(V,Q){for(var re;;){if(V.lookahead===0&&(pe(V),V.lookahead===0)){if(Q===d)return b;break}if(V.match_length=0,re=o._tr_tally(V,0,V.window[V.strstart]),V.lookahead--,V.strstart++,re&&(U(V,!1),V.strm.avail_out===0))return b}return V.insert=0,Q===p?(U(V,!0),V.strm.avail_out===0?q:G):V.last_lit&&(U(V,!1),V.strm.avail_out===0)?b:B}(D,Y):D.strategy===3?function(V,Q){for(var re,$,oe,ye,ue=V.window;;){if(V.lookahead<=I){if(pe(V),V.lookahead<=I&&Q===d)return b;if(V.lookahead===0)break}if(V.match_length=0,V.lookahead>=M&&0<V.strstart&&($=ue[oe=V.strstart-1])===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]){ye=V.strstart+I;do;while($===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]&&$===ue[++oe]&&oe<ye);V.match_length=I-(ye-oe),V.match_length>V.lookahead&&(V.match_length=V.lookahead)}if(V.match_length>=M?(re=o._tr_tally(V,1,V.match_length-M),V.lookahead-=V.match_length,V.strstart+=V.match_length,V.match_length=0):(re=o._tr_tally(V,0,V.window[V.strstart]),V.lookahead--,V.strstart++),re&&(U(V,!1),V.strm.avail_out===0))return b}return V.insert=0,Q===p?(U(V,!0),V.strm.avail_out===0?q:G):V.last_lit&&(U(V,!1),V.strm.avail_out===0)?b:B}(D,Y):n[D.level].func(D,Y);if(X!==q&&X!==G||(D.status=666),X===b||X===q)return w.avail_out===0&&(D.last_flush=-1),u;if(X===B&&(Y===1?o._tr_align(D):Y!==5&&(o._tr_stored_block(D,0,0,!1),Y===3&&(se(D.head),D.lookahead===0&&(D.strstart=0,D.block_start=0,D.insert=0))),F(w),w.avail_out===0))return D.last_flush=-1,u}return Y!==p?u:D.wrap<=0?1:(D.wrap===2?(ne(D,255&w.adler),ne(D,w.adler>>8&255),ne(D,w.adler>>16&255),ne(D,w.adler>>24&255),ne(D,255&w.total_in),ne(D,w.total_in>>8&255),ne(D,w.total_in>>16&255),ne(D,w.total_in>>24&255)):(ee(D,w.adler>>>16),ee(D,65535&w.adler)),F(w),0<D.wrap&&(D.wrap=-D.wrap),D.pending!==0?u:1)},i.deflateEnd=function(w){var Y;return w&&w.state?(Y=w.state.status)!==T&&Y!==69&&Y!==73&&Y!==91&&Y!==103&&Y!==z&&Y!==666?te(w,g):(w.state=null,Y===z?te(w,-3):u):g},i.deflateSetDictionary=function(w,Y){var H,D,O,N,Z,X,V,Q,re=Y.length;if(!w||!w.state||(N=(H=w.state).wrap)===2||N===1&&H.status!==T||H.lookahead)return g;for(N===1&&(w.adler=l(w.adler,Y,re,0)),H.wrap=0,re>=H.w_size&&(N===0&&(se(H.head),H.strstart=0,H.block_start=0,H.insert=0),Q=new r.Buf8(H.w_size),r.arraySet(Q,Y,re-H.w_size,H.w_size,0),Y=Q,re=H.w_size),Z=w.avail_in,X=w.next_in,V=w.input,w.avail_in=re,w.next_in=0,w.input=Y,pe(H);H.lookahead>=M;){for(D=H.strstart,O=H.lookahead-(M-1);H.ins_h=(H.ins_h<<H.hash_shift^H.window[D+M-1])&H.hash_mask,H.prev[D&H.w_mask]=H.head[H.ins_h],H.head[H.ins_h]=D,D++,--O;);H.strstart=D,H.lookahead=M-1,pe(H)}return H.strstart+=H.lookahead,H.block_start=H.strstart,H.insert=H.lookahead,H.lookahead=0,H.match_length=H.prev_length=M-1,H.match_available=0,w.next_in=X,w.input=V,w.avail_in=Z,H.wrap=N,u},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,s,i){s.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],48:[function(t,s,i){s.exports=function(n,r){var o,l,h,c,d,p,u,g,m,v,f,y,_,x,C,P,A,k,M,I,R,T,z,b,B;o=n.state,l=n.next_in,b=n.input,h=l+(n.avail_in-5),c=n.next_out,B=n.output,d=c-(r-n.avail_out),p=c+(n.avail_out-257),u=o.dmax,g=o.wsize,m=o.whave,v=o.wnext,f=o.window,y=o.hold,_=o.bits,x=o.lencode,C=o.distcode,P=(1<<o.lenbits)-1,A=(1<<o.distbits)-1;e:do{_<15&&(y+=b[l++]<<_,_+=8,y+=b[l++]<<_,_+=8),k=x[y&P];t:for(;;){if(y>>>=M=k>>>24,_-=M,(M=k>>>16&255)===0)B[c++]=65535&k;else{if(!(16&M)){if(!(64&M)){k=x[(65535&k)+(y&(1<<M)-1)];continue t}if(32&M){o.mode=12;break e}n.msg="invalid literal/length code",o.mode=30;break e}I=65535&k,(M&=15)&&(_<M&&(y+=b[l++]<<_,_+=8),I+=y&(1<<M)-1,y>>>=M,_-=M),_<15&&(y+=b[l++]<<_,_+=8,y+=b[l++]<<_,_+=8),k=C[y&A];s:for(;;){if(y>>>=M=k>>>24,_-=M,!(16&(M=k>>>16&255))){if(!(64&M)){k=C[(65535&k)+(y&(1<<M)-1)];continue s}n.msg="invalid distance code",o.mode=30;break e}if(R=65535&k,_<(M&=15)&&(y+=b[l++]<<_,(_+=8)<M&&(y+=b[l++]<<_,_+=8)),u<(R+=y&(1<<M)-1)){n.msg="invalid distance too far back",o.mode=30;break e}if(y>>>=M,_-=M,(M=c-d)<R){if(m<(M=R-M)&&o.sane){n.msg="invalid distance too far back",o.mode=30;break e}if(z=f,(T=0)===v){if(T+=g-M,M<I){for(I-=M;B[c++]=f[T++],--M;);T=c-R,z=B}}else if(v<M){if(T+=g+v-M,(M-=v)<I){for(I-=M;B[c++]=f[T++],--M;);if(T=0,v<I){for(I-=M=v;B[c++]=f[T++],--M;);T=c-R,z=B}}}else if(T+=v-M,M<I){for(I-=M;B[c++]=f[T++],--M;);T=c-R,z=B}for(;2<I;)B[c++]=z[T++],B[c++]=z[T++],B[c++]=z[T++],I-=3;I&&(B[c++]=z[T++],1<I&&(B[c++]=z[T++]))}else{for(T=c-R;B[c++]=B[T++],B[c++]=B[T++],B[c++]=B[T++],2<(I-=3););I&&(B[c++]=B[T++],1<I&&(B[c++]=B[T++]))}break}}break}}while(l<h&&c<p);l-=I=_>>3,y&=(1<<(_-=I<<3))-1,n.next_in=l,n.next_out=c,n.avail_in=l<h?h-l+5:5-(l-h),n.avail_out=c<p?p-c+257:257-(c-p),o.hold=y,o.bits=_}},{}],49:[function(t,s,i){var n=t("../utils/common"),r=t("./adler32"),o=t("./crc32"),l=t("./inffast"),h=t("./inftrees"),c=1,d=2,p=0,u=-2,g=1,m=852,v=592;function f(T){return(T>>>24&255)+(T>>>8&65280)+((65280&T)<<8)+((255&T)<<24)}function y(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function _(T){var z;return T&&T.state?(z=T.state,T.total_in=T.total_out=z.total=0,T.msg="",z.wrap&&(T.adler=1&z.wrap),z.mode=g,z.last=0,z.havedict=0,z.dmax=32768,z.head=null,z.hold=0,z.bits=0,z.lencode=z.lendyn=new n.Buf32(m),z.distcode=z.distdyn=new n.Buf32(v),z.sane=1,z.back=-1,p):u}function x(T){var z;return T&&T.state?((z=T.state).wsize=0,z.whave=0,z.wnext=0,_(T)):u}function C(T,z){var b,B;return T&&T.state?(B=T.state,z<0?(b=0,z=-z):(b=1+(z>>4),z<48&&(z&=15)),z&&(z<8||15<z)?u:(B.window!==null&&B.wbits!==z&&(B.window=null),B.wrap=b,B.wbits=z,x(T))):u}function P(T,z){var b,B;return T?(B=new y,(T.state=B).window=null,(b=C(T,z))!==p&&(T.state=null),b):u}var A,k,M=!0;function I(T){if(M){var z;for(A=new n.Buf32(512),k=new n.Buf32(32),z=0;z<144;)T.lens[z++]=8;for(;z<256;)T.lens[z++]=9;for(;z<280;)T.lens[z++]=7;for(;z<288;)T.lens[z++]=8;for(h(c,T.lens,0,288,A,0,T.work,{bits:9}),z=0;z<32;)T.lens[z++]=5;h(d,T.lens,0,32,k,0,T.work,{bits:5}),M=!1}T.lencode=A,T.lenbits=9,T.distcode=k,T.distbits=5}function R(T,z,b,B){var q,G=T.state;return G.window===null&&(G.wsize=1<<G.wbits,G.wnext=0,G.whave=0,G.window=new n.Buf8(G.wsize)),B>=G.wsize?(n.arraySet(G.window,z,b-G.wsize,G.wsize,0),G.wnext=0,G.whave=G.wsize):(B<(q=G.wsize-G.wnext)&&(q=B),n.arraySet(G.window,z,b-B,q,G.wnext),(B-=q)?(n.arraySet(G.window,z,b-B,B,0),G.wnext=B,G.whave=G.wsize):(G.wnext+=q,G.wnext===G.wsize&&(G.wnext=0),G.whave<G.wsize&&(G.whave+=q))),0}i.inflateReset=x,i.inflateReset2=C,i.inflateResetKeep=_,i.inflateInit=function(T){return P(T,15)},i.inflateInit2=P,i.inflate=function(T,z){var b,B,q,G,te,W,se,F,U,ne,ee,J,pe,ge,ae,ce,Ee,we,Fe,ke,w,Y,H,D,O=0,N=new n.Buf8(4),Z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!T||!T.state||!T.output||!T.input&&T.avail_in!==0)return u;(b=T.state).mode===12&&(b.mode=13),te=T.next_out,q=T.output,se=T.avail_out,G=T.next_in,B=T.input,W=T.avail_in,F=b.hold,U=b.bits,ne=W,ee=se,Y=p;e:for(;;)switch(b.mode){case g:if(b.wrap===0){b.mode=13;break}for(;U<16;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(2&b.wrap&&F===35615){N[b.check=0]=255&F,N[1]=F>>>8&255,b.check=o(b.check,N,2,0),U=F=0,b.mode=2;break}if(b.flags=0,b.head&&(b.head.done=!1),!(1&b.wrap)||(((255&F)<<8)+(F>>8))%31){T.msg="incorrect header check",b.mode=30;break}if((15&F)!=8){T.msg="unknown compression method",b.mode=30;break}if(U-=4,w=8+(15&(F>>>=4)),b.wbits===0)b.wbits=w;else if(w>b.wbits){T.msg="invalid window size",b.mode=30;break}b.dmax=1<<w,T.adler=b.check=1,b.mode=512&F?10:12,U=F=0;break;case 2:for(;U<16;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(b.flags=F,(255&b.flags)!=8){T.msg="unknown compression method",b.mode=30;break}if(57344&b.flags){T.msg="unknown header flags set",b.mode=30;break}b.head&&(b.head.text=F>>8&1),512&b.flags&&(N[0]=255&F,N[1]=F>>>8&255,b.check=o(b.check,N,2,0)),U=F=0,b.mode=3;case 3:for(;U<32;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}b.head&&(b.head.time=F),512&b.flags&&(N[0]=255&F,N[1]=F>>>8&255,N[2]=F>>>16&255,N[3]=F>>>24&255,b.check=o(b.check,N,4,0)),U=F=0,b.mode=4;case 4:for(;U<16;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}b.head&&(b.head.xflags=255&F,b.head.os=F>>8),512&b.flags&&(N[0]=255&F,N[1]=F>>>8&255,b.check=o(b.check,N,2,0)),U=F=0,b.mode=5;case 5:if(1024&b.flags){for(;U<16;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}b.length=F,b.head&&(b.head.extra_len=F),512&b.flags&&(N[0]=255&F,N[1]=F>>>8&255,b.check=o(b.check,N,2,0)),U=F=0}else b.head&&(b.head.extra=null);b.mode=6;case 6:if(1024&b.flags&&(W<(J=b.length)&&(J=W),J&&(b.head&&(w=b.head.extra_len-b.length,b.head.extra||(b.head.extra=new Array(b.head.extra_len)),n.arraySet(b.head.extra,B,G,J,w)),512&b.flags&&(b.check=o(b.check,B,J,G)),W-=J,G+=J,b.length-=J),b.length))break e;b.length=0,b.mode=7;case 7:if(2048&b.flags){if(W===0)break e;for(J=0;w=B[G+J++],b.head&&w&&b.length<65536&&(b.head.name+=String.fromCharCode(w)),w&&J<W;);if(512&b.flags&&(b.check=o(b.check,B,J,G)),W-=J,G+=J,w)break e}else b.head&&(b.head.name=null);b.length=0,b.mode=8;case 8:if(4096&b.flags){if(W===0)break e;for(J=0;w=B[G+J++],b.head&&w&&b.length<65536&&(b.head.comment+=String.fromCharCode(w)),w&&J<W;);if(512&b.flags&&(b.check=o(b.check,B,J,G)),W-=J,G+=J,w)break e}else b.head&&(b.head.comment=null);b.mode=9;case 9:if(512&b.flags){for(;U<16;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(F!==(65535&b.check)){T.msg="header crc mismatch",b.mode=30;break}U=F=0}b.head&&(b.head.hcrc=b.flags>>9&1,b.head.done=!0),T.adler=b.check=0,b.mode=12;break;case 10:for(;U<32;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}T.adler=b.check=f(F),U=F=0,b.mode=11;case 11:if(b.havedict===0)return T.next_out=te,T.avail_out=se,T.next_in=G,T.avail_in=W,b.hold=F,b.bits=U,2;T.adler=b.check=1,b.mode=12;case 12:if(z===5||z===6)break e;case 13:if(b.last){F>>>=7&U,U-=7&U,b.mode=27;break}for(;U<3;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}switch(b.last=1&F,U-=1,3&(F>>>=1)){case 0:b.mode=14;break;case 1:if(I(b),b.mode=20,z!==6)break;F>>>=2,U-=2;break e;case 2:b.mode=17;break;case 3:T.msg="invalid block type",b.mode=30}F>>>=2,U-=2;break;case 14:for(F>>>=7&U,U-=7&U;U<32;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if((65535&F)!=(F>>>16^65535)){T.msg="invalid stored block lengths",b.mode=30;break}if(b.length=65535&F,U=F=0,b.mode=15,z===6)break e;case 15:b.mode=16;case 16:if(J=b.length){if(W<J&&(J=W),se<J&&(J=se),J===0)break e;n.arraySet(q,B,G,J,te),W-=J,G+=J,se-=J,te+=J,b.length-=J;break}b.mode=12;break;case 17:for(;U<14;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(b.nlen=257+(31&F),F>>>=5,U-=5,b.ndist=1+(31&F),F>>>=5,U-=5,b.ncode=4+(15&F),F>>>=4,U-=4,286<b.nlen||30<b.ndist){T.msg="too many length or distance symbols",b.mode=30;break}b.have=0,b.mode=18;case 18:for(;b.have<b.ncode;){for(;U<3;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}b.lens[Z[b.have++]]=7&F,F>>>=3,U-=3}for(;b.have<19;)b.lens[Z[b.have++]]=0;if(b.lencode=b.lendyn,b.lenbits=7,H={bits:b.lenbits},Y=h(0,b.lens,0,19,b.lencode,0,b.work,H),b.lenbits=H.bits,Y){T.msg="invalid code lengths set",b.mode=30;break}b.have=0,b.mode=19;case 19:for(;b.have<b.nlen+b.ndist;){for(;ce=(O=b.lencode[F&(1<<b.lenbits)-1])>>>16&255,Ee=65535&O,!((ae=O>>>24)<=U);){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(Ee<16)F>>>=ae,U-=ae,b.lens[b.have++]=Ee;else{if(Ee===16){for(D=ae+2;U<D;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(F>>>=ae,U-=ae,b.have===0){T.msg="invalid bit length repeat",b.mode=30;break}w=b.lens[b.have-1],J=3+(3&F),F>>>=2,U-=2}else if(Ee===17){for(D=ae+3;U<D;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}U-=ae,w=0,J=3+(7&(F>>>=ae)),F>>>=3,U-=3}else{for(D=ae+7;U<D;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}U-=ae,w=0,J=11+(127&(F>>>=ae)),F>>>=7,U-=7}if(b.have+J>b.nlen+b.ndist){T.msg="invalid bit length repeat",b.mode=30;break}for(;J--;)b.lens[b.have++]=w}}if(b.mode===30)break;if(b.lens[256]===0){T.msg="invalid code -- missing end-of-block",b.mode=30;break}if(b.lenbits=9,H={bits:b.lenbits},Y=h(c,b.lens,0,b.nlen,b.lencode,0,b.work,H),b.lenbits=H.bits,Y){T.msg="invalid literal/lengths set",b.mode=30;break}if(b.distbits=6,b.distcode=b.distdyn,H={bits:b.distbits},Y=h(d,b.lens,b.nlen,b.ndist,b.distcode,0,b.work,H),b.distbits=H.bits,Y){T.msg="invalid distances set",b.mode=30;break}if(b.mode=20,z===6)break e;case 20:b.mode=21;case 21:if(6<=W&&258<=se){T.next_out=te,T.avail_out=se,T.next_in=G,T.avail_in=W,b.hold=F,b.bits=U,l(T,ee),te=T.next_out,q=T.output,se=T.avail_out,G=T.next_in,B=T.input,W=T.avail_in,F=b.hold,U=b.bits,b.mode===12&&(b.back=-1);break}for(b.back=0;ce=(O=b.lencode[F&(1<<b.lenbits)-1])>>>16&255,Ee=65535&O,!((ae=O>>>24)<=U);){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(ce&&!(240&ce)){for(we=ae,Fe=ce,ke=Ee;ce=(O=b.lencode[ke+((F&(1<<we+Fe)-1)>>we)])>>>16&255,Ee=65535&O,!(we+(ae=O>>>24)<=U);){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}F>>>=we,U-=we,b.back+=we}if(F>>>=ae,U-=ae,b.back+=ae,b.length=Ee,ce===0){b.mode=26;break}if(32&ce){b.back=-1,b.mode=12;break}if(64&ce){T.msg="invalid literal/length code",b.mode=30;break}b.extra=15&ce,b.mode=22;case 22:if(b.extra){for(D=b.extra;U<D;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}b.length+=F&(1<<b.extra)-1,F>>>=b.extra,U-=b.extra,b.back+=b.extra}b.was=b.length,b.mode=23;case 23:for(;ce=(O=b.distcode[F&(1<<b.distbits)-1])>>>16&255,Ee=65535&O,!((ae=O>>>24)<=U);){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(!(240&ce)){for(we=ae,Fe=ce,ke=Ee;ce=(O=b.distcode[ke+((F&(1<<we+Fe)-1)>>we)])>>>16&255,Ee=65535&O,!(we+(ae=O>>>24)<=U);){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}F>>>=we,U-=we,b.back+=we}if(F>>>=ae,U-=ae,b.back+=ae,64&ce){T.msg="invalid distance code",b.mode=30;break}b.offset=Ee,b.extra=15&ce,b.mode=24;case 24:if(b.extra){for(D=b.extra;U<D;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}b.offset+=F&(1<<b.extra)-1,F>>>=b.extra,U-=b.extra,b.back+=b.extra}if(b.offset>b.dmax){T.msg="invalid distance too far back",b.mode=30;break}b.mode=25;case 25:if(se===0)break e;if(J=ee-se,b.offset>J){if((J=b.offset-J)>b.whave&&b.sane){T.msg="invalid distance too far back",b.mode=30;break}pe=J>b.wnext?(J-=b.wnext,b.wsize-J):b.wnext-J,J>b.length&&(J=b.length),ge=b.window}else ge=q,pe=te-b.offset,J=b.length;for(se<J&&(J=se),se-=J,b.length-=J;q[te++]=ge[pe++],--J;);b.length===0&&(b.mode=21);break;case 26:if(se===0)break e;q[te++]=b.length,se--,b.mode=21;break;case 27:if(b.wrap){for(;U<32;){if(W===0)break e;W--,F|=B[G++]<<U,U+=8}if(ee-=se,T.total_out+=ee,b.total+=ee,ee&&(T.adler=b.check=b.flags?o(b.check,q,ee,te-ee):r(b.check,q,ee,te-ee)),ee=se,(b.flags?F:f(F))!==b.check){T.msg="incorrect data check",b.mode=30;break}U=F=0}b.mode=28;case 28:if(b.wrap&&b.flags){for(;U<32;){if(W===0)break e;W--,F+=B[G++]<<U,U+=8}if(F!==(4294967295&b.total)){T.msg="incorrect length check",b.mode=30;break}U=F=0}b.mode=29;case 29:Y=1;break e;case 30:Y=-3;break e;case 31:return-4;case 32:default:return u}return T.next_out=te,T.avail_out=se,T.next_in=G,T.avail_in=W,b.hold=F,b.bits=U,(b.wsize||ee!==T.avail_out&&b.mode<30&&(b.mode<27||z!==4))&&R(T,T.output,T.next_out,ee-T.avail_out)?(b.mode=31,-4):(ne-=T.avail_in,ee-=T.avail_out,T.total_in+=ne,T.total_out+=ee,b.total+=ee,b.wrap&&ee&&(T.adler=b.check=b.flags?o(b.check,q,ee,T.next_out-ee):r(b.check,q,ee,T.next_out-ee)),T.data_type=b.bits+(b.last?64:0)+(b.mode===12?128:0)+(b.mode===20||b.mode===15?256:0),(ne==0&&ee===0||z===4)&&Y===p&&(Y=-5),Y)},i.inflateEnd=function(T){if(!T||!T.state)return u;var z=T.state;return z.window&&(z.window=null),T.state=null,p},i.inflateGetHeader=function(T,z){var b;return T&&T.state&&2&(b=T.state).wrap?((b.head=z).done=!1,p):u},i.inflateSetDictionary=function(T,z){var b,B=z.length;return T&&T.state?(b=T.state).wrap!==0&&b.mode!==11?u:b.mode===11&&r(1,z,B,0)!==b.check?-3:R(T,z,B,B)?(b.mode=31,-4):(b.havedict=1,p):u},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,s,i){var n=t("../utils/common"),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],l=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],h=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];s.exports=function(c,d,p,u,g,m,v,f){var y,_,x,C,P,A,k,M,I,R=f.bits,T=0,z=0,b=0,B=0,q=0,G=0,te=0,W=0,se=0,F=0,U=null,ne=0,ee=new n.Buf16(16),J=new n.Buf16(16),pe=null,ge=0;for(T=0;T<=15;T++)ee[T]=0;for(z=0;z<u;z++)ee[d[p+z]]++;for(q=R,B=15;1<=B&&ee[B]===0;B--);if(B<q&&(q=B),B===0)return g[m++]=20971520,g[m++]=20971520,f.bits=1,0;for(b=1;b<B&&ee[b]===0;b++);for(q<b&&(q=b),T=W=1;T<=15;T++)if(W<<=1,(W-=ee[T])<0)return-1;if(0<W&&(c===0||B!==1))return-1;for(J[1]=0,T=1;T<15;T++)J[T+1]=J[T]+ee[T];for(z=0;z<u;z++)d[p+z]!==0&&(v[J[d[p+z]]++]=z);if(A=c===0?(U=pe=v,19):c===1?(U=r,ne-=257,pe=o,ge-=257,256):(U=l,pe=h,-1),T=b,P=m,te=z=F=0,x=-1,C=(se=1<<(G=q))-1,c===1&&852<se||c===2&&592<se)return 1;for(;;){for(k=T-te,I=v[z]<A?(M=0,v[z]):v[z]>A?(M=pe[ge+v[z]],U[ne+v[z]]):(M=96,0),y=1<<T-te,b=_=1<<G;g[P+(F>>te)+(_-=y)]=k<<24|M<<16|I|0,_!==0;);for(y=1<<T-1;F&y;)y>>=1;if(y!==0?(F&=y-1,F+=y):F=0,z++,--ee[T]==0){if(T===B)break;T=d[p+v[z]]}if(q<T&&(F&C)!==x){for(te===0&&(te=q),P+=b,W=1<<(G=T-te);G+te<B&&!((W-=ee[G+te])<=0);)G++,W<<=1;if(se+=1<<G,c===1&&852<se||c===2&&592<se)return 1;g[x=F&C]=q<<24|G<<16|P-m|0}}return F!==0&&(g[P+F]=T-te<<24|64<<16|0),f.bits=q,0}},{"../utils/common":41}],51:[function(t,s,i){s.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],52:[function(t,s,i){var n=t("../utils/common"),r=0,o=1;function l(O){for(var N=O.length;0<=--N;)O[N]=0}var h=0,c=29,d=256,p=d+1+c,u=30,g=19,m=2*p+1,v=15,f=16,y=7,_=256,x=16,C=17,P=18,A=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],k=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],M=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],I=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],R=new Array(2*(p+2));l(R);var T=new Array(2*u);l(T);var z=new Array(512);l(z);var b=new Array(256);l(b);var B=new Array(c);l(B);var q,G,te,W=new Array(u);function se(O,N,Z,X,V){this.static_tree=O,this.extra_bits=N,this.extra_base=Z,this.elems=X,this.max_length=V,this.has_stree=O&&O.length}function F(O,N){this.dyn_tree=O,this.max_code=0,this.stat_desc=N}function U(O){return O<256?z[O]:z[256+(O>>>7)]}function ne(O,N){O.pending_buf[O.pending++]=255&N,O.pending_buf[O.pending++]=N>>>8&255}function ee(O,N,Z){O.bi_valid>f-Z?(O.bi_buf|=N<<O.bi_valid&65535,ne(O,O.bi_buf),O.bi_buf=N>>f-O.bi_valid,O.bi_valid+=Z-f):(O.bi_buf|=N<<O.bi_valid&65535,O.bi_valid+=Z)}function J(O,N,Z){ee(O,Z[2*N],Z[2*N+1])}function pe(O,N){for(var Z=0;Z|=1&O,O>>>=1,Z<<=1,0<--N;);return Z>>>1}function ge(O,N,Z){var X,V,Q=new Array(v+1),re=0;for(X=1;X<=v;X++)Q[X]=re=re+Z[X-1]<<1;for(V=0;V<=N;V++){var $=O[2*V+1];$!==0&&(O[2*V]=pe(Q[$]++,$))}}function ae(O){var N;for(N=0;N<p;N++)O.dyn_ltree[2*N]=0;for(N=0;N<u;N++)O.dyn_dtree[2*N]=0;for(N=0;N<g;N++)O.bl_tree[2*N]=0;O.dyn_ltree[2*_]=1,O.opt_len=O.static_len=0,O.last_lit=O.matches=0}function ce(O){8<O.bi_valid?ne(O,O.bi_buf):0<O.bi_valid&&(O.pending_buf[O.pending++]=O.bi_buf),O.bi_buf=0,O.bi_valid=0}function Ee(O,N,Z,X){var V=2*N,Q=2*Z;return O[V]<O[Q]||O[V]===O[Q]&&X[N]<=X[Z]}function we(O,N,Z){for(var X=O.heap[Z],V=Z<<1;V<=O.heap_len&&(V<O.heap_len&&Ee(N,O.heap[V+1],O.heap[V],O.depth)&&V++,!Ee(N,X,O.heap[V],O.depth));)O.heap[Z]=O.heap[V],Z=V,V<<=1;O.heap[Z]=X}function Fe(O,N,Z){var X,V,Q,re,$=0;if(O.last_lit!==0)for(;X=O.pending_buf[O.d_buf+2*$]<<8|O.pending_buf[O.d_buf+2*$+1],V=O.pending_buf[O.l_buf+$],$++,X===0?J(O,V,N):(J(O,(Q=b[V])+d+1,N),(re=A[Q])!==0&&ee(O,V-=B[Q],re),J(O,Q=U(--X),Z),(re=k[Q])!==0&&ee(O,X-=W[Q],re)),$<O.last_lit;);J(O,_,N)}function ke(O,N){var Z,X,V,Q=N.dyn_tree,re=N.stat_desc.static_tree,$=N.stat_desc.has_stree,oe=N.stat_desc.elems,ye=-1;for(O.heap_len=0,O.heap_max=m,Z=0;Z<oe;Z++)Q[2*Z]!==0?(O.heap[++O.heap_len]=ye=Z,O.depth[Z]=0):Q[2*Z+1]=0;for(;O.heap_len<2;)Q[2*(V=O.heap[++O.heap_len]=ye<2?++ye:0)]=1,O.depth[V]=0,O.opt_len--,$&&(O.static_len-=re[2*V+1]);for(N.max_code=ye,Z=O.heap_len>>1;1<=Z;Z--)we(O,Q,Z);for(V=oe;Z=O.heap[1],O.heap[1]=O.heap[O.heap_len--],we(O,Q,1),X=O.heap[1],O.heap[--O.heap_max]=Z,O.heap[--O.heap_max]=X,Q[2*V]=Q[2*Z]+Q[2*X],O.depth[V]=(O.depth[Z]>=O.depth[X]?O.depth[Z]:O.depth[X])+1,Q[2*Z+1]=Q[2*X+1]=V,O.heap[1]=V++,we(O,Q,1),2<=O.heap_len;);O.heap[--O.heap_max]=O.heap[1],function(ue,Ve){var vt,Xe,ns,Oe,ys,js,yt=Ve.dyn_tree,Ht=Ve.max_code,rs=Ve.stat_desc.static_tree,os=Ve.stat_desc.has_stree,as=Ve.stat_desc.extra_bits,Wt=Ve.stat_desc.extra_base,Hs=Ve.stat_desc.max_length,wi=0;for(Oe=0;Oe<=v;Oe++)ue.bl_count[Oe]=0;for(yt[2*ue.heap[ue.heap_max]+1]=0,vt=ue.heap_max+1;vt<m;vt++)Hs<(Oe=yt[2*yt[2*(Xe=ue.heap[vt])+1]+1]+1)&&(Oe=Hs,wi++),yt[2*Xe+1]=Oe,Ht<Xe||(ue.bl_count[Oe]++,ys=0,Wt<=Xe&&(ys=as[Xe-Wt]),js=yt[2*Xe],ue.opt_len+=js*(Oe+ys),os&&(ue.static_len+=js*(rs[2*Xe+1]+ys)));if(wi!==0){do{for(Oe=Hs-1;ue.bl_count[Oe]===0;)Oe--;ue.bl_count[Oe]--,ue.bl_count[Oe+1]+=2,ue.bl_count[Hs]--,wi-=2}while(0<wi);for(Oe=Hs;Oe!==0;Oe--)for(Xe=ue.bl_count[Oe];Xe!==0;)Ht<(ns=ue.heap[--vt])||(yt[2*ns+1]!==Oe&&(ue.opt_len+=(Oe-yt[2*ns+1])*yt[2*ns],yt[2*ns+1]=Oe),Xe--)}}(O,N),ge(Q,ye,O.bl_count)}function w(O,N,Z){var X,V,Q=-1,re=N[1],$=0,oe=7,ye=4;for(re===0&&(oe=138,ye=3),N[2*(Z+1)+1]=65535,X=0;X<=Z;X++)V=re,re=N[2*(X+1)+1],++$<oe&&V===re||($<ye?O.bl_tree[2*V]+=$:V!==0?(V!==Q&&O.bl_tree[2*V]++,O.bl_tree[2*x]++):$<=10?O.bl_tree[2*C]++:O.bl_tree[2*P]++,Q=V,ye=($=0)===re?(oe=138,3):V===re?(oe=6,3):(oe=7,4))}function Y(O,N,Z){var X,V,Q=-1,re=N[1],$=0,oe=7,ye=4;for(re===0&&(oe=138,ye=3),X=0;X<=Z;X++)if(V=re,re=N[2*(X+1)+1],!(++$<oe&&V===re)){if($<ye)for(;J(O,V,O.bl_tree),--$!=0;);else V!==0?(V!==Q&&(J(O,V,O.bl_tree),$--),J(O,x,O.bl_tree),ee(O,$-3,2)):$<=10?(J(O,C,O.bl_tree),ee(O,$-3,3)):(J(O,P,O.bl_tree),ee(O,$-11,7));Q=V,ye=($=0)===re?(oe=138,3):V===re?(oe=6,3):(oe=7,4)}}l(W);var H=!1;function D(O,N,Z,X){ee(O,(h<<1)+(X?1:0),3),function(V,Q,re,$){ce(V),ne(V,re),ne(V,~re),n.arraySet(V.pending_buf,V.window,Q,re,V.pending),V.pending+=re}(O,N,Z)}i._tr_init=function(O){H||(function(){var N,Z,X,V,Q,re=new Array(v+1);for(V=X=0;V<c-1;V++)for(B[V]=X,N=0;N<1<<A[V];N++)b[X++]=V;for(b[X-1]=V,V=Q=0;V<16;V++)for(W[V]=Q,N=0;N<1<<k[V];N++)z[Q++]=V;for(Q>>=7;V<u;V++)for(W[V]=Q<<7,N=0;N<1<<k[V]-7;N++)z[256+Q++]=V;for(Z=0;Z<=v;Z++)re[Z]=0;for(N=0;N<=143;)R[2*N+1]=8,N++,re[8]++;for(;N<=255;)R[2*N+1]=9,N++,re[9]++;for(;N<=279;)R[2*N+1]=7,N++,re[7]++;for(;N<=287;)R[2*N+1]=8,N++,re[8]++;for(ge(R,p+1,re),N=0;N<u;N++)T[2*N+1]=5,T[2*N]=pe(N,5);q=new se(R,A,d+1,p,v),G=new se(T,k,0,u,v),te=new se(new Array(0),M,0,g,y)}(),H=!0),O.l_desc=new F(O.dyn_ltree,q),O.d_desc=new F(O.dyn_dtree,G),O.bl_desc=new F(O.bl_tree,te),O.bi_buf=0,O.bi_valid=0,ae(O)},i._tr_stored_block=D,i._tr_flush_block=function(O,N,Z,X){var V,Q,re=0;0<O.level?(O.strm.data_type===2&&(O.strm.data_type=function($){var oe,ye=4093624447;for(oe=0;oe<=31;oe++,ye>>>=1)if(1&ye&&$.dyn_ltree[2*oe]!==0)return r;if($.dyn_ltree[18]!==0||$.dyn_ltree[20]!==0||$.dyn_ltree[26]!==0)return o;for(oe=32;oe<d;oe++)if($.dyn_ltree[2*oe]!==0)return o;return r}(O)),ke(O,O.l_desc),ke(O,O.d_desc),re=function($){var oe;for(w($,$.dyn_ltree,$.l_desc.max_code),w($,$.dyn_dtree,$.d_desc.max_code),ke($,$.bl_desc),oe=g-1;3<=oe&&$.bl_tree[2*I[oe]+1]===0;oe--);return $.opt_len+=3*(oe+1)+5+5+4,oe}(O),V=O.opt_len+3+7>>>3,(Q=O.static_len+3+7>>>3)<=V&&(V=Q)):V=Q=Z+5,Z+4<=V&&N!==-1?D(O,N,Z,X):O.strategy===4||Q===V?(ee(O,2+(X?1:0),3),Fe(O,R,T)):(ee(O,4+(X?1:0),3),function($,oe,ye,ue){var Ve;for(ee($,oe-257,5),ee($,ye-1,5),ee($,ue-4,4),Ve=0;Ve<ue;Ve++)ee($,$.bl_tree[2*I[Ve]+1],3);Y($,$.dyn_ltree,oe-1),Y($,$.dyn_dtree,ye-1)}(O,O.l_desc.max_code+1,O.d_desc.max_code+1,re+1),Fe(O,O.dyn_ltree,O.dyn_dtree)),ae(O),X&&ce(O)},i._tr_tally=function(O,N,Z){return O.pending_buf[O.d_buf+2*O.last_lit]=N>>>8&255,O.pending_buf[O.d_buf+2*O.last_lit+1]=255&N,O.pending_buf[O.l_buf+O.last_lit]=255&Z,O.last_lit++,N===0?O.dyn_ltree[2*Z]++:(O.matches++,N--,O.dyn_ltree[2*(b[Z]+d+1)]++,O.dyn_dtree[2*U(N)]++),O.last_lit===O.lit_bufsize-1},i._tr_align=function(O){ee(O,2,3),J(O,_,R),function(N){N.bi_valid===16?(ne(N,N.bi_buf),N.bi_buf=0,N.bi_valid=0):8<=N.bi_valid&&(N.pending_buf[N.pending++]=255&N.bi_buf,N.bi_buf>>=8,N.bi_valid-=8)}(O)}},{"../utils/common":41}],53:[function(t,s,i){s.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],54:[function(t,s,i){(function(n){(function(r,o){if(!r.setImmediate){var l,h,c,d,p=1,u={},g=!1,m=r.document,v=Object.getPrototypeOf&&Object.getPrototypeOf(r);v=v&&v.setTimeout?v:r,l={}.toString.call(r.process)==="[object process]"?function(x){process.nextTick(function(){y(x)})}:function(){if(r.postMessage&&!r.importScripts){var x=!0,C=r.onmessage;return r.onmessage=function(){x=!1},r.postMessage("","*"),r.onmessage=C,x}}()?(d="setImmediate$"+Math.random()+"$",r.addEventListener?r.addEventListener("message",_,!1):r.attachEvent("onmessage",_),function(x){r.postMessage(d+x,"*")}):r.MessageChannel?((c=new MessageChannel).port1.onmessage=function(x){y(x.data)},function(x){c.port2.postMessage(x)}):m&&"onreadystatechange"in m.createElement("script")?(h=m.documentElement,function(x){var C=m.createElement("script");C.onreadystatechange=function(){y(x),C.onreadystatechange=null,h.removeChild(C),C=null},h.appendChild(C)}):function(x){setTimeout(y,0,x)},v.setImmediate=function(x){typeof x!="function"&&(x=new Function(""+x));for(var C=new Array(arguments.length-1),P=0;P<C.length;P++)C[P]=arguments[P+1];var A={callback:x,args:C};return u[p]=A,l(p),p++},v.clearImmediate=f}function f(x){delete u[x]}function y(x){if(g)setTimeout(y,0,x);else{var C=u[x];if(C){g=!0;try{(function(P){var A=P.callback,k=P.args;switch(k.length){case 0:A();break;case 1:A(k[0]);break;case 2:A(k[0],k[1]);break;case 3:A(k[0],k[1],k[2]);break;default:A.apply(o,k)}})(C)}finally{f(x),g=!1}}}}function _(x){x.source===r&&typeof x.data=="string"&&x.data.indexOf(d)===0&&y(+x.data.slice(d.length))}})(typeof self>"u"?n===void 0?this:n:self)}).call(this,typeof Si<"u"?Si:typeof self<"u"?self:typeof window<"u"?window:{})},{}]},{},[10])(10)})})(Qa);var Jd=Qa.exports;const Do=dh(Jd);class vr{constructor(e,t){E(this,"date",new Date),E(this,"author"),E(this,"guid",Ze.create()),E(this,"viewpoint"),E(this,"modifiedAuthor"),E(this,"modifiedDate"),E(this,"topic"),E(this,"_components"),E(this,"_comment",""),this._components=e,this._comment=t;const s=this._components.get(He);this.author=s.config.author}set comment(e){var t;const s=this._components.get(He);this._comment=e,this.modifiedDate=new Date,this.modifiedAuthor=s.config.author,(t=this.topic)==null||t.comments.set(this.guid,this)}get comment(){return this._comment}toJSON(){var e,t;const s={guid:this.guid,date:this.date.toISOString(),author:this.author,comment:this.comment,topic_guid:(e=this.topic)==null?void 0:e.guid,viewpoint_guid:this.viewpoint,modified_date:(t=this.modifiedDate)==null?void 0:t.toISOString(),modified_author:this.modifiedAuthor};for(const[i,n]of Object.entries(s))n===void 0&&delete s[i];return s}}const Ka=class Xt{constructor(e){E(this,"guid",Ze.create()),E(this,"title",Xt.default.title),E(this,"creationDate",new Date),E(this,"creationAuthor",""),E(this,"viewpoints",new Le),E(this,"relatedTopics",new Le),E(this,"comments",new be),E(this,"documentReferences",new Le),E(this,"customData",{}),E(this,"description"),E(this,"serverAssignedId"),E(this,"dueDate"),E(this,"modifiedAuthor"),E(this,"modifiedDate"),E(this,"index"),E(this,"_type",Xt.default.type),E(this,"_status",Xt.default.status),E(this,"_priority",Xt.default.priority),E(this,"_stage",Xt.default.stage),E(this,"_assignedTo",Xt.default.assignedTo),E(this,"_labels",Xt.default.labels??new Set),E(this,"_components"),this._components=e;const t=e.get(He);this.creationAuthor=t.config.author,this.relatedTopics.guard=s=>s!==this.guid}set type(e){const t=this._components.get(He),{strict:s,types:i}=t.config;(!s||i.has(e))&&(this._type=e)}get type(){return this._type}set status(e){const t=this._components.get(He),{strict:s,statuses:i}=t.config;(!s||i.has(e))&&(this._status=e)}get status(){return this._status}set priority(e){const t=this._components.get(He);if(e){const{strict:s,priorities:i}=t.config;if(!(!s||i.has(e)))return;this._priority=e}else this._priority=e}get priority(){return this._priority}set stage(e){const t=this._components.get(He);if(e){const{strict:s,stages:i}=t.config;if(!(!s||i.has(e)))return;this._stage=e}else this._stage=e}get stage(){return this._stage}set assignedTo(e){const t=this._components.get(He);if(e){const{strict:s,users:i}=t.config;if(!(!s||i.has(e)))return;this._assignedTo=e}else this._assignedTo=e}get assignedTo(){return this._assignedTo}set labels(e){const t=this._components.get(He),{strict:s,labels:i}=t.config;if(s){const n=new Set;for(const r of e)(!s||i.has(r))&&n.add(r);this._labels=n}else this._labels=e}get labels(){return this._labels}get _managerVersion(){return this._components.get(He).config.version}set(e){const t=e,s=this;for(const i in e){if(i==="guid")continue;const n=t[i];i in this&&(s[i]=n)}return this._components.get(He).list.set(this.guid,this),this}createComment(e,t){const s=new vr(this._components,e);return s.viewpoint=t,s.topic=this,this.comments.set(s.guid,s),s}createLabelTags(){const e=[...this.labels];if(this._components.get(He).config.exportCustomDataAsLabels)for(const t in this.customData){const s=this.customData[t];typeof s=="string"&&e.push(s)}return e}createCommentTags(){return[...this.comments.values()].map(e=>{var t;return{$Guid:e.guid,Date:e.date.toISOString(),Author:e.author,Comment:e.comment,ModifiedAuthor:e.modifiedAuthor,ModifiedDate:(t=e.modifiedDate)==null?void 0:t.toISOString(),Viewpoint:e.viewpoint?{$Guid:e.viewpoint}:void 0}})}createViewpointTags(){const e=this._components.get(Bt);return[...this.viewpoints].map(t=>e.list.get(t)).filter(t=>t).map(t=>{const s={$Guid:t.guid,Viewpoint:`${t.title??t.guid}.bcfv`};if(e.snapshots.get(t.snapshot)){const i=e.getSnapshotExtension(t.snapshot);s.Snapshot=`${t.snapshot}.${i}`}return s})}createRelatedTopicTags(){return[...this.relatedTopics].map(e=>({$Guid:e}))}createDocumentReferencesTag(e=this._managerVersion){const t=[];if(!(e==="3"||e==="2.1"))return t;const s=this._components.get(He);for(const i of this.documentReferences){const n=s.documents.get(i);if(!n)continue;let r={$Guid:Ze.create(),Description:n.description};e==="2.1"&&(r={...r,$isExternal:n.type==="external"?!0:void 0,ReferencedDocument:n.type==="external"?n.url:`../${n.fileName}`}),e==="3"&&(r={...r,DocumentGuid:n.type==="internal"?i:void 0,Url:n.type==="external"?n.url:void 0}),Object.keys(r).length>0&&t.push(r)}return t}toJSON(){var e,t;const s={guid:this.guid,server_assigned_id:this.serverAssignedId,topic_type:this.type,topic_status:this.status,title:this.title,priority:this.priority,index:this.index,labels:[...this.labels],creation_date:this.creationDate.toISOString(),creation_author:this.creationAuthor,modified_date:(e=this.modifiedDate)==null?void 0:e.toISOString(),modified_author:this.modifiedAuthor,assigned_to:this.assignedTo,stage:this.stage,description:this.description,due_date:(t=this.dueDate)==null?void 0:t.toISOString(),comments:[...this.comments].map(([r,o])=>o.toJSON()),relatedTopics:[...this.relatedTopics].map(r=>({related_topic_guid:r}))},i=this._components.get(Bt);for(const r of this.viewpoints){const o=i.list.get(r);o&&(s.viewpoints||(s.viewpoints=[]),s.viewpoints.push(o.toJSON()))}const n=this._components.get(He);for(const r of this.documentReferences){const o=n.documents.get(r);o&&(s.document_references||(s.document_references=[]),o.type==="external"?s.document_references.push({guid:Ze.create(),description:o.description,url:o.url}):s.document_references.push({guid:Ze.create(),description:o.description,document_guid:r}))}for(const[r,o]of Object.entries(s))(o===void 0||Array.isArray(o)&&o.length===0)&&delete s[r];return s}serialize(){var e,t;const s=this._managerVersion,i={$Guid:this.guid,$TopicType:this.type,$TopicStatus:this.status,$ServerAssignedId:this.serverAssignedId,Title:this.title,CreationAuthor:this.creationAuthor,CreationDate:this.creationDate.toISOString(),Priority:this.priority,Index:s==="2.1"?this.index:void 0,ModifiedDate:(e=this.modifiedDate)==null?void 0:e.toISOString(),ModifiedAuthor:this.modifiedAuthor,DueDate:(t=this.dueDate)==null?void 0:t.toISOString(),AssignedTo:this.assignedTo,Description:this.description,Stage:this.stage,DocumentReferences:s==="3"?{DocumentReference:this.createDocumentReferencesTag(s)}:void 0,RelatedTopics:s==="3"?{RelatedTopic:this.createRelatedTopicTags()}:void 0,RelatedTopic:s==="2.1"?this.createRelatedTopicTags():void 0,Labels:s==="3"?{Label:this.createLabelTags()}:void 0,Viewpoints:s==="3"?{ViewPoint:this.createViewpointTags()}:void 0,Comments:s==="3"?{Comment:this.createCommentTags()}:void 0};s==="2.1"&&(i.Labels=this.createLabelTags(),i.DocumentReference=this.createDocumentReferencesTag(s));const n={Markup:{Topic:i}};return s==="2.1"&&(n.Markup.Viewpoints=this.createViewpointTags(),n.Markup.Comment=this.createCommentTags()),`<?xml version="1.0" encoding="UTF-8"?>
    ${En.builder.build(n)}`}};E(Ka,"default",{title:"BCF Topic",type:"Issue",status:"Active"});let zo=Ka;const $d=(a,e)=>{if(e.trim()==="")return;const t=He.xmlParser.parse(e).Extensions;if(!t)return;const{Priorities:s,TopicStatuses:i,TopicTypes:n,Users:r}=t;if(s&&s.Priority){const o=Array.isArray(s.Priority)?s.Priority:[s.Priority];for(const l of o)a.config.priorities.add(l)}if(i&&i.TopicStatus){const o=Array.isArray(i.TopicStatus)?i.TopicStatus:[i.TopicStatus];for(const l of o)a.config.statuses.add(l)}if(n&&n.TopicType){const o=Array.isArray(n.TopicType)?n.TopicType:[n.TopicType];for(const l of o)a.config.types.add(l)}if(r&&r.User){const o=Array.isArray(r.User)?r.User:[r.User];for(const l of o)a.config.users.add(l)}};class eu extends Sn{constructor(){super(...arguments),E(this,"_config",{version:{type:"Select",options:new Set(["2.1","3"]),multiple:!1,value:""},author:{type:"Text",value:""},types:{type:"TextSet",value:new Set},statuses:{type:"TextSet",value:new Set},priorities:{type:"TextSet",value:new Set},labels:{type:"TextSet",value:new Set},stages:{type:"TextSet",value:new Set},users:{type:"TextSet",value:new Set},includeSelectionTag:{type:"Boolean",value:!1},updateExtensionsOnImport:{type:"Boolean",value:!1},strict:{type:"Boolean",value:!1},includeAllExtensionsOnExport:{type:"Boolean",value:!1},fallbackVersionOnImport:{type:"Select",multiple:!1,options:new Set(["2.1","3"]),value:""},ignoreIncompleteTopicsOnImport:{type:"Boolean",value:!1},exportCustomDataAsLabels:{type:"Boolean",value:!1}})}get version(){return this._config.version.value}set version(e){this._config.version.value=e}get author(){return this._config.author.value}set author(e){this._config.author.value=e}get types(){return this._config.types.value}set types(e){this._config.types.value=e}get statuses(){return this._config.statuses.value}set statuses(e){this._config.statuses.value=e}get priorities(){return this._config.priorities.value}set priorities(e){this._config.priorities.value=e}get labels(){return this._config.labels.value}set labels(e){this._config.labels.value=e}get stages(){return this._config.stages.value}set stages(e){this._config.stages.value=e}get users(){return this._config.users.value}set users(e){this._config.users.value=e}get includeSelectionTag(){return this._config.includeSelectionTag.value}set includeSelectionTag(e){this._config.includeSelectionTag.value=e}get updateExtensionsOnImport(){return this._config.updateExtensionsOnImport.value}set updateExtensionsOnImport(e){this._config.updateExtensionsOnImport.value=e}get strict(){return this._config.strict.value}set strict(e){this._config.strict.value=e}get includeAllExtensionsOnExport(){return this._config.includeAllExtensionsOnExport.value}set includeAllExtensionsOnExport(e){this._config.includeAllExtensionsOnExport.value=e}get fallbackVersionOnImport(){return this._config.fallbackVersionOnImport.value}set fallbackVersionOnImport(e){this._config.fallbackVersionOnImport.value=e}get ignoreIncompleteTopicsOnImport(){return this._config.ignoreIncompleteTopicsOnImport.value}set ignoreIncompleteTopicsOnImport(e){this._config.ignoreIncompleteTopicsOnImport.value=e}get exportCustomDataAsLabels(){return this._config.exportCustomDataAsLabels.value}set exportCustomDataAsLabels(e){this._config.exportCustomDataAsLabels.value=e}}const Fr=class ai extends xe{constructor(){super(...arguments),E(this,"enabled",!1),E(this,"_defaultConfig",{author:"jhon.doe@example.com",version:"2.1",types:new Set(["Clash","Failure","Fault","Inquiry","Issue","Remark","Request"]),statuses:new Set(["Active","In Progress","Done","In Review","Closed"]),priorities:new Set(["On hold","Minor","Normal","Major","Critical"]),labels:new Set,stages:new Set,users:new Set,includeSelectionTag:!1,updateExtensionsOnImport:!0,strict:!1,includeAllExtensionsOnExport:!0,fallbackVersionOnImport:"2.1",ignoreIncompleteTopicsOnImport:!1,exportCustomDataAsLabels:!1}),E(this,"config",new eu(this,this.components,"BCF Topics",ai.uuid)),E(this,"list",new be),E(this,"documents",new be),E(this,"onSetup",new K),E(this,"isSetup",!1),E(this,"onBCFImported",new K),E(this,"onDisposed",new K)}setup(e){if(this.isSetup)return;const t={...this._defaultConfig,...e};this.config.version=t.version,this.config.author=t.author,this.config.types=t.types,this.config.statuses=t.statuses,this.config.priorities=t.priorities,this.config.labels=t.labels,this.config.stages=t.stages,this.config.users=t.users,this.config.includeSelectionTag=t.includeSelectionTag,this.config.updateExtensionsOnImport=t.updateExtensionsOnImport,this.config.strict=t.strict,this.config.includeAllExtensionsOnExport=t.includeAllExtensionsOnExport,this.config.fallbackVersionOnImport=t.fallbackVersionOnImport||"",this.config.ignoreIncompleteTopicsOnImport=t.ignoreIncompleteTopicsOnImport,this.isSetup=!0,this.enabled=!0,this.onSetup.trigger()}create(e){const t=new zo(this.components);return e?(t.guid=e.guid??t.guid,t.set(e)):this.list.set(t.guid,t),t}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}get usedTypes(){const e=[...this.list].map(([t,s])=>s.type);return new Set(e)}get usedStatuses(){const e=[...this.list].map(([t,s])=>s.status);return new Set(e)}get usedPriorities(){const e=[...this.list].map(([t,s])=>s.priority).filter(t=>t);return new Set(e)}get usedStages(){const e=[...this.list].map(([t,s])=>s.stage).filter(t=>t);return new Set(e)}get usedUsers(){const e=[];for(const[t,s]of this.list){e.push(s.creationAuthor),s.assignedTo&&e.push(s.assignedTo),s.modifiedAuthor&&e.push(s.modifiedAuthor);for(const[i,n]of s.comments)e.push(n.author),n.modifiedAuthor&&e.push(n.modifiedAuthor)}return new Set(e)}get usedLabels(){const e=[];for(const[t,s]of this.list)e.push(...s.labels);return new Set(e)}updateExtensions(){for(const[e,t]of this.list){for(const s of t.labels)this.config.labels.add(s);this.config.types.add(t.type),t.priority&&this.config.priorities.add(t.priority),t.stage&&this.config.stages.add(t.stage),this.config.statuses.add(t.status),this.config.users.add(t.creationAuthor),t.assignedTo&&this.config.users.add(t.assignedTo),t.modifiedAuthor&&this.config.users.add(t.modifiedAuthor);for(const[s,i]of t.comments)this.config.users.add(i.author),i.modifiedAuthor&&this.config.users.add(i.modifiedAuthor)}}updateViewpointReferences(){const e=this.components.get(Bt);for(const[t,s]of this.list)for(const i of s.viewpoints)e.list.has(i)||s.viewpoints.delete(i)}async export(e=this.list.values()){const t=new Do;t.file("bcf.version",`<?xml version="1.0" encoding="UTF-8"?>
    <Version VersionId="${this.config.version}" xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/buildingSMART/BCF-XML/release_3_0/Schemas/version.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    </Version>`);for(const[i,n]of this.documents.entries())n.type!=="external"&&t.file(this.config.version==="2.1"?n.fileName:`documents/${i}`,n.data);if(this.config.version==="3"){const i=[];for(const[n,r]of this.documents.entries()){const{type:o,description:l}=r;o!=="external"&&i.push(`<Document Guid="${n}">
        <Filename>${r.fileName}</Filename>
        ${l?`<Description>${l}</Description>`:""}
      </Document>`)}i.length>0&&t.file("documents.xml",`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
  <DocumentInfo xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="documents.xsd">
    <Documents>
      ${i.join(`
`)}
    </Documents>
  </DocumentInfo>`)}t.file("bcf.extensions",this.serializeExtensions());const s=this.components.get(Bt);for(const i of e){const n=t.folder(i.guid);n.file("markup.bcf",i.serialize());for(const r of i.viewpoints){const o=s.list.get(r);if(!o)continue;const l=o.title??o.guid;n.file(`${l}.bcfv`,await o.serialize());const h=s.snapshots.get(o.snapshot);if(!h)continue;const c=h?o.snapshot:o.guid,d=s.getSnapshotExtension(o.snapshot);n.file(`${c}.${d}`,h,{binary:!0})}}return await t.generateAsync({type:"blob"})}serializeExtensions(){const e=[...this.config.types].map(o=>`<TopicType>${o}</TopicType>`).join(`
`),t=[...this.config.statuses].map(o=>`<TopicStatus>${o}</TopicStatus>`).join(`
`),s=[...this.config.priorities].map(o=>`<Priority>${o}</Priority>`).join(`
`),i=[...this.config.labels].map(o=>`<TopicLabel>${o}</TopicLabel>`).join(`
`),n=[...this.config.stages].map(o=>`<Stage>${o}</Stage>`).join(`
`),r=[...this.config.users].map(o=>`<User>${o}</User>`).join(`
`);return`
      <?xml version="1.0" encoding="UTF-8"?>
      <Extensions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="your-schema-location.xsd">
        ${e.length!==0?`<TopicTypes>
${e}
</TopicTypes>`:""}
        ${t.length!==0?`<TopicStatuses>
${t}
</TopicStatuses>`:""}
        ${s.length!==0?`<Priorities>
${s}
</Priorities>`:""}
        ${i.length!==0?`<TopicLabels>
${i}
</TopicLabels>`:""}
        ${n.length!==0?`<Stages>
${n}
</Stages>`:""}
        ${r.length!==0?`<Users>
${r}
</Users>`:""}
      </Extensions>
    `}processMarkupComment(e){const{Guid:t,Date:s,Author:i,Comment:n,Viewpoint:r}=e;if(!(t&&s&&i&&(vr||r)))return null;const o=new vr(this.components,n??"");return o.guid=t,o.date=new Date(s),o.author=i,o.viewpoint=r==null?void 0:r.Guid,o.modifiedAuthor=e.ModifiedAuthor,o.modifiedDate=e.ModifiedDate?new Date(e.ModifiedDate):void 0,o}getMarkupComments(e,t){var s;let i;if(t==="2.1"&&(i=e.Comment),t==="3"&&(i=(s=e.Topic.Comments)==null?void 0:s.Comment),!i)return[];i=Array.isArray(i)?i:[i];const n=i.map(r=>this.processMarkupComment(r)).filter(r=>r);return Array.isArray(n)?n:[n]}getMarkupLabels(e,t){var s;let i;return t==="2.1"&&(i=e.Topic.Labels),t==="3"&&(i=(s=e.Topic.Labels)==null?void 0:s.Label),i?Array.isArray(i)?i:[i]:[]}getMarkupViewpoints(e,t){var s;let i;return t==="2.1"&&(i=e.Viewpoints),t==="3"&&(i=(s=e.Topic.Viewpoints)==null?void 0:s.ViewPoint),i?(i=Array.isArray(i)?i:[i],i):[]}getMarkupRelatedTopics(e,t){var s;let i;return t==="2.1"&&(i=e.Topic.RelatedTopic),t==="3"&&(i=(s=e.Topic.RelatedTopics)==null?void 0:s.RelatedTopic),i?(Array.isArray(i)?i:[i]).map(n=>n.Guid):[]}getMarkupDocumentReferences(e,t){var s;let i;return t==="2.1"&&(i=e.Topic.DocumentReference),t==="3"&&(i=(s=e.Topic.DocumentReferences)==null?void 0:s.DocumentReference),i?Array.isArray(i)?i:[i]:[]}async load(e){var t,s,i;const{fallbackVersionOnImport:n,ignoreIncompleteTopicsOnImport:r,updateExtensionsOnImport:o}=this.config,l=new Do;await l.loadAsync(e);const h=Object.values(l.files);let c=n;const d=h.find(_=>_.name.endsWith(".version"));if(d){const _=await d.async("string"),x=ai.xmlParser.parse(_).Version.VersionId;c=String(x)}if(!(c&&(c==="2.1"||c==="3")))throw new Error(`BCFTopics: ${c} is not supported.`);const p=h.find(_=>_.name.endsWith(".extensions"));if(o&&p){const _=await p.async("string");$d(this,_)}const u=[],g=this.components.get(Bt),m=h.filter(_=>_.name.endsWith(".bcfv"));for(const _ of m){const x=await _.async("string"),C=ai.xmlParser.parse(x).VisualizationInfo;if(!C){console.warn("Missing VisualizationInfo in Viewpoint");continue}const P={},{Guid:A,ClippingPlanes:k,Components:M,OrthogonalCamera:I,PerspectiveCamera:R}=C;if(A&&(P.guid=A),M){const z={selection:[],coloring:[],visibility:{default_visibility:!1,exceptions:[],view_setup_hints:{spaces_visible:!1,space_boundaries_visible:!1,openings_visible:!1}}};P.components=z;const{Selection:b,Visibility:B}=M;if(b&&b.Component){const te=Array.isArray(b.Component)?b.Component:[b.Component];z.selection=te.map(W=>W.IfcGuid?{ifc_guid:W.IfcGuid}:null).filter(W=>W!==null)}if(B&&"DefaultVisibility"in B&&(z.visibility.default_visibility=B.DefaultVisibility),B&&B.Exceptions&&"Component"in B.Exceptions){const{Component:te}=B.Exceptions,W=Array.isArray(te)?te:[te];z.visibility.exceptions=W.map(se=>se.IfcGuid?{ifc_guid:se.IfcGuid}:null).filter(se=>se!==null)}let q;c==="2.1"&&(q=M.ViewSetupHints),c==="3"&&(q=(t=M.Visibility)==null?void 0:t.ViewSetupHints),q&&("OpeningsVisible"in q&&(z.visibility.view_setup_hints.openings_visible=q.OpeningsVisible),"SpacesVisible"in q&&(z.visibility.view_setup_hints.spaces_visible=q.SpacesVisible),"SpaceBoundariesVisible"in q&&(z.visibility.view_setup_hints.space_boundaries_visible=q.SpaceBoundariesVisible));const{Coloring:G}=M;if(G&&G.Color){const te=Array.isArray(G.Color)?G.Color:[G.Color];for(const W of te){const{Color:se,Component:F}=W;if(!(se.length===6||se.length===8))continue;const U=se.length===6?se:se.slice(2),ne=(Array.isArray(F)?F:[F]).map(ee=>ee.IfcGuid?{ifc_guid:ee.IfcGuid}:null).filter(ee=>ee!==null);z.coloring.push({color:U,components:ne})}}}if(I||R){const z=C.PerspectiveCamera??C.OrthogonalCamera,{CameraViewPoint:b,CameraDirection:B}=z,q=new L(Number(b.X),Number(b.Z),Number(-b.Y)),G=new L(Number(B.X),Number(B.Z),Number(-B.Y)),te={camera_view_point:{x:q.x,y:q.y,z:q.z},camera_direction:{x:G.x,y:G.y,z:G.z},aspect_ratio:"AspectRatio"in z?z.AspectRatio:1,camera_up_vector:{x:0,y:0,z:0}};"ViewToWorldScale"in z&&(P.orthogonal_camera={...te,view_to_world_scale:z.ViewToWorldScale}),"FieldOfView"in z&&(P.perspective_camera={...te,field_of_view:z.FieldOfView})}if(k){const z=(Array.isArray(k.ClippingPlane)?k.ClippingPlane:[k.ClippingPlane]).map(({Location:b,Direction:B})=>({location:{x:b.x,y:b.y,z:b.z},direction:{x:B.x,y:B.y,z:B.z}}));P.clipping_planes=z}const T=new $a(this.components,P);u.push(T)}const v={},f=[],y=h.filter(_=>_.name.endsWith(".bcf"));for(const _ of y){const x=await _.async("string"),C=ai.xmlParser.parse(x).Markup,P=C.Topic,{Guid:A,TopicType:k,TopicStatus:M,Title:I,CreationDate:R,CreationAuthor:T}=P;if(r&&!(A&&k&&M&&I&&R&&T))continue;const z=new zo(this.components);z.guid=A??z.guid;const b=this.getMarkupRelatedTopics(C,c);v[z.guid]=new Set(b),z.type=k??z.type,z.status=M??z.status,z.title=I??z.title,z.creationDate=R?new Date(R):z.creationDate,z.creationAuthor=T??z.creationAuthor,z.serverAssignedId=P.ServerAssignedId,z.priority=P.Priority,z.index=P.Index,z.modifiedDate=P.ModifiedDate?new Date(P.ModifiedDate):void 0,z.modifiedAuthor=P.ModifiedAuthor,z.dueDate=P.DueDate?new Date(P.DueDate):void 0,z.assignedTo=P.AssignedTo,z.description=P.Description,z.stage=P.Stage;const B=this.getMarkupLabels(C,c);for(const U of B)z.labels.add(U);const q=this.getMarkupComments(C,c);for(const U of q)z.comments.set(U.guid,U);const G=this.getMarkupViewpoints(C,c);for(const U of G){if(!(U&&U.Guid))continue;const ne=g.list.get(U.Guid);if(!ne)continue;z.viewpoints.add(ne.guid);const ee=`${z.guid}/${U.Snapshot}`,J=h.find(({name:pe})=>pe===ee);if(J){const pe=await J.async("arraybuffer"),ge=new Uint8Array(pe);g.snapshots.set(ne.guid,ge),ne.snapshot=ne.guid??null}}const te=this.getMarkupDocumentReferences(C,c),W=h.find(U=>U.name==="documents.xml");let se=[];const F=await(W==null?void 0:W.async("string"));if(F){const U=(i=(s=En.parser.parse(F).DocumentInfo)==null?void 0:s.Documents)==null?void 0:i.Document;se=Array.isArray(U)?U:[U]}for(const U of te){const{Description:ne,DocumentGuid:ee,Url:J,isExternal:pe,ReferencedDocument:ge}=U;if(ee&&se.length>0){const ae=se.find(({Guid:ke})=>ke===ee),ce=h.find(ke=>ke.name.endsWith(ee)),Ee=await(ce==null?void 0:ce.async("uint8array"));if(!(ae&&Ee))continue;const{Description:we,Filename:Fe}=ae;this.documents.set(ee,{type:"internal",fileName:Fe,description:we,data:Ee}),z.documentReferences.add(ee)}if(J){const ae=this.documents.add({type:"external",url:J,description:ne});z.documentReferences.add(ae)}if(ge){let ae=null;if(pe)ae=this.documents.add({type:"external",url:ge,description:ne});else{const ce=ge.split("/"),Ee=ce[ce.length-1],we=h.find(ke=>ke.name.endsWith(Ee)),Fe=await(we==null?void 0:we.async("uint8array"));if(!Fe)continue;ae=this.documents.add({type:"internal",fileName:Ee,data:Fe,description:ne})}z.documentReferences.add(ae)}}this.list.set(z.guid,z),f.push(z)}for(const _ in v){const x=this.list.get(_);if(!x)continue;const C=v[_];for(const P of C)x.relatedTopics.add(P)}return this.onBCFImported.trigger(f),{viewpoints:u,topics:f}}};E(Fr,"uuid","de977976-e4f6-4e4f-a01a-204727839802");E(Fr,"xmlParser",new xn.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let He=Fr;const cs=new Ar,Qe=new L,Yt=new L,Me=new bt,ko={X:new L(1,0,0),Y:new L(0,1,0),Z:new L(0,0,1)},Xn={type:"change"},Io={type:"mouseDown",mode:null},Lo={type:"mouseUp",mode:null},No={type:"objectChange"};class tu extends Fl{constructor(e,t=null){super(void 0,t);const s=new au(this);this._root=s;const i=new lu;this._gizmo=i,s.add(i);const n=new hu;this._plane=n,s.add(n);const r=this;function o(_,x){let C=x;Object.defineProperty(r,_,{get:function(){return C!==void 0?C:x},set:function(P){C!==P&&(C=P,n[_]=P,i[_]=P,r.dispatchEvent({type:_+"-changed",value:P}),r.dispatchEvent(Xn))}}),r[_]=x,n[_]=x,i[_]=x}o("camera",e),o("object",void 0),o("enabled",!0),o("axis",null),o("mode","translate"),o("translationSnap",null),o("rotationSnap",null),o("scaleSnap",null),o("space","world"),o("size",1),o("dragging",!1),o("showX",!0),o("showY",!0),o("showZ",!0),o("minX",-1/0),o("maxX",1/0),o("minY",-1/0),o("maxY",1/0),o("minZ",-1/0),o("maxZ",1/0);const l=new L,h=new L,c=new bt,d=new bt,p=new L,u=new bt,g=new L,m=new L,v=new L,f=0,y=new L;o("worldPosition",l),o("worldPositionStart",h),o("worldQuaternion",c),o("worldQuaternionStart",d),o("cameraPosition",p),o("cameraQuaternion",u),o("pointStart",g),o("pointEnd",m),o("rotationAxis",v),o("rotationAngle",f),o("eye",y),this._offset=new L,this._startNorm=new L,this._endNorm=new L,this._cameraScale=new L,this._parentPosition=new L,this._parentQuaternion=new bt,this._parentQuaternionInv=new bt,this._parentScale=new L,this._worldScaleStart=new L,this._worldQuaternionInv=new bt,this._worldScale=new L,this._positionStart=new L,this._quaternionStart=new bt,this._scaleStart=new L,this._getPointer=su.bind(this),this._onPointerDown=nu.bind(this),this._onPointerHover=iu.bind(this),this._onPointerMove=ru.bind(this),this._onPointerUp=ou.bind(this),t!==null&&this.connect(t)}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.style.touchAction="auto"}getHelper(){return this._root}pointerHover(e){if(this.object===void 0||this.dragging===!0)return;e!==null&&cs.setFromCamera(e,this.camera);const t=qn(this._gizmo.picker[this.mode],cs);t?this.axis=t.object.name:this.axis=null}pointerDown(e){if(!(this.object===void 0||this.dragging===!0||e!=null&&e.button!==0)&&this.axis!==null){e!==null&&cs.setFromCamera(e,this.camera);const t=qn(this._plane,cs,!0);t&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(t.point).sub(this.worldPositionStart)),this.dragging=!0,Io.mode=this.mode,this.dispatchEvent(Io)}}pointerMove(e){const t=this.axis,s=this.mode,i=this.object;let n=this.space;if(s==="scale"?n="local":(t==="E"||t==="XYZE"||t==="XYZ")&&(n="world"),i===void 0||t===null||this.dragging===!1||e!==null&&e.button!==-1)return;e!==null&&cs.setFromCamera(e,this.camera);const r=qn(this._plane,cs,!0);if(r){if(this.pointEnd.copy(r.point).sub(this.worldPositionStart),s==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),n==="local"&&t!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),t.indexOf("X")===-1&&(this._offset.x=0),t.indexOf("Y")===-1&&(this._offset.y=0),t.indexOf("Z")===-1&&(this._offset.z=0),n==="local"&&t!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),i.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(n==="local"&&(i.position.applyQuaternion(Me.copy(this._quaternionStart).invert()),t.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(this._quaternionStart)),n==="world"&&(i.parent&&i.position.add(Qe.setFromMatrixPosition(i.parent.matrixWorld)),t.search("X")!==-1&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),t.search("Y")!==-1&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),t.search("Z")!==-1&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(Qe.setFromMatrixPosition(i.parent.matrixWorld)))),i.position.x=Math.max(this.minX,Math.min(this.maxX,i.position.x)),i.position.y=Math.max(this.minY,Math.min(this.maxY,i.position.y)),i.position.z=Math.max(this.minZ,Math.min(this.maxZ,i.position.z));else if(s==="scale"){if(t.search("XYZ")!==-1){let o=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(o*=-1),Yt.set(o,o,o)}else Qe.copy(this.pointStart),Yt.copy(this.pointEnd),Qe.applyQuaternion(this._worldQuaternionInv),Yt.applyQuaternion(this._worldQuaternionInv),Yt.divide(Qe),t.search("X")===-1&&(Yt.x=1),t.search("Y")===-1&&(Yt.y=1),t.search("Z")===-1&&(Yt.z=1);i.scale.copy(this._scaleStart).multiply(Yt),this.scaleSnap&&(t.search("X")!==-1&&(i.scale.x=Math.round(i.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Y")!==-1&&(i.scale.y=Math.round(i.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),t.search("Z")!==-1&&(i.scale.z=Math.round(i.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(s==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const o=20/this.worldPosition.distanceTo(Qe.setFromMatrixPosition(this.camera.matrixWorld));let l=!1;t==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(Qe.copy(this.rotationAxis).cross(this.eye))*o):(t==="X"||t==="Y"||t==="Z")&&(this.rotationAxis.copy(ko[t]),Qe.copy(ko[t]),n==="local"&&Qe.applyQuaternion(this.worldQuaternion),Qe.cross(this.eye),Qe.length()===0?l=!0:this.rotationAngle=this._offset.dot(Qe.normalize())*o),(t==="E"||l)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),n==="local"&&t!=="E"&&t!=="XYZE"?(i.quaternion.copy(this._quaternionStart),i.quaternion.multiply(Me.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),i.quaternion.copy(Me.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),i.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(Xn),this.dispatchEvent(No)}}pointerUp(e){e!==null&&e.button!==0||(this.dragging&&this.axis!==null&&(Lo.mode=this.mode,this.dispatchEvent(Lo)),this.dragging=!1,this.axis=null)}dispose(){this.disconnect(),this._root.dispose()}attach(e){return this.object=e,this._root.visible=!0,this}detach(){return this.object=void 0,this.axis=null,this._root.visible=!1,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(Xn),this.dispatchEvent(No),this.pointStart.copy(this.pointEnd))}getRaycaster(){return cs}getMode(){return this.mode}setMode(e){this.mode=e}setTranslationSnap(e){this.translationSnap=e}setRotationSnap(e){this.rotationSnap=e}setScaleSnap(e){this.scaleSnap=e}setSize(e){this.size=e}setSpace(e){this.space=e}}function su(a){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:a.button};{const e=this.domElement.getBoundingClientRect();return{x:(a.clientX-e.left)/e.width*2-1,y:-(a.clientY-e.top)/e.height*2+1,button:a.button}}}function iu(a){if(this.enabled)switch(a.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(a));break}}function nu(a){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(a.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(a)),this.pointerDown(this._getPointer(a)))}function ru(a){this.enabled&&this.pointerMove(this._getPointer(a))}function ou(a){this.enabled&&(this.domElement.releasePointerCapture(a.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(a)))}function qn(a,e,t){const s=e.intersectObject(a,!0);for(let i=0;i<s.length;i++)if(s[i].object.visible||t)return s[i];return!1}const Gi=new jl,Se=new L(0,1,0),Uo=new L(0,0,0),Bo=new Pe,Yi=new bt,cn=new bt,Pt=new L,Ro=new Pe,li=new L(1,0,0),ds=new L(0,1,0),hi=new L(0,0,1),Zi=new L,ni=new L,ri=new L;class au extends pi{constructor(e){super(),this.isTransformControlsRoot=!0,this.controls=e,this.visible=!1}updateMatrixWorld(e){const t=this.controls;t.object!==void 0&&(t.object.updateMatrixWorld(),t.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):t.object.parent.matrixWorld.decompose(t._parentPosition,t._parentQuaternion,t._parentScale),t.object.matrixWorld.decompose(t.worldPosition,t.worldQuaternion,t._worldScale),t._parentQuaternionInv.copy(t._parentQuaternion).invert(),t._worldQuaternionInv.copy(t.worldQuaternion).invert()),t.camera.updateMatrixWorld(),t.camera.matrixWorld.decompose(t.cameraPosition,t.cameraQuaternion,t._cameraScale),t.camera.isOrthographicCamera?t.camera.getWorldDirection(t.eye).negate():t.eye.copy(t.cameraPosition).sub(t.worldPosition).normalize(),super.updateMatrixWorld(e)}dispose(){this.traverse(function(e){e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}}class lu extends pi{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const e=new vs({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),t=new la({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),s=e.clone();s.opacity=.15;const i=t.clone();i.opacity=.5;const n=e.clone();n.color.setHex(16711680);const r=e.clone();r.color.setHex(65280);const o=e.clone();o.color.setHex(255);const l=e.clone();l.color.setHex(16711680),l.opacity=.5;const h=e.clone();h.color.setHex(65280),h.opacity=.5;const c=e.clone();c.color.setHex(255),c.opacity=.5;const d=e.clone();d.opacity=.25;const p=e.clone();p.color.setHex(16776960),p.opacity=.25,e.clone().color.setHex(16776960);const u=e.clone();u.color.setHex(7895160);const g=new Je(0,.04,.1,12);g.translate(0,.05,0);const m=new qe(.08,.08,.08);m.translate(0,.04,0);const v=new rt;v.setAttribute("position",new es([0,0,0,1,0,0],3));const f=new Je(.0075,.0075,.5,3);f.translate(0,.25,0);function y(b,B){const q=new Ws(b,.0075,3,64,B*Math.PI*2);return q.rotateY(Math.PI/2),q.rotateX(Math.PI/2),q}function _(){const b=new rt;return b.setAttribute("position",new es([0,0,0,1,1,1],3)),b}const x={X:[[new ie(g,n),[.5,0,0],[0,0,-Math.PI/2]],[new ie(g,n),[-.5,0,0],[0,0,Math.PI/2]],[new ie(f,n),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new ie(g,r),[0,.5,0]],[new ie(g,r),[0,-.5,0],[Math.PI,0,0]],[new ie(f,r)]],Z:[[new ie(g,o),[0,0,.5],[Math.PI/2,0,0]],[new ie(g,o),[0,0,-.5],[-Math.PI/2,0,0]],[new ie(f,o),null,[Math.PI/2,0,0]]],XYZ:[[new ie(new bi(.1,0),d.clone()),[0,0,0]]],XY:[[new ie(new qe(.15,.15,.01),c.clone()),[.15,.15,0]]],YZ:[[new ie(new qe(.15,.15,.01),l.clone()),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ie(new qe(.15,.15,.01),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]]]},C={X:[[new ie(new Je(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new ie(new Je(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new ie(new Je(.2,0,.6,4),s),[0,.3,0]],[new ie(new Je(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new ie(new Je(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new ie(new Je(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XYZ:[[new ie(new bi(.2,0),s)]],XY:[[new ie(new qe(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new ie(new qe(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ie(new qe(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]]},P={START:[[new ie(new bi(.01,2),i),null,null,null,"helper"]],END:[[new ie(new bi(.01,2),i),null,null,null,"helper"]],DELTA:[[new Dt(_(),i),null,null,null,"helper"]],X:[[new Dt(v,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Dt(v,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Dt(v,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},A={XYZE:[[new ie(y(.5,1),u),null,[0,Math.PI/2,0]]],X:[[new ie(y(.5,.5),n)]],Y:[[new ie(y(.5,.5),r),null,[0,0,-Math.PI/2]]],Z:[[new ie(y(.5,.5),o),null,[0,Math.PI/2,0]]],E:[[new ie(y(.75,1),p),null,[0,Math.PI/2,0]]]},k={AXIS:[[new Dt(v,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},M={XYZE:[[new ie(new Vl(.25,10,8),s)]],X:[[new ie(new Ws(.5,.1,4,24),s),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new ie(new Ws(.5,.1,4,24),s),[0,0,0],[Math.PI/2,0,0]]],Z:[[new ie(new Ws(.5,.1,4,24),s),[0,0,0],[0,0,-Math.PI/2]]],E:[[new ie(new Ws(.75,.1,2,24),s)]]},I={X:[[new ie(m,n),[.5,0,0],[0,0,-Math.PI/2]],[new ie(f,n),[0,0,0],[0,0,-Math.PI/2]],[new ie(m,n),[-.5,0,0],[0,0,Math.PI/2]]],Y:[[new ie(m,r),[0,.5,0]],[new ie(f,r)],[new ie(m,r),[0,-.5,0],[0,0,Math.PI]]],Z:[[new ie(m,o),[0,0,.5],[Math.PI/2,0,0]],[new ie(f,o),[0,0,0],[Math.PI/2,0,0]],[new ie(m,o),[0,0,-.5],[-Math.PI/2,0,0]]],XY:[[new ie(new qe(.15,.15,.01),c),[.15,.15,0]]],YZ:[[new ie(new qe(.15,.15,.01),l),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ie(new qe(.15,.15,.01),h),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new ie(new qe(.1,.1,.1),d.clone())]]},R={X:[[new ie(new Je(.2,0,.6,4),s),[.3,0,0],[0,0,-Math.PI/2]],[new ie(new Je(.2,0,.6,4),s),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new ie(new Je(.2,0,.6,4),s),[0,.3,0]],[new ie(new Je(.2,0,.6,4),s),[0,-.3,0],[0,0,Math.PI]]],Z:[[new ie(new Je(.2,0,.6,4),s),[0,0,.3],[Math.PI/2,0,0]],[new ie(new Je(.2,0,.6,4),s),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new ie(new qe(.2,.2,.01),s),[.15,.15,0]]],YZ:[[new ie(new qe(.2,.2,.01),s),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new ie(new qe(.2,.2,.01),s),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new ie(new qe(.2,.2,.2),s),[0,0,0]]]},T={X:[[new Dt(v,i.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Dt(v,i.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Dt(v,i.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function z(b){const B=new pi;for(const q in b)for(let G=b[q].length;G--;){const te=b[q][G][0].clone(),W=b[q][G][1],se=b[q][G][2],F=b[q][G][3],U=b[q][G][4];te.name=q,te.tag=U,W&&te.position.set(W[0],W[1],W[2]),se&&te.rotation.set(se[0],se[1],se[2]),F&&te.scale.set(F[0],F[1],F[2]),te.updateMatrix();const ne=te.geometry.clone();ne.applyMatrix4(te.matrix),te.geometry=ne,te.renderOrder=1/0,te.position.set(0,0,0),te.rotation.set(0,0,0),te.scale.set(1,1,1),B.add(te)}return B}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=z(x)),this.add(this.gizmo.rotate=z(A)),this.add(this.gizmo.scale=z(I)),this.add(this.picker.translate=z(C)),this.add(this.picker.rotate=z(M)),this.add(this.picker.scale=z(R)),this.add(this.helper.translate=z(P)),this.add(this.helper.rotate=z(k)),this.add(this.helper.scale=z(T)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(e){const t=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:cn;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let s=[];s=s.concat(this.picker[this.mode].children),s=s.concat(this.gizmo[this.mode].children),s=s.concat(this.helper[this.mode].children);for(let i=0;i<s.length;i++){const n=s[i];n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition);let r;if(this.camera.isOrthographicCamera?r=(this.camera.top-this.camera.bottom)/this.camera.zoom:r=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),n.scale.set(1,1,1).multiplyScalar(r*this.size/4),n.tag==="helper"){n.visible=!1,n.name==="AXIS"?(n.visible=!!this.axis,this.axis==="X"&&(Me.setFromEuler(Gi.set(0,0,0)),n.quaternion.copy(t).multiply(Me),Math.abs(Se.copy(li).applyQuaternion(t).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Y"&&(Me.setFromEuler(Gi.set(0,0,Math.PI/2)),n.quaternion.copy(t).multiply(Me),Math.abs(Se.copy(ds).applyQuaternion(t).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="Z"&&(Me.setFromEuler(Gi.set(0,Math.PI/2,0)),n.quaternion.copy(t).multiply(Me),Math.abs(Se.copy(hi).applyQuaternion(t).dot(this.eye))>.9&&(n.visible=!1)),this.axis==="XYZE"&&(Me.setFromEuler(Gi.set(0,Math.PI/2,0)),Se.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(Bo.lookAt(Uo,Se,ds)),n.quaternion.multiply(Me),n.visible=this.dragging),this.axis==="E"&&(n.visible=!1)):n.name==="START"?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):n.name==="END"?(n.position.copy(this.worldPosition),n.visible=this.dragging):n.name==="DELTA"?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),Qe.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),Qe.applyQuaternion(this.worldQuaternionStart.clone().invert()),n.scale.copy(Qe),n.visible=this.dragging):(n.quaternion.copy(t),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=this.axis.search(n.name)!==-1));continue}n.quaternion.copy(t),this.mode==="translate"||this.mode==="scale"?(n.name==="X"&&Math.abs(Se.copy(li).applyQuaternion(t).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Y"&&Math.abs(Se.copy(ds).applyQuaternion(t).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="Z"&&Math.abs(Se.copy(hi).applyQuaternion(t).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XY"&&Math.abs(Se.copy(hi).applyQuaternion(t).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="YZ"&&Math.abs(Se.copy(li).applyQuaternion(t).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),n.name==="XZ"&&Math.abs(Se.copy(ds).applyQuaternion(t).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1)):this.mode==="rotate"&&(Yi.copy(t),Se.copy(this.eye).applyQuaternion(Me.copy(t).invert()),n.name.search("E")!==-1&&n.quaternion.setFromRotationMatrix(Bo.lookAt(this.eye,Uo,ds)),n.name==="X"&&(Me.setFromAxisAngle(li,Math.atan2(-Se.y,Se.z)),Me.multiplyQuaternions(Yi,Me),n.quaternion.copy(Me)),n.name==="Y"&&(Me.setFromAxisAngle(ds,Math.atan2(Se.x,Se.z)),Me.multiplyQuaternions(Yi,Me),n.quaternion.copy(Me)),n.name==="Z"&&(Me.setFromAxisAngle(hi,Math.atan2(Se.y,Se.x)),Me.multiplyQuaternions(Yi,Me),n.quaternion.copy(Me))),n.visible=n.visible&&(n.name.indexOf("X")===-1||this.showX),n.visible=n.visible&&(n.name.indexOf("Y")===-1||this.showY),n.visible=n.visible&&(n.name.indexOf("Z")===-1||this.showZ),n.visible=n.visible&&(n.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),n.material._color=n.material._color||n.material.color.clone(),n.material._opacity=n.material._opacity||n.material.opacity,n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled&&this.axis&&(n.name===this.axis||this.axis.split("").some(function(o){return n.name===o}))&&(n.material.color.setHex(16776960),n.material.opacity=1)}super.updateMatrixWorld(e)}}class hu extends ie{constructor(){super(new Or(1e5,1e5,2,2),new vs({visible:!1,wireframe:!0,side:Ft,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(e){let t=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(t="local"),Zi.copy(li).applyQuaternion(t==="local"?this.worldQuaternion:cn),ni.copy(ds).applyQuaternion(t==="local"?this.worldQuaternion:cn),ri.copy(hi).applyQuaternion(t==="local"?this.worldQuaternion:cn),Se.copy(ni),this.mode){case"translate":case"scale":switch(this.axis){case"X":Se.copy(this.eye).cross(Zi),Pt.copy(Zi).cross(Se);break;case"Y":Se.copy(this.eye).cross(ni),Pt.copy(ni).cross(Se);break;case"Z":Se.copy(this.eye).cross(ri),Pt.copy(ri).cross(Se);break;case"XY":Pt.copy(ri);break;case"YZ":Pt.copy(Zi);break;case"XZ":Se.copy(ri),Pt.copy(ni);break;case"XYZ":case"E":Pt.set(0,0,0);break}break;case"rotate":default:Pt.set(0,0,0)}Pt.length()===0?this.quaternion.copy(this.cameraQuaternion):(Ro.lookAt(Qe.set(0,0,0),Pt,Se),this.quaternion.setFromRotationMatrix(Ro)),super.updateMatrixWorld(e)}}class Vr{constructor(e,t,s,i,n,r=5,o=!0){if(E(this,"onDraggingStarted",new K),E(this,"onDraggingEnded",new K),E(this,"onDisposed",new K),E(this,"normal"),E(this,"origin"),E(this,"three",new ct),E(this,"components"),E(this,"world"),E(this,"type","default"),E(this,"_title","Clipping Plane"),E(this,"_helper"),E(this,"_visible",!0),E(this,"_enabled",!0),E(this,"_controlsActive",!1),E(this,"_arrowBoundBox",new ie),E(this,"_planeMesh"),E(this,"_controls"),E(this,"_hiddenMaterial",new vs({visible:!1})),E(this,"_visibilityBeforeDisabled",!0),E(this,"notifyManager",()=>{const l=this.components.get(Qt),h=l.list.getKey(this);h&&l.list.set(h,this)}),E(this,"update",()=>{this._enabled&&this.three.setFromNormalAndCoplanarPoint(this.normal,this._helper.position)}),E(this,"changeDrag",l=>{this._visible=!l.value,this.preventCameraMovement(),this.notifyDraggingChanged(l)}),this.components=e,this.world=t,!t.renderer)throw new Error("The given world must have a renderer!");this.normal=i,this.origin=s,t.renderer.setPlane(!0,this.three),this._planeMesh=Vr.newPlaneMesh(r,n),this._helper=this.newHelper(),this._controls=this.newTransformControls(),this.three.setFromNormalAndCoplanarPoint(i,s),o&&this.toggleControls(!0)}set title(e){this._title=e,this.notifyManager()}get title(){return this._title}get enabled(){return this._enabled}set enabled(e){if(!this.world.isDisposing){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");this._enabled=e,e?this.visible=this._visibilityBeforeDisabled:(this._visibilityBeforeDisabled=this.visible,this.visible=!1),this.world.renderer.setPlane(e,this.three),this.notifyManager()}}get visible(){return this._visible}set visible(e){this._visible=e,this._controls.getHelper().visible=e,this._helper.visible=e,this.toggleControls(e),this.notifyManager()}get meshes(){return[this._planeMesh,this._arrowBoundBox]}get planeMaterial(){return this._planeMesh.material}set planeMaterial(e){this._planeMesh.material=e}get size(){return this._planeMesh.scale.x}set size(e){this._planeMesh.scale.set(e,e,e)}get helper(){return this._helper}get controls(){return this._controls}setFromNormalAndCoplanarPoint(e,t){this.reset(),this.normal.equals(e)||(this.normal.copy(e),this._helper.lookAt(e)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix(),this.update()}dispose(){this._enabled=!1,this.onDraggingStarted.reset(),this.onDraggingEnded.reset(),this._helper.removeFromParent(),this.world.renderer&&this.world.renderer.setPlane(!1,this.three),this._arrowBoundBox.removeFromParent(),this._arrowBoundBox.geometry.dispose(),this._planeMesh.geometry.dispose(),this._controls.getHelper().removeFromParent(),this._controls.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}reset(){const e=new L(1,0,0),t=new L;this.normal.equals(e)||(this.normal.copy(e),this._helper.lookAt(e)),this.origin.copy(t),this._helper.position.copy(t),this._helper.updateMatrix()}toggleControls(e){if(e){if(this._controlsActive)return;this._controls.addEventListener("change",this.update),this._controls.addEventListener("dragging-changed",this.changeDrag)}else this._controls.removeEventListener("change",this.update),this._controls.removeEventListener("dragging-changed",this.changeDrag);this._controlsActive=e}newTransformControls(){if(!this.world.renderer)throw new Error("No renderer found for clipping plane!");const e=this.world.camera.three,t=this.world.renderer.three.domElement,s=new tu(e,t);return this.initializeControls(s),this.world.scene.three.add(s.getHelper()),s}initializeControls(e){e.attach(this._helper),e.showX=!1,e.showY=!1,e.setSpace("local"),this.createArrowBoundingBox(),e.getHelper().children[0].children[0].add(this._arrowBoundBox)}createArrowBoundingBox(){this._arrowBoundBox.geometry=new Je(.18,.18,1.2),this._arrowBoundBox.material=this._hiddenMaterial,this._arrowBoundBox.rotateX(Math.PI/2),this._arrowBoundBox.updateMatrix(),this._arrowBoundBox.geometry.applyMatrix4(this._arrowBoundBox.matrix)}notifyDraggingChanged(e){e.value?this.onDraggingStarted.trigger():this.onDraggingEnded.trigger()}preventCameraMovement(){this.world.camera.enabled=this._visible}newHelper(){const e=new pi;return e.lookAt(this.normal),e.position.copy(this.origin),this._planeMesh.position.z+=.01,e.add(this._planeMesh),this.world.scene.three.add(e),e}static newPlaneMesh(e,t){const s=new Or(1),i=new ie(s,t);return i.scale.set(e,e,e),i}}class cu extends Sn{constructor(){super(...arguments),E(this,"_config",{enabled:{value:!0,type:"Boolean"},visible:{value:!0,type:"Boolean"},color:{value:new fe,type:"Color"},opacity:{type:"Number",interpolable:!0,value:1,min:0,max:1},size:{type:"Number",interpolable:!0,value:2,min:0,max:100}})}get enabled(){return this._config.enabled.value}set enabled(e){this._config.enabled.value=e,this._component.enabled=e}get visible(){return this._config.visible.value}set visible(e){this._config.visible.value=e,this._component.visible=e}get color(){return this._config.color.value}set color(e){this._config.color.value=e,this._component.material.color.copy(e)}get opacity(){return this._config.opacity.value}set opacity(e){this._config.opacity.value=e,this._component.material.opacity=e}get size(){return this._config.size.value}set size(e){this._config.size.value=e,this._component.size=e}}const Ja=class dn extends xe{constructor(e){super(e),E(this,"onSetup",new K),E(this,"onBeforeDrag",new K),E(this,"onAfterDrag",new K),E(this,"onBeforeCreate",new K),E(this,"onBeforeCancel",new K),E(this,"onAfterCancel",new K),E(this,"onBeforeDelete",new K),E(this,"onAfterCreate",new K),E(this,"onAfterDelete",new K),E(this,"onDisposed",new K),E(this,"isSetup",!1),E(this,"orthogonalY",!1),E(this,"toleranceOrthogonalY",.7),E(this,"Type",Vr),E(this,"list",new be),E(this,"config",new cu(this,this.components,"Clipper",dn.uuid)),E(this,"_defaultConfig",{color:new fe(12255487),opacity:.2,size:2}),E(this,"_material",new vs({color:12255487,side:Ft,transparent:!0,opacity:.2})),E(this,"_size",5),E(this,"_enabled",!1),E(this,"_visible",!0),E(this,"onStateChanged",new K),E(this,"_onStartDragging",()=>{this.onBeforeDrag.trigger()}),E(this,"_onEndDragging",()=>{this.onAfterDrag.trigger()}),this.components.add(dn.uuid,this),this.setEvents()}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this.onStateChanged.trigger(["enabled"])}get visible(){return this._visible}set visible(e){this._visible=e;for(const[t,s]of this.list)s.visible=e;this.onStateChanged.trigger(["visibility"])}get material(){return this._material}set material(e){this._material=e;for(const[t,s]of this.list)s.planeMaterial=e;this.onStateChanged.trigger(["material"])}get size(){return this._size}set size(e){this._size=e;for(const[t,s]of this.list)s.size=e;this.onStateChanged.trigger(["size"])}setEvents(){this.list.onBeforeDelete.add(({value:e})=>{if(!e.world.renderer)throw new Error("Renderer not found for this plane's world!");e.world.renderer.setPlane(!1,e.three),e.dispose(),this.updateMaterialsAndPlanes(),this.onAfterDelete.trigger(e)})}dispose(){this._enabled=!1,this.components.get(Nr).list.delete(this.config.uuid),this.list.clear(),this._material.dispose(),this.onBeforeCreate.reset(),this.onBeforeCancel.reset(),this.onBeforeDelete.reset(),this.onBeforeDrag.reset(),this.onAfterCreate.reset(),this.onAfterCancel.reset(),this.onAfterDelete.reset(),this.onAfterDrag.reset(),this.onDisposed.trigger(dn.uuid),this.onDisposed.reset()}async create(e){const t=await this.components.get(et).get(e).castRay();return t?this.createPlaneFromIntersection(e,t):null}createFromNormalAndCoplanarPoint(e,t,s){const i=this.newPlane(e,s,t);return this.updateMaterialsAndPlanes(),i}async delete(e,t){if(!t){const s=await this.pickPlane(e);if(!s)return;t=this.list.getKey(s)}t&&this.list.delete(t)}deleteAll(e){for(const[t,s]of this.list)(!e||e.has(s.type))&&this.list.delete(t)}setup(e){const t={...this._defaultConfig,...e};this.config.color=t.color,this.config.opacity=t.opacity,this.config.size=t.size,this.isSetup=!0,this.onSetup.trigger()}async pickPlane(e){const t=this.components.get(et).get(e),s=this.getAllPlaneMeshes(),i=await t.castRay({items:s});if(i){const n=i.object;return[...this.list.values()].find(r=>r.meshes.includes(n))}}getAllPlaneMeshes(){const e=[];for(const[t,s]of this.list)e.push(...s.meshes);return e}createPlaneFromIntersection(e,t){var s;if(!e.renderer)throw new Error("The given world must have a renderer!");const i=t.point.distanceTo(new L(0,0,0)),n=t.normal||((s=t.face)==null?void 0:s.normal);if(!i||!n)return null;const r=this.getWorldNormal(t,n),o=this.newPlane(e,t.point,r.negate()),l=this.list.get(o);return l.visible=this._visible,l.size=this._size,e.renderer.setPlane(!0,l.three),this.updateMaterialsAndPlanes(),l}getWorldNormal(e,t){const s=e.object;let i=e.object.matrixWorld.clone();if(s instanceof Cl&&e.instanceId!==void 0){const o=new Pe;s.getMatrixAt(e.instanceId,o),i=o.multiply(i)}const n=new Tl().getNormalMatrix(i),r=t.clone().applyMatrix3(n).normalize();return this.normalizePlaneDirectionY(r),r}normalizePlaneDirectionY(e){this.orthogonalY&&(e.y>this.toleranceOrthogonalY&&(e.x=0,e.y=1,e.z=0),e.y<-this.toleranceOrthogonalY&&(e.x=0,e.y=-1,e.z=0))}newPlane(e,t,s){const i=new this.Type(this.components,e,t,s,this._material);i.onDraggingStarted.add(this._onStartDragging),i.onDraggingEnded.add(this._onEndDragging);const n=Ze.create();return this.list.set(n,i),this.onAfterCreate.trigger(i),n}updateMaterialsAndPlanes(){const e=this.components.get(Fa);for(const[t,s]of e.list){if(!s.renderer)continue;s.renderer.updateClippingPlanes();const{clippingPlanes:i}=s.renderer;for(const n of s.meshes)if(n.material)if(Array.isArray(n.material))for(const r of n.material)r.clippingPlanes=i;else n.material.clippingPlanes=i}}};E(Ja,"uuid","66290bc5-18c4-4cd1-9379-2e17a0617611");let Qt=Ja;class $a{constructor(e,t){E(this,"title"),E(this,"guid",Ze.create()),E(this,"clippingPlanes",new Le),E(this,"camera",{aspect_ratio:1,field_of_view:60,camera_direction:{x:0,y:0,z:0},camera_view_point:{x:0,y:0,z:0},camera_up_vector:{x:0,y:1,z:0}}),E(this,"customData",{}),E(this,"exceptionComponents",new Le),E(this,"selectionComponents",new Le),E(this,"componentColors",new be),E(this,"spacesVisible",!1),E(this,"spaceBoundariesVisible",!1),E(this,"openingsVisible",!1),E(this,"defaultVisibility",!0),E(this,"snapshot",this.guid),E(this,"_components"),E(this,"_world",null),E(this,"notifyUpdate",()=>{this._components.get(Bt).list.set(this.guid,this)}),this._components=e,t&&(this.guid=t.guid??this.guid,this.set(t)),this.setEvents()}async getSelectionMap(){return await this._components.get(le).guidsToModelIdMap([...this.selectionComponents])}async getExceptionMap(){return await this._components.get(le).guidsToModelIdMap([...this.exceptionComponents])}get projection(){return"field_of_view"in this.camera?"Perspective":"Orthographic"}get position(){const e=this._components.get(le),{camera_view_point:t}=this.camera,{x:s,y:i,z:n}=t,r=new L(s,i,n);return e.applyBaseCoordinateSystem(r,new Pe),r}set position(e){const t=e.clone(),s=this._components.get(le);e.clone().applyMatrix4(s.baseCoordinationMatrix.clone().invert()),this.camera.camera_view_point={x:t.x,y:t.y,z:t.z}}get direction(){const{camera_direction:e}=this.camera,{x:t,y:s,z:i}=e;return new L(t,s,i)}set world(e){this._world=e}get world(){return this._world}get _managerVersion(){return this._components.get(He).config.version}get topics(){return[...this._components.get(He).list.values()].filter(e=>e.viewpoints.has(this.guid))}setEvents(){this.selectionComponents.onUpdated.add(this.notifyUpdate),this.exceptionComponents.onUpdated.add(this.notifyUpdate),this.clippingPlanes.onUpdated.add(this.notifyUpdate),this.componentColors.onItemSet.add(this.notifyUpdate),this.componentColors.onItemDeleted.add(this.notifyUpdate),this.componentColors.onItemUpdated.add(this.notifyUpdate),this.componentColors.onCleared.add(this.notifyUpdate)}set(e){this.title=e.title;const{components:t,perspective_camera:s,orthogonal_camera:i,clipping_planes:n}=e;if(t){const{selection:r,visibility:o,coloring:l}=t;if(r){this.selectionComponents.clear();for(const{ifc_guid:h}of r)h&&this.selectionComponents.add(h)}if(o){const{default_visibility:h,exceptions:c,view_setup_hints:d}=o;if(h!==void 0&&(this.defaultVisibility=h),c){this.exceptionComponents.clear();for(const{ifc_guid:p}of c)p&&this.exceptionComponents.add(p)}if(d){const{spaces_visible:p,space_boundaries_visible:u,openings_visible:g}=d;p!==void 0&&(this.spacesVisible=p),u!==void 0&&(this.spaceBoundariesVisible=u),g!==void 0&&(this.openingsVisible=g)}}if(l){this.componentColors.clear();for(const h of l){const{color:c,components:d}=h,p=d.map(u=>u.ifc_guid).filter(u=>u!==null);this.componentColors.set(c,p)}}}if((s||i)&&(this.camera=s??i),n&&this.world){const r=this._components.get(Qt);for(const o of n){const{location:l,direction:h}=o,c=new L(l.x,l.z,-l.y),d=new L(h.x,h.z,-h.y),p=r.createFromNormalAndCoplanarPoint(this.world,d,c);this.clippingPlanes.add(p),r.list.get(p).enabled=!1,r.list.get(p).visible=!1}}this.notifyUpdate()}async go(e){if(!this.world)return;const{camera:t}=this.world;if(!(t instanceof qa))throw new Error("Viewpoint: the world's camera component must be of type OrthoPerspectiveCamera to switch between perspective and orthographic projections.");const{transition:s,applyClippings:i,applyVisibility:n,clippingsVisibility:r}={transition:!0,applyClippings:!0,applyVisibility:!0,clippingsVisibility:!0,...e};t.projection.set(this.projection);const o=new L(this.camera.camera_view_point.x,this.camera.camera_view_point.y,this.camera.camera_view_point.z),l=new L(this.camera.camera_direction.x,this.camera.camera_direction.y,this.camera.camera_direction.z);if(o.equals(new L)&&l.equals(new L))return;const h=this.position,c=this.direction,d=80,p={x:h.x+c.x*d,y:h.y+c.y*d,z:h.z+c.z*d},u=[];i&&this.setClippingState(!0),n&&u.push(this.applyVisibility()),this.setClippingVisibility(r),u.push(t.controls.setLookAt(h.x,h.y,h.z,p.x,p.y,p.z,s)),await Promise.all(u)}async updateCamera(e=!0){return new Promise(t=>{if(!this.world){t(!1);return}const{camera:s,renderer:i}=this.world;if(!i)throw new Error("Viewpoint: the world needs to have a renderer!");if(!s.hasCameraControls())throw new Error("Viewpoint: world's camera need camera controls!");const n=new L;s.controls.getPosition(n);const r=s.three,o=new L(0,0,-1).applyEuler(r.rotation),{width:l,height:h}=i.getSize();let c=l/h;Number.isNaN(c)&&(c=1);const d=this._components.get(le);n.applyMatrix4(d.baseCoordinationMatrix.clone().invert());const p={aspect_ratio:c,camera_view_point:{x:n.x,y:n.y,z:n.z},camera_direction:{x:o.x,y:o.y,z:o.z},camera_up_vector:{x:0,y:1,z:0}};if(r instanceof ha?this.camera={...p,field_of_view:r.fov}:r instanceof wn&&(this.camera={...p,view_to_world_scale:r.top-r.bottom}),e){const u=this._components.get(Bt),g=i.three.domElement;i.three.render(this.world.scene.three,s.three),g.toBlob(async m=>{if(m){const v=await m.arrayBuffer(),f=new Uint8Array(v);u.snapshots.set(this.guid,f)}this.notifyUpdate(),t(!0)})}else this.notifyUpdate(),t(!0)})}takeSnapshot(){return new Promise(e=>{if(!this.world){e(!1);return}const{camera:t,renderer:s}=this.world;if(!s)throw new Error("Viewpoint: the world needs to have a renderer!");const i=this._components.get(Bt),n=s.three.domElement;s.three.render(this.world.scene.three,t.three),n.toBlob(async r=>{if(r){const o=await r.arrayBuffer(),l=new Uint8Array(o);i.snapshots.set(this.guid,l)}this.notifyUpdate(),e(!0)})})}updateClippingPlanes(){this.clippingPlanes.clear();const e=this._components.get(Qt);for(const[t,s]of e.list)s.enabled&&this.clippingPlanes.add(t)}async applyVisibility(){const e=this._components.get(Mc);e.set(this.defaultVisibility);const t=await this.getExceptionMap();e.set(!this.defaultVisibility,t);const s=await this.getSelectionMap();e.set(!0,s)}async setColorizationState(e){const t=this._components.get(le),s=[];if(e)for(const[i,n]of this.componentColors){const r=`#${i}`,o=await t.guidsToModelIdMap(n);for(const[l,h]of Object.entries(o)){const c=t.list.get(l);c&&s.push(c.highlight([...h],{customId:r,color:new fe(r),renderedFaces:oa.ONE,opacity:1,transparent:!1}))}}else for(const[i,n]of this.componentColors){const r=await t.guidsToModelIdMap(n);for(const[o,l]of Object.entries(r)){const h=t.list.get(o);h&&s.push(h.resetHighlight([...l]))}}s.push(t.core.update(!0)),await Promise.all(s)}setClippingState(e){const t=this._components.get(Qt);for(const[s,i]of t.list)i.enabled=e&&this.clippingPlanes.has(s)}setClippingVisibility(e){const t=this._components.get(Qt);for(const s of this.clippingPlanes){const i=t.list.get(s);i&&(i.visible=e)}}async createComponentTags(e){var t;const s=this._components.get(le),i=this._components.get(He);let n="";if(i.config.includeSelectionTag){const r=e==="selection"?await this.getSelectionMap():await this.getExceptionMap();for(const o in r){const l=s.list.get(o);if(!l)continue;const h=r[o];for(const c of h){const d=l.getItem(c),p=await d.getGuid();if(!p)continue;const u=(t=await d.getAttributes())==null?void 0:t.getValue("Tag");let g=null;u&&(g=`AuthoringToolId="${u}"`),n+=`
<Component IfcGuid="${p}" ${g??""} />`}}}else n=[...this.selectionComponents].map(r=>`<Component IfcGuid="${r}" />`).join(`
`);return n}createColorTags(){let e="";for(const[t,s]of this.componentColors.entries()){const i=s.map(n=>`
<Component IfcGuid="${n}" />`).join(`
`);e+=`<Color Color="${t}">
${i}
</Color>`}return e.length!==0?`<Coloring>
${e}
</Coloring>`:"<Coloring />"}toJSON(){const e=this._components.get(Qt),t={guid:this.guid,components:{selection:[...this.selectionComponents].map(n=>({ifc_guid:n,authoring_tool_id:null})),coloring:[...this.componentColors].map(([n,r])=>({color:n,components:r.map(o=>({ifc_guid:o,authoring_tool_id:null}))})),visibility:{default_visibility:this.defaultVisibility,exceptions:[...this.exceptionComponents].map(n=>({ifc_guid:n,authoring_tool_id:null})),view_setup_hints:{spaces_visible:this.spacesVisible,space_boundaries_visible:this.spaceBoundariesVisible,openings_visible:this.openingsVisible}}},clipping_planes:[...this.clippingPlanes].map(n=>{const r=e.list.get(n);if(!r)return null;const o=r._controls.worldPosition??r.origin,{normal:l}=r;return{location:{x:o.x,y:-o.z,z:o.y},direction:{x:l.x,y:-l.z,z:l.y}}}).filter(n=>n!==null)};"field_of_view"in this.camera?t.perspective_camera=this.camera:t.orthogonal_camera=this.camera;const s=this._components.get(Bt),i=s.snapshots.get(this.snapshot);if(i){const n=i.toString(),r=btoa(n),o=s.getSnapshotExtension(this.snapshot);t.snapshot={snapshot_type:o,snapshot_data:r}}return t}async serialize(e=this._managerVersion){const t=this._components.get(le),s=this.position;s.applyMatrix4(t.baseCoordinationMatrix.clone().invert());const i=this.direction;i.normalize();const n=new Pe().makeRotationX(Math.PI/2),r=i.clone().applyMatrix4(n);r.normalize();const o=`<CameraViewPoint>
      <X>${s.x}</X>
      <Y>${-s.z}</Y>
      <Z>${s.y}</Z>
    </CameraViewPoint>`,l=`<CameraDirection>
      <X>${i.x}</X>
      <Y>${-i.z}</Y>
      <Z>${i.y}</Z>
    </CameraDirection>`,h=`<CameraUpVector>
      <X>${r.x}</X>
      <Y>${-r.z}</Y>
      <Z>${r.y}</Z>
    </CameraUpVector>`,c=`<AspectRatio>${this.camera.aspect_ratio}</AspectRatio>`;let d="";"view_to_world_scale"in this.camera?d=`<OrthogonalCamera>
        ${o}
        ${l}
        ${h}
        ${c}
        <ViewToWorldScale>${this.camera.view_to_world_scale}</ViewToWorldScale>
      </OrthogonalCamera>`:"field_of_view"in this.camera&&(d=`<PerspectiveCamera>
        ${o}
        ${l}
        ${h}
        ${c}
        <FieldOfView>${this.camera.field_of_view}</FieldOfView>
      </PerspectiveCamera>`);const p=`<ViewSetupHints SpacesVisible="${this.spacesVisible??!1}" SpaceBoundariesVisible="${this.spaceBoundariesVisible??!1}" OpeningsVisible="${this.openingsVisible??!1}" />`,u=(await this.createComponentTags("selection")).trim(),g=(await this.createComponentTags("exception")).trim(),m=this.createColorTags();return`<?xml version="1.0" encoding="UTF-8"?>
    <VisualizationInfo Guid="${this.guid}">
      <Components>
        ${e==="2.1"?p:""}
        ${u.length!==0?`<Selection>${u}</Selection>`:""}
        <Visibility DefaultVisibility="${this.defaultVisibility}">
          ${e==="3"?p:""}
          ${g.length!==0?`<Exceptions>${g}</Exceptions>`:""}
        </Visibility>
        ${m}
      </Components>
      ${d}
    </VisualizationInfo>`}}class du extends Sn{constructor(){super(...arguments),E(this,"_config",{overwriteColors:{value:!1,type:"Boolean"}})}get overwriteColors(){return this._config.overwriteColors.value}set overwriteColors(e){this._config.overwriteColors.value=e}}const el=class yr extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"world",null),E(this,"list",new be),E(this,"snapshots",new be),E(this,"isSetup",!1),E(this,"onSetup",new K),E(this,"config",new du(this,this.components,"Viewpoints",yr.uuid)),E(this,"onDisposed",new K),e.add(yr.uuid,this)}create(e){const t=new $a(this.components,e);return t.world=this.world,e||this.list.set(t.guid,t),t}getSnapshotExtension(e){let t="jpeg";const s=this.snapshots.get(e);if(!s)return t;const i=s.subarray(0,4);let n="";for(let r=0;r<i.length;r++)n+=i[r].toString(16);return n.startsWith("89504e47")&&(t="png"),n.startsWith("ffd8ffe")&&(t="jpeg"),t}setup(){}dispose(){this.list.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}};E(el,"uuid","ee867824-a796-408d-8aa0-4e5962a83c66");let Bt=el;class Fo{constructor(e,t){E(this,"_components"),E(this,"_cameraOffset",10),E(this,"_planeHelper"),E(this,"_farPlaneHelper"),E(this,"_cameraHelper"),E(this,"onStateChanged",new K),E(this,"onUpdated",new K),E(this,"onDisposed",new K),E(this,"camera"),E(this,"plane",new ct),E(this,"farPlane",new ct),E(this,"id",Ze.create()),E(this,"_open",!1),E(this,"_range",uu.defaultRange),E(this,"_world",null),E(this,"_helpersVisible",!1),E(this,"_planesEnabled",!1),this._components=e,this.camera=new qa(this._components);const{threeOrtho:s}=this.camera;if(t!=null&&t.id&&(this.id=t.id),t!=null&&t.normal&&t!=null&&t.point){const{normal:i,point:n}=t;this.plane.setFromNormalAndCoplanarPoint(i,n)}this._cameraHelper=new Dl(s),this._planeHelper=new Zr(this.plane,50),this._farPlaneHelper=new Zr(this.farPlane,50),this.farPlaneHelperColor=new fe("blue"),this.update()}get _planeNormalOpposite(){return this.plane.normal.clone().negate()}get _planePosition(){return this.plane.normal.clone().multiplyScalar(-this.plane.constant)}get _cameraPosition(){return this._planePosition.addScaledVector(this._planeNormalOpposite,this._cameraOffset)}set open(e){this._open=e,this.onStateChanged.trigger(["open"])}get open(){return this._open}set planeHelperColor(e){!Array.isArray(this._planeHelper.material)&&"color"in this._planeHelper.material&&this._planeHelper.material.color instanceof fe&&(this._planeHelper.material.color=e)}set farPlaneHelperColor(e){!Array.isArray(this._farPlaneHelper.material)&&"color"in this._farPlaneHelper.material&&this._farPlaneHelper.material.color instanceof fe&&(this._farPlaneHelper.material.color=e)}set range(e){this._range=e,this.update()}get range(){return this._range}set distance(e){this.plane.constant=e,this.update()}get distance(){return this.plane.constant}set world(e){this._world=e,this.camera.currentWorld=e,e&&(this.camera.projection.set("Orthographic"),this.camera.set("Plan"),this.camera.controls.dollySpeed=6,this.camera.controls.restThreshold=.005,this.update())}get world(){return this._world}set helpersVisible(e){if(!e){this._helpersVisible=e,this._planeHelper.removeFromParent(),this._farPlaneHelper.removeFromParent(),this._cameraHelper.removeFromParent();return}this.world&&(this._helpersVisible=e,this.world.scene.three.add(this._planeHelper,this._farPlaneHelper))}get helpersVisible(){return this._helpersVisible}set planesEnabled(e){const{world:t}=this;if(!t)return;const{renderer:s}=t;s&&(s.setPlane(e,this.plane),s.setPlane(e,this.farPlane),this._planesEnabled=e)}get planesEnabled(){return this._planesEnabled}dispose(){this.helpersVisible=!1;const e=this._components.get(It);e.destroy(this._planeHelper),e.destroy(this._farPlaneHelper),e.destroy(this._cameraHelper),this.camera.dispose(),this.onDisposed.trigger()}update(){if(this.world){const e=this._cameraPosition,t=this._planePosition;this.camera.controls.setLookAt(e.x,e.y,e.z,t.x,t.y,t.z,!1)}this.farPlane.normal.copy(this._planeNormalOpposite),this.farPlane.constant=this.range-this.plane.constant,this.onUpdated.trigger()}flip(){this.plane.normal.negate(),this.update()}}const jr=class tl extends xe{constructor(e){super(e),E(this,"list",new be),E(this,"enabled",!0),E(this,"world",null),E(this,"_fragmentsUpdateEvent",()=>{this.components.get(le).core.update(!0)}),e.add(tl.uuid,this),this.setupEvents()}get hasOpenViews(){return[...this.list.values()].some(e=>e.open)}setupEvents(){this.list.onBeforeDelete.add(({key:e,value:t})=>{t.open&&this.close(e),t.dispose()})}create(e,t,s){const i=new Fo(this.components,{id:s==null?void 0:s.id,normal:e,point:t});return i.world=(s==null?void 0:s.world)??this.world,this.list.set(i.id,i),i}createFromPlane(e,t){const s=new Fo(this.components,{id:t==null?void 0:t.id});return s.plane.copy(e),s.update(),s.world=(t==null?void 0:t.world)??this.world,this.list.set(s.id,s),s}async createFromIfcStoreys(e){const t=[],s=this.components.get(le),i=(e==null?void 0:e.offset)===void 0?.25:e.offset;for(const[n,r]of s.list){if(e&&e.modelIds&&!e.modelIds.some(d=>d.test(n)))continue;const o=Object.values(await r.getItemsOfCategories([/BUILDINGSTOREY/])).flat();if(o.length===0)continue;const l=await r.getItemsData(o),[,h]=await r.getCoordinates(),c=new L(0,-1,0);for(const d of l){if(!("value"in d.Name&&"value"in d.Elevation))continue;const{value:p}=d.Name;if(e!=null&&e.storeyNames&&!e.storeyNames.some(v=>v.test(p)))continue;const u=d.Elevation.value+h+i,g=new ct(c,u),m=this.createFromPlane(g,{id:p,world:e==null?void 0:e.world});t.push(m)}}return t}createElevations(e){const t=[],s=this.components.get(le),i=(e==null?void 0:e.combine)===void 0?!1:e.combine,n=(e==null?void 0:e.namingCallback)??(o=>({front:`${i?"Front":`${o}: Front`}`,back:`${i?"Back":`${o}: Back`}`,left:`${i?"Left":`${o}: Left`}`,right:`${i?"Right":`${o}: Right`}`}));let r=[];for(const[o,l]of s.list)e&&e.modelIds&&!e.modelIds.some(h=>h.test(o))||r.push({id:o,box:l.box});if(i){const o=this.components.get(mn);o.list.clear(),o.list.add(...r.map(l=>l.box)),r=[{id:"combined",box:o.get()}]}for(const{id:o,box:l}of r){const{min:h,max:c}=l,d=Math.abs(c.x-h.x),p=Math.abs(c.z-h.z),u=new L;l.getCenter(u);const g=new ct(new L(0,0,-1),c.z),m=new ct(new L(0,0,1),-h.z),v=new ct(new L(-1,0,0),c.x),f=new ct(new L(1,0,0),-h.x),{front:y,back:_,left:x,right:C}=n(o),P=this.createFromPlane(g,{id:y,world:e==null?void 0:e.world});P.range=p;const A=this.createFromPlane(m,{id:_,world:e==null?void 0:e.world});A.range=p;const k=this.createFromPlane(v,{id:x,world:e==null?void 0:e.world});k.range=d;const M=this.createFromPlane(f,{id:C,world:e==null?void 0:e.world});M.range=d,t.push(P,A,k,M)}return t}open(e){const t=this.list.get(e);if(!t)throw new Error(`Views: the view with id ${e} doesn't exist.`);if(t.open)return;const{world:s}=t;if(!s)throw new Error(`Views: no world found for view with id ${e}.`);const{renderer:i}=s;if(!i)throw new Error(`Views: no renderer found for world with id ${s.uuid}.`);for(const[,n]of this.list)n.world===s&&this.close(n.id);i.setPlane(!0,t.plane),i.setPlane(!0,t.farPlane),t.camera.controls.addEventListener("rest",this._fragmentsUpdateEvent),s.camera=t.camera,t.open=!0}close(e){let t;if(e?t=this.list.get(e):t=[...this.list.values()].find(n=>n.open),e&&!t)throw new Error(`Views: the view with id ${e} doesn't exist.`);if(!t||!t.open)return;const{world:s}=t;if(!s)throw new Error(`Views: no world found for view with id ${e}.`);const{renderer:i}=s;if(!i)throw new Error(`Views: no renderer found for world with id ${s.uuid}.`);i.setPlane(!1,t.plane),i.setPlane(!1,t.farPlane),t.camera.controls.removeEventListener("rest",this._fragmentsUpdateEvent),s.useDefaultCamera(),t.open=!1}};E(jr,"uuid","fb22f1f5-6598-4664-a11d-de8963ae420f");E(jr,"defaultRange",15);let uu=jr;class Vs{constructor(e){E(this,"cardinality","required"),E(this,"instructions"),E(this,"evalRequirement",(t,s,i,n)=>{const r={parameter:i,currentValue:t,requiredValue:s,pass:!1};n&&this.addCheckResult(r,n);let o=!1;if(s.type==="simple"&&(o=t===s.parameter),s.type==="enumeration"&&(o=s.parameter.includes(t)),s.type==="pattern"&&(o=new RegExp(s.parameter).test(String(t))),s.type==="length"){const{min:l,length:h,max:c}=s.parameter;h!==void 0&&(o=String(t).length===h),l!==void 0&&(o=String(t).length>=l),c!==void 0&&(o=String(t).length<=c)}if(s.type==="bounds"&&typeof t=="number"){const{min:l,minInclusive:h,max:c,maxInclusive:d}=s.parameter;let p=!0,u=!0;l!==void 0&&(p=h?t>=l:t>l),c!==void 0&&(u=d?t<=c:t<c),o=p&&u}return this.cardinality==="prohibited"&&(o=!o),this.cardinality==="optional"&&(o=!0),r.pass=o,r.pass}),this._components=e}addCheckResult(e,t){const s=t.findIndex(({parameter:i})=>i===e.parameter);s!==-1?t[s]=e:t.push(e)}getItemChecks(e,t,s,i){if(!("value"in s._localId&&typeof s._localId.value=="number"))return null;let n=e.get(t);n||(n=new be,e.set(t,n));let r=n.get(s._localId.value);if(r&&i&&!r.pass)return null;if(!r){const h=[];r={guid:Array.isArray(s._guid)?void 0:s._guid.value,pass:!1,checks:h},Object.defineProperty(r,"pass",{get:()=>h.every(({pass:c})=>c)}),n.set(s._localId.value,r)}const o=[],l={facetType:this.facetType,cardinality:this.cardinality,checks:o,pass:!1};return Object.defineProperty(l,"pass",{get:()=>o.every(({pass:h})=>h)}),r.checks.push(l),l.checks}}const kt=(a,e)=>{let t="";if(!e)return t;if(e.type==="simple"&&(t=`<simpleValue>${e.parameter}</simpleValue>`),e.type==="enumeration"&&(t=`<xs:restriction base="xs:string">
    ${e.parameter.map(s=>`<xs:enumeration value="${s}" />`).join(`
`)}
    </xs:restriction>`),e.type==="pattern"&&(t=`<xs:restriction base="xs:string">
      <xs:pattern value="${e.parameter}" />
    </xs:restriction>`),e.type==="bounds"){const{min:s,minInclusive:i,max:n,maxInclusive:r}=e.parameter;let o="";s!==void 0&&(o=`<xs:min${i?"Inclusive":"Exclusive"} value="${s}">`);let l="";n!==void 0&&(l=`<xs:max${r?"Inclusive":"Exclusive"} value="${n}">`),t=`<xs:restriction base="xs:double">
      ${o}
      ${l}
    </xs:restriction>`}if(e.type==="length"){const{length:s,min:i,max:n}=e.parameter;let r="";s!==void 0&&i===void 0&&n===void 0&&(r=`<xs:length value="${s}" />`);let o="";i!==void 0&&s===void 0&&(o=`<xs:minLength value="${i}" />`);let l="";n!==void 0&&s===void 0&&(l=`<xs:maxLength value="${n}" />`),t=`<xs:restriction base="xs:string">
      ${r}
      ${o}
      ${l}
    </xs:restriction>`}return`<${a[0].toLowerCase()+a.slice(1)}>
    ${t}
  </${a[0].toLowerCase()+a.slice(1)}>`};class pu extends Vs{constructor(e,t){super(e),E(this,"facetType","Attribute"),E(this,"name"),E(this,"value"),this.name=t}serialize(e){const t=kt("Name",this.name),s=kt("Value",this.value);let i="";return e==="requirement"&&(i+=`cardinality="${this.cardinality}"`,i+=this.instructions?`instructions="${this.instructions}"`:""),`<attribute ${i}>
  ${t}
  ${s}
</attribute>`}async getEntities(){}async test(e,t,s={skipIfFails:!0}){const i=this._components.get(le);for(const[n,r]of Object.entries(e)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([...r]);for(const h of l){const c=this.getItemChecks(t,n,h,s.skipIfFails);if(!c)continue;const d=Object.keys(h).filter(u=>{const g=this.evalRequirement(u,this.name,"Name");if(!g)return!1;const m=h[u];return Array.isArray(m)?!0:m===null||m.value===null?this.cardinality==="optional"||this.cardinality==="prohibited":Array.isArray(m.value)&&m.value.length===0||typeof m.value=="string"&&m.value.trim()===""?!1:g}),p=d.length>0;if(c.push({parameter:"Name",currentValue:p?d[0]:null,requiredValue:this.name,pass:this.cardinality==="prohibited"?!p:p}),this.value)if(d[0]){const u=h[d[0]];Array.isArray(u)?c.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"}):Array.isArray(u.value)?c.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"}):this.evalRequirement(u.value,this.value,"Value",c)}else c.push({parameter:"Value",currentValue:null,requiredValue:this.value,pass:this.cardinality==="prohibited"})}}}}class fu extends Vs{constructor(e,t){super(e),E(this,"facetType","Classification"),E(this,"system"),E(this,"value"),E(this,"uri"),this.system=t}serialize(e){const t=kt("System",this.system),s=kt("Value",this.value);let i="";return e==="requirement"&&(i+=`cardinality="${this.cardinality}"`,i+=this.uri?`uri=${this.uri}`:"",i+=this.instructions?`instructions="${this.instructions}"`:""),`<classification ${i}>
  ${t}
  ${s}
</classification>`}async getEntities(e,t){}async test(e,t){}}class _r extends Vs{constructor(e,t){super(e),E(this,"facetType","Entity"),E(this,"name"),E(this,"predefinedType"),this.name=t}serialize(e){const t=kt("Name",this.name),s=kt("Name",this.predefinedType);let i="";return e==="requirement"&&(i+=`cardinality="${this.cardinality}"`,i+=this.instructions?`instructions="${this.instructions}"`:""),`<entity ${i}>
  ${t}
  ${s}
</entity>`}async getEntities(e,t){const s=this._components.get(le),i=new Map;for(const[r,o]of s.list){if(!e.find(h=>h.test(r)))continue;const l=await o.getCategories();for(const h of l){if(!await this.evalName(h))continue;let c=i.get(r);c||(c=[],i.set(r,c)),c.push(h)}}const n={};if(await Promise.all(Array.from(i.entries()).map(async([r,o])=>{const l=s.list.get(r);if(!l)return;const h=o.map(p=>new RegExp(`^${p}$`)),c=await l.getItemsOfCategories(h),d=Object.values(c).flat();n[r]=new Set(d)})),!this.predefinedType){ve.add(t,n);return}for(const[r,o]of Object.entries(n)){const l=s.list.get(r);if(!l)continue;const h=await l.getItemsData([...o]);for(const c of h)"value"in c._localId&&await this.evalPredefinedType(r,c)&&ve.append(t,r,c._localId.value)}}async test(e,t,s){const i=this._components.get(le);for(const[n,r]of Object.entries(e)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([...r]);for(const h of l){if(!("value"in h._category))continue;const c=this.getItemChecks(t,n,h,s.skipIfFails);c&&(await this.evalName(h._category.value,c),await this.evalPredefinedType(n,h,c))}}}async evalName(e,t){return this.evalRequirement(e,this.name,"Name",t)}async evalPredefinedType(e,t,s){if(!this.predefinedType||!("value"in t.PredefinedType))return null;const i=typeof this.predefinedType.parameter=="string"&&this.predefinedType.parameter==="USERDEFINED";let n=t.PredefinedType.value;if(n==="USERDEFINED"&&!i){const r=Object.keys(t).find(o=>/^((?!Predefined).)*Type$/.test(o));if(r){const o=t[r];"value"in o&&(n=o.value)}else n="USERDEFINED"}if(!n){const r=this._components.get(le).list.get(e);if(r&&"value"in t._localId){const[o]=await r.getItemsData([t._localId.value],{relations:{IsTypedBy:{attributes:!0,relations:!1}}});if(Array.isArray(o.IsTypedBy)){const l=o.IsTypedBy[0];if(l&&"value"in l.PredefinedType&&(n=l.PredefinedType.value,n==="USERDEFINED"&&!i)){const h=Object.keys(l).find(c=>/^((?!Predefined).)*Type$/.test(c));if(h){const c=l[h];"value"in c&&(n=c.value)}else n="USERDEFINED"}}}}return this.evalRequirement(n,this.predefinedType,"PredefinedType",s)}}class mu extends Vs{constructor(e,t,s){super(e),E(this,"facetType","Property"),E(this,"propertySet"),E(this,"baseName"),E(this,"value"),E(this,"dataType"),E(this,"uri"),E(this,"_unsupportedTypes",["IFCCOMPLEXPROPERTY","IFCPHYSICALCOMPLEXQUANTITY"]),this.propertySet=t,this.baseName=s}serialize(e){const t=kt("PropertySet",this.propertySet),s=kt("BaseName",this.baseName),i=kt("Value",this.value),n=this.dataType?`dataType=${this.dataType}`:"";let r="";return e==="requirement"&&(r+=`cardinality="${this.cardinality}"`,r+=this.uri?`uri=${this.uri}`:"",r+=this.instructions?`instructions="${this.instructions}"`:""),`<property ${n} ${r}>
  ${t}
  ${s}
  ${i}
</property>`}async getEntities(e,t){const s=this._components.get(le);for(const[i,n]of s.list){if(!e.find(h=>h.test(i)))continue;const r=await n.getItemsOfCategories([/PROPERTYSET/,/ELEMENTQUANTITY/]),o=Object.values(r).flat();if(o.length===0)continue;const l=await n.getItemsData(o,{relations:{HasProperties:{attributes:!0,relations:!1},DefinesOcurrence:{attributes:!0,relations:!1}}});for(const h of l){if(!("value"in h._localId&&"value"in h._category&&"value"in h.Name&&Array.isArray(h.DefinesOcurrence))||!this.evalRequirement(h.Name.value,this.propertySet,"PropertySet"))continue;let c;if(h._category.value==="IFCPROPERTYSET"&&(c="HasProperties"),h._category.value==="IFCELEMENTQUANTITY"&&(c="Quantities"),!c)continue;const d=h[c];if(Array.isArray(d))for(const p of d){const u=Object.keys(p),g=u.find(f=>/Name/.test(f));if(!(g&&"value"in p[g]))continue;const m=p[g];if(!("value"in m)||!this.evalRequirement(m.value,this.baseName,"BaseName"))continue;if(this.value){const f=u.find(_=>/Value/.test(_));if(!f)continue;const y=p[f];if(!("value"in y)||!this.evalRequirement(y.value,this.value,"Value"))continue}const v=h.DefinesOcurrence.map(f=>"value"in f._localId&&typeof f._localId.value=="number"?f._localId.value:null).filter(f=>f!==null);ve.append(t,i,...v)}}}}async test(e,t,s={skipIfFails:!0}){const i=this._components.get(le);for(const[n,r]of Object.entries(e)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([...r],{relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasPropertySets:{attributes:!0,relations:!0},DefinesOcurrence:{attributes:!1,relations:!1}}});for(const h of l){const c=this.getItemChecks(t,n,h,s.skipIfFails);if(!c)continue;const d=(await this.getPsets(h)).filter(p=>!("value"in p.Name)||!this.evalRequirement(p.Name.value,this.propertySet,"PropertySet")?!1:(c.push({currentValue:p.Name.value,parameter:"PropertySet",pass:!0,requiredValue:this.propertySet}),!0));if(d.length===0){c.push({currentValue:null,parameter:"PropertySet",pass:!1,requiredValue:this.propertySet});continue}for(const p of d){const u=this.getPropertyListName(p);if(!u)continue;const g=p[u];if(!Array.isArray(g)){c.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}const m=g.filter(v=>!("value"in v._category&&"value"in v.Name)||this._unsupportedTypes.includes(v._category.value)||!this.evalRequirement(v.Name.value,this.baseName,"BaseName")?!1:(c.push({currentValue:v.Name.value,parameter:"BaseName",pass:!0,requiredValue:this.baseName}),!0));if(m.length===0){c.push({currentValue:null,parameter:"BaseName",pass:!1,requiredValue:this.baseName});continue}for(const v of m)this.evalValue(v,c),this.evalDataType(v,c),this.evalURI()}}}}getPropertyListName(e){let t;return"value"in e._category&&(e._category.value==="IFCPROPERTYSET"&&(t="HasProperties"),e._category.value==="IFCELEMENTQUANTITY"&&(t="Quantities")),t}getValueKey(e){return Object.keys(e).find(t=>/Value/.test(t)||/Values/.test(t))}getTypePsets(e){if(!Array.isArray(e.IsTypedBy))return[];const[t]=e.IsTypedBy;return t&&Array.isArray(t.HasPropertySets)?t.HasPropertySets:[]}async getPsets(e){const t=this.getTypePsets(e);if(!Array.isArray(e.IsDefinedBy))return t;const s=[];for(const i of e.IsDefinedBy){if(!("value"in i.Name))continue;const n=i.Name.value,r=this.getPropertyListName(i);if(!(n&&r))continue;const o=t.find(l=>"value"in l.Name?l.Name.value===n:!1);if(o&&Array.isArray(o.HasProperties)&&Array.isArray(i.HasProperties))for(const l of o.HasProperties){if(!("value"in l.Name))continue;const h=l.Name.value;i.HasProperties.find(c=>"value"in c.Name?c.Name.value===h:!1)||i.HasProperties.push(l)}s.push(i)}return s}evalValue(e,t){const s=this.getValueKey(e),i=e[s];if(!("value"in i))return!1;if(this.value){if(!s)return t==null||t.push({parameter:"Value",currentValue:null,pass:!1,requiredValue:this.value}),!1;const n=structuredClone(this.value);return i.type==="IFCLABEL"&&n.type==="simple"&&(n.parameter=String(n.parameter)),this.evalRequirement(i.value,n,"Value",t)}return s&&typeof i.value=="string"&&i.value.trim()===""?(t==null||t.push({parameter:"Value",currentValue:"",pass:!1,requiredValue:this.value}),!1):!0}evalDataType(e,t){if(!this.dataType)return!0;const s=this.getValueKey(e);if(!(s&&"value"in e[s]))return t==null||t.push({parameter:"DataType",currentValue:null,pass:!1,requiredValue:this.dataType}),!1;const i=e[s];return this.evalRequirement(i.type??null,{type:"simple",parameter:this.dataType},"DataType",t)}evalURI(){return!0}}class gu extends Vs{constructor(){super(...arguments),E(this,"_ifcMaterialEntities",[/^IFCMATERIALLAYERSETUSAGE$/,/^IFCMATERIALCONSTITUENTSET$/,/^IFCMATERIAL$/,/^IFCMATERIALLIST$/]),E(this,"facetType","Material"),E(this,"value"),E(this,"uri")}serialize(e){if(!(this.value&&this.uri))return"<material />";const t=kt("Value",this.value);let s="";return e==="requirement"&&(s+=`cardinality="${this.cardinality}"`,s+=this.uri?`uri=${this.uri}`:"",s+=this.instructions?`instructions="${this.instructions}"`:""),`<material ${s}>
  ${t}
</material>`}async getEntities(e,t){const s=this._components.get(le);for(const[i,n]of s.list){if(!e.find(h=>h.test(i)))continue;const r=await n.getItemsOfCategories(this._ifcMaterialEntities),o=Object.values(r).flat();if(o.length===0)continue;const l=await n.getItemsData(o,{relations:{AssociatedTo:{attributes:!0,relations:!1},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const h of l){if(!("value"in h._localId&&"value"in h._category&&Array.isArray(h.AssociatedTo))||!this.hasValidMaterial(h))continue;const c=h.AssociatedTo.map(d=>"value"in d._localId&&d._localId.value?d._localId.value:null).filter(d=>d!==null);ve.append(t,i,...c)}}}async test(e,t,s={skipIfFails:!0}){const i=this._components.get(le);for(const[n,r]of Object.entries(e)){const o=i.list.get(n);if(!o)continue;const l=await o.getItemsData([[...r][0]],{relations:{AssociatedTo:{attributes:!1,relations:!1},HasAssociations:{attributes:!0,relations:!0},MaterialConstituents:{attributes:!0,relations:!0},ForLayerSet:{attributes:!0,relations:!0},MaterialLayers:{attributes:!0,relations:!0},Materials:{attributes:!0,relations:!1}}});for(const h of l){const c=this.getItemChecks(t,n,h,s.skipIfFails);if(c){if(!Array.isArray(h.HasAssociations)){c.push({parameter:null,currentValue:null,requiredValue:this.value,pass:!1});continue}for(const d of h.HasAssociations)if(this._ifcMaterialEntities.some(p=>"value"in d._category?p.test(d._category.value):!1)&&this.hasValidMaterial(d,c))break}}}}hasValidMaterial(e,t){let s=!1;if("value"in e._category&&e._category.value==="IFCMATERIAL")this.evalValue(e,t)&&(s=!0);else for(const[i,n]of Object.entries(e))if(["ForLayerSet","MaterialLayers","Material","MaterialConstituents","Materials"].includes(i)&&Array.isArray(n)){for(const r of n)if("value"in r._category&&r._category.value==="IFCMATERIAL"){if(this.evalValue(r,t)){s=!0;break}}else if(this.hasValidMaterial(r)){s=!0;break}}return s}evalValue(e,t){if(!this.value)return t==null||t.push({parameter:null,currentValue:e.Name&&"value"in e.Name?e.Name.value:null,pass:!0}),!0;if(!("value"in e._category&&e._category.value==="IFCMATERIAL"))return null;let s=!1;return e.Name&&"value"in e.Name&&(s=this.evalRequirement(e.Name.value,this.value,"Value",t)),s||(e.Category&&"value"in e.Category&&(s=this.evalRequirement(e.Category.value,this.value,"Value",t)),s)}}class vu extends Vs{constructor(e,t){super(e),E(this,"facetType","PartOf"),E(this,"_entityFacet"),E(this,"_entity"),E(this,"relation"),E(this,"cardinality","required"),this._entity=t,this._entityFacet=new _r(e,t.name),this._entityFacet.predefinedType=t.predefinedType}set entity(e){this._entity=e;const{name:t,predefinedType:s}=e;this._entityFacet=new _r(this._components,t),this._entityFacet.predefinedType=s}get entity(){return this._entity}serialize(){return""}async getEntities(e,t){}async test(e){}}class yu{constructor(e,t,s){E(this,"name"),E(this,"ifcVersion",new Set),E(this,"identifier",Ze.create()),E(this,"description"),E(this,"instructions"),E(this,"requirementsDescription"),E(this,"applicability",new Le),E(this,"requirements",new Le),E(this,"components"),this.components=e,this.name=t;for(const i of s)this.ifcVersion.add(i)}set(e){const t=e,s=this;for(const i in e){if(i==="identifier")continue;const n=t[i];i in this&&(s[i]=n)}return this.components.get(_u).list.set(this.identifier,this),this}async test(e,t={skipIfFails:!0}){const s=new be;if(this.requirements.size===0)return s;const i={},n=[];for(const o of this.applicability)n.push(o.getEntities(e,i));await Promise.all(n);const r=[];for(const o of this.requirements)r.push(o.test(i,s,t));return await Promise.all(r),s}serialize(){const e=`name="${this.name}"`,t=this.identifier?`identifier="${this.identifier}"`:"",s=this.description?`description="${this.description}"`:"",i=this.instructions?`instructions="${this.instructions}"`:"";return`<specification ifcVersion="${[...this.ifcVersion].join(" ")}" ${e} ${t} ${s} ${i}>
      <applicability minOccurs="1" maxOccurs="unbounded">
        ${[...this.applicability].map(n=>n.serialize("applicability")).join(`
`)}
      </applicability>
      <requirements>
        ${[...this.requirements].map(n=>n.serialize("requirement")).join(`
`)}
      </requirements>
    </specification>`}}const gt=a=>{if(!a)return;const e={};if("simpleValue"in a&&(e.type="simple",e.parameter=a.simpleValue),"restriction"in a){const t=a.restriction,s=Object.keys(t);if("pattern"in t&&(e.type="pattern",e.parameter=t.pattern.value),"enumeration"in t){e.type="enumeration";const i=t.enumeration.map(({value:n})=>t.base.includes("string")?String(n):t.base.includes("integer")||t.base.includes("double")?Number(n):n);e.parameter=i}if(s.some(i=>["minInclusive","minExclusive","maxInclusive","maxExclusive"].includes(i))){e.type="bounds";const i={},n=s.find(o=>o.includes("min")),r=s.find(o=>o.includes("max"));n&&(i.minInclusive=n==="minInclusive",i.min=t[n].value),r&&(i.maxInclusive=r==="maxInclusive",i.max=t[r].value),e.parameter=i}if(s.some(i=>["minLength","length","maxLength"].includes(i))){e.type="length";const i={};t.length!==void 0&&(i.length=t.length.value),t.minLength!==void 0&&(i.min=t.minLength.value),t.maxLength!==void 0&&(i.max=t.maxLength.value),e.parameter=i}}if(e.parameter!==void 0)return e},Vo=(a,e)=>{const t=[];for(const s of e){const i=s.name,n=gt(i);if(!n)continue;const r=new _r(a,n);s.cardinality&&(r.cardinality=s.cardinality),r.predefinedType=gt(s.predefinedType),r.instructions=s.instructions,t.push(r)}return t},jo=(a,e)=>{const t=[];for(const s of e){const i=s.name,n=gt(i);if(!n)continue;const r=new pu(a,n);s.cardinality&&(r.cardinality=s.cardinality),r.value=gt(s.value),r.instructions=s.instructions,t.push(r)}return t},Ho=(a,e)=>{const t=[];for(const s of e){const i=new gu(a);s.cardinality&&(i.cardinality=s.cardinality);const n=gt(s.value);(n==null?void 0:n.type)==="enumeration"&&Array.isArray(n.parameter)&&(n.parameter=n.parameter.map(String)),i.value=n,i.uri=s.uri,i.instructions=s.instructions,t.push(i)}return t},Wo=(a,e)=>{const t=[];for(const s of e){const i=s.propertySet,n=s.baseName,r=gt(i),o=gt(n);if(!(o&&r))continue;const l=new mu(a,r,o);s.cardinality&&(l.cardinality=s.cardinality);const h=gt(s.value);l.value=h,l.dataType=s.dataType,l.uri=s.uri,l.instructions=s.instructions,t.push(l)}return t},Go=(a,e)=>{const t=[];for(const s of e){const i=s.system,n=gt(i);if(!n)continue;const r=new fu(a,n);s.cardinality&&(r.cardinality=s.cardinality);const o=gt(s.value);(o==null?void 0:o.type)==="simple"&&(o.parameter=String(o.parameter)),(o==null?void 0:o.type)==="enumeration"&&Array.isArray(o.parameter)&&(o.parameter=o.parameter.map(String)),r.value=o,r.uri=s.uri,r.instructions=s.instructions,t.push(r)}return t},Yo=(a,e)=>{const t=[];for(const s of e){const i=gt(s.entity.name);if(!i)continue;const n=gt(s.entity.predefinedType),r=new vu(a,{name:i,predefinedType:n});r.relation=s.relation,s.cardinality&&(r.cardinality=s.cardinality),r.instructions=s.instructions,t.push(r)}return t},Hr=class wr extends xe{constructor(e){super(e),E(this,"enabled",!0),E(this,"IDSInfo"),E(this,"list",new be),e.add(wr.uuid,this)}getModelIdMap(e){const t={},s={};for(const[i,n]of e){const r=[...n].filter(([,l])=>l.pass).map(([l])=>l);ve.append(t,i,...r);const o=[...n].filter(([,l])=>!l.pass).map(([l])=>l);ve.append(s,i,...o)}return{pass:t,fail:s}}create(e,t,s){const i=new yu(this.components,e,t);return s&&(i.identifier=s),this.list.set(i.identifier,i),i}load(e){const t=[],s=wr.xmlParser.parse(e).ids,{specifications:i,info:n}=s;if(this.IDSInfo={...n},i&&i.specification){const r=Array.isArray(i.specification)?i.specification:[i.specification];for(const o of r){const{name:l,ifcVersion:h,description:c,instructions:d,identifier:p}=o;if(!(l&&h))continue;const u=[],g=[],{applicability:m,requirements:v}=o;if(m){const{maxOccurs:_,...x}=m,C=Array.isArray(x)?x:[x];for(const P of C)for(const A in P){const k=Array.isArray(P[A])?P[A]:[P[A]];if(A==="entity"){const M=Vo(this.components,k);u.push(...M)}if(A==="attribute"){const M=jo(this.components,k);u.push(...M)}if(A==="material"){const M=Ho(this.components,k);u.push(...M)}if(A==="classification"){const M=Go(this.components,k);u.push(...M)}if(A==="property"){const M=Wo(this.components,k);u.push(...M)}if(A==="partOf"){const M=Yo(this.components,k);u.push(...M)}}}let f;if(v){const{maxOccurs:_,...x}=v;f=v.description;const C=Array.isArray(x)?x:[x];for(const P of C)for(const A in P){const k=Array.isArray(P[A])?P[A]:[P[A]];if(A==="entity"){const M=Vo(this.components,k);g.push(...M)}if(A==="attribute"){const M=jo(this.components,k);g.push(...M)}if(A==="material"){const M=Ho(this.components,k);g.push(...M)}if(A==="classification"){const M=Go(this.components,k);g.push(...M)}if(A==="property"){const M=Wo(this.components,k);g.push(...M)}if(A==="partOf"){const M=Yo(this.components,k);g.push(...M)}}}const y=this.create(l,h.split(/\s+/),p);y.description=c,y.instructions=d,y.requirementsDescription=f,y.applicability.add(...u),y.requirements.add(...g),t.push(y)}}return t}export(e,t=this.list.values()){const s=t??this.list;return`<ids xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://standards.buildingsmart.org/IDS http://standards.buildingsmart.org/IDS/1.0/ids.xsd" xmlns:ids="http://standards.buildingsmart.org/IDS">
  <!-- Made with That Open Engine ${Xa.release} (https://github.com/thatopen/engine_components) -->
  <info>
    <title>${e.title}</title>
    ${e.copyright?`<copyright>${e.copyright}</copyright>`:""}
    ${e.version?`<version>${e.version}</version>`:""}
    ${e.description?`<description>${e.description}</description>`:""}
    ${e.author?`<author>${e.author}</author>`:""}
    ${e.date?`<date>${e.date.toISOString().split("T")[0]}</date>`:""}
    ${e.purpose?`<purpose>${e.purpose}</purpose>`:""}
    ${e.milestone?`<milestone>${e.milestone}</milestone>`:""}
  </info>
  <specifications>
    ${[...s].map(i=>i.serialize()).join(`
`)}
  </specifications>
</ids>`}};E(Hr,"uuid","9f0b9f78-9b2e-481a-b766-2fbfd01f342c");E(Hr,"xmlParser",new xn.XMLParser({allowBooleanAttributes:!0,attributeNamePrefix:"",ignoreAttributes:!1,ignoreDeclaration:!0,ignorePiTags:!0,numberParseOptions:{leadingZeros:!0,hex:!0},parseAttributeValue:!0,preserveOrder:!1,processEntities:!1,removeNSPrefix:!0,trimValues:!0}));let _u=Hr;const sl=class il extends xe{constructor(e){super(e),E(this,"enabled",!0),e.add(il.uuid,this)}static distanceFromPointToLine(e,t,s,i=!1){const n=new lt,r=new L;return n.set(t,s),n.closestPointToPoint(e,i,r),r.distanceTo(e)}round(e){e.x=Math.trunc(e.x*1e3)/1e3,e.y=Math.trunc(e.y*1e3)/1e3,e.z=Math.trunc(e.z*1e3)/1e3}async getVolumeFromFragments(e){return console.warn("getVolumeFromFragments is deprecated. Use getItemsVolume instead."),this.getItemsVolume(e)}async getItemsVolume(e){let t=0;const s=this.components.get(le);for(const[i,n]of Object.entries(e)){const r=s.list.get(i);r&&(t+=await r.getItemsVolume([...n]))}return t}static convertUnits(e,t,s,i=2){const n={m:1,cm:.01,mm:.001,km:1e3,m2:1,cm2:1e-4,mm2:1e-6,km2:1e6,m3:1,cm3:1e-6,mm3:1e-9,km3:1e9};if(!n[t]||!n[s])throw new Error("Invalid units provided for conversion.");if(!Number.isInteger(i)||i<0||i>5)throw new Error("Precision must be an integer between 0 and 5.");let r=n[t]/n[s];const o=e*r,l=10**i;return Math.round(o*l)/l}};E(sl,"uuid","267ca032-672f-4cb0-afa9-d24e904f39d6");let Rs=sl;const wu=class nl extends xe{constructor(e){super(e),S(this,"enabled",!0),S(this,"inputs",["OBC","BUI"]),S(this,"_requestEventID","thatOpenCompanyComponentRequested"),S(this,"_createEventID","thatOpenCompanyComponentCreated"),e.add(nl.uuid,this)}async import(e){return new Promise(t=>{const s=document.createElement("script"),i=`
        function loader() {
          const { ${this.inputs} } = window.ThatOpenCompany;
        
          ${e}
        
          const onComponentRequested = () => {
            window.removeEventListener("${this._requestEventID}", onComponentRequested);
            const event = new CustomEvent("${this._createEventID}", { detail: main });
            window.dispatchEvent(event);
          };
          
          window.addEventListener("${this._requestEventID}", onComponentRequested);
        }
        
        loader();
      `,n=r=>{window.removeEventListener(this._createEventID,n);const{componentDefinition:o}=r.detail;let l=null;if(o){const h=o;l=this.components.get(h)}s.remove(),t(l)};s.addEventListener("load",()=>{window.addEventListener(this._createEventID,n),window.dispatchEvent(new Event(this._requestEventID))}),s.src=URL.createObjectURL(new File([i],"temp.js")),document.head.appendChild(s)})}};S(wu,"uuid","74c0c370-1af8-4ca9-900a-4a4196c0f2f5");class rl extends pi{constructor(e=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=e,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new Ce(.5,.5),this.addEventListener("removed",function(){this.traverse(function(t){t.element instanceof t.element.ownerDocument.defaultView.Element&&t.element.parentNode!==null&&t.element.remove()})})}copy(e,t){return super.copy(e,t),this.element=e.element.cloneNode(!0),this.center=e.center,this}}const ks=new L,Zo=new Pe,Xo=new Pe,qo=new L,Qo=new L;class bu{constructor(e={}){const t=this;let s,i,n,r;const o={objects:new WeakMap},l=e.element!==void 0?e.element:document.createElement("div");l.style.overflow="hidden",this.domElement=l,this.getSize=function(){return{width:s,height:i}},this.render=function(g,m){g.matrixWorldAutoUpdate===!0&&g.updateMatrixWorld(),m.parent===null&&m.matrixWorldAutoUpdate===!0&&m.updateMatrixWorld(),Zo.copy(m.matrixWorldInverse),Xo.multiplyMatrices(m.projectionMatrix,Zo),c(g,g,m),u(g)},this.setSize=function(g,m){s=g,i=m,n=s/2,r=i/2,l.style.width=g+"px",l.style.height=m+"px"};function h(g){g.isCSS2DObject&&(g.element.style.display="none");for(let m=0,v=g.children.length;m<v;m++)h(g.children[m])}function c(g,m,v){if(g.visible===!1){h(g);return}if(g.isCSS2DObject){ks.setFromMatrixPosition(g.matrixWorld),ks.applyMatrix4(Xo);const f=ks.z>=-1&&ks.z<=1&&g.layers.test(v.layers)===!0,y=g.element;y.style.display=f===!0?"":"none",f===!0&&(g.onBeforeRender(t,m,v),y.style.transform="translate("+-100*g.center.x+"%,"+-100*g.center.y+"%)translate("+(ks.x*n+n)+"px,"+(-ks.y*r+r)+"px)",y.parentNode!==l&&l.appendChild(y),g.onAfterRender(t,m,v));const _={distanceToCameraSquared:d(v,g)};o.objects.set(g,_)}for(let f=0,y=g.children.length;f<y;f++)c(g.children[f],m,v)}function d(g,m){return qo.setFromMatrixPosition(g.matrixWorld),Qo.setFromMatrixPosition(m.matrixWorld),qo.distanceToSquared(Qo)}function p(g){const m=[];return g.traverseVisible(function(v){v.isCSS2DObject&&m.push(v)}),m}function u(g){const m=p(g).sort(function(f,y){if(f.renderOrder!==y.renderOrder)return y.renderOrder-f.renderOrder;const _=o.objects.get(f).distanceToCameraSquared,x=o.objects.get(y).distanceToCameraSquared;return _-x}),v=m.length;for(let f=0,y=m.length;f<y;f++)m[f].element.style.zIndex=v-f}}}class Jt{constructor(e,t,s){S(this,"three"),S(this,"world"),S(this,"wasVisible",!0),S(this,"onDisposed",new K),this.world=e;let i;if(t)i=t;else{i=document.createElement("div");const n="6px";i.style.color="white",i.style.height=n,i.style.width=n,i.style.borderRadius="50%",i.style.border="2px solid rgb(122, 75, 209)",i.style.zIndex="-20"}this.three=new rl(i),(s||e.scene.three).add(this.three),this.visible=!0}set visible(e){this.three.visible=e,this.wasVisible=e}get visible(){return this.three.visible}toggleVisibility(){this.visible=!this.visible}notDisplay(){this.visible=!1}dispose(){this.three.removeFromParent(),this.three.element.remove(),this.onDisposed.trigger(),this.onDisposed.reset()}}class xu extends Nc{constructor(e,t,s){super(e,t,s),S(this,"three2D",new bu),this.onAfterUpdate.add(()=>{if(this.onBeforeUpdate.trigger(this),!this.enabled||!this.currentWorld)return;const i=this.currentWorld.scene.three,n=this.currentWorld.camera.three;i instanceof Dr&&this.three2D.render(i,n)}),this.onDisposed.add(()=>{this.three2D.domElement.remove()}),this.onResize.add(({x:i,y:n})=>{this.three2D.setSize(i,n)}),this.setupHtmlRenderer(),this.resize()}setupHtmlRenderer(){this.three2D.domElement.style.position="absolute",this.three2D.domElement.style.top="0px",this.three2D.domElement.style.pointerEvents="none",this.container&&(this.container.appendChild(this.three2D.domElement),this.container.style.position="relative")}}const Ko=class br extends xe{constructor(e){super(e),S(this,"onDisposed",new K),S(this,"enabled",!0),S(this,"threshold",50),S(this,"autoCluster",!0),S(this,"clusterElementStyles",{...br.DEFAULT_CLUSTER_STYLES}),S(this,"list",new Map),S(this,"clusterLabels",new Set),S(this,"currentKeys",new Set),S(this,"_color","white"),S(this,"_markerKey",0),S(this,"_clusterKey",0),S(this,"_worldEvents",new Map),S(this,"_setupWorlds",new Set),S(this,"clusterElementFactory",()=>{const t=document.createElement("div");return t.style.color="#000000",t.style.background="#FFFFFF",t.style.fontSize="1.2rem",t.style.fontWeight="500",t.style.borderRadius="50%",t.style.padding="5px 11px",t.style.textAlign="center",t.addEventListener("pointerover",()=>{t.style.background=this.clusterElementStyles.hoverBackgroundColor||"#BCF124"}),t.addEventListener("pointerout",()=>{t.style.background=this.clusterElementStyles.backgroundColor||"#FFFFFF"}),t}),e.add(br.uuid,this)}get color(){return this._color}set color(e){this._color=e;for(const[t,s]of this.list)for(const[i,n]of s)n.label.three.element.style.color=e}create(e,t,s,i=!1){this.setupEvents(e,!0);const n=this._markerKey.toString(),r=this.getWorldMarkerList(e);if(r.has(n))return null;const o=document.createElement("span");o.append(t);const l=new Jt(e,o);return l.three.position.copy(s),r.set(n,{key:n,label:l,merged:!1,static:i}),this._markerKey++,n}delete(e){for(const[t,s]of this.list){const i=s.get(e);i&&i.label.dispose(),s.delete(e)}}getWorldMarkerList(e){return this.list.has(e.uuid)||this.list.set(e.uuid,new Map),this.list.get(e.uuid)}dispose(e){for(const[t,s]of this.list){const i=[...s.keys()];for(const n of i){const r=s.get(n);e&&r.type!==e||(r.label.dispose(),s.delete(n))}}if(!e){this.list.clear(),this._markerKey=0;for(const t of this.clusterLabels)t.label.dispose();this.clusterLabels.clear(),this._clusterKey=0,this.currentKeys.clear()}this.onDisposed.trigger()}setupEvents(e,t){if(t&&this._setupWorlds.has(e.uuid)||!e.camera.hasCameraControls())return;const s=this.getWorldEvent(e);e.camera.controls.removeEventListener("sleep",s),e.camera.controls.removeEventListener("rest",s),t&&(e.camera.controls.addEventListener("sleep",s),e.camera.controls.addEventListener("rest",s))}cluster(e){if(!this.autoCluster)return;this.resetMarkers();const t=this.list.get(e.uuid);if(t){for(const[s,i]of t)if(!i.merged&&!i.static){this.currentKeys.clear();for(const[n,r]of t)r.static||i.key!==r.key&&!r.merged&&this.distance(i.label,r.label)<this.threshold&&(this.currentKeys.add(r.key),r.merged=!0);if(this.currentKeys.size>0){this.currentKeys.add(i.key),i.merged=!0;const n=Array.from(this.currentKeys),r=this.getAveragePositionFromLabels(n),o=new Jt(i.label.world,this.createClusterElement(this._clusterKey.toString())),{element:l}=o.three;l.firstChild.textContent=n.length.toString(),o.three.position.copy(r),this.clusterLabels.add({key:this._clusterKey.toString(),markerKeys:n,label:o}),this._clusterKey++}}this.removeMergeMarkers(e)}}getWorldEvent(e){if(!this._worldEvents.has(e.uuid)){const t=()=>{this.cluster(e)};this._worldEvents.set(e.uuid,t)}return this._worldEvents.get(e.uuid)}resetMarkers(){for(const[e,t]of this.list)for(const[s,i]of t)i.merged=!1;for(const e of this.clusterLabels)e.label.dispose();this.clusterLabels.clear(),this._clusterKey=0}removeMergeMarkers(e){const t=this.list.get(e.uuid);if(t){for(const[s,i]of t)i.merged?i.label.dispose():i.label.world.scene.three.add(i.label.three);for(const s of this.clusterLabels)if(s.markerKeys.length===1){for(const[i,n]of this.list){const r=n.get(s.markerKeys[0]);r&&(r.label.world.scene.three.add(r.label.three),r.merged=!1)}s.label.dispose(),this.clusterLabels.delete(s)}}}getAveragePositionFromLabels(e){const t=e.map(s=>{for(const[i,n]of this.list){const r=n.get(s);if(r)return r.label.three.position}return new L});return t.reduce((s,i)=>s.add(i),new L).divideScalar(t.length)}createClusterElement(e){const t=this.clusterElementFactory();t.textContent=e;const s=document.createElement("span");return s.append(t),s.style.pointerEvents="auto",s.style.cursor="pointer",s.addEventListener("pointerdown",()=>{this.navigateToCluster(e)}),s}getScreenPosition(e){const t=new L;if(!e.world.renderer)throw new Error("Renderer not found!");const s=e.three.position.clone();s.project(e.world.camera.three);const i=e.world.renderer.getSize();return t.x=s.x*i.x/2+i.x/2,t.y=-(s.y*i.y/2)+i.y/2,t}distance(e,t){const s=this.getScreenPosition(e),i=this.getScreenPosition(t),n=s.x-i.x,r=s.y-i.y,o=Math.sqrt(n*n+r*r)*.5;return o===0?this.threshold+1:o}navigateToCluster(e){const t=[],s=Array.from(this.clusterLabels).find(h=>h.key===e);if(!s)return;const i=s.label.world.camera;if(!i.hasCameraControls()){console.warn("Zoom to clusters only supported with Camera Controls!");return}for(const h of s.markerKeys)for(const[c,d]of this.list){const p=d.get(h);if(p){const{x:u,y:g,z:m}=p.label.three.position;t.push(u,g,m)}}s.label.dispose(),this.clusterLabels.delete(s);const n=new rt,r=new Float32Array(t),o=new Rt(r,3);n.setAttribute("position",o);const l=new ie(n);l.geometry.computeBoundingSphere(),l.geometry.boundingSphere&&i.controls.fitToSphere(l,!0),n.dispose(),l.clear(),t.length=0}};S(Ko,"uuid","4079eb91-79b0-4ede-bcf2-15b837129236"),S(Ko,"DEFAULT_CLUSTER_STYLES",{backgroundColor:"#FFFFFF",textColor:"#000000",fontSize:"1.2rem",fontWeight:"500",borderRadius:"50%",padding:"5px 11px",textAlign:"center",cursor:"pointer",hoverBackgroundColor:"#BCF124",transition:void 0});const un={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class St{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const Eu=new wn(-1,1,1,-1,0,1);class Su extends rt{constructor(){super(),this.setAttribute("position",new es([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new es([0,2,0,0,2,0],2))}}const Cu=new Su;class jt{constructor(e){this._mesh=new ie(Cu,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,Eu)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class Tu extends St{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof Be?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=dt.clone(e.uniforms),this.material=new Be({name:e.name!==void 0?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new jt(this.material)}render(e,t,s){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=s.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class Jo extends St{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,s){const i=e.getContext(),n=e.state;n.buffers.color.setMask(!1),n.buffers.depth.setMask(!1),n.buffers.color.setLocked(!0),n.buffers.depth.setLocked(!0);let r,o;this.inverse?(r=0,o=1):(r=1,o=0),n.buffers.stencil.setTest(!0),n.buffers.stencil.setOp(i.REPLACE,i.REPLACE,i.REPLACE),n.buffers.stencil.setFunc(i.ALWAYS,r,4294967295),n.buffers.stencil.setClear(o),n.buffers.stencil.setLocked(!0),e.setRenderTarget(s),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),n.buffers.color.setLocked(!1),n.buffers.depth.setLocked(!1),n.buffers.color.setMask(!0),n.buffers.depth.setMask(!0),n.buffers.stencil.setLocked(!1),n.buffers.stencil.setFunc(i.EQUAL,1,4294967295),n.buffers.stencil.setOp(i.KEEP,i.KEEP,i.KEEP),n.buffers.stencil.setLocked(!0)}}class Pu extends St{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class Au{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),t===void 0){const s=e.getSize(new Ce);this._width=s.width,this._height=s.height,t=new xt(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Us}),t.texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new Tu(un),this.copyPass.material.blending=Lt,this.clock=new ra}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let s=!1;for(let i=0,n=this.passes.length;i<n;i++){const r=this.passes[i];if(r.enabled!==!1){if(r.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(i),r.render(this.renderer,this.writeBuffer,this.readBuffer,e,s),r.needsSwap){if(s){const o=this.renderer.getContext(),l=this.renderer.state.buffers.stencil;l.setFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),l.setFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}Jo!==void 0&&(r instanceof Jo?s=!0:r instanceof Pu&&(s=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new Ce);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const s=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget1.setSize(s,i),this.renderTarget2.setSize(s,i);for(let n=0;n<this.passes.length;n++)this.passes[n].setSize(s,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}const Xi={defines:{PERSPECTIVE_CAMERA:1,SAMPLES:16,NORMAL_VECTOR_TYPE:1,DEPTH_SWIZZLING:"x",SCREEN_SPACE_RADIUS:0,SCREEN_SPACE_RADIUS_SCALE:100,SCENE_CLIP_BOX:0},uniforms:{tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},resolution:{value:new Ce},cameraNear:{value:null},cameraFar:{value:null},cameraProjectionMatrix:{value:new Pe},cameraProjectionMatrixInverse:{value:new Pe},cameraWorldMatrix:{value:new Pe},radius:{value:.25},distanceExponent:{value:1},thickness:{value:1},distanceFallOff:{value:1},scale:{value:1},sceneBoxMin:{value:new L(-1,-1,-1)},sceneBoxMax:{value:new L(1,1,1)}},vertexShader:`

		varying vec2 vUv;

		void main() {
			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}`,fragmentShader:`
		varying vec2 vUv;
		uniform highp sampler2D tNormal;
		uniform highp sampler2D tDepth;
		uniform sampler2D tNoise;
		uniform vec2 resolution;
		uniform float cameraNear;
		uniform float cameraFar;
		uniform mat4 cameraProjectionMatrix;
		uniform mat4 cameraProjectionMatrixInverse;
		uniform mat4 cameraWorldMatrix;
		uniform float radius;
		uniform float distanceExponent;
		uniform float thickness;
		uniform float distanceFallOff;
		uniform float scale;
		#if SCENE_CLIP_BOX == 1
			uniform vec3 sceneBoxMin;
			uniform vec3 sceneBoxMax;
		#endif

		#include <common>
		#include <packing>

		#ifndef FRAGMENT_OUTPUT
		#define FRAGMENT_OUTPUT vec4(vec3(ao), 1.)
		#endif

		vec3 getViewPosition(const in vec2 screenPosition, const in float depth) {
			vec4 clipSpacePosition = vec4(vec3(screenPosition, depth) * 2.0 - 1.0, 1.0);
			vec4 viewSpacePosition = cameraProjectionMatrixInverse * clipSpacePosition;
			return viewSpacePosition.xyz / viewSpacePosition.w;
		}

		float getDepth(const vec2 uv) {
			return textureLod(tDepth, uv.xy, 0.0).DEPTH_SWIZZLING;
		}

		float fetchDepth(const ivec2 uv) {
			return texelFetch(tDepth, uv.xy, 0).DEPTH_SWIZZLING;
		}

		float getViewZ(const in float depth) {
			#if PERSPECTIVE_CAMERA == 1
				return perspectiveDepthToViewZ(depth, cameraNear, cameraFar);
			#else
				return orthographicDepthToViewZ(depth, cameraNear, cameraFar);
			#endif
		}

		vec3 computeNormalFromDepth(const vec2 uv) {
			vec2 size = vec2(textureSize(tDepth, 0));
			ivec2 p = ivec2(uv * size);
			float c0 = fetchDepth(p);
			float l2 = fetchDepth(p - ivec2(2, 0));
			float l1 = fetchDepth(p - ivec2(1, 0));
			float r1 = fetchDepth(p + ivec2(1, 0));
			float r2 = fetchDepth(p + ivec2(2, 0));
			float b2 = fetchDepth(p - ivec2(0, 2));
			float b1 = fetchDepth(p - ivec2(0, 1));
			float t1 = fetchDepth(p + ivec2(0, 1));
			float t2 = fetchDepth(p + ivec2(0, 2));
			float dl = abs((2.0 * l1 - l2) - c0);
			float dr = abs((2.0 * r1 - r2) - c0);
			float db = abs((2.0 * b1 - b2) - c0);
			float dt = abs((2.0 * t1 - t2) - c0);
			vec3 ce = getViewPosition(uv, c0).xyz;
			vec3 dpdx = (dl < dr) ? ce - getViewPosition((uv - vec2(1.0 / size.x, 0.0)), l1).xyz : -ce + getViewPosition((uv + vec2(1.0 / size.x, 0.0)), r1).xyz;
			vec3 dpdy = (db < dt) ? ce - getViewPosition((uv - vec2(0.0, 1.0 / size.y)), b1).xyz : -ce + getViewPosition((uv + vec2(0.0, 1.0 / size.y)), t1).xyz;
			return normalize(cross(dpdx, dpdy));
		}

		vec3 getViewNormal(const vec2 uv) {
			#if NORMAL_VECTOR_TYPE == 2
				return normalize(textureLod(tNormal, uv, 0.).rgb);
			#elif NORMAL_VECTOR_TYPE == 1
				return unpackRGBToNormal(textureLod(tNormal, uv, 0.).rgb);
			#else
				return computeNormalFromDepth(uv);
			#endif
		}

		vec3 getSceneUvAndDepth(vec3 sampleViewPos) {
			vec4 sampleClipPos = cameraProjectionMatrix * vec4(sampleViewPos, 1.);
			vec2 sampleUv = sampleClipPos.xy / sampleClipPos.w * 0.5 + 0.5;
			float sampleSceneDepth = getDepth(sampleUv);
			return vec3(sampleUv, sampleSceneDepth);
		}

		void main() {
			float depth = getDepth(vUv.xy);
			if (depth >= 1.0) {
				discard;
				return;
			}
			vec3 viewPos = getViewPosition(vUv, depth);
			vec3 viewNormal = getViewNormal(vUv);

			float radiusToUse = radius;
			float distanceFalloffToUse = thickness;
			#if SCREEN_SPACE_RADIUS == 1
				float radiusScale = getViewPosition(vec2(0.5 + float(SCREEN_SPACE_RADIUS_SCALE) / resolution.x, 0.0), depth).x;
				radiusToUse *= radiusScale;
				distanceFalloffToUse *= radiusScale;
			#endif

			#if SCENE_CLIP_BOX == 1
				vec3 worldPos = (cameraWorldMatrix * vec4(viewPos, 1.0)).xyz;
				float boxDistance = length(max(vec3(0.0), max(sceneBoxMin - worldPos, worldPos - sceneBoxMax)));
				if (boxDistance > radiusToUse) {
					discard;
					return;
				}
			#endif

			vec2 noiseResolution = vec2(textureSize(tNoise, 0));
			vec2 noiseUv = vUv * resolution / noiseResolution;
			vec4 noiseTexel = textureLod(tNoise, noiseUv, 0.0);
			vec3 randomVec = noiseTexel.xyz * 2.0 - 1.0;
			vec3 tangent = normalize(vec3(randomVec.xy, 0.));
			vec3 bitangent = vec3(-tangent.y, tangent.x, 0.);
			mat3 kernelMatrix = mat3(tangent, bitangent, vec3(0., 0., 1.));

			const int DIRECTIONS = SAMPLES < 30 ? 3 : 5;
			const int STEPS = (SAMPLES + DIRECTIONS - 1) / DIRECTIONS;
			float ao = 0.0;
			for (int i = 0; i < DIRECTIONS; ++i) {

				float angle = float(i) / float(DIRECTIONS) * PI;
				vec4 sampleDir = vec4(cos(angle), sin(angle), 0., 0.5 + 0.5 * noiseTexel.w);
				sampleDir.xyz = normalize(kernelMatrix * sampleDir.xyz);

				vec3 viewDir = normalize(-viewPos.xyz);
				vec3 sliceBitangent = normalize(cross(sampleDir.xyz, viewDir));
				vec3 sliceTangent = cross(sliceBitangent, viewDir);
				vec3 normalInSlice = normalize(viewNormal - sliceBitangent * dot(viewNormal, sliceBitangent));

				vec3 tangentToNormalInSlice = cross(normalInSlice, sliceBitangent);
				vec2 cosHorizons = vec2(dot(viewDir, tangentToNormalInSlice), dot(viewDir, -tangentToNormalInSlice));

				for (int j = 0; j < STEPS; ++j) {
					vec3 sampleViewOffset = sampleDir.xyz * radiusToUse * sampleDir.w * pow(float(j + 1) / float(STEPS), distanceExponent);

					vec3 sampleSceneUvDepth = getSceneUvAndDepth(viewPos + sampleViewOffset);
					vec3 sampleSceneViewPos = getViewPosition(sampleSceneUvDepth.xy, sampleSceneUvDepth.z);
					vec3 viewDelta = sampleSceneViewPos - viewPos;
					if (abs(viewDelta.z) < thickness) {
						float sampleCosHorizon = dot(viewDir, normalize(viewDelta));
						cosHorizons.x += max(0., (sampleCosHorizon - cosHorizons.x) * mix(1., 2. / float(j + 2), distanceFallOff));
					}

					sampleSceneUvDepth = getSceneUvAndDepth(viewPos - sampleViewOffset);
					sampleSceneViewPos = getViewPosition(sampleSceneUvDepth.xy, sampleSceneUvDepth.z);
					viewDelta = sampleSceneViewPos - viewPos;
					if (abs(viewDelta.z) < thickness) {
						float sampleCosHorizon = dot(viewDir, normalize(viewDelta));
						cosHorizons.y += max(0., (sampleCosHorizon - cosHorizons.y) * mix(1., 2. / float(j + 2), distanceFallOff));
					}
				}

				vec2 sinHorizons = sqrt(1. - cosHorizons * cosHorizons);
				float nx = dot(normalInSlice, sliceTangent);
				float ny = dot(normalInSlice, viewDir);
				float nxb = 1. / 2. * (acos(cosHorizons.y) - acos(cosHorizons.x) + sinHorizons.x * cosHorizons.x - sinHorizons.y * cosHorizons.y);
				float nyb = 1. / 2. * (2. - cosHorizons.x * cosHorizons.x - cosHorizons.y * cosHorizons.y);
				float occlusion = nx * nxb + ny * nyb;
				ao += occlusion;
			}

			ao = clamp(ao / float(DIRECTIONS), 0., 1.);
		#if SCENE_CLIP_BOX == 1
			ao = mix(ao, 1., smoothstep(0., radiusToUse, boxDistance));
		#endif
			ao = pow(ao, scale);

			gl_FragColor = FRAGMENT_OUTPUT;
		}`},qi={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:`
		varying vec2 vUv;

		void main() {
			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}`,fragmentShader:`
		uniform sampler2D tDepth;
		uniform float cameraNear;
		uniform float cameraFar;
		varying vec2 vUv;

		#include <packing>

		float getLinearDepth( const in vec2 screenPosition ) {
			#if PERSPECTIVE_CAMERA == 1
				float fragCoordZ = texture2D( tDepth, screenPosition ).x;
				float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );
				return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );
			#else
				return texture2D( tDepth, screenPosition ).x;
			#endif
		}

		void main() {
			float depth = getLinearDepth( vUv );
			gl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );

		}`},Qn={uniforms:{tDiffuse:{value:null},intensity:{value:1}},vertexShader:`
		varying vec2 vUv;

		void main() {
			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}`,fragmentShader:`
		uniform float intensity;
		uniform sampler2D tDiffuse;
		varying vec2 vUv;

		void main() {
			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = vec4(mix(vec3(1.), texel.rgb, intensity), texel.a);
		}`};function Mu(a=5){const e=Math.floor(a)%2===0?Math.floor(a)+1:Math.floor(a),t=Ou(e),s=t.length,i=new Uint8Array(s*4);for(let r=0;r<s;++r){const o=t[r],l=2*Math.PI*o/s,h=new L(Math.cos(l),Math.sin(l),0).normalize();i[r*4]=(h.x*.5+.5)*255,i[r*4+1]=(h.y*.5+.5)*255,i[r*4+2]=127,i[r*4+3]=255}const n=new da(i,e,e);return n.wrapS=fn,n.wrapT=fn,n.needsUpdate=!0,n}function Ou(a){const e=Math.floor(a)%2===0?Math.floor(a)+1:Math.floor(a),t=e*e,s=Array(t).fill(0);let i=Math.floor(e/2),n=e-1;for(let r=1;r<=t;){if(i===-1&&n===e?(n=e-2,i=0):(n===e&&(n=0),i<0&&(i=e-1)),s[i*e+n]!==0){n-=2,i++;continue}else s[i*e+n]=r++;n++,i--}return s}const Qi={defines:{SAMPLES:16,SAMPLE_VECTORS:ol(16,2,1),NORMAL_VECTOR_TYPE:1,DEPTH_VALUE_SOURCE:0},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},resolution:{value:new Ce},cameraProjectionMatrixInverse:{value:new Pe},lumaPhi:{value:5},depthPhi:{value:5},normalPhi:{value:5},radius:{value:4},index:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {
			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}`,fragmentShader:`

		varying vec2 vUv;

		uniform sampler2D tDiffuse;
		uniform sampler2D tNormal;
		uniform sampler2D tDepth;
		uniform sampler2D tNoise;
		uniform vec2 resolution;
		uniform mat4 cameraProjectionMatrixInverse;
		uniform float lumaPhi;
		uniform float depthPhi;
		uniform float normalPhi;
		uniform float radius;
		uniform int index;

		#include <common>
		#include <packing>

		#ifndef SAMPLE_LUMINANCE
		#define SAMPLE_LUMINANCE dot(vec3(0.2125, 0.7154, 0.0721), a)
		#endif

		#ifndef FRAGMENT_OUTPUT
		#define FRAGMENT_OUTPUT vec4(denoised, 1.)
		#endif

		float getLuminance(const in vec3 a) {
			return SAMPLE_LUMINANCE;
		}

		const vec3 poissonDisk[SAMPLES] = SAMPLE_VECTORS;

		vec3 getViewPosition(const in vec2 screenPosition, const in float depth) {
			vec4 clipSpacePosition = vec4(vec3(screenPosition, depth) * 2.0 - 1.0, 1.0);
			vec4 viewSpacePosition = cameraProjectionMatrixInverse * clipSpacePosition;
			return viewSpacePosition.xyz / viewSpacePosition.w;
		}

		float getDepth(const vec2 uv) {
		#if DEPTH_VALUE_SOURCE == 1
			return textureLod(tDepth, uv.xy, 0.0).a;
		#else
			return textureLod(tDepth, uv.xy, 0.0).r;
		#endif
		}

		float fetchDepth(const ivec2 uv) {
			#if DEPTH_VALUE_SOURCE == 1
				return texelFetch(tDepth, uv.xy, 0).a;
			#else
				return texelFetch(tDepth, uv.xy, 0).r;
			#endif
		}

		vec3 computeNormalFromDepth(const vec2 uv) {
			vec2 size = vec2(textureSize(tDepth, 0));
			ivec2 p = ivec2(uv * size);
			float c0 = fetchDepth(p);
			float l2 = fetchDepth(p - ivec2(2, 0));
			float l1 = fetchDepth(p - ivec2(1, 0));
			float r1 = fetchDepth(p + ivec2(1, 0));
			float r2 = fetchDepth(p + ivec2(2, 0));
			float b2 = fetchDepth(p - ivec2(0, 2));
			float b1 = fetchDepth(p - ivec2(0, 1));
			float t1 = fetchDepth(p + ivec2(0, 1));
			float t2 = fetchDepth(p + ivec2(0, 2));
			float dl = abs((2.0 * l1 - l2) - c0);
			float dr = abs((2.0 * r1 - r2) - c0);
			float db = abs((2.0 * b1 - b2) - c0);
			float dt = abs((2.0 * t1 - t2) - c0);
			vec3 ce = getViewPosition(uv, c0).xyz;
			vec3 dpdx = (dl < dr) ?  ce - getViewPosition((uv - vec2(1.0 / size.x, 0.0)), l1).xyz
									: -ce + getViewPosition((uv + vec2(1.0 / size.x, 0.0)), r1).xyz;
			vec3 dpdy = (db < dt) ?  ce - getViewPosition((uv - vec2(0.0, 1.0 / size.y)), b1).xyz
									: -ce + getViewPosition((uv + vec2(0.0, 1.0 / size.y)), t1).xyz;
			return normalize(cross(dpdx, dpdy));
		}

		vec3 getViewNormal(const vec2 uv) {
		#if NORMAL_VECTOR_TYPE == 2
			return normalize(textureLod(tNormal, uv, 0.).rgb);
		#elif NORMAL_VECTOR_TYPE == 1
			return unpackRGBToNormal(textureLod(tNormal, uv, 0.).rgb);
		#else
			return computeNormalFromDepth(uv);
		#endif
		}

		void denoiseSample(in vec3 center, in vec3 viewNormal, in vec3 viewPos, in vec2 sampleUv, inout vec3 denoised, inout float totalWeight) {
			vec4 sampleTexel = textureLod(tDiffuse, sampleUv, 0.0);
			float sampleDepth = getDepth(sampleUv);
			vec3 sampleNormal = getViewNormal(sampleUv);
			vec3 neighborColor = sampleTexel.rgb;
			vec3 viewPosSample = getViewPosition(sampleUv, sampleDepth);

			float normalDiff = dot(viewNormal, sampleNormal);
			float normalSimilarity = pow(max(normalDiff, 0.), normalPhi);
			float lumaDiff = abs(getLuminance(neighborColor) - getLuminance(center));
			float lumaSimilarity = max(1.0 - lumaDiff / lumaPhi, 0.0);
			float depthDiff = abs(dot(viewPos - viewPosSample, viewNormal));
			float depthSimilarity = max(1. - depthDiff / depthPhi, 0.);
			float w = lumaSimilarity * depthSimilarity * normalSimilarity;

			denoised += w * neighborColor;
			totalWeight += w;
		}

		void main() {
			float depth = getDepth(vUv.xy);
			vec3 viewNormal = getViewNormal(vUv);
			if (depth == 1. || dot(viewNormal, viewNormal) == 0.) {
				discard;
				return;
			}
			vec4 texel = textureLod(tDiffuse, vUv, 0.0);
			vec3 center = texel.rgb;
			vec3 viewPos = getViewPosition(vUv, depth);

			vec2 noiseResolution = vec2(textureSize(tNoise, 0));
			vec2 noiseUv = vUv * resolution / noiseResolution;
			vec4 noiseTexel = textureLod(tNoise, noiseUv, 0.0);
      		vec2 noiseVec = vec2(sin(noiseTexel[index % 4] * 2. * PI), cos(noiseTexel[index % 4] * 2. * PI));
    		mat2 rotationMatrix = mat2(noiseVec.x, -noiseVec.y, noiseVec.x, noiseVec.y);

			float totalWeight = 1.0;
			vec3 denoised = texel.rgb;
			for (int i = 0; i < SAMPLES; i++) {
				vec3 sampleDir = poissonDisk[i];
				vec2 offset = rotationMatrix * (sampleDir.xy * (1. + sampleDir.z * (radius - 1.)) / resolution);
				vec2 sampleUv = vUv + offset;
				denoiseSample(center, viewNormal, viewPos, sampleUv, denoised, totalWeight);
			}

			if (totalWeight > 0.) {
				denoised /= totalWeight;
			}
			gl_FragColor = FRAGMENT_OUTPUT;
		}`};function ol(a,e,t){const s=Du(a,e,t);let i="vec3[SAMPLES](";for(let n=0;n<a;n++){const r=s[n];i+=`vec3(${r.x}, ${r.y}, ${r.z})${n<a-1?",":")"}`}return i}function Du(a,e,t){const s=[];for(let i=0;i<a;i++){const n=2*Math.PI*e*i/a,r=Math.pow(i/(a-1),t);s.push(new L(Math.cos(n),Math.sin(n),r))}return s}class zu{constructor(e=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let t=0;t<256;t++)this.p[t]=Math.floor(e.random()*256);this.perm=[];for(let t=0;t<512;t++)this.perm[t]=this.p[t&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}noise(e,t){let s,i,n;const r=.5*(Math.sqrt(3)-1),o=(e+t)*r,l=Math.floor(e+o),h=Math.floor(t+o),c=(3-Math.sqrt(3))/6,d=(l+h)*c,p=l-d,u=h-d,g=e-p,m=t-u;let v,f;g>m?(v=1,f=0):(v=0,f=1);const y=g-v+c,_=m-f+c,x=g-1+2*c,C=m-1+2*c,P=l&255,A=h&255,k=this.perm[P+this.perm[A]]%12,M=this.perm[P+v+this.perm[A+f]]%12,I=this.perm[P+1+this.perm[A+1]]%12;let R=.5-g*g-m*m;R<0?s=0:(R*=R,s=R*R*this._dot(this.grad3[k],g,m));let T=.5-y*y-_*_;T<0?i=0:(T*=T,i=T*T*this._dot(this.grad3[M],y,_));let z=.5-x*x-C*C;return z<0?n=0:(z*=z,n=z*z*this._dot(this.grad3[I],x,C)),70*(s+i+n)}noise3d(e,t,s){let i,n,r,o;const l=(e+t+s)*.3333333333333333,h=Math.floor(e+l),c=Math.floor(t+l),d=Math.floor(s+l),p=1/6,u=(h+c+d)*p,g=h-u,m=c-u,v=d-u,f=e-g,y=t-m,_=s-v;let x,C,P,A,k,M;f>=y?y>=_?(x=1,C=0,P=0,A=1,k=1,M=0):f>=_?(x=1,C=0,P=0,A=1,k=0,M=1):(x=0,C=0,P=1,A=1,k=0,M=1):y<_?(x=0,C=0,P=1,A=0,k=1,M=1):f<_?(x=0,C=1,P=0,A=0,k=1,M=1):(x=0,C=1,P=0,A=1,k=1,M=0);const I=f-x+p,R=y-C+p,T=_-P+p,z=f-A+2*p,b=y-k+2*p,B=_-M+2*p,q=f-1+3*p,G=y-1+3*p,te=_-1+3*p,W=h&255,se=c&255,F=d&255,U=this.perm[W+this.perm[se+this.perm[F]]]%12,ne=this.perm[W+x+this.perm[se+C+this.perm[F+P]]]%12,ee=this.perm[W+A+this.perm[se+k+this.perm[F+M]]]%12,J=this.perm[W+1+this.perm[se+1+this.perm[F+1]]]%12;let pe=.6-f*f-y*y-_*_;pe<0?i=0:(pe*=pe,i=pe*pe*this._dot3(this.grad3[U],f,y,_));let ge=.6-I*I-R*R-T*T;ge<0?n=0:(ge*=ge,n=ge*ge*this._dot3(this.grad3[ne],I,R,T));let ae=.6-z*z-b*b-B*B;ae<0?r=0:(ae*=ae,r=ae*ae*this._dot3(this.grad3[ee],z,b,B));let ce=.6-q*q-G*G-te*te;return ce<0?o=0:(ce*=ce,o=ce*ce*this._dot3(this.grad3[J],q,G,te)),32*(i+n+r+o)}noise4d(e,t,s,i){const n=this.grad4,r=this.simplex,o=this.perm,l=(Math.sqrt(5)-1)/4,h=(5-Math.sqrt(5))/20;let c,d,p,u,g;const m=(e+t+s+i)*l,v=Math.floor(e+m),f=Math.floor(t+m),y=Math.floor(s+m),_=Math.floor(i+m),x=(v+f+y+_)*h,C=v-x,P=f-x,A=y-x,k=_-x,M=e-C,I=t-P,R=s-A,T=i-k,z=M>I?32:0,b=M>R?16:0,B=I>R?8:0,q=M>T?4:0,G=I>T?2:0,te=R>T?1:0,W=z+b+B+q+G+te,se=r[W][0]>=3?1:0,F=r[W][1]>=3?1:0,U=r[W][2]>=3?1:0,ne=r[W][3]>=3?1:0,ee=r[W][0]>=2?1:0,J=r[W][1]>=2?1:0,pe=r[W][2]>=2?1:0,ge=r[W][3]>=2?1:0,ae=r[W][0]>=1?1:0,ce=r[W][1]>=1?1:0,Ee=r[W][2]>=1?1:0,we=r[W][3]>=1?1:0,Fe=M-se+h,ke=I-F+h,w=R-U+h,Y=T-ne+h,H=M-ee+2*h,D=I-J+2*h,O=R-pe+2*h,N=T-ge+2*h,Z=M-ae+3*h,X=I-ce+3*h,V=R-Ee+3*h,Q=T-we+3*h,re=M-1+4*h,$=I-1+4*h,oe=R-1+4*h,ye=T-1+4*h,ue=v&255,Ve=f&255,vt=y&255,Xe=_&255,ns=o[ue+o[Ve+o[vt+o[Xe]]]]%32,Oe=o[ue+se+o[Ve+F+o[vt+U+o[Xe+ne]]]]%32,ys=o[ue+ee+o[Ve+J+o[vt+pe+o[Xe+ge]]]]%32,js=o[ue+ae+o[Ve+ce+o[vt+Ee+o[Xe+we]]]]%32,yt=o[ue+1+o[Ve+1+o[vt+1+o[Xe+1]]]]%32;let Ht=.6-M*M-I*I-R*R-T*T;Ht<0?c=0:(Ht*=Ht,c=Ht*Ht*this._dot4(n[ns],M,I,R,T));let rs=.6-Fe*Fe-ke*ke-w*w-Y*Y;rs<0?d=0:(rs*=rs,d=rs*rs*this._dot4(n[Oe],Fe,ke,w,Y));let os=.6-H*H-D*D-O*O-N*N;os<0?p=0:(os*=os,p=os*os*this._dot4(n[ys],H,D,O,N));let as=.6-Z*Z-X*X-V*V-Q*Q;as<0?u=0:(as*=as,u=as*as*this._dot4(n[js],Z,X,V,Q));let Wt=.6-re*re-$*$-oe*oe-ye*ye;return Wt<0?g=0:(Wt*=Wt,g=Wt*Wt*this._dot4(n[yt],re,$,oe,ye)),27*(c+d+p+u+g)}_dot(e,t,s){return e[0]*t+e[1]*s}_dot3(e,t,s,i){return e[0]*t+e[1]*s+e[2]*i}_dot4(e,t,s,i,n){return e[0]*t+e[1]*s+e[2]*i+e[3]*n}}class nt extends St{constructor(e,t,s=512,i=512,n,r,o){super(),this.width=s,this.height=i,this.clear=!0,this.camera=t,this.scene=e,this.output=0,this._renderGBuffer=!0,this._visibilityCache=new Map,this.blendIntensity=1,this.pdRings=2,this.pdRadiusExponent=2,this.pdSamples=16,this.gtaoNoiseTexture=Mu(),this.pdNoiseTexture=this._generateNoise(),this.gtaoRenderTarget=new xt(this.width,this.height,{type:Us}),this.pdRenderTarget=this.gtaoRenderTarget.clone(),this.gtaoMaterial=new Be({defines:Object.assign({},Xi.defines),uniforms:dt.clone(Xi.uniforms),vertexShader:Xi.vertexShader,fragmentShader:Xi.fragmentShader,blending:Lt,depthTest:!1,depthWrite:!1}),this.gtaoMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.gtaoMaterial.uniforms.tNoise.value=this.gtaoNoiseTexture,this.gtaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.gtaoMaterial.uniforms.cameraNear.value=this.camera.near,this.gtaoMaterial.uniforms.cameraFar.value=this.camera.far,this.normalMaterial=new Wl,this.normalMaterial.blending=Lt,this.pdMaterial=new Be({defines:Object.assign({},Qi.defines),uniforms:dt.clone(Qi.uniforms),vertexShader:Qi.vertexShader,fragmentShader:Qi.fragmentShader,depthTest:!1,depthWrite:!1}),this.pdMaterial.uniforms.tDiffuse.value=this.gtaoRenderTarget.texture,this.pdMaterial.uniforms.tNoise.value=this.pdNoiseTexture,this.pdMaterial.uniforms.resolution.value.set(this.width,this.height),this.pdMaterial.uniforms.lumaPhi.value=10,this.pdMaterial.uniforms.depthPhi.value=2,this.pdMaterial.uniforms.normalPhi.value=3,this.pdMaterial.uniforms.radius.value=8,this.depthRenderMaterial=new Be({defines:Object.assign({},qi.defines),uniforms:dt.clone(qi.uniforms),vertexShader:qi.vertexShader,fragmentShader:qi.fragmentShader,blending:Lt}),this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new Be({uniforms:dt.clone(un.uniforms),vertexShader:un.vertexShader,fragmentShader:un.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:Kr,blendDst:Ei,blendEquation:xi,blendSrcAlpha:Qr,blendDstAlpha:Ei,blendEquationAlpha:xi}),this.blendMaterial=new Be({uniforms:dt.clone(Qn.uniforms),vertexShader:Qn.vertexShader,fragmentShader:Qn.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blending:Gl,blendSrc:Kr,blendDst:Ei,blendEquation:xi,blendSrcAlpha:Qr,blendDstAlpha:Ei,blendEquationAlpha:xi}),this._fsQuad=new jt(null),this._originalClearColor=new fe,this.setGBuffer(n?n.depthTexture:void 0,n?n.normalTexture:void 0),r!==void 0&&this.updateGtaoMaterial(r),o!==void 0&&this.updatePdMaterial(o)}setSize(e,t){this.width=e,this.height=t,this.gtaoRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.pdRenderTarget.setSize(e,t),this.gtaoMaterial.uniforms.resolution.value.set(e,t),this.gtaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.gtaoMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse),this.pdMaterial.uniforms.resolution.value.set(e,t),this.pdMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse)}dispose(){this.gtaoNoiseTexture.dispose(),this.pdNoiseTexture.dispose(),this.normalRenderTarget.dispose(),this.gtaoRenderTarget.dispose(),this.pdRenderTarget.dispose(),this.normalMaterial.dispose(),this.pdMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this._fsQuad.dispose()}get gtaoMap(){return this.pdRenderTarget.texture}setGBuffer(e,t){e!==void 0?(this.depthTexture=e,this.normalTexture=t,this._renderGBuffer=!1):(this.depthTexture=new Yl,this.depthTexture.format=Zl,this.depthTexture.type=Xl,this.normalRenderTarget=new xt(this.width,this.height,{minFilter:Bs,magFilter:Bs,type:Us,depthTexture:this.depthTexture}),this.normalTexture=this.normalRenderTarget.texture,this._renderGBuffer=!0);const s=this.normalTexture?1:0,i=this.depthTexture===this.normalTexture?"w":"x";this.gtaoMaterial.defines.NORMAL_VECTOR_TYPE=s,this.gtaoMaterial.defines.DEPTH_SWIZZLING=i,this.gtaoMaterial.uniforms.tNormal.value=this.normalTexture,this.gtaoMaterial.uniforms.tDepth.value=this.depthTexture,this.pdMaterial.defines.NORMAL_VECTOR_TYPE=s,this.pdMaterial.defines.DEPTH_SWIZZLING=i,this.pdMaterial.uniforms.tNormal.value=this.normalTexture,this.pdMaterial.uniforms.tDepth.value=this.depthTexture,this.depthRenderMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture}setSceneClipBox(e){e?(this.gtaoMaterial.needsUpdate=this.gtaoMaterial.defines.SCENE_CLIP_BOX!==1,this.gtaoMaterial.defines.SCENE_CLIP_BOX=1,this.gtaoMaterial.uniforms.sceneBoxMin.value.copy(e.min),this.gtaoMaterial.uniforms.sceneBoxMax.value.copy(e.max)):(this.gtaoMaterial.needsUpdate=this.gtaoMaterial.defines.SCENE_CLIP_BOX===0,this.gtaoMaterial.defines.SCENE_CLIP_BOX=0)}updateGtaoMaterial(e){e.radius!==void 0&&(this.gtaoMaterial.uniforms.radius.value=e.radius),e.distanceExponent!==void 0&&(this.gtaoMaterial.uniforms.distanceExponent.value=e.distanceExponent),e.thickness!==void 0&&(this.gtaoMaterial.uniforms.thickness.value=e.thickness),e.distanceFallOff!==void 0&&(this.gtaoMaterial.uniforms.distanceFallOff.value=e.distanceFallOff,this.gtaoMaterial.needsUpdate=!0),e.scale!==void 0&&(this.gtaoMaterial.uniforms.scale.value=e.scale),e.samples!==void 0&&e.samples!==this.gtaoMaterial.defines.SAMPLES&&(this.gtaoMaterial.defines.SAMPLES=e.samples,this.gtaoMaterial.needsUpdate=!0),e.screenSpaceRadius!==void 0&&(e.screenSpaceRadius?1:0)!==this.gtaoMaterial.defines.SCREEN_SPACE_RADIUS&&(this.gtaoMaterial.defines.SCREEN_SPACE_RADIUS=e.screenSpaceRadius?1:0,this.gtaoMaterial.needsUpdate=!0)}updatePdMaterial(e){let t=!1;e.lumaPhi!==void 0&&(this.pdMaterial.uniforms.lumaPhi.value=e.lumaPhi),e.depthPhi!==void 0&&(this.pdMaterial.uniforms.depthPhi.value=e.depthPhi),e.normalPhi!==void 0&&(this.pdMaterial.uniforms.normalPhi.value=e.normalPhi),e.radius!==void 0&&e.radius!==this.radius&&(this.pdMaterial.uniforms.radius.value=e.radius),e.radiusExponent!==void 0&&e.radiusExponent!==this.pdRadiusExponent&&(this.pdRadiusExponent=e.radiusExponent,t=!0),e.rings!==void 0&&e.rings!==this.pdRings&&(this.pdRings=e.rings,t=!0),e.samples!==void 0&&e.samples!==this.pdSamples&&(this.pdSamples=e.samples,t=!0),t&&(this.pdMaterial.defines.SAMPLES=this.pdSamples,this.pdMaterial.defines.SAMPLE_VECTORS=ol(this.pdSamples,this.pdRings,this.pdRadiusExponent),this.pdMaterial.needsUpdate=!0)}render(e,t,s){switch(this._renderGBuffer&&(this._overrideVisibility(),this._renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this._restoreVisibility()),this.gtaoMaterial.uniforms.cameraNear.value=this.camera.near,this.gtaoMaterial.uniforms.cameraFar.value=this.camera.far,this.gtaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.gtaoMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse),this.gtaoMaterial.uniforms.cameraWorldMatrix.value.copy(this.camera.matrixWorld),this._renderPass(e,this.gtaoMaterial,this.gtaoRenderTarget,16777215,1),this.pdMaterial.uniforms.cameraProjectionMatrixInverse.value.copy(this.camera.projectionMatrixInverse),this._renderPass(e,this.pdMaterial,this.pdRenderTarget,16777215,1),this.output){case nt.OUTPUT.Off:break;case nt.OUTPUT.Diffuse:this.copyMaterial.uniforms.tDiffuse.value=s.texture,this.copyMaterial.blending=Lt,this._renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case nt.OUTPUT.AO:this.copyMaterial.uniforms.tDiffuse.value=this.gtaoRenderTarget.texture,this.copyMaterial.blending=Lt,this._renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case nt.OUTPUT.Denoise:this.copyMaterial.uniforms.tDiffuse.value=this.pdRenderTarget.texture,this.copyMaterial.blending=Lt,this._renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case nt.OUTPUT.Depth:this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this._renderPass(e,this.depthRenderMaterial,this.renderToScreen?null:t);break;case nt.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=Lt,this._renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case nt.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=s.texture,this.copyMaterial.blending=Lt,this._renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.blendMaterial.uniforms.intensity.value=this.blendIntensity,this.blendMaterial.uniforms.tDiffuse.value=this.pdRenderTarget.texture,this._renderPass(e,this.blendMaterial,this.renderToScreen?null:t);break;default:console.warn("THREE.GTAOPass: Unknown output type.")}}_renderPass(e,t,s,i,n){e.getClearColor(this._originalClearColor);const r=e.getClearAlpha(),o=e.autoClear;e.setRenderTarget(s),e.autoClear=!1,i!=null&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this._fsQuad.material=t,this._fsQuad.render(e),e.autoClear=o,e.setClearColor(this._originalClearColor),e.setClearAlpha(r)}_renderOverride(e,t,s,i,n){e.getClearColor(this._originalClearColor);const r=e.getClearAlpha(),o=e.autoClear;e.setRenderTarget(s),e.autoClear=!1,i=t.clearColor||i,n=t.clearAlpha||n,i!=null&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=o,e.setClearColor(this._originalClearColor),e.setClearAlpha(r)}_overrideVisibility(){const e=this.scene,t=this._visibilityCache;e.traverse(function(s){t.set(s,s.visible),(s.isPoints||s.isLine)&&(s.visible=!1)})}_restoreVisibility(){const e=this.scene,t=this._visibilityCache;e.traverse(function(s){const i=t.get(s);s.visible=i}),t.clear()}_generateNoise(e=64){const t=new zu,s=e*e*4,i=new Uint8Array(s);for(let r=0;r<e;r++)for(let o=0;o<e;o++){const l=r,h=o;i[(r*e+o)*4]=(t.noise(l,h)*.5+.5)*255,i[(r*e+o)*4+1]=(t.noise(l+e,h)*.5+.5)*255,i[(r*e+o)*4+2]=(t.noise(l,h+e)*.5+.5)*255,i[(r*e+o)*4+3]=(t.noise(l+e,h+e)*.5+.5)*255}const n=new da(i,e,e,ms,Mr);return n.wrapS=fn,n.wrapT=fn,n.needsUpdate=!0,n}}nt.OUTPUT={Off:-1,Default:0,Diffuse:1,Depth:2,Normal:3,AO:4,Denoise:5};const Ki={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:`
		precision highp float;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		precision highp float;

		uniform sampler2D tDiffuse;

		#include <tonemapping_pars_fragment>
		#include <colorspace_pars_fragment>

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );

			// tone mapping

			#ifdef LINEAR_TONE_MAPPING

				gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );

			#elif defined( REINHARD_TONE_MAPPING )

				gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );

			#elif defined( CINEON_TONE_MAPPING )

				gl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );

			#elif defined( ACES_FILMIC_TONE_MAPPING )

				gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );

			#elif defined( AGX_TONE_MAPPING )

				gl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );

			#elif defined( NEUTRAL_TONE_MAPPING )

				gl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );

			#elif defined( CUSTOM_TONE_MAPPING )

				gl_FragColor.rgb = CustomToneMapping( gl_FragColor.rgb );

			#endif

			// color space

			#ifdef SRGB_TRANSFER

				gl_FragColor = sRGBTransferOETF( gl_FragColor );

			#endif

		}`};class ku extends St{constructor(){super(),this.uniforms=dt.clone(Ki.uniforms),this.material=new ql({name:Ki.name,uniforms:this.uniforms,vertexShader:Ki.vertexShader,fragmentShader:Ki.fragmentShader}),this._fsQuad=new jt(this.material),this._outputColorSpace=null,this._toneMapping=null}render(e,t,s){this.uniforms.tDiffuse.value=s.texture,this.uniforms.toneMappingExposure.value=e.toneMappingExposure,(this._outputColorSpace!==e.outputColorSpace||this._toneMapping!==e.toneMapping)&&(this._outputColorSpace=e.outputColorSpace,this._toneMapping=e.toneMapping,this.material.defines={},Ql.getTransfer(this._outputColorSpace)===Kl&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===Jl?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===$l?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===eh?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===th?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===sh?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===ih?this.material.defines.NEUTRAL_TONE_MAPPING="":this._toneMapping===nh&&(this.material.defines.CUSTOM_TONE_MAPPING=""),this.material.needsUpdate=!0),this.renderToScreen===!0?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}const Ji={defines:{SMAA_THRESHOLD:"0.1"},uniforms:{tDiffuse:{value:null},resolution:{value:new Ce(1/1024,1/512)}},vertexShader:`

		uniform vec2 resolution;

		varying vec2 vUv;
		varying vec4 vOffset[ 3 ];

		void SMAAEdgeDetectionVS( vec2 texcoord ) {
			vOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 ); // WebGL port note: Changed sign in W component
			vOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 ); // WebGL port note: Changed sign in W component
			vOffset[ 2 ] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 ); // WebGL port note: Changed sign in W component
		}

		void main() {

			vUv = uv;

			SMAAEdgeDetectionVS( vUv );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;

		varying vec2 vUv;
		varying vec4 vOffset[ 3 ];

		vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
			vec2 threshold = vec2( SMAA_THRESHOLD, SMAA_THRESHOLD );

			// Calculate color deltas:
			vec4 delta;
			vec3 C = texture2D( colorTex, texcoord ).rgb;

			vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
			vec3 t = abs( C - Cleft );
			delta.x = max( max( t.r, t.g ), t.b );

			vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
			t = abs( C - Ctop );
			delta.y = max( max( t.r, t.g ), t.b );

			// We do the usual threshold:
			vec2 edges = step( threshold, delta.xy );

			// Then discard if there is no edge:
			if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
				discard;

			// Calculate right and bottom deltas:
			vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
			t = abs( C - Cright );
			delta.z = max( max( t.r, t.g ), t.b );

			vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
			t = abs( C - Cbottom );
			delta.w = max( max( t.r, t.g ), t.b );

			// Calculate the maximum delta in the direct neighborhood:
			float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

			// Calculate left-left and top-top deltas:
			vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
			t = abs( C - Cleftleft );
			delta.z = max( max( t.r, t.g ), t.b );

			vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
			t = abs( C - Ctoptop );
			delta.w = max( max( t.r, t.g ), t.b );

			// Calculate the final maximum delta:
			maxDelta = max( max( maxDelta, delta.z ), delta.w );

			// Local contrast adaptation in action:
			edges.xy *= step( 0.5 * maxDelta, delta.xy );

			return vec4( edges, 0.0, 0.0 );
		}

		void main() {

			gl_FragColor = SMAAColorEdgeDetectionPS( vUv, vOffset, tDiffuse );

		}`},$i={defines:{SMAA_MAX_SEARCH_STEPS:"8",SMAA_AREATEX_MAX_DISTANCE:"16",SMAA_AREATEX_PIXEL_SIZE:"( 1.0 / vec2( 160.0, 560.0 ) )",SMAA_AREATEX_SUBTEX_SIZE:"( 1.0 / 7.0 )"},uniforms:{tDiffuse:{value:null},tArea:{value:null},tSearch:{value:null},resolution:{value:new Ce(1/1024,1/512)}},vertexShader:`

		uniform vec2 resolution;

		varying vec2 vUv;
		varying vec4 vOffset[ 3 ];
		varying vec2 vPixcoord;

		void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
			vPixcoord = texcoord / resolution;

			// We will use these offsets for the searches later on (see @PSEUDO_GATHER4):
			vOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 ); // WebGL port note: Changed sign in Y and W components
			vOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 ); // WebGL port note: Changed sign in Y and W components

			// And these for the searches, they indicate the ends of the loops:
			vOffset[ 2 ] = vec4( vOffset[ 0 ].xz, vOffset[ 1 ].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( SMAA_MAX_SEARCH_STEPS );

		}

		void main() {

			vUv = uv;

			SMAABlendingWeightCalculationVS( vUv );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		#define SMAASampleLevelZeroOffset( tex, coord, offset ) texture2D( tex, coord + float( offset ) * resolution, 0.0 )

		uniform sampler2D tDiffuse;
		uniform sampler2D tArea;
		uniform sampler2D tSearch;
		uniform vec2 resolution;

		varying vec2 vUv;
		varying vec4 vOffset[3];
		varying vec2 vPixcoord;

		#if __VERSION__ == 100
		vec2 round( vec2 x ) {
			return sign( x ) * floor( abs( x ) + 0.5 );
		}
		#endif

		float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
			// Not required if searchTex accesses are set to point:
			// float2 SEARCH_TEX_PIXEL_SIZE = 1.0 / float2(66.0, 33.0);
			// e = float2(bias, 0.0) + 0.5 * SEARCH_TEX_PIXEL_SIZE +
			//     e * float2(scale, 1.0) * float2(64.0, 32.0) * SEARCH_TEX_PIXEL_SIZE;
			e.r = bias + e.r * scale;
			return 255.0 * texture2D( searchTex, e, 0.0 ).r;
		}

		float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
			/**
				* @PSEUDO_GATHER4
				* This texcoord has been offset by (-0.25, -0.125) in the vertex shader to
				* sample between edge, thus fetching four edges in a row.
				* Sampling with different offsets in each direction allows to disambiguate
				* which edges are active from the four fetched ones.
				*/
			vec2 e = vec2( 0.0, 1.0 );

			for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for
				e = texture2D( edgesTex, texcoord, 0.0 ).rg;
				texcoord -= vec2( 2.0, 0.0 ) * resolution;
				if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
			}

			// We correct the previous (-0.25, -0.125) offset we applied:
			texcoord.x += 0.25 * resolution.x;

			// The searches are bias by 1, so adjust the coords accordingly:
			texcoord.x += resolution.x;

			// Disambiguate the length added by the last step:
			texcoord.x += 2.0 * resolution.x; // Undo last step
			texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);

			return texcoord.x;
		}

		float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
			vec2 e = vec2( 0.0, 1.0 );

			for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for
				e = texture2D( edgesTex, texcoord, 0.0 ).rg;
				texcoord += vec2( 2.0, 0.0 ) * resolution;
				if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
			}

			texcoord.x -= 0.25 * resolution.x;
			texcoord.x -= resolution.x;
			texcoord.x -= 2.0 * resolution.x;
			texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );

			return texcoord.x;
		}

		float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
			vec2 e = vec2( 1.0, 0.0 );

			for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for
				e = texture2D( edgesTex, texcoord, 0.0 ).rg;
				texcoord += vec2( 0.0, 2.0 ) * resolution; // WebGL port note: Changed sign
				if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
			}

			texcoord.y -= 0.25 * resolution.y; // WebGL port note: Changed sign
			texcoord.y -= resolution.y; // WebGL port note: Changed sign
			texcoord.y -= 2.0 * resolution.y; // WebGL port note: Changed sign
			texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 ); // WebGL port note: Changed sign

			return texcoord.y;
		}

		float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
			vec2 e = vec2( 1.0, 0.0 );

			for ( int i = 0; i < SMAA_MAX_SEARCH_STEPS; i ++ ) { // WebGL port note: Changed while to for
				e = texture2D( edgesTex, texcoord, 0.0 ).rg;
				texcoord -= vec2( 0.0, 2.0 ) * resolution; // WebGL port note: Changed sign
				if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
			}

			texcoord.y += 0.25 * resolution.y; // WebGL port note: Changed sign
			texcoord.y += resolution.y; // WebGL port note: Changed sign
			texcoord.y += 2.0 * resolution.y; // WebGL port note: Changed sign
			texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 ); // WebGL port note: Changed sign

			return texcoord.y;
		}

		vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
			// Rounding prevents precision errors of bilinear filtering:
			vec2 texcoord = float( SMAA_AREATEX_MAX_DISTANCE ) * round( 4.0 * vec2( e1, e2 ) ) + dist;

			// We do a scale and bias for mapping to texel space:
			texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );

			// Move to proper place, according to the subpixel offset:
			texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;

			return texture2D( areaTex, texcoord, 0.0 ).rg;
		}

		vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
			vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );

			vec2 e = texture2D( edgesTex, texcoord ).rg;

			if ( e.g > 0.0 ) { // Edge at north
				vec2 d;

				// Find the distance to the left:
				vec2 coords;
				coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
				coords.y = offset[ 1 ].y; // offset[1].y = texcoord.y - 0.25 * resolution.y (@CROSSING_OFFSET)
				d.x = coords.x;

				// Now fetch the left crossing edges, two at a time using bilinear
				// filtering. Sampling at -0.25 (see @CROSSING_OFFSET) enables to
				// discern what value each edge has:
				float e1 = texture2D( edgesTex, coords, 0.0 ).r;

				// Find the distance to the right:
				coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
				d.y = coords.x;

				// We want the distances to be in pixel units (doing this here allow to
				// better interleave arithmetic and memory accesses):
				d = d / resolution.x - pixcoord.x;

				// SMAAArea below needs a sqrt, as the areas texture is compressed
				// quadratically:
				vec2 sqrt_d = sqrt( abs( d ) );

				// Fetch the right crossing edges:
				coords.y -= 1.0 * resolution.y; // WebGL port note: Added
				float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 1, 0 ) ).r;

				// Ok, we know how this pattern looks like, now it is time for getting
				// the actual area:
				weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
			}

			if ( e.r > 0.0 ) { // Edge at west
				vec2 d;

				// Find the distance to the top:
				vec2 coords;

				coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
				coords.x = offset[ 0 ].x; // offset[1].x = texcoord.x - 0.25 * resolution.x;
				d.x = coords.y;

				// Fetch the top crossing edges:
				float e1 = texture2D( edgesTex, coords, 0.0 ).g;

				// Find the distance to the bottom:
				coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
				d.y = coords.y;

				// We want the distances to be in pixel units:
				d = d / resolution.y - pixcoord.y;

				// SMAAArea below needs a sqrt, as the areas texture is compressed
				// quadratically:
				vec2 sqrt_d = sqrt( abs( d ) );

				// Fetch the bottom crossing edges:
				coords.y -= 1.0 * resolution.y; // WebGL port note: Added
				float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, ivec2( 0, 1 ) ).g;

				// Get the area for this direction:
				weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );
			}

			return weights;
		}

		void main() {

			gl_FragColor = SMAABlendingWeightCalculationPS( vUv, vPixcoord, vOffset, tDiffuse, tArea, tSearch, ivec4( 0.0 ) );

		}`},Kn={uniforms:{tDiffuse:{value:null},tColor:{value:null},resolution:{value:new Ce(1/1024,1/512)}},vertexShader:`

		uniform vec2 resolution;

		varying vec2 vUv;
		varying vec4 vOffset[ 2 ];

		void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
			vOffset[ 0 ] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 ); // WebGL port note: Changed sign in W component
			vOffset[ 1 ] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 ); // WebGL port note: Changed sign in W component
		}

		void main() {

			vUv = uv;

			SMAANeighborhoodBlendingVS( vUv );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform sampler2D tColor;
		uniform vec2 resolution;

		varying vec2 vUv;
		varying vec4 vOffset[ 2 ];

		vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
			// Fetch the blending weights for current pixel:
			vec4 a;
			a.xz = texture2D( blendTex, texcoord ).xz;
			a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
			a.w = texture2D( blendTex, offset[ 1 ].xy ).a;

			// Is there any blending weight with a value greater than 0.0?
			if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
				return texture2D( colorTex, texcoord, 0.0 );
			} else {
				// Up to 4 lines can be crossing a pixel (one through each edge). We
				// favor blending by choosing the line with the maximum weight for each
				// direction:
				vec2 offset;
				offset.x = a.a > a.b ? a.a : -a.b; // left vs. right
				offset.y = a.g > a.r ? -a.g : a.r; // top vs. bottom // WebGL port note: Changed signs

				// Then we go in the direction that has the maximum weight:
				if ( abs( offset.x ) > abs( offset.y )) { // horizontal vs. vertical
					offset.y = 0.0;
				} else {
					offset.x = 0.0;
				}

				// Fetch the opposite color and lerp by hand:
				vec4 C = texture2D( colorTex, texcoord, 0.0 );
				texcoord += sign( offset ) * resolution;
				vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
				float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );

				// WebGL port note: Added gamma correction
				C.xyz = pow(C.xyz, vec3(2.2));
				Cop.xyz = pow(Cop.xyz, vec3(2.2));
				vec4 mixed = mix(C, Cop, s);
				mixed.xyz = pow(mixed.xyz, vec3(1.0 / 2.2));

				return mixed;
			}
		}

		void main() {

			gl_FragColor = SMAANeighborhoodBlendingPS( vUv, vOffset, tColor, tDiffuse );

		}`};class Iu extends St{constructor(){super(),this._edgesRT=new xt(1,1,{depthBuffer:!1,type:Us}),this._edgesRT.texture.name="SMAAPass.edges",this._weightsRT=new xt(1,1,{depthBuffer:!1,type:Us}),this._weightsRT.texture.name="SMAAPass.weights";const e=this,t=new Image;t.src=this._getAreaTexture(),t.onload=function(){e._areaTexture.needsUpdate=!0},this._areaTexture=new Jr,this._areaTexture.name="SMAAPass.area",this._areaTexture.image=t,this._areaTexture.minFilter=Ut,this._areaTexture.generateMipmaps=!1,this._areaTexture.flipY=!1;const s=new Image;s.src=this._getSearchTexture(),s.onload=function(){e._searchTexture.needsUpdate=!0},this._searchTexture=new Jr,this._searchTexture.name="SMAAPass.search",this._searchTexture.image=s,this._searchTexture.magFilter=Bs,this._searchTexture.minFilter=Bs,this._searchTexture.generateMipmaps=!1,this._searchTexture.flipY=!1,this._uniformsEdges=dt.clone(Ji.uniforms),this._materialEdges=new Be({defines:Object.assign({},Ji.defines),uniforms:this._uniformsEdges,vertexShader:Ji.vertexShader,fragmentShader:Ji.fragmentShader}),this._uniformsWeights=dt.clone($i.uniforms),this._uniformsWeights.tDiffuse.value=this._edgesRT.texture,this._uniformsWeights.tArea.value=this._areaTexture,this._uniformsWeights.tSearch.value=this._searchTexture,this._materialWeights=new Be({defines:Object.assign({},$i.defines),uniforms:this._uniformsWeights,vertexShader:$i.vertexShader,fragmentShader:$i.fragmentShader}),this._uniformsBlend=dt.clone(Kn.uniforms),this._uniformsBlend.tDiffuse.value=this._weightsRT.texture,this._materialBlend=new Be({uniforms:this._uniformsBlend,vertexShader:Kn.vertexShader,fragmentShader:Kn.fragmentShader}),this._fsQuad=new jt(null)}render(e,t,s){this._uniformsEdges.tDiffuse.value=s.texture,this._fsQuad.material=this._materialEdges,e.setRenderTarget(this._edgesRT),this.clear&&e.clear(),this._fsQuad.render(e),this._fsQuad.material=this._materialWeights,e.setRenderTarget(this._weightsRT),this.clear&&e.clear(),this._fsQuad.render(e),this._uniformsBlend.tColor.value=s.texture,this._fsQuad.material=this._materialBlend,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(),this._fsQuad.render(e))}setSize(e,t){this._edgesRT.setSize(e,t),this._weightsRT.setSize(e,t),this._materialEdges.uniforms.resolution.value.set(1/e,1/t),this._materialWeights.uniforms.resolution.value.set(1/e,1/t),this._materialBlend.uniforms.resolution.value.set(1/e,1/t)}dispose(){this._edgesRT.dispose(),this._weightsRT.dispose(),this._areaTexture.dispose(),this._searchTexture.dispose(),this._materialEdges.dispose(),this._materialWeights.dispose(),this._materialBlend.dispose(),this._fsQuad.dispose()}_getAreaTexture(){return"data:image/png;base64,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"}_getSearchTexture(){return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAAAhCAAAAABIXyLAAAAAOElEQVRIx2NgGAWjYBSMglEwEICREYRgFBZBqDCSLA2MGPUIVQETE9iNUAqLR5gIeoQKRgwXjwAAGn4AtaFeYLEAAAAASUVORK5CYII="}}class Lu extends St{constructor(e,t,s=1){super(),S(this,"_edgeMaterial"),S(this,"_combineMaterial"),S(this,"_fsQuad"),S(this,"_edgeRenderTarget"),S(this,"_vertexColorRenderTarget"),S(this,"_fragments"),S(this,"_renderer"),S(this,"_overrideMaterial"),S(this,"_depthBiasStrength",.001),S(this,"_mode",0),this._renderer=e,this._fragments=t,this._overrideMaterial=new Be({clipping:!0,vertexColors:!0,side:Ft,uniforms:{depthBiasStrength:{value:this._depthBiasStrength}},vertexShader:`
        #include <common>
        #include <color_pars_vertex>
        #include <clipping_planes_pars_vertex>
        
        uniform float depthBiasStrength;
        
        void main() {
          #include <color_vertex>
          vColor = color;
          
          #include <begin_vertex>
          #include <project_vertex>
          
          // Compute priority from vertex color (using luminance)
          // Higher values = higher priority = render on top
          float priority = dot(color, vec3(0.299, 0.587, 0.114)); // Luminance
          
          // Apply depth bias: subtract from z to bring higher priority faces closer
          // In clip space, smaller z values are closer to camera
          gl_Position.z -= priority * depthBiasStrength;

          #include <clipping_planes_vertex>
        }
      `,fragmentShader:`
        varying vec3 vColor;
        #include <clipping_planes_pars_fragment>
        
        void main() {
          #include <clipping_planes_fragment>
          gl_FragColor = vec4(vColor, 1.0);
        }
      `}),this._edgeMaterial=new Be({uniforms:{tDiffuse:{value:null},width:{value:s}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform sampler2D tDiffuse;
        uniform float width;
        varying vec2 vUv;

        void main() {
          vec2 texel = vec2(1.0 / float(textureSize(tDiffuse, 0).x), 1.0 / float(textureSize(tDiffuse, 0).y));
          vec2 offset = texel * width;
          
          vec4 center = texture2D(tDiffuse, vUv);
          vec4 right = texture2D(tDiffuse, vUv + vec2(offset.x, 0.0));
          vec4 up = texture2D(tDiffuse, vUv + vec2(0.0, offset.y));
          
          float diff = 0.0;
          diff += distance(center.rgb, right.rgb);
          diff += distance(center.rgb, up.rgb);
          gl_FragColor = vec4(vec3(step(0.0001, diff)), 1.0);
        }
      `}),this._combineMaterial=new Be({uniforms:{tDiffuse:{value:null},tEdges:{value:null},edgeColor:{value:new fe(8947848)}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform sampler2D tDiffuse;
        uniform sampler2D tEdges;
        uniform vec3 edgeColor;
        varying vec2 vUv;

        void main() {
          vec4 color = texture2D(tDiffuse, vUv);
          vec4 edges = texture2D(tEdges, vUv);
          
          // Combine color with edges (edges are black, so we multiply)
          gl_FragColor = mix(color, vec4(edgeColor, 1.0), edges.r);
        }
      `}),this._fsQuad=new jt(this._edgeMaterial),this._edgeRenderTarget=new xt(1,1,{minFilter:Ut,magFilter:Ut,format:ms}),this._vertexColorRenderTarget=new xt(1,1,{minFilter:Ut,magFilter:Ut,format:ms})}get mode(){return this._mode}set mode(e){this._mode=e,this.setMaterialToMesh(!1)}get width(){return this._edgeMaterial.uniforms.width.value}set width(e){this._edgeMaterial.uniforms.width.value=e}get color(){return this._combineMaterial.uniforms.edgeColor.value}set color(e){this._combineMaterial.uniforms.edgeColor.value=e}get depthBiasStrength(){return this._depthBiasStrength}set depthBiasStrength(e){this._depthBiasStrength=e,this._overrideMaterial&&(this._overrideMaterial.uniforms.depthBiasStrength.value=e)}setSize(e,t){this._edgeRenderTarget.setSize(e,t),this._vertexColorRenderTarget.setSize(e,t)}setWidth(e){this._edgeMaterial.uniforms.width.value=e}render(e,t,s){const i=this._renderer.currentWorld,n=i.scene.three,r=i.scene.three,o=r.fog,l=r.background;if(r.fog=null,r.background=null,this._mode===0)this.setMaterialToMesh(!0),e.setRenderTarget(this._vertexColorRenderTarget),e.render(n,i.camera.three),this.setMaterialToMesh(!1);else if(this._mode===1){const h=n.overrideMaterial;n.overrideMaterial=this._overrideMaterial,e.setRenderTarget(this._vertexColorRenderTarget),e.render(n,i.camera.three),n.overrideMaterial=h}r.fog=o,r.background=l,this._edgeMaterial.uniforms.tDiffuse.value=this._vertexColorRenderTarget.texture,this._fsQuad.material=this._edgeMaterial,e.setRenderTarget(this._edgeRenderTarget),this._fsQuad.render(e),this._combineMaterial.uniforms.tDiffuse.value=s.texture,this._combineMaterial.uniforms.tEdges.value=this._edgeRenderTarget.texture,this._fsQuad.material=this._combineMaterial,this.renderToScreen?e.setRenderTarget(null):e.setRenderTarget(t),this._fsQuad.render(e)}dispose(){this._edgeMaterial.dispose(),this._combineMaterial.dispose(),this._overrideMaterial.dispose(),this._fsQuad.dispose(),this._edgeRenderTarget.dispose(),this._vertexColorRenderTarget.dispose()}setMaterialToMesh(e){for(const[,t]of this._fragments.core.models.list)for(const[,s]of t.tiles)"isLODGeometry"in s.geometry||(e?(s.userData.edgePassPreviousMaterial=s.material,s.material=[this._overrideMaterial]):"edgePassPreviousMaterial"in s.userData&&(s.material=s.userData.edgePassPreviousMaterial))}}class Nu extends St{constructor(e,t,s){super(),S(this,"outlineColor",new fe(16762880)),S(this,"thickness",2),S(this,"fillColor",new fe(16776960)),S(this,"fillOpacity",.3),S(this,"debugShowMask",!1),S(this,"scene",new Dr),S(this,"_maskTarget"),S(this,"_fsQuad"),S(this,"_world"),S(this,"_debugQuad",null),this._world=s,this.scene.background=new fe(0),this._maskTarget=new xt(e,t,{minFilter:Ut,magFilter:Ut,format:ms,type:Mr}),this._fsQuad=new jt(new Be({uniforms:{tDiffuse:{value:null},tMask:{value:null},outlineColor:{value:new fe(65280)},thickness:{value:2},resolution:{value:new Ce(e,t)},fillColor:{value:new fe(16776960)},fillOpacity:{value:.3}},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,fragmentShader:`
          uniform sampler2D tDiffuse;
          uniform sampler2D tMask;
          uniform vec3 outlineColor;
          uniform float thickness;
          uniform vec2 resolution;
          uniform vec3 fillColor;
          uniform float fillOpacity;
          varying vec2 vUv;

          void main() {
            float mask = texture2D(tMask, vUv).r;
            float outline = 0.0;
            float t = thickness;
            vec2 texel = 1.0 / resolution;
            for (float x = -t; x <= t; x++) {
              for (float y = -t; y <= t; y++) {
                vec2 offset = vec2(x, y) * texel;
                float neighbor = texture2D(tMask, vUv + offset).r;
                if (neighbor > 0.5) outline = 1.0;
              }
            }
            vec4 sceneColor = texture2D(tDiffuse, vUv);
            // Fill inside
            if (mask > 0.5) {
              sceneColor.rgb = mix(sceneColor.rgb, fillColor, fillOpacity);
            }
            // Only draw outline where mask is not set but neighbor is
            if (outline > 0.5 && mask < 0.5) {
              gl_FragColor = vec4(outlineColor, 1.0);
            } else {
              gl_FragColor = sceneColor;
            }
          }
        `})),this._debugQuad=new jt(new Be({uniforms:{tMask:{value:null}},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
        `,fragmentShader:`
          uniform sampler2D tMask;
          varying vec2 vUv;
          void main() {
            float mask = texture2D(tMask, vUv).r;
            gl_FragColor = vec4(vec3(mask), 1.0);
          }
        `}))}setSize(e,t){this._maskTarget.setSize(e,t),this._fsQuad.material.uniforms.resolution.value.set(e,t)}render(e,t,s){const i=this._world.camera.three,n=e.getClearColor(new fe),r=e.getClearAlpha();if(e.setClearColor(0,0),e.setRenderTarget(this._maskTarget),e.clear(),e.render(this.scene,i),e.setClearColor(n,r),this.debugShowMask){const l=this._debugQuad.material;l.uniforms.tMask.value=this._maskTarget.texture,this.renderToScreen?e.setRenderTarget(null):e.setRenderTarget(t),this._debugQuad.render(e);return}const o=this._fsQuad.material;o.uniforms.tDiffuse.value=s.texture,o.uniforms.tMask.value=this._maskTarget.texture,o.uniforms.outlineColor.value.copy(this.outlineColor),o.uniforms.thickness.value=this.thickness,o.uniforms.fillColor.value.copy(this.fillColor),o.uniforms.fillOpacity.value=this.fillOpacity,this.renderToScreen?e.setRenderTarget(null):e.setRenderTarget(t),this._fsQuad.render(e)}dispose(){this._maskTarget.dispose(),this._fsQuad.dispose();const e=[...this.scene.children];for(const t of e)t.removeFromParent()}}class Uu extends St{constructor(e,t){super(),S(this,"materialToExclude",new vs({color:0})),S(this,"_excludedMaterials",new Set),S(this,"_originalMaterials",new Map),S(this,"_renderer"),S(this,"_world"),S(this,"_fsQuad"),S(this,"_combineMaterial"),S(this,"_excludedRenderTarget"),this._renderer=e,this._world=t,this._excludedRenderTarget=new xt(1,1,{minFilter:Ut,magFilter:Ut,format:ms}),this._combineMaterial=new Be({uniforms:{tDiffuse:{value:null},tExcluded:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform sampler2D tDiffuse;
        uniform sampler2D tExcluded;
        varying vec2 vUv;

        void main() {
          vec4 inputColor = texture2D(tDiffuse, vUv);
          vec4 excludedColor = texture2D(tExcluded, vUv);
          
          // If excluded pixel is black (or very dark), use input color
          // Otherwise, use excluded color
          float excludedLuminance = (excludedColor.r + excludedColor.g + excludedColor.b) / 3.0;
          float threshold = 0.01; // Adjust this threshold as needed
          
          if (excludedLuminance < threshold) {
            gl_FragColor = inputColor;
          } else {
            gl_FragColor = excludedColor;
          }
        }
      `}),this._fsQuad=new jt(this._combineMaterial)}addExcludedMaterial(e){this._excludedMaterials.add(e)}removeExcludedMaterial(e){this._excludedMaterials.delete(e)}clearExcludedMaterials(){this._excludedMaterials.clear()}get excludedMaterials(){return Array.from(this._excludedMaterials)}setSize(e,t){this._excludedRenderTarget.setSize(e,t)}render(e,t,s){const i=this._world.scene.three,n=this._world.camera.three,r=e.getClearColor(new fe),o=e.getClearAlpha();e.setClearColor(0,0),this._substituteMaterials(i),e.setRenderTarget(this._excludedRenderTarget),e.render(i,n),this._restoreMaterials(),this._combineMaterial.uniforms.tDiffuse.value=s.texture,this._combineMaterial.uniforms.tExcluded.value=this._excludedRenderTarget.texture,this.renderToScreen?e.setRenderTarget(null):e.setRenderTarget(t),this._fsQuad.render(e),e.setClearColor(r,o)}_substituteMaterials(e){if(e instanceof ie){const t=e.material;if(Array.isArray(t)){for(const s of t)if("isLodMaterial"in s)return}else if("isLodMaterial"in t)return;this._excludedMaterials.has(t)||(this._originalMaterials.set(e,t),e.material=this.materialToExclude)}for(const t of e.children)this._substituteMaterials(t)}_restoreMaterials(){for(const[e,t]of this._originalMaterials)e.material=t;this._originalMaterials.clear()}dispose(){this.materialToExclude.dispose(),this._combineMaterial.dispose(),this._fsQuad.dispose(),this._excludedRenderTarget.dispose(),this._excludedMaterials.clear(),this._originalMaterials.clear()}}class Bu extends St{constructor(e,t,s=null,i=null,n=null){super(),S(this,"scene"),S(this,"camera"),S(this,"overrideMaterial"),S(this,"clearColor"),S(this,"clearAlpha"),S(this,"clearDepth"),S(this,"needsSwap"),S(this,"isolatedMaterials",[]),S(this,"_oldClearColor"),this.scene=e,this.camera=t,this.overrideMaterial=s,this.clearColor=i,this.clearAlpha=n,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new fe}render(e,t,s){for(const o of this.isolatedMaterials)o.userData.wasVisibleBasePass!==void 0&&(o.visible=o.userData.wasVisibleBasePass);const i=e.autoClear;e.autoClear=!1;let n,r;this.overrideMaterial!==null&&(r=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),this.clearAlpha!==null&&(n=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),this.clearDepth===!0&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:s),this.clear===!0&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor!==null&&e.setClearColor(this._oldClearColor),this.clearAlpha!==null&&e.setClearAlpha(n),this.overrideMaterial!==null&&(this.scene.overrideMaterial=r),e.autoClear=i;for(const o of this.isolatedMaterials)o.userData.wasVisibleBasePass=o.visible,o.visible=!1}}function Ru(){return new Be({clipping:!0,uniforms:{glossExponent:{value:10},fresnelExponent:{value:6},glossFactor:{value:.2},fresnelFactor:{value:1}},vertexShader:`
    varying vec3 vCameraPosition;
    varying vec3 vPosition;
    varying vec3 vNormal;
    
    #include <clipping_planes_pars_vertex>
  
    void main() {
       #include <begin_vertex>
       
       vec4 absPosition = vec4(position, 1.0);
       vNormal = normal;
       
       #ifdef USE_INSTANCING
          absPosition = instanceMatrix * absPosition;
          vNormal = (instanceMatrix * vec4(normal, 0.)).xyz;
       #endif
       
       absPosition = modelMatrix * absPosition;
       vNormal = (normalize(modelMatrix * vec4(vNormal, 0.))).xyz;
       
       gl_Position = projectionMatrix * viewMatrix * absPosition;
       
       vCameraPosition = cameraPosition;
       vPosition = absPosition.xyz;
       
       #include <project_vertex>
       #include <clipping_planes_vertex>
    }
    `,fragmentShader:`
    uniform float glossExponent;
    uniform float glossFactor;
    uniform float fresnelExponent;
    uniform float fresnelFactor;

    varying vec3 vCameraPosition;
    varying vec3 vPosition;
    varying vec3 vNormal;
    
    #include <clipping_planes_pars_fragment>
  
    void main() {
      #include <clipping_planes_fragment>
      vec3 cameraPixelVec = normalize(vCameraPosition - vPosition);
      float dotProduct = dot(vNormal, cameraPixelVec);

      // Use abs() for both gloss and fresnel to handle DoubleSide materials
      // On back faces, dotProduct is negative, which breaks the fresnel calculation

      float absDotProduct = abs(dotProduct);
      float gloss = absDotProduct;

      // Use absDotProduct instead of dotProduct to prevent values > 1.0
      
      float fresnel = pow(1.0 - absDotProduct, fresnelExponent) * fresnelFactor;

      gloss = pow(gloss, glossExponent) * glossFactor;

      float result = gloss + fresnel;

      gl_FragColor = vec4(result, result, result, 1.);
    }
    `})}class Fu extends St{constructor(e,t){super(),S(this,"resolution"),S(this,"renderScene"),S(this,"renderCamera"),S(this,"fsQuad"),S(this,"glossOverrideMaterial"),S(this,"glossBuffer"),S(this,"_glossEnabled",!0),this.renderScene=t.scene.three,this.renderCamera=t.camera.three,this.resolution=new Ce(e.x,e.y),this.fsQuad=new jt,this.fsQuad.material=this.createGlossMaterial(),this.glossBuffer=this.newRenderTarget();const s=Ru();this.glossOverrideMaterial=s}get glossEnabled(){return this._glossEnabled}set glossEnabled(e){this._glossEnabled=e;const t=this.fsQuad.material;t.uniforms.glossEnabled.value=e?1:0}get minGloss(){return this.fsQuad.material.uniforms.minGloss.value}set minGloss(e){const t=this.fsQuad.material;t.uniforms.minGloss.value=e}get maxGloss(){return this.fsQuad.material.uniforms.maxGloss.value}set maxGloss(e){const t=this.fsQuad.material;t.uniforms.maxGloss.value=e}get glossExponent(){return this.glossOverrideMaterial.uniforms.glossExponent.value}set glossExponent(e){this.glossOverrideMaterial.uniforms.glossExponent.value=e}get fresnelExponent(){return this.glossOverrideMaterial.uniforms.fresnelExponent.value}set fresnelExponent(e){this.glossOverrideMaterial.uniforms.fresnelExponent.value=e}get glossFactor(){return this.glossOverrideMaterial.uniforms.glossFactor.value}set glossFactor(e){this.glossOverrideMaterial.uniforms.glossFactor.value=e}get fresnelFactor(){return this.glossOverrideMaterial.uniforms.fresnelFactor.value}set fresnelFactor(e){this.glossOverrideMaterial.uniforms.fresnelFactor.value=e}dispose(){this.glossBuffer.dispose(),this.glossOverrideMaterial.dispose(),this.fsQuad.dispose()}setSize(e,t){this.glossBuffer.setSize(e,t),this.resolution.set(e,t),this.fsQuad.material.uniforms.screenSize.value.set(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)}render(e,t,s){const i=t.depthBuffer;t.depthBuffer=!1;const n=this.renderScene.overrideMaterial,r=this.renderScene.background;this.renderScene.background=null,e.setRenderTarget(this.glossBuffer),this.renderScene.overrideMaterial=this.glossOverrideMaterial,e.render(this.renderScene,this.renderCamera),this.renderScene.overrideMaterial=n,this.renderScene.background=r;const o=this.fsQuad.material;o.uniforms.glossBuffer.value=this.glossBuffer.texture,o.uniforms.sceneColorBuffer.value=s.texture,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.fsQuad.render(e)),t.depthBuffer=i}get vertexShader(){return`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `}get fragmentShader(){return`
      uniform sampler2D sceneColorBuffer;
      uniform sampler2D glossBuffer;
      uniform vec4 screenSize;
      uniform float glossEnabled;
      uniform float minGloss;
      uniform float maxGloss;


      varying vec2 vUv;

      vec4 getValue(sampler2D buffer, int x, int y) {
        return texture2D(buffer, vUv + screenSize.zw * vec2(x, y));
      }

      void main() {
        vec4 sceneColor = getValue(sceneColorBuffer, 0, 0);
        
        // Apply gloss effect
        vec3 gloss = getValue(glossBuffer, 0, 0).xyz;
        // Prevent the gloss from being zero, which would break normalize() later
        gloss = max(gloss, vec3(0.001));
        
        vec3 glossEffect = gloss * glossEnabled;

        // Map glossEffect to range [minGloss, maxGloss]
        // All dimensions of the glossEffect are the same, so we can use the x dimension.
        float mappedGloss = minGloss + (maxGloss - minGloss) * glossEffect.x;


        glossEffect = normalize(glossEffect) * mappedGloss;

        vec4 glossedColor = sceneColor + vec4(glossEffect, 0.0);

        // Prevent the glossed color from being darker than zero
        glossedColor = max(glossedColor, vec4(0.0, 0.0, 0.0, sceneColor.a));
        
        gl_FragColor = glossedColor;
      }
    `}createGlossMaterial(){return new Be({uniforms:{sceneColorBuffer:{value:null},glossBuffer:{value:null},glossEnabled:{value:this._glossEnabled?1:0},minGloss:{value:-.12},maxGloss:{value:.8},screenSize:{value:new gs(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)}},vertexShader:this.vertexShader,fragmentShader:this.fragmentShader})}newRenderTarget(){const e=new xt(this.resolution.x,this.resolution.y);return e.texture.colorSpace="srgb-linear",e.texture.format=ms,e.texture.type=Us,e.texture.minFilter=Bs,e.texture.magFilter=Bs,e.texture.generateMipmaps=!1,e.stencilBuffer=!1,e}}var xr=(a=>(a[a.COLOR=0]="COLOR",a[a.PEN=1]="PEN",a[a.PEN_SHADOWS=2]="PEN_SHADOWS",a[a.COLOR_PEN=3]="COLOR_PEN",a[a.COLOR_SHADOWS=4]="COLOR_SHADOWS",a[a.COLOR_PEN_SHADOWS=5]="COLOR_PEN_SHADOWS",a))(xr||{});class Vu{constructor(e,t){S(this,"invisibleMaterials",new Set),S(this,"composer"),S(this,"onStyleChanged",new K),S(this,"_enabled",!1),S(this,"_initialized",!1),S(this,"_basePass"),S(this,"_aoPass"),S(this,"_outputPass"),S(this,"_edgeDetectionPass"),S(this,"_smaaPass"),S(this,"_simpleOutlinePass"),S(this,"_excludedObjectsPass"),S(this,"_glossPass"),S(this,"_style",0),S(this,"_outlinesEnabled",!1),S(this,"_glossEnabled",!1),S(this,"_smaaEnabled",!1),S(this,"_excludedObjectsEnabled",!1),S(this,"_components"),S(this,"_renderer"),S(this,"defaultAoParameters",{radius:.25,distanceExponent:5.7,thickness:10,scale:2,samples:16,distanceFallOff:1,screenSpaceRadius:!0}),this._components=e,this._renderer=t}get basePass(){if(!this._basePass)throw new Error("Base pass not initialized");return this._basePass}get enabled(){return this._enabled}set enabled(e){if(this._enabled=e,e&&!this._initialized&&this.initialize(),!e)for(const t of this.basePass.isolatedMaterials)t.visible=!0}get aoPass(){if(!this._aoPass)throw new Error("AO pass not initialized");return this._aoPass}get outlinePass(){if(!this._simpleOutlinePass)throw new Error("Outline pass not initialized");return this._simpleOutlinePass}get edgesPass(){if(!this._edgeDetectionPass)throw new Error("Edge detection pass not initialized");return this._edgeDetectionPass}get excludedObjectsPass(){if(!this._excludedObjectsPass)throw new Error("Excluded objects pass not initialized");return this._excludedObjectsPass}get glossPass(){if(!this._glossPass)throw new Error("Gloss pass not initialized");return this._glossPass}get outlinesEnabled(){return this._outlinesEnabled}set outlinesEnabled(e){this._outlinesEnabled=e,this.style=this._style}get excludedObjectsEnabled(){return this._excludedObjectsEnabled}set excludedObjectsEnabled(e){this._excludedObjectsEnabled=e,this.style=this._style}get glossEnabled(){return this._glossEnabled}set glossEnabled(e){this._glossEnabled=e,this.style=this._style}get smaaEnabled(){return this._smaaEnabled}set smaaEnabled(e){this._smaaEnabled=e,this.style=this._style}get style(){return this._style}set style(e){this.composer&&(!this.composer||!this._basePass||!this._smaaPass||!this._outputPass||!this._aoPass||!this._edgeDetectionPass||!this._simpleOutlinePass||!this._excludedObjectsPass||!this._glossPass||(this._style===2&&this._aoPass.updateGtaoMaterial(this.defaultAoParameters),this._style=e,this.clear(),e===0&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),e===1&&(this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass)),e===2&&(this.composer.addPass(this._basePass),this.composer.addPass(this._aoPass),this._aoPass.output=nt.OUTPUT.AO,this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),e===3&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),e===4&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this.composer.addPass(this._aoPass),this._aoPass.output=nt.OUTPUT.Default,this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),e===5&&(this.composer.addPass(this._basePass),this._glossEnabled&&this.composer.addPass(this._glossPass),this.composer.addPass(this._aoPass),this._aoPass.output=nt.OUTPUT.Default,this.composer.addPass(this._edgeDetectionPass),this._outlinesEnabled&&this.composer.addPass(this._simpleOutlinePass),this._excludedObjectsEnabled&&this.composer.addPass(this._excludedObjectsPass),this._smaaEnabled&&this.composer.addPass(this._smaaPass),this.composer.addPass(this._outputPass)),this.onStyleChanged.trigger(e)))}update(){if(this.composer){for(const e of this.invisibleMaterials)e.userData.wasVisibleForPostproduction=e.visible,e.visible=!1;this.composer.render();for(const e of this.invisibleMaterials)e.visible=e.userData.wasVisibleForPostproduction}}dispose(){var e,t,s,i,n,r,o,l;(e=this.composer)==null||e.dispose(),(t=this._aoPass)==null||t.dispose(),(s=this._outputPass)==null||s.dispose(),(i=this._edgeDetectionPass)==null||i.dispose(),(n=this._smaaPass)==null||n.dispose(),(r=this._simpleOutlinePass)==null||r.dispose(),(o=this._excludedObjectsPass)==null||o.dispose(),(l=this._glossPass)==null||l.dispose()}setSize(e,t){e===0||t===0||(this.composer&&this.composer.setSize(e,t),this._simpleOutlinePass&&this._simpleOutlinePass.setSize(e,t),this._excludedObjectsPass&&this._excludedObjectsPass.setSize(e,t),this._glossPass&&this._glossPass.setSize(e,t))}updateCamera(){const e=this._renderer.currentWorld.camera.three;this._basePass&&(this._basePass.camera=e),this._aoPass&&(this._aoPass.camera=e)}clear(){if(!this.composer)return;const e=[...this.composer.passes];for(const t of e)this.composer.removePass(t);this._renderer.three.setClearColor(0,0),this._renderer.three.setRenderTarget(this.composer.renderTarget1),this._renderer.three.clear(),this._renderer.three.setRenderTarget(this.composer.renderTarget2),this._renderer.three.clear(),this._renderer.three.setRenderTarget(null)}initialize(){this._initialized=!0;const e=this._renderer.currentWorld.scene.three,t=this._renderer.currentWorld.camera.three;this._renderer.three.setClearColor(0,0),this.composer=new Au(this._renderer.three);const s=new Bu(e,t);this._basePass=s,this._smaaPass=new Iu,this._aoPass=new nt(e,t,this._renderer.three.domElement.width,this._renderer.three.domElement.height),this._aoPass.output=nt.OUTPUT.Default;const i=this._components.get(le);this._edgeDetectionPass=new Lu(this._renderer,i),this._outputPass=new ku,this._simpleOutlinePass=new Nu(this._renderer.three.domElement.width,this._renderer.three.domElement.height,this._renderer.currentWorld),this._excludedObjectsPass=new Uu(this._renderer,this._renderer.currentWorld),this._glossPass=new Fu(new Ce(this._renderer.three.domElement.width,this._renderer.three.domElement.height),this._renderer.currentWorld),this.style=0}}class _p extends xu{constructor(e,t,s){super(e,t,s),S(this,"manualDefaultStyle",xr.COLOR),S(this,"turnOffOnManualMode",!0),S(this,"manualModeDelay",50),S(this,"_postproduction"),S(this,"_timeout"),S(this,"_previousStyle",xr.COLOR),S(this,"_previousEnabled",!1),this.onResize.add(i=>{this.setPostproductionSize(i)}),this.onWorldChanged.add(()=>{this.currentWorld&&(this._postproduction&&this._postproduction.dispose(),this._postproduction=new Vu(e,this),this._postproduction.onStyleChanged.add(i=>{this._previousStyle=i}),this.setPostproductionSize())})}get postproduction(){if(!this._postproduction)throw new Error("Renderer not initialized yet with a world!");return this._postproduction}update(){if(!this.enabled||!this.currentWorld||this.mode===ln.MANUAL&&!this.needsUpdate)return;this.needsUpdate=!1,this.onBeforeUpdate.trigger();const e=this.currentWorld.scene.three,t=this.currentWorld.camera.three;this.mode===ln.MANUAL&&(this.turnOffOnManualMode&&this.postproduction.enabled&&(this._previousEnabled=this.postproduction.enabled,this.postproduction.enabled=!1),this.manualDefaultStyle!==this.postproduction.style&&this.setStyleWithoutEvent(this.manualDefaultStyle)),this.postproduction.enabled?this.postproduction.update():this.three.render(e,t),e instanceof Dr&&this.three2D.render(e,t),this.mode===ln.MANUAL&&(this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(()=>{this.turnOffOnManualMode&&(this.postproduction.enabled=this._previousEnabled),this.setStyleWithoutEvent(this._previousStyle),this.postproduction.update()},this.manualModeDelay)),this.onAfterUpdate.trigger()}dispose(){super.dispose(),this.postproduction.dispose()}setStyleWithoutEvent(e){this.postproduction.onStyleChanged.enabled=!1,this.postproduction.style=e,this.postproduction.onStyleChanged.enabled=!0}setPostproductionSize(e){if(e&&(e.x===0||e.y===0)||!this.container||!this._postproduction)return;const t=Math.min(window.devicePixelRatio,2),s=(e==null?void 0:e.x)??this.container.clientWidth*t,i=(e==null?void 0:e.y)??this.container.clientHeight*t;s===0||i===0||this.postproduction.setSize(s,i)}}const $o=new Ue,en=new L;class Wr extends Il{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],s=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(s),this.setAttribute("position",new es(e,3)),this.setAttribute("uv",new es(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,s=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),s.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const s=new nr(t,6,1);return this.setAttribute("instanceStart",new Ls(s,3,0)),this.setAttribute("instanceEnd",new Ls(s,3,3)),this.instanceCount=this.attributes.instanceStart.count,this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const s=new nr(t,6,1);return this.setAttribute("instanceColorStart",new Ls(s,3,0)),this.setAttribute("instanceColorEnd",new Ls(s,3,3)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new Ll(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Ue);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),$o.setFromBufferAttribute(t),this.boundingBox.union($o))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new fs),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const s=this.boundingSphere.center;this.boundingBox.getCenter(s);let i=0;for(let n=0,r=e.count;n<r;n++)en.fromBufferAttribute(e,n),i=Math.max(i,s.distanceToSquared(en)),en.fromBufferAttribute(t,n),i=Math.max(i,s.distanceToSquared(en));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}}on.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new Ce(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}};an.line={uniforms:dt.merge([on.common,on.fog,on.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 tmpFwd = normalize( mix( start.xyz, end.xyz, 0.5 ) );
				vec3 worldUp = normalize( cross( worldDir, tmpFwd ) );
				vec3 worldFwd = cross( worldDir, worldUp );
				worldPos = position.y < 0.5 ? start: end;

				// height offset
				float hw = linewidth * 0.5;
				worldPos.xyz += position.x < 0.0 ? hw * worldUp : - hw * worldUp;

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// cap extension
					worldPos.xyz += position.y < 0.5 ? - hw * worldDir : hw * worldDir;

					// add width to the box
					worldPos.xyz += worldFwd * hw;

					// endcaps
					if ( position.y > 1.0 || position.y < 0.0 ) {

						worldPos.xyz -= worldFwd * 2.0 * hw;

					}

				#endif

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class Gr extends Be{constructor(e){super({type:"LineMaterial",uniforms:dt.clone(an.line.uniforms),vertexShader:an.line.vertexShader,fragmentShader:an.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(e){this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}get dashed(){return"USE_DASH"in this.defines}set dashed(e){e===!0!==this.dashed&&(this.needsUpdate=!0),e===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}get opacity(){return this.uniforms.opacity.value}set opacity(e){this.uniforms&&(this.uniforms.opacity.value=e)}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(e){this.defines&&(e===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),e===!0?this.defines.USE_ALPHA_TO_COVERAGE="":delete this.defines.USE_ALPHA_TO_COVERAGE)}}const Jn=new gs,ea=new L,ta=new L,We=new gs,Ge=new gs,At=new gs,$n=new L,er=new Pe,Ye=new lt,sa=new L,tn=new Ue,sn=new fs,Mt=new gs;let zt,ps;function ia(a,e,t){return Mt.set(0,0,-e,1).applyMatrix4(a.projectionMatrix),Mt.multiplyScalar(1/Mt.w),Mt.x=ps/t.width,Mt.y=ps/t.height,Mt.applyMatrix4(a.projectionMatrixInverse),Mt.multiplyScalar(1/Mt.w),Math.abs(Math.max(Mt.x,Mt.y))}function ju(a,e){const t=a.matrixWorld,s=a.geometry,i=s.attributes.instanceStart,n=s.attributes.instanceEnd,r=Math.min(s.instanceCount,i.count);for(let o=0,l=r;o<l;o++){Ye.start.fromBufferAttribute(i,o),Ye.end.fromBufferAttribute(n,o),Ye.applyMatrix4(t);const h=new L,c=new L;zt.distanceSqToSegment(Ye.start,Ye.end,c,h),c.distanceTo(h)<ps*.5&&e.push({point:c,pointOnLine:h,distance:zt.origin.distanceTo(c),object:a,face:null,faceIndex:o,uv:null,uv1:null})}}function Hu(a,e,t){const s=e.projectionMatrix,i=a.material.resolution,n=a.matrixWorld,r=a.geometry,o=r.attributes.instanceStart,l=r.attributes.instanceEnd,h=Math.min(r.instanceCount,o.count),c=-e.near;zt.at(1,At),At.w=1,At.applyMatrix4(e.matrixWorldInverse),At.applyMatrix4(s),At.multiplyScalar(1/At.w),At.x*=i.x/2,At.y*=i.y/2,At.z=0,$n.copy(At),er.multiplyMatrices(e.matrixWorldInverse,n);for(let d=0,p=h;d<p;d++){if(We.fromBufferAttribute(o,d),Ge.fromBufferAttribute(l,d),We.w=1,Ge.w=1,We.applyMatrix4(er),Ge.applyMatrix4(er),We.z>c&&Ge.z>c)continue;if(We.z>c){const f=We.z-Ge.z,y=(We.z-c)/f;We.lerp(Ge,y)}else if(Ge.z>c){const f=Ge.z-We.z,y=(Ge.z-c)/f;Ge.lerp(We,y)}We.applyMatrix4(s),Ge.applyMatrix4(s),We.multiplyScalar(1/We.w),Ge.multiplyScalar(1/Ge.w),We.x*=i.x/2,We.y*=i.y/2,Ge.x*=i.x/2,Ge.y*=i.y/2,Ye.start.copy(We),Ye.start.z=0,Ye.end.copy(Ge),Ye.end.z=0;const u=Ye.closestPointToPointParameter($n,!0);Ye.at(u,sa);const g=ca.lerp(We.z,Ge.z,u),m=g>=-1&&g<=1,v=$n.distanceTo(sa)<ps*.5;if(m&&v){Ye.start.fromBufferAttribute(o,d),Ye.end.fromBufferAttribute(l,d),Ye.start.applyMatrix4(n),Ye.end.applyMatrix4(n);const f=new L,y=new L;zt.distanceSqToSegment(Ye.start,Ye.end,y,f),t.push({point:y,pointOnLine:f,distance:zt.origin.distanceTo(y),object:a,face:null,faceIndex:d,uv:null,uv1:null})}}}class al extends ie{constructor(e=new Wr,t=new Gr({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,s=e.attributes.instanceEnd,i=new Float32Array(2*t.count);for(let r=0,o=0,l=t.count;r<l;r++,o+=2)ea.fromBufferAttribute(t,r),ta.fromBufferAttribute(s,r),i[o]=o===0?0:i[o-1],i[o+1]=i[o]+ea.distanceTo(ta);const n=new nr(i,2,1);return e.setAttribute("instanceDistanceStart",new Ls(n,1,0)),e.setAttribute("instanceDistanceEnd",new Ls(n,1,1)),this}raycast(e,t){const s=this.material.worldUnits,i=e.camera;i===null&&!s&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const n=e.params.Line2!==void 0&&e.params.Line2.threshold||0;zt=e.ray;const r=this.matrixWorld,o=this.geometry,l=this.material;ps=l.linewidth+n,o.boundingSphere===null&&o.computeBoundingSphere(),sn.copy(o.boundingSphere).applyMatrix4(r);let h;if(s)h=ps*.5;else{const d=Math.max(i.near,sn.distanceToPoint(zt.origin));h=ia(i,d,l.resolution)}if(sn.radius+=h,zt.intersectsSphere(sn)===!1)return;o.boundingBox===null&&o.computeBoundingBox(),tn.copy(o.boundingBox).applyMatrix4(r);let c;if(s)c=ps*.5;else{const d=Math.max(i.near,tn.distanceToPoint(zt.origin));c=ia(i,d,l.resolution)}tn.expandByScalar(c),zt.intersectsBox(tn)!==!1&&(s?ju(this,t):Hu(this,i,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(Jn),this.material.uniforms.resolution.value.set(Jn.z,Jn.w))}}class Wu{constructor(e,t){S(this,"_components"),S(this,"_modelStyleGeometries",new be),S(this,"onDisposed",new K),S(this,"three",new yi),S(this,"plane"),S(this,"items",new be),S(this,"world",null),S(this,"_visible",!1),this._components=e,this.plane=t,this.setupEvents()}set visible(e){e?this.world&&(this.world.scene.three.add(this.three),this._visible=!0):(this.three.removeFromParent(),this._visible=!1)}get visible(){return this._visible}setupEvents(){const e=this._components.get(tr);this.items.guard=(t,{style:s})=>!!e.styles.get(s),this.items.onItemSet.add(({value:t})=>{const{style:s,data:i}=t;this.create(s,i)})}async getStyleMeshes(e,t){const s=this._components.get(tr).styles.get(t);if(!s)throw new Error(`ClipStyler: "${t}" style not found.`);const i=this._components.get(le),n=i.list.get(e);if(!n)throw new Error(`ClipEdges: model with id "${e}" not found.`);const{linesMaterial:r,fillsMaterial:o}=s;let l=this._modelStyleGeometries.get(e);l||(l=new be,this._modelStyleGeometries.set(e,l));let h=l.get(t);if(!h){let c;r&&(c=new al(new Wr,r),c.frustumCulled=!1,n&&i.applyBaseCoordinateSystem(c,await n.getCoordinationMatrix()),this.three.add(c));let d;o&&(d=new ie(new rt,o),n&&i.applyBaseCoordinateSystem(d,await n.getCoordinationMatrix()),this.three.add(d)),h={edges:c,fills:d},l.set(t,h)}return h}async updateMeshes(e,t,s){const i=this._components.get(le),n=i.list.get(e);if(!n)return;const r=this._components.get(It),o=this.plane.clone(),l=(await n.getCoordinationMatrix()).clone().multiply(i.baseCoordinationMatrix.clone().invert());o.applyMatrix4(l),o.constant-=.01;const h=await n.getSection(o,s),{buffer:c,index:d,fillsIndices:p}=h,u=await this.getStyleMeshes(e,t),{edges:g,fills:m}=u,v=new Rt(c,3,!1);if(g){v.setUsage(zl);const f=new rt;f.setAttribute("position",v),f.setDrawRange(0,d);const y=new aa(f);g.geometry.fromLineSegments(y),r.destroy(y)}m&&(m.geometry.attributes.position=v,m.geometry.setIndex(p))}async create(e,t){if(!this._components.get(tr).styles.get(e))throw new Error(`ClipEdges: "${e}" style not found.`);const s=this._components.get(Dc);let i=null;t&&(i=await s.find(t));const n=this._components.get(le);if(i)for(const[r,o]of Object.entries(i))n.list.get(r)&&this.updateMeshes(r,e,[...o]);else for(const[r]of n.list)this.updateMeshes(r,e)}async update(e){for(const[t,{data:s,style:i}]of this.items)e&&!e.includes(t)||this.create(i,s)}dispose(){this._components.get(It).destroy(this.three,!0,!0),this._modelStyleGeometries.clear()}}const ll=class Er extends xe{constructor(e){super(e),S(this,"onDisposed",new K),S(this,"enabled",!0),S(this,"world",null),S(this,"styles",new be),S(this,"list",new be),S(this,"_visible",!0),this.components.list.set(Er.uuid,this),this.setEvents()}get visible(){return this._visible}set visible(e){this._visible=e;for(const[,t]of this.list)t.visible=e}setEvents(){this.list.onBeforeDelete.add(({value:e})=>e.dispose())}setEdgesConfig(e,t){if(e.world=(t==null?void 0:t.world)??this.world,t!=null&&t.items)for(const[i,n]of Object.entries(t.items))e.items.set(i,n);const s=(t==null?void 0:t.id)??Ze.create();this.list.set(s,e)}create(e,t){const s=new Wu(this.components,e);return t&&this.setEdgesConfig(s,t),s}createFromView(e,t){const s=this.create(e.plane,t);return((t==null?void 0:t.link)===void 0||t.link)&&(e.onDisposed.add(()=>s.dispose()),e.onUpdated.add(()=>s.update()),e.onStateChanged.add(()=>s.visible=e.open)),s}createFromClipping(e,t){const s=this.components.get(Qt).list.get(e);if(!s)throw new Error(`ClipStyler: Clipping plane with ID ${e} not found.`);const i=this.create(s.three,t);return i.visible=!0,((t==null?void 0:t.link)===void 0||t.link)&&(s.onDraggingEnded.add(()=>i.update()),s.onDisposed.add(()=>i.dispose())),i}dispose(){this.styles.clear(),this.list.clear(),this.onDisposed.trigger(Er.uuid)}};S(ll,"uuid","24dfc306-a3c4-410f-8071-babc4afa5e4d");let tr=ll;const hl=class Sr extends xe{constructor(e){super(e),S(this,"onDisposed",new K),S(this,"onBeforeUpdate",new K),S(this,"onAfterUpdate",new K),S(this,"onSetup",new K),S(this,"isSetup",!1),S(this,"enabled",!0),S(this,"events",{}),S(this,"multiple","ctrlKey"),S(this,"zoomFactor",1.5),S(this,"zoomToSelection",!1),S(this,"backupColor",null),S(this,"selection",{}),S(this,"config",{selectName:"select",selectionColor:null,autoHighlightOnClick:!0,world:null,selectEnabled:!0,autoUpdateFragments:!0,selectMaterialDefinition:{color:new fe("#BCF124"),renderedFaces:oa.ONE,opacity:1,transparent:!1}}),S(this,"styles",new be),S(this,"autoToggle",new Set),S(this,"mouseDownPosition",{x:0,y:0}),S(this,"mouseMoveThreshold",5),S(this,"selectable",{}),S(this,"eventManager",new Tc),S(this,"_mouseState",{down:!1,moved:!1}),S(this,"_fromHighlight",!1),S(this,"restorePreviousColors",(t=this.selection.select)=>{for(const[s,i]of Object.entries(this.selection))if(!(s===this.config.selectName||!this.styles.get(s)))for(const[n,r]of Object.entries(t)){const o=i[n];if(!o)continue;const l=[...r].filter(h=>o.has(h));l.length!==0&&new Set(l)}}),S(this,"onMouseDown",t=>{this.enabled&&(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.mouseDownPosition={x:t.clientX,y:t.clientY},this._mouseState.down=!0)}),S(this,"debounceTimeout",null),S(this,"onMouseUp",async t=>{if(!this.enabled)return;const{world:s,autoHighlightOnClick:i,selectEnabled:n}=this.config;if(!s)throw new Error("No world found!");if(!s.renderer)throw new Error("This world doesn't have a renderer!");if(t.target===s.renderer.three.domElement){if(this._mouseState.down=!1,this._mouseState.moved||t.button!==0){this._mouseState.moved=!1;return}if(this._mouseState.moved=!1,i&&n){const r=this.multiple==="none"?!0:!t[this.multiple];await this.highlight(this.config.selectName,r,this.zoomToSelection)}}}),S(this,"onMouseMove",async t=>{if(!this.enabled)return;const s=t.clientX-this.mouseDownPosition.x,i=t.clientY-this.mouseDownPosition.y,n=Math.sqrt(s*s+i*i);this._mouseState.moved||n>this.mouseMoveThreshold&&(this._mouseState.moved=this._mouseState.down)}),this.components.add(Sr.uuid,this),this.eventManager.list.add(this.onSetup),this.eventManager.list.add(this.onDisposed),this.setStyleEvents()}setStyleEvents(){this.styles.onBeforeDelete.add(async({key:e})=>{if(await this.clear(e),delete this.selection[e],!(e in this.events))return;const{onClear:t,onHighlight:s,onBeforeHighlight:i}=this.events[e];this.eventManager.list.delete(t),this.eventManager.list.delete(s),this.eventManager.list.delete(i),delete this.events[e]}),this.styles.onItemSet.add(({key:e})=>{this.selection[e]={};const t=new K,s=new K,i=new K;this.events[e]={onHighlight:t,onClear:i,onBeforeHighlight:s},this.eventManager.add([i,t,s])})}async dispose(){this.setupEvents(!1),this.onBeforeUpdate.reset(),this.onAfterUpdate.reset(),this.selection={},this.styles.clear(),this.onDisposed.trigger(Sr.uuid),this.eventManager.reset(),this.isSetup=!1}add(e){if(console.warn("highlighter.add() is deprecated, use highlighter.styles.set() instead"),typeof e=="string")this.styles.set(e,null);else{const{customId:t}=e;this.styles.set(t,e)}}async remove(e){console.warn("highlighter.remove() is deprecated, use highlighter.styles.delete() instead"),this.styles.delete(e)}async highlight(e,t=!0,s=this.zoomToSelection,i=null){if(!this.enabled)return;if(!this.config.world)throw new Error("No world found in config!");const n=this.config.world;if(!this.selection[e])throw new Error(`Selection ${e} does not exist.`);const r=await this.components.get(et).get(n).castRay();if(!r||r.localId===void 0||r.localId===null){t&&this.clear(e);return}const{localId:o,fragments:{modelId:l}}=r,h={[l]:new Set([o])};await this.highlightByID(e,h,t,s,i,!0)}async highlightByID(e,t,s=!0,i=this.zoomToSelection,n=null,r=!1){var o;if(!this.enabled)return;this._fromHighlight=!0,this.events[e].onBeforeHighlight.trigger(this.selection[e]),s&&await this.clear(e);let l=ve.clone(t);const h=this.components.get(le);for(const[d,p]of Object.entries(t)){const u=h.list.get(d);u!=null&&u.isDeltaModel&&u.parentModelId&&ve.add(l,{[u.parentModelId]:p})}const c=(o=this.selectable)==null?void 0:o[e];if(c){const d=ve.clone(c);l=ve.intersect([l,d])}if(n){const d=ve.clone(n);for(const[p,u]of Object.entries(d)){const g=h.list.get(p);g!=null&&g.deltaModelId&&ve.add(d,{[g.deltaModelId]:u})}ve.remove(l,n)}if(r&&this.autoToggle.has(e)){const d={};let p=!1;for(const u in l){const g=this.selection[e][u];if(!g)continue;const m=l[u];for(const v of m)if(g.has(v)){g.delete(v);let f=d[u];f||(f=new Set,d[u]=f),f.add(v),p=!0}else g.add(v);l[u]=g}p&&(this.events[e].onClear.trigger(d),e===this.config.selectName&&this.restorePreviousColors(d))}this.updateStyleMap(e,l),this.events[e].onHighlight.trigger(this.selection[e]),this._fromHighlight=!1,await this.updateColors(),i&&await this.zoomSelection(l)}async updateColors(){const e=this.components.get(le),t=[e.resetHighlight()];for(const[s,i]of Object.entries(this.selection)){const n=this.styles.get(s);if(!n)continue;const r=s==="select"||!this.styles.get(this.config.selectName)?i:this.getMapWithoutSelection(s);r&&t.push(e.highlight({...n,customId:s},r))}this.config.autoUpdateFragments&&t.push(e.core.update(!0)),await Promise.allSettled(t)}updateStyleMap(e,t){const s=this.selection[e];for(const i in t){let n=s[i];n||(n=new Set,s[i]=n);const r=t[i];for(const o of r)n.add(o)}if(e!==this.config.selectName)for(const[i,n]of Object.entries(this.selection)){if(i===this.config.selectName||i===e)continue;const r=n;for(const[o,l]of Object.entries(s)){const h=r[o];if(h)for(const c of l)h.delete(c)}}}getMapWithoutSelection(e,t){const s=this.selection[e];if(!s)throw new Error(`Style ${e} does not exist.`);const i=this.selection[this.config.selectName]??{},n={};for(const r in s){const o=s[r],l=e===this.config.selectName?new Set:i[r]??new Set,h=Array.from(o).filter(c=>{var d;return!l.has(c)&&(!t||((d=t[r])==null?void 0:d.has(c)))});h.length>0&&(n[r]=new Set(h))}return Object.keys(n).length>0?n:null}async clear(e,t){const s=e?[e]:Object.keys(this.selection),i=t??void 0;for(const n of s){const r=this.selection[n]??{},o=i??r;n===this.config.selectName&&this.restorePreviousColors();const l={};for(const[h,c]of Object.entries(o)){const d=r[h];if(d)for(const p of c){if(!d.delete(p))continue;let u=l[h];u||(u=new Set,l[h]=u),u.add(p)}}Object.keys(l).length>0&&this.events[n].onClear.trigger(l),this.selection[n]={}}this._fromHighlight||await this.updateColors()}setup(e){if(this.isSetup)return;this.config={...this.config,...e};const{selectName:t,selectionColor:s,selectMaterialDefinition:i}=this.config;this.config.world&&this.components.get(et).get(this.config.world),i?(s&&(console.warn("highlighter.config.selectionColor is deprecated, use selectMaterialDefinition instead"),i.color=s),this.styles.set(t,i)):this.styles.set(t,null),this.autoToggle.add(this.config.selectName),this.setupEvents(!0),this.enabled=!0,this.isSetup=!0,this.onSetup.trigger(this)}async zoomSelection(e){if(!this.config.world)throw new Error("No world found in config!");const t=this.config.world;let s=!1;for(const m in e)if(e[m].size>0){s=!0;break}if(!s||!t.camera.hasCameraControls())return;const i=await this.components.get(le).getBBoxes(e),n=new fs,r=new Ue;for(const m of i)r.union(m);r.getBoundingSphere(n);const o=1/0,l=-1/0,{x:h,y:c,z:d}=n.center,p=n.radius===o||h===o||c===o||d===o,u=n.radius===l||h===l||c===l||d===l,g=n.radius===0;p||u||g||(n.radius*=this.zoomFactor,await t.camera.controls.fitToSphere(n,!0))}setupEvents(e){if(!this.config.world){console.log("No world found while setting up events!");return}if(this.config.world.isDisposing)return;if(!this.config.world.renderer)throw new Error("The given world doesn't have a renderer!");const t=this.config.world.renderer.three.domElement;t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("mouseup",this.onMouseUp),t.removeEventListener("pointermove",this.onMouseMove),e&&(t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("mouseup",this.onMouseUp),t.addEventListener("pointermove",this.onMouseMove))}};S(hl,"uuid","cb8a76f2-654a-4b50-80c6-66fd83cafd77");let sr=hl;const cl=class dl extends xe{constructor(){super(...arguments),S(this,"enabled",!0),S(this,"geometries",new be),S(this,"onDisposed",new K)}async get(e,t){const{material:s,applyTransformation:i}={applyTransformation:!0,...t},n=this.components.get(le),r=new be;for(const[o,l]of Object.entries(e)){const h=n.list.get(o);if(!h)continue;const c=this.getModelMeshes(o);for(const d of l){let p=r.get(o);p||(p=new be,r.set(o,p));let u=c.get(d);if(u&&u.length>0){const v=[];for(const[f,{geometry:y,transform:_}]of u.entries()){const x=await this.createMesh(h,y,_,{material:s,applyTransformation:i});v.push(x)}p.set(d,v);continue}else u=[],c.set(d,u);const[g]=await h.getItemsGeometry([d]);if(!g)continue;const m=[];for(const v of g){const f=this.createGeometry(v);if(!f)continue;const{geometry:y,transform:_}=f;u.push(f);const x=await this.createMesh(h,y,_,{material:s,applyTransformation:i});m.push(x)}p.set(d,m)}}return r}getModelMeshes(e){let t=this.geometries.get(e);return t||(t=new be,this.geometries.set(e,t)),t}remove(e=[...this.geometries.keys()]){for(const t of e){const s=this.geometries.get(t);if(s){for(const[i,n]of s)for(const{geometry:r}of n)r.dispose();this.geometries.delete(t)}}}dispose(e=!0){this.remove(),e&&this.geometries.dispose(),this.onDisposed.trigger(dl.uuid)}getMeshesFromResult(e){const t=[];for(const s of e.values())for(const i of s.values())t.push(...i);return t}createGeometry(e){const{positions:t,indices:s,normals:i,transform:n}=e;if(!(t&&s&&i))return null;const r=new rt;return r.setAttribute("position",new Rt(t,3)),r.setAttribute("normal",new Rt(i,3,!0)),r.setIndex(new Rt(s,1)),{geometry:r,transform:n}}async createMesh(e,t,s,i){const{material:n,applyTransformation:r}={applyTransformation:!0,...i},o=new ie(t,n);return o.applyMatrix4(s),o.applyMatrix4(e.object.matrixWorld),r||(o.position.set(0,0,0),o.rotation.set(0,0,0)),o}};S(cl,"uuid","ab45d0a7-feea-4afc-927c-80832dae76dd");let vn=cl;const Gu=class Cr extends xe{constructor(e){super(e),S(this,"_world"),S(this,"styles",new Le),S(this,"outlinePositions",!1),S(this,"_mesh",null),S(this,"onDisposed",new K),S(this,"_meshes",[]),S(this,"_map",{}),S(this,"_activeStyles",new Set),S(this,"_styleCallbacks",{}),e.add(Cr.uuid,this),this.setupEvents()}set world(e){this._world=e,e&&this.getRenderer().postproduction.excludedObjectsPass.addExcludedMaterial(this._points.material)}get world(){return this._world}get _points(){return this._mesh||(this._mesh=new Pl(new rt,new Al({size:10,sizeAttenuation:!1,depthTest:!1}))),this._mesh}get enabled(){return!this.world||this.world.isDisposing?!1:this.getRenderer().postproduction.outlinesEnabled}set enabled(e){if(!this.world||this.world.isDisposing)return;const t=this.getRenderer();t.postproduction.outlinesEnabled=e,this.outlinePositions&&(this._points.material.color=this.color,this.world.scene.three.add(this._points))}get color(){return this.getRenderer().postproduction.outlinePass.outlineColor}set color(e){this.getRenderer().postproduction.outlinePass.outlineColor.copy(e),this._points.material.color.copy(e)}get thickness(){return this.getRenderer().postproduction.outlinePass.thickness}set thickness(e){this.getRenderer().postproduction.outlinePass.thickness=e}get fillColor(){return this.getRenderer().postproduction.outlinePass.fillColor}set fillColor(e){this.getRenderer().postproduction.outlinePass.fillColor.copy(e)}get fillOpacity(){return this.getRenderer().postproduction.outlinePass.fillOpacity}set fillOpacity(e){const t=this.getRenderer().postproduction;t.outlinePass.fillOpacity=e}setupEvents(){const e=this.components.get(sr);this.styles.guard=t=>e.styles.has(t),this.styles.onItemAdded.add(t=>{const s=this.components.get(sr),i=()=>{this._activeStyles.add(t),this.updateFromStyles()},n=()=>{this._activeStyles.delete(t),this.updateFromStyles()};this._styleCallbacks[t]={onHighlight:i,onClear:n},s.events[t].onHighlight.add(i),s.events[t].onClear.add(n)}),this.styles.onBeforeDelete.add(t=>{const{onHighlight:s,onClear:i}=this._styleCallbacks[t];e.events[t].onHighlight.remove(s),e.events[t].onClear.remove(i),this._activeStyles.delete(t),delete this._styleCallbacks[t]}),e.styles.onItemDeleted.add(t=>this.styles.delete(t))}async updateFromStyles(){const e=this.components.get(sr),t=[];for(const i of this._activeStyles){const n=e.selection[i];n&&t.push(n)}const s=ve.join(t);this._map=s,await this.update()}async update(e=this._map){if(e===this._map&&this.cleanMeshes(),this.outlinePositions&&this.updatePoints(),Object.keys(e).length===0)return;const t=this.components.get(le),s=this.getRenderer().postproduction.outlinePass,i=await this.components.get(vn).get(e);for(const n of Object.keys(e)){const r=t.list.get(n),o=new Set(await(r==null?void 0:r.getItemsByVisibility(!1)));if(r){for(const[l,h]of i.entries())for(const[c,d]of h)if(!o.has(c))for(const p of d)this._meshes.push(p),s.scene.add(p)}}}async addItems(e){ve.add(this._map,e),await this.update(e)}async removeItems(e){ve.remove(this._map,e),await this.update()}clean(){this._map={},this._activeStyles.clear(),this.cleanMeshes(),this._mesh&&this.components.get(It).destroy(this._mesh,!0,!0),this._mesh=null}dispose(){this.styles.clear(),this.clean(),this.onDisposed.trigger(Cr.uuid)}cleanMeshes(){for(const e of this._meshes)e.removeFromParent();this._meshes=[]}async updatePoints(){let e=0;for(const[s,i]of Object.entries(this._map))e+=i.size;this._points.geometry.setAttribute("position",new es(new Float32Array(e*3),3));const t=await this.components.get(le).getPositions(this._map);for(let s=0;s<t.length;s++){const{x:i,y:n,z:r}=t[s];this._points.geometry.attributes.position.array[s*3]=i,this._points.geometry.attributes.position.array[s*3+1]=n,this._points.geometry.attributes.position.array[s*3+2]=r}this._points.geometry.attributes.position.needsUpdate=!0}getRenderer(){if(!this.world)throw new Error("You must set a world to use the outliner!");const e=this.world.renderer;if(!e.postproduction)throw new Error("The world given to the outliner must use the postproduction renderer.");return e}};S(Gu,"uuid","2fd3bcc5-b3b6-4ded-9f64-f47a02854a10");const ul=class pl extends xe{constructor(e){super(e),S(this,"onHoverStarted",new K),S(this,"onHoverEnded",new K),S(this,"HOVERER_OPACITY_KEY","_maxHoverOpacity"),S(this,"_hoverTimeout",null),S(this,"_meshes",new Le),S(this,"_localId",null),S(this,"_fadeAnimation",null),S(this,"_world",null),S(this,"_enabled",!1),S(this,"_material",new vs({color:16777215,transparent:!0,opacity:.5,depthTest:!1,userData:{[this.HOVERER_OPACITY_KEY]:.5}})),S(this,"onDisposed",new K),S(this,"duration",200),S(this,"animation",!0),S(this,"mouseStopTimeout",null),S(this,"onMouseMove",()=>{this.mouseStopTimeout!==null&&clearTimeout(this.mouseStopTimeout),this.mouseStopTimeout=window.setTimeout(()=>this.hover(),50)}),S(this,"onMouseLeave",()=>{this._meshes.clear()}),S(this,"animate",()=>{if(!(this._fadeAnimation&&this.animation&&this.material.transparent))return;const{startTime:t,duration:s,fadeIn:i}=this._fadeAnimation,n=Date.now()-t,r=Math.min(n/s,1),o=i?r:1-r,l=this.material.userData[this.HOVERER_OPACITY_KEY],h=o*(l!==void 0?l:1);this.material.opacity=h,r<1?requestAnimationFrame(this.animate):(i||this._meshes.clear(),this._fadeAnimation=null,this.onHoverEnded.trigger(this))}),e.add(pl.uuid,this),this._meshes.onBeforeDelete.add(t=>{t.removeFromParent(),t.geometry.dispose()}),this._meshes.onItemAdded.add(t=>{this.world&&this.world.scene.three.add(t)}),this._meshes.onCleared.add(()=>{this._localId=null,this._hoverTimeout&&(clearTimeout(this._hoverTimeout),this._hoverTimeout=null)})}set world(e){if(e){this.components.get(et).get(e),this._world=e,this.setupEvents(!0);for(const t of this._meshes)e.scene.three.add(t)}else{this.setupEvents(!1),this._world=null;for(const t of this._meshes)t.removeFromParent()}}get world(){return this._world}set enabled(e){this.setupEvents(e),this._enabled=e}get enabled(){return this._enabled}set material(e){e.userData[this.HOVERER_OPACITY_KEY]=e.opacity;for(const t of this._meshes)t.material=e;this._material.dispose(),this._material=e}get material(){return this._material}setupEvents(e){if(!this.world||this.world.isDisposing)return;if(!this.world.renderer)throw new Error("The given world doesn't have a renderer!");const t=this.world.renderer.three.domElement;t.removeEventListener("mousemove",this.onMouseMove),t.removeEventListener("mouseleave",this.onMouseMove),e&&(t.addEventListener("mousemove",this.onMouseMove),t.addEventListener("mouseleave",this.onMouseLeave))}async hover(){if(!this.enabled||!this.world)return;const e=await this.components.get(et).get(this.world).castRay();if(!e){this._meshes.clear();return}const{fragments:t,localId:s}=e;this._localId!==s&&(this._meshes.clear(),this._localId=s,this._hoverTimeout=window.setTimeout(async()=>{const i={[t.modelId]:new Set([s])},n=await this.components.get(vn).get(i);for(const[r,o]of n.entries()){const l=[...o.values()].flat();for(const h of l)h.material=this.material,this._meshes.add(h)}this._fadeAnimation={startTime:Date.now(),duration:this.duration,fadeIn:!0},this.onHoverStarted.trigger(this),this.animate()},100))}clear(){this._meshes.clear()}dispose(){this._enabled=!1,this._meshes.clear(),this._fadeAnimation=null,this._hoverTimeout=null,this.onHoverStarted.reset(),this.onHoverEnded.reset(),this.onDisposed.trigger()}};S(ul,"uuid","26fbd870-b1b2-4b71-b747-4063d484de1b");let Yu=ul;class Zu{constructor(e){S(this,"alignments",[]),S(this,"enabled",!0),S(this,"world",null),S(this,"_raycastable",[]),S(this,"_components"),this._components=e}update(){this.dispose();for(const e of this.alignments)for(const t of e.children){const s=t;s.updateWorldMatrix(!0,!0);for(const i of s.children){const n=i;if(n.isLine2&&n.userData.points){const r=new rt,o=new Dt;o.geometry.setIndex(n.geometry.index);const l=new Float32Array(n.userData.points),h=new Rt(l,3);r.setAttribute("position",h),o.geometry=r,o.userData.curve=n,o.applyMatrix4(n.matrixWorld),o.updateMatrixWorld(),this._raycastable.push(o)}}}}dispose(){for(const e of this._raycastable)e.geometry.dispose(),e.geometry=void 0;this._raycastable=[]}castRay(){if(!this.enabled||!this.world)return null;const e=this._components.get(et).get(this.world).castRayToObjects(this._raycastable);if(!e)return null;const t=e.object,s=t.geometry,i=e.index,n=s.attributes.position.array[i*3],r=s.attributes.position.array[i*3+1],o=s.attributes.position.array[i*3+2],l=s.attributes.position.array[i*3+3],h=s.attributes.position.array[i*3+4],c=s.attributes.position.array[i*3+5],d=new L(l-n,h-r,c-o).normalize();return{point:e.point,normal:d,curve:t.userData.curve,alignment:t.userData.curve.parent}}}class ir{static alignmentPercentageToPoint(e,t){const s=new L,i=new L,n=this.alignmentLength(e),r=t*n;let o=0;if(e.updateWorldMatrix(!0,!0),t===1)for(let l=e.children.length-1;l>=0;l--){const h=e.children[l],c=h.userData.points;if(!c)continue;const d=new L(c[c.length-3],c[c.length-2],c[c.length-1]);return d.applyMatrix4(h.matrixWorld),{normal:new L,point:d,curve:h,alignment:e}}for(const l of e.children){const h=l.userData.points;if(h)for(let c=0;c<h.length-3;c+=3){const d=s.set(h[c],h[c+1],h[c+2]),p=i.set(h[c+3],h[c+4],h[c+5]),u=d.distanceTo(p);if(o+u>=r){const g=r-o,m=p.clone().sub(d).normalize(),v=m.clone().multiplyScalar(g);return d.add(v),d.applyMatrix4(l.matrixWorld),{normal:m,point:d,curve:l,alignment:e}}o+=u}}return null}static curvePercentageToPoint(e,t,s){const i=new L,n=new L,r=this.curveLength(t),o=s*r;let l=0;const h=t.userData.points;if(!h)throw new Error("No points found in curve");for(let c=0;c<h.length-3;c+=3){const d=i.set(h[c],h[c+1],h[c+2]),p=n.set(h[c+3],h[c+4],h[c+5]),u=d.distanceTo(p);if(l+u>=o){const g=o-l,m=p.clone().sub(d).normalize(),v=m.clone().multiplyScalar(g);return d.add(v),{normal:m,point:d,curve:t,alignment:e}}l+=u}return null}static alignmentLength(e){let t=0;if(e.userData.length!==void 0)return e.userData.length;for(const s of e.children)"isLine2"in s&&(t+=this.curveLength(s));return e.userData.length=t,t}static curveLength(e){let t=0;if(e.userData.length!==void 0)return e.userData.length;const s=new L,i=new L,n=e.userData.points;if(!n)throw new Error("No points found in curve");for(let r=0;r<n.length-2-3;r+=3){const o=s.set(n[r],n[r+1],n[r+2]),l=i.set(n[r+3],n[r+4],n[r+5]);t+=o.distanceTo(l)}return e.userData.length=t,t}static curvePointToAlignmentPercentage(e,t,s){const i=new L,n=new L,r=this.alignmentLength(e);let o=0;e.updateWorldMatrix(!0,!0);for(const l of e.children){const h=l.userData.points;if(h)for(let c=0;c<h.length-3;c+=3){const d=i.set(h[c],h[c+1],h[c+2]),p=n.set(h[c+3],h[c+4],h[c+5]);d.applyMatrix4(l.matrixWorld),p.applyMatrix4(l.matrixWorld);const u=d.distanceTo(p),g=d.distanceTo(t)<.001,m=p.distanceTo(t)<.001,v=this.isPointbetweenTwoOthers(d,p,t);if(l===s&&(g||m||v)){const f=d.distanceTo(t);return(o+f)/r}o+=u}}return null}static isPointbetweenTwoOthers(e,t,s){const i=new L;i.subVectors(t,e).normalize();const n=new L;n.subVectors(s,e).normalize();const r=new L;r.subVectors(s,t).normalize();const o=1-.0016;return i.dot(n)>o&&i.dot(r)<-.9984}}class Xu{constructor(e,t){S(this,"onDisposed",new K),S(this,"alignments",[]),S(this,"components"),S(this,"onMarkerChange",new K),S(this,"enabled",!0),S(this,"highlightMaterial"),S(this,"increments",20),S(this,"screenDistanceLimit",.1),S(this,"fadeInTime",500),S(this,"_mouseMarkers"),S(this,"_highlighted",new Set),S(this,"_stationPoints",new Map),S(this,"_originalHighlightMaterialId","originalHighlightMaterial"),S(this,"_world",null),S(this,"_raycaster"),S(this,"_stationLabelColor",new fe(16777215)),S(this,"_stationLabelBackgroundColor",new fe(8014801)),S(this,"_stationPointerColor",new fe(16777215)),S(this,"_stationPointerBackgroundColor",new fe(4803766)),S(this,"_pointerDown",performance.now()),S(this,"_pointerDownTime",150),S(this,"onPointerDown",()=>{this._pointerDown=performance.now()}),S(this,"onPointerUp",()=>{if(performance.now()-this._pointerDown>this._pointerDownTime)return;const s=this.setMarkerToMouse("select");s&&this.onMarkerChange.trigger(s)}),S(this,"onMouseMove",()=>{this.setMarkerToMouse("hover")}),this.components=e,this.highlightMaterial=t,this._raycaster=new Zu(e),this._raycaster.alignments=this.alignments}get world(){return this._world}set world(e){var t,s,i,n;if(e===this._world||(this._world&&this.setupEvents(!1),this._world=e,(t=this._mouseMarkers)==null||t.hover.removeFromParent(),(s=this._mouseMarkers)==null||s.select.removeFromParent(),(i=this._mouseMarkers)==null||i.hover.element.remove(),(n=this._mouseMarkers)==null||n.select.element.remove(),!e))return;this._raycaster.world=e;const r=this.newCivilLabel(0,"stationPointer");e.scene.three.add(r),r.visible=!1,r.element.style.transition="";const o=this.newCivilLabel(0,"stationPointer");o.element.style.transition="",o.element.style.opacity="0.5",e.scene.three.add(o),o.visible=!1,this._mouseMarkers={select:r,hover:o},this.setupEvents(!0)}get stationLabelColor(){return this._stationLabelColor}set stationLabelColor(e){this._stationLabelColor=e;const t=`#${e.getHexString()}`;for(const[,{labels:s}]of this._stationPoints){const i=[...s.children];for(const n of i){const r=this.getLabel(n);r.style.color=t;const o=this.getPoint(n);o.style.backgroundColor=t}}}get stationLabelBackgroundColor(){return this._stationLabelBackgroundColor}set stationLabelBackgroundColor(e){this._stationLabelBackgroundColor=e;const t=`#${e.getHexString()}`;for(const[,{labels:s}]of this._stationPoints){const i=[...s.children];for(const n of i){const r=this.getLabel(n);r.style.backgroundColor=t;const o=this.getPoint(n);o.style.border=`2px solid ${t}`}}}get stationPointerColor(){return this._stationPointerColor}set stationPointerColor(e){this._stationPointerColor=e;const t=`#${e.getHexString()}`;if(this._mouseMarkers){const s=this._mouseMarkers.select,i=this.getLabel(s);i.style.color=t;const n=this.getPoint(s);n.style.backgroundColor=t}}get stationPointerBackgroundColor(){return this._stationPointerBackgroundColor}set stationPointerBackgroundColor(e){this._stationPointerBackgroundColor=e;const t=`#${e.getHexString()}`;if(this._mouseMarkers){const s=this._mouseMarkers.select,i=this.getLabel(s);i.style.backgroundColor=t;const n=this.getPoint(s);n.style.border=`2px solid ${t}`}}dispose(){var e,t,s,i;this.clearHighlight(),this.clearStations(),this.alignments=[],(e=this._mouseMarkers)==null||e.hover.removeFromParent(),(t=this._mouseMarkers)==null||t.select.removeFromParent(),(s=this._mouseMarkers)==null||s.hover.element.remove(),(i=this._mouseMarkers)==null||i.select.element.remove(),this._raycaster.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}updateAlignments(){this._raycaster.update()}setMarkerAtPoint(e,t){if(!this._mouseMarkers)throw new Error("No mouse markers found! Initialize the world before using this.");this.updateMarkerValue(e,t),this._mouseMarkers[t].visible=!0,this._mouseMarkers[t].position.copy(e.point)}highlight(e,t=!0){t&&this.clearHighlight(this._highlighted);for(const s of e.children)"isLineSegments2"in s&&"material"in s&&(s.userData[this._originalHighlightMaterialId]=s.material,s.material=this.highlightMaterial);this._highlighted.add(e)}clearHighlight(e=this._highlighted){for(const t of e)for(const s of t.children)"isLineSegments2"in s&&"material"in s&&(s.material=s.userData[this._originalHighlightMaterialId],delete s.userData[this._originalHighlightMaterialId]);this._highlighted.clear()}createStations(e){if(!this.world||this._stationPoints.has(e.uuid))return;const t=new yi;this.world.scene.three.add(t),this._stationPoints.set(e.uuid,{alignment:e,labels:t})}clearStations(e=this._stationPoints.keys()){for(const t of e){const s=this._stationPoints.get(t);s&&(this.clearLabels(s.labels),this._stationPoints.delete(t))}}updateStations(){if(!this.world)throw new Error("No world found!");if(!this.world.renderer)throw new Error("No renderer found!");const e=this.world.camera.three,t=this.world.renderer.three,s=new kl,i=t.clippingPlanes,n=new L,r=new L;let o=!0;const l=new L;for(const[,{alignment:h,labels:c}]of this._stationPoints){this.clearLabels(c),h.updateWorldMatrix(!0,!0);const d=h.userData.initialStation;let p=d||0;const u=p%this.increments;let g=d+this.increments-u;for(const m of h.children){if(!("isLine2"in m))continue;const v=m;if(v.geometry.boundingBox||v.geometry.computeBoundingBox(),s.setFromProjectionMatrix(new Pe().multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),!s.intersectsBox(v.geometry.boundingBox)){const I=ir.curveLength(m);p+=I;const R=p%this.increments;g=p+this.increments-R;continue}const f=m.userData.points,y=f[0],_=f[1],x=f[2];if(l.set(y,_,x),l.applyMatrix4(m.matrixWorld),!this.isLabelClipped(i,l)){if(o){o=!1,n.set(l.x,l.y,l.z),n.project(e),n.z=0;const I=this.newCivilLabel(p,"stationLabel");I.position.set(l.x,l.y,l.z),c.children.push(I)}else if(r.set(l.x,l.y,l.z),r.project(e),r.z=0,n.distanceTo(r)>this.screenDistanceLimit){const I=this.newCivilLabel(p,"stationLabel");I.position.set(l.x,l.y,l.z),c.children.push(I),n.copy(r)}}const C=new L,P=new L;for(let I=0;I<f.length-3;I+=3){C.set(f[I],f[I+1],f[I+2]),P.set(f[I+3],f[I+4],f[I+5]);const R=C.distanceTo(P),T=p+R,z=P.clone().sub(C).normalize();for(;T>g;){const b=g-p,B=z.clone();B.multiplyScalar(b);const{x:q,y:G,z:te}=C.clone().add(B);if(l.set(q,G,te),l.applyMatrix4(m.matrixWorld),!this.isLabelClipped(i,l)&&s.containsPoint(l)&&(r.set(l.x,l.y,l.z),r.project(e),r.z=0,n.distanceTo(r)>this.screenDistanceLimit)){const W=this.newCivilLabel(g,"stationLabel");W.position.set(l.x,l.y,l.z),c.children.push(W),n.copy(r)}g+=this.increments}p+=R}const A=f[f.length-3],k=f[f.length-2],M=f[f.length-1];if(l.set(A,k,M),l.applyMatrix4(m.matrixWorld),!(this.isLabelClipped(i,l)||!s.containsPoint(l))&&(r.set(l.x,l.y,l.z),r.project(e),r.z=0,n.distanceTo(r)>this.screenDistanceLimit)){const I=this.newCivilLabel(p,"stationLabel");I.position.set(l.x,l.y,l.z),c.children.push(I),n.copy(r)}}}}getCursorValue(){if(!this._mouseMarkers)throw new Error("No mouse markers found! Initialize the world before using this.");return this._mouseMarkers.select.element.children[0].children[0].innerText}setCursorValue(e,t){if(!this._mouseMarkers)throw new Error("No mouse markers found! Initialize the world before using this.");const s=this._mouseMarkers[t].element.children[0].children[0];s.innerText=e}isLabelClipped(e,t){for(const s of e)if(!(s.distanceToPoint(t)>0))return!0;return!1}clearLabels(e){const t=[...e.children];for(const s of t)s.element.style.opacity="0";setTimeout(()=>{for(const s of t)s.removeFromParent(),s.element.remove(),s.visible=!1},this.fadeInTime)}newCivilLabel(e,t){const s=document.createElement("div"),i=t==="stationLabel"?this.stationLabelColor:this.stationPointerColor,n=t==="stationLabel"?this.stationLabelBackgroundColor:this.stationPointerBackgroundColor,r=document.createElement("div");r.style.width="4px",r.style.height="4px",r.style.borderRadius="50%",r.style.backgroundColor=`#${i.getHexString()}`,r.style.border=`2px solid #${n.getHexString()}`,r.style.display="flex",r.style.justifyContent="center";const o=this.getFormattedStation(e),l=document.createElement("div");l.innerText=o,l.style.backgroundColor=`#${n.getHexString()}`,l.style.color=`#${i.getHexString()}`,l.style.padding="0.3rem",l.style.position="absolute",l.style.bottom="1rem",l.style.borderRadius="6px",l.style.boxShadow="rgba(0, 0, 0, 0.6) 0px 4px 6px",r.appendChild(l);const h=new rl(s);return s.appendChild(r),t==="stationLabel"&&(s.style.transition=`opacity ${this.fadeInTime}ms ease-in-out`,s.style.opacity="0",setTimeout(()=>{s.style.opacity="1"})),h}setupEvents(e){if(!this.world)throw new Error("No world found!");if(this.world.isDisposing||!this.world.renderer)return;const t=this.world.renderer.three.domElement,s=this.components.get(et).get(this.world);s.three.params.Line||(s.three.params.Line={threshold:10}),t.removeEventListener("pointerdown",this.onPointerDown),t.removeEventListener("pointerup",this.onPointerUp),t.removeEventListener("pointermove",this.onMouseMove),e&&(t.addEventListener("pointerdown",this.onPointerDown),t.addEventListener("pointerup",this.onPointerUp),t.addEventListener("pointermove",this.onMouseMove))}setMarkerToMouse(e){if(!this.enabled||!this._mouseMarkers)return null;if(!this.world)throw new Error("No world found!");const t=this._raycaster.castRay();if(!t)return this._mouseMarkers[e].visible=!1,null;this._mouseMarkers[e].visible=!0;const s=t.point;return this._mouseMarkers[e].position.copy(s),this.updateMarkerValue(t,e),t}updateMarkerValue(e,t){if(!this._mouseMarkers)return;const{alignment:s,curve:i,point:n}=e,r=ir.curvePointToAlignmentPercentage(s,n,i);if(r===null)throw new Error("Point is not on the curve");const o=r*ir.alignmentLength(s)+s.userData.initialStation,l=this.getFormattedStation(o);this.setCursorValue(l,t)}getFormattedStation(e){const t=Math.floor(e/1e3),s=Math.round(e-t*1e3);return`${t}+${s}`}getLabel(e){return e.element.children[0].children[0]}getPoint(e){return e.element.children[0]}}const qu=class fl extends xe{constructor(e){super(e),S(this,"onDisposed",new K),S(this,"list",new Map),S(this,"enabled",!0),S(this,"highlightMaterial",new Gr({color:8014801,linewidth:5,depthTest:!1})),S(this,"_increments",20),S(this,"_screenDistanceLimit",.1),S(this,"_fadeInTime",500),S(this,"_stationLabelColor",new fe(16777215)),S(this,"_stationLabelBackgroundColor",new fe(8014801)),S(this,"_stationPointerColor",new fe(16777215)),S(this,"_stationPointerBackgroundColor",new fe(4803766)),this.components.add(fl.uuid,this)}get increments(){return this._increments}set increments(e){this._increments=e;for(const[,t]of this.list)t.increments=e}get screenDistanceLimit(){return this._screenDistanceLimit}set screenDistanceLimit(e){this._screenDistanceLimit=e;for(const[,t]of this.list)t.screenDistanceLimit=e}get fadeInTime(){return this._fadeInTime}set fadeInTime(e){this._fadeInTime=e;for(const[,t]of this.list)t.fadeInTime=e}get stationLabelColor(){return this._stationLabelColor}set stationLabelColor(e){this._stationLabelColor=e;for(const[,t]of this.list)t.stationLabelColor=e}get stationLabelBackgroundColor(){return this._stationLabelBackgroundColor}set stationLabelBackgroundColor(e){this._stationLabelBackgroundColor=e;for(const[,t]of this.list)t.stationLabelBackgroundColor=e}get stationPointerColor(){return this._stationPointerColor}set stationPointerColor(e){this._stationPointerColor=e;for(const[,t]of this.list)t.stationPointerColor=e}get stationPointerBackgroundColor(){return this._stationPointerBackgroundColor}set stationPointerBackgroundColor(e){this._stationPointerBackgroundColor=e;for(const[,t]of this.list)t.stationPointerBackgroundColor=e}create(e){const t=new Xu(this.components,this.highlightMaterial);return this.list.set(e,t),t}delete(e){const t=this.list.get(e);t&&(t.dispose(),this.list.delete(e))}dispose(){for(const[,e]of this.list)e.dispose();this.onDisposed.trigger(),this.onDisposed.reset()}updateAlignments(){for(const[,e]of this.list)e.updateAlignments()}};S(qu,"uuid","0a59c09e-2b49-474a-9320-99f51f40f182");const Qu=class ml extends xe{constructor(e){super(e),S(this,"enabled",!0),S(this,"onDisposed",new K),S(this,"_world",null),S(this,"_flip",!1),S(this,"_plane"),S(this,"_point",new L),S(this,"_edgeMeshes",[]),S(this,"_sectionVisible",!1),S(this,"_sectionOffset",.1),S(this,"edgeMaterial",new Gr({color:0,linewidth:5,depthTest:!1})),this.components.add(ml.uuid,this)}get plane(){if(!this._plane)throw new Error("Plane is not set. You must give a world.");return this._plane}set plane(e){this._plane=e}get sectionVisible(){return this._sectionVisible}set sectionVisible(e){this._sectionVisible=e;for(const t of this._edgeMeshes)t.visible=e}get world(){return this._world}set world(e){var t;if(this._world=e,(t=this._plane)==null||t.dispose(),!e)return;const s=this.components.get(Qt),i=s.createFromNormalAndCoplanarPoint(e,new L(1,0,0),new L);this.plane=s.list.get(i),this.plane.visible=!1,this.plane.enabled=!1}get flip(){return this._flip}set flip(e){var t;if(e===this._flip)return;this._flip=e;const s=(t=this.plane)==null?void 0:t.normal.clone().multiplyScalar(-1);for(const i of this._edgeMeshes)i.position.add(s.clone().multiplyScalar(this._sectionOffset));this.plane.setFromNormalAndCoplanarPoint(s,this._point),this.plane.update()}dispose(){var e;this.clearMeshes(),(e=this.plane)==null||e.dispose(),this.onDisposed.trigger(),this.onDisposed.reset()}async set(e,t){this.flip&&t.multiplyScalar(-1),this.plane.setFromNormalAndCoplanarPoint(t,e),this._point.copy(e)}async update(){this.clearMeshes();const e=this.components.get(le);this.plane.update();const t=[];for(const[,s]of e.list)t.push(this.generateModelSection(s));await Promise.all(t)}async generateModelSection(e){if(!this.world)return;const t=this.plane.three.clone();t.constant-=.01;const{buffer:s}=await e.getSection(t),i=new rt,n=new Rt(s,3,!1);i.setAttribute("position",n);const r=new aa(i),o=new Wr;o.fromLineSegments(r);const l=new al(o,this.edgeMaterial);l.frustumCulled=!1,this.world.scene.three.add(l),this._edgeMeshes.push(l),l.renderOrder=3,r.geometry.dispose()}clearMeshes(){for(const e of this._edgeMeshes)e.removeFromParent(),e.geometry.dispose(),e.material=void 0;this._edgeMeshes=[]}};S(Qu,"uuid","96b2c87e-d90b-4639-8257-8f01136fe324");const Is=class Ot{constructor(e){S(this,"onDisposed",new K),S(this,"marker",null),S(this,"world",null),S(this,"mode",0),S(this,"maxDistance",1),S(this,"_enabled",!1),S(this,"_components"),S(this,"_preview",document.createElement("div")),S(this,"_pointerVisible",!1),S(this,"_intersectionFound",!1),this._components=e;for(const t in Ot.baseSnappingStyle){const s=Ot.baseSnappingStyle[t];this._preview.style[t]=s}this._preview.style.zIndex="999",this._preview.style.pointerEvents="none",this._preview.style.position="fixed",this._preview.style.top="0",this._preview.style.left="0"}set enabled(e){this._enabled=e,this.marker&&(this.marker.visible=e),e&&this.get()}get enabled(){return this._enabled}dispose(){this.marker&&this.marker.dispose()}async get(e){return this.mode===1?this.getSynchronous(e):this.getDefault(e)}async getSynchronous(e){const t=(e==null?void 0:e.world)??this.world;if(!t)throw new Error("GraphicVertexPicker: a world is need to get a casting result.");const s=this._components.get(et).get(t);let i=null;if(this.mode===0?i=await s.castRay({snappingClasses:e==null?void 0:e.snappingClasses}):this.mode===1&&(i=await s.castRayToObjects()),this._intersectionFound=!!i,i){const{point:n}=i;if(!this.marker){const r=document.createElement("div");this.marker=new Jt(t,r)}if(this.marker.world!==t&&(this.marker.world=t,this.marker.three.removeFromParent(),t.scene.three.add(this.marker.three)),this.hidePointer(),this.marker.visible=!0,!!(e!=null&&e.snappingClasses)){const r=(e==null?void 0:e.snappingClasses)||[];let o=it.FACE;r.includes(it.POINT)?o=it.POINT:r.includes(it.LINE)&&(o=it.LINE);let l=!1;if(o!==it.FACE&&(l=this.applySnapping(i,o)),!l)Object.assign(this.marker.three.element.style,Ot.baseSnappingStyle);else{const h=Ot.snappingStyles[o]??Ot.baseSnappingStyle;Object.assign(this.marker.three.element.style,h)}this.marker.three.position.copy(n)}else Object.assign(this.marker.three.element.style,Ot.baseSnappingStyle)}else this.marker&&(this.marker.visible=!1);return i}async getDefault(e){const t=(e==null?void 0:e.world)??this.world;if(!t)throw new Error("GraphicVertexPicker: a world is need to get a casting result.");const s=await this._components.get(et).get(t).castRay({snappingClasses:e==null?void 0:e.snappingClasses});if(this._intersectionFound=!!s,s){const{point:i}=s;if(!this.marker){const n=document.createElement("div");this.marker=new Jt(t,n)}if(this.marker.world!==t&&(this.marker.world=t,this.marker.three.removeFromParent(),t.scene.three.add(this.marker.three)),this.hidePointer(),this.marker.visible=!0,this.marker.three.position.copy(i),"snappingClass"in s&&typeof s.snappingClass=="number"&&(s.snappingClass===0||s.snappingClass===1||s.snappingClass===2)){const n=Ot.snappingStyles[s.snappingClass]??Ot.baseSnappingStyle;Object.assign(this.marker.three.element.style,n)}else Object.assign(this.marker.three.element.style,Ot.baseSnappingStyle)}else this.marker&&(this.marker.visible=!1);return s}updatePointer(){if(!this.world||!this.marker)return;if(this.mode===1&&this._intersectionFound){this.hidePointer();return}this.showPointer(),this.marker.visible&&(this.marker.visible=!1);const e=this._components.get(et).get(this.world).mouse.rawPosition;this._preview.style.transform=`translate(-50%, -50%) translate(${e.x}px, ${e.y}px)`}showPointer(){var e;!this.world||this._pointerVisible||(this._pointerVisible=!0,(e=this.world.renderer.three.domElement.parentElement)==null||e.appendChild(this._preview))}hidePointer(){var e;!this.world||!this._pointerVisible||(this._pointerVisible=!1,(e=this.world.renderer.three.domElement.parentElement)==null||e.removeChild(this._preview))}applySnapping(e,t){if(t===it.FACE)return!0;const s=e.object;if(!e.face||!s||!s.geometry||!s.geometry.index||!s.geometry.attributes||!s.geometry.attributes.position)return!1;const i=e.object.matrixWorld,n=s.geometry.attributes.position.array,r=e.point,o=e.face.a,l=e.face.b,h=e.face.c,c=new L(n[o*3],n[o*3+1],n[o*3+2]).applyMatrix4(i),d=new L(n[l*3],n[l*3+1],n[l*3+2]).applyMatrix4(i),p=new L(n[h*3],n[h*3+1],n[h*3+2]).applyMatrix4(i);if(e.facePoints=[c.x,c.y,c.z,d.x,d.y,d.z,p.x,p.y,p.z],t===it.LINE){const y=[[c,d],[d,p],[p,c]],_=new L,x=new L,C=new lt;let P=Number.MAX_SAFE_INTEGER,A=!1;const k=this.maxDistance*this.maxDistance;for(const[M,I]of y){C.set(M,I),C.closestPointToPoint(r,!0,_);const R=r.distanceToSquared(_);R<k&&R<P&&(e.snappedEdgeP1=M,e.snappedEdgeP2=I,P=R,x.copy(_),A=!0)}return A?(e.point.copy(x),!0):!1}const u=[c,d,p],g=new L;let m=Number.MAX_SAFE_INTEGER,v=!1;const f=this.maxDistance*this.maxDistance;for(let y=0;y<u.length;y++){const _=u[y],x=r.distanceToSquared(_);x<f&&x<m&&(m=x,g.copy(_),v=!0)}return v?(e.point.copy(g),!0):!1}};S(Is,"baseSnappingStyle",{height:"6px",width:"6px",borderRadius:"100%",borderWidth:"2px",borderColor:"rgb(122, 75, 209)",borderStyle:"solid",zIndex:"-20"}),S(Is,"snappingStyles",{[it.FACE]:{...Is.baseSnappingStyle},[it.POINT]:{...Is.baseSnappingStyle,borderColor:"#e25959",borderRadius:"0"},[it.LINE]:{...Is.baseSnappingStyle,borderColor:"#2d2d2d",borderRadius:"0"}});let Ku=Is;function gl(){const a=document.createElement("div");return a.style.backgroundColor="blue",a.style.color="white",a.style.padding="6px",a.style.borderRadius="6px",a.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.6)",a.style.zIndex="-10",a}function Ju(a={}){const{color:e="white",size:t="4px",border:s="2px solid blue",background:i="white"}=a,n=document.createElement("div");return n.style.backgroundColor=i,n.style.color=e,n.style.height=t,n.style.width=t,n.style.borderRadius="50%",n.style.border=s,n.style.zIndex="-20",n}class $t extends lt{constructor(){super(...arguments),S(this,"id",Ze.create()),S(this,"_units","m"),S(this,"_rounding",2)}set units(e){this._units=e}get units(){return this._units}set rounding(e){this._rounding=e}get rounding(){return this._rounding}get value(){const e=this.distance();return Rs.convertUnits(e,"m",this.units,this.rounding)}}class yn{constructor(e,t,s,i=2,n="m"){S(this,"label"),S(this,"boundingBox",new ie),S(this,"world"),S(this,"_components"),S(this,"_units","m"),S(this,"_rounding",2),S(this,"startNormal",null),S(this,"line"),S(this,"rectangleComponentLines",[]),S(this,"projectionComponentLines",[]),S(this,"_visible",!0),S(this,"_root",new yi),S(this,"_endpoints",new Le),S(this,"lineElement"),S(this,"rectangleDimensions",new Le),S(this,"projectionDimensions",new Le),S(this,"isSelected",!1),S(this,"_latestRectangularInversion",!1),S(this,"_endpointElement",Ju()),S(this,"_material"),S(this,"_componentsMaterial",new Ul({depthTest:!1,gapSize:.2,dashSize:.2,transparent:!0,opacity:.5,color:3026478})),S(this,"valueFormatter",null),this._components=e,this.world=t,this._material=s.lineMaterial,this._rounding=i,this._units=n,this.line=s.line,this.startNormal=s.startNormal??null,this.rectangleComponentLines=[new $t,new $t],this.updateRectangleComponents(),this.updateProjectionComponents(),this.lineElement=this.createLine(s),this._endpoints.onItemAdded.add(r=>{this._root.add(r.three);const o=this._endpoints.size===1?this.line.start:this.line.end;r.three.position.copy(o)}),this._endpoints.onBeforeDelete.add(r=>r.dispose()),this.createEndpoints();for(const r of this._endpoints)r.three.element.style.borderColor=`#${s.lineMaterial.color.getHexString()}`;this.label=this.newText(),this.label.three.element.style.backgroundColor=`#${s.lineMaterial.color.getHexString()}`,this.label.three.renderOrder=1,this._root.renderOrder=2,this.world.scene.three.add(this._root),this.setupEvents()}set units(e){for(const t of this.rectangleDimensions)t.units=e;for(const t of this.projectionDimensions)t.units=e;this._units=e,this.updateLabel()}get units(){return this._units}set rounding(e){for(const t of this.rectangleDimensions)t.rounding=e;for(const t of this.projectionDimensions)t.rounding=e;this._rounding=e,this.updateLabel()}get rounding(){return this._rounding}get visible(){return this._visible}set visible(e){for(const o of this.rectangleDimensions)o.visible=e;for(const o of this.projectionDimensions)o.visible=e;this._visible=e,this.label.visible=e;for(const o of this._endpoints)o.visible=e;const[t,s]=this._endpoints,i=t.three,n=s.three,r=this.label.three;e?(this.world.scene.three.add(this._root),this._root.add(r,i,n)):(r.removeFromParent(),i.removeFromParent(),n.removeFromParent(),this._root.removeFromParent())}set end(e){this.line.end=e;const t=this.lineElement.geometry.attributes.position;t.setXYZ(1,e.x,e.y,e.z),t.needsUpdate=!0,this.update()}set start(e){this.line.start=e;const t=this.lineElement.geometry.attributes.position;t.setXYZ(0,e.x,e.y,e.z),t.needsUpdate=!0,this.update()}applyPlanesVisibility(e){for(const t of this._endpoints){if(!t.wasVisible)continue;let s=!1;for(const i of e)if(i.distanceToPoint(t.three.position)<0){s=!0;break}t.three.visible=!s}if(this.label.wasVisible){let t=!1;const s=this.label.three.position;for(const i of e)if(i.distanceToPoint(s)<0){t=!0;break}this.label.three.visible=!t}for(const t of this.rectangleDimensions)t.applyPlanesVisibility(e);for(const t of this.projectionDimensions)t.applyPlanesVisibility(e)}setupEvents(){this.rectangleDimensions.onBeforeDelete.add(e=>e.dispose()),this.projectionDimensions.onBeforeDelete.add(e=>e.dispose())}dispose(){this.visible=!1;const e=this._components.get(It);e.destroy(this._root),e.destroy(this.lineElement),this._endpoints.clear(),this.label.dispose(),this.boundingBox&&e.destroy(this.boundingBox),this.rectangleDimensions.clear(),this.projectionDimensions.clear(),this._components=null}createBoundingBox(){const e=new L;this.line.getCenter(e);const t=this.line.distance();this.boundingBox.geometry=new qe(1,1,t),this.boundingBox.position.copy(e),this.boundingBox.lookAt(this.line.end),this.boundingBox.visible=!1,this._root.add(this.boundingBox)}invertRectangularDimensions(){this.rectangleDimensions.size!==0&&(this.rectangleDimensions.clear(),this._latestRectangularInversion=!this._latestRectangularInversion,this.updateRectangleComponents(this._latestRectangularInversion),this.displayRectangularDimensions())}displayRectangularDimensions(){this.rectangleDimensions.clear();for(const e of this.rectangleComponentLines){const t=new yn(this._components,this.world,{line:e,lineMaterial:this._componentsMaterial,endpointElement:this.endpointElement});t.lineElement.computeLineDistances(),this.rectangleDimensions.add(t)}}displayProjectionDimensions(){this.projectionDimensions.clear();for(const e of this.projectionComponentLines){const t=new yn(this._components,this.world,{line:e,lineMaterial:this._componentsMaterial,endpointElement:this.endpointElement});t.lineElement.computeLineDistances(),this.projectionDimensions.add(t)}}set endpointElement(e){for(const t of this.rectangleDimensions)t.endpointElement=e;for(const t of this.projectionDimensions)t.endpointElement=e;this._endpointElement=e,this.createEndpoints()}get endpointElement(){return this._endpointElement}createEndpoints(){this._endpoints.clear();const e=new Jt(this.world,this._endpointElement),t=new Jt(this.world,this._endpointElement.cloneNode(!0));this._endpoints.add(e,t)}updateProjectionComponents(){if(!this.startNormal)return;const e=new ct().setFromNormalAndCoplanarPoint(this.startNormal,this.line.start),t=new L;e.projectPoint(this.line.end,t);let[s]=this.projectionComponentLines;s||(s=new $t,this.projectionComponentLines.push(s)),s.set(this.line.end,t),s.distance()<.01&&this.projectionComponentLines.shift();for(const i of this.projectionDimensions)i&&i.update()}updateRectangleComponents(e=!1){const t=e?this.line.end:this.line.start,s=e?this.line.start:this.line.end,i=new L;i.subVectors(s,t),Math.abs(s.y-t.y)>=.1?i.y=0:i.x=0;const n=t.clone().add(i),[r,o]=this.rectangleComponentLines;r.set(n,t),o.set(n,s);for(const l of this.rectangleDimensions)l.update()}updateLabel(){this.label.three.element.textContent=this.getTextContent();const e=new L;this.line.getCenter(e),this.label.three.position.copy(e)}updateGeometry(){this.updateRectangleComponents(),this.updateProjectionComponents(),[...this._endpoints][0].three.position.copy(this.line.start),[...this._endpoints][1].three.position.copy(this.line.end),this.lineElement.geometry.computeBoundingSphere()}update(){this.updateGeometry(),this.updateLabel()}set material(e){this._material.dispose(),this._material=e,this.lineElement.material=e}get material(){return this._material}createLine(e){const t=new rt;t.setFromPoints([e.line.start,e.line.end]);const s=new Dt(t,e.lineMaterial);return this._root.add(s),s}newText(){const e=gl();e.textContent=this.getTextContent();const t=new Jt(this.world,e),s=new L;return this.line.getCenter(s),t.three.position.copy(s),this._root.add(t.three),t}getTextContent(e=this.line.distance()){const t=Rs.convertUnits(e,"m",this._units,this.rounding);return`${ss.valueFormatter?ss.valueFormatter(t):t.toFixed(this.rounding)} ${this._units}`}set color(e){const t=`#${e.getHexString()}`;this.label.three.element.style.backgroundColor=t;for(const s of this._endpoints)s.three.element.style.borderColor=t;this._material.color.set(e)}}class _i{constructor(e){S(this,"id",Ze.create()),S(this,"points",new Le),S(this,"tolerance",.005),S(this,"_plane",null),S(this,"_rounding",2),S(this,"_units","m2"),this.points.guard=t=>{const s=[...this.points].some(n=>n.equals(t)),i=this.isPointInPlane(t);return!s&&i},this.points.onItemAdded.add(t=>{if(this.plane){const s=new L;this.plane.projectPoint(t,s),t.copy(s)}this.points.size<3||this.points.size===3&&this.computePlane()}),this.points.onItemDeleted.add(()=>{this.points.size>=3||(this._plane=null)}),this.points.onCleared.add(()=>{this._plane=null}),e&&this.points.add(...e)}get plane(){return this._plane}get _coordinateSystem(){if(!this.plane)return null;const e=this.plane.normal,t=new L,s=new L;return Math.abs(e.x)>Math.abs(e.z)?t.set(-e.y,e.x,0).normalize():t.set(0,-e.z,e.y).normalize(),s.crossVectors(e,t).normalize(),{normal:e.clone(),x:t.clone(),y:s.clone()}}get points2D(){if(!this.plane)if(this.points.size>=3)this.computePlane();else return null;return[...this.points].map(e=>this.convertPointTo2D(e)).filter(e=>e!==null)}get center(){if(!this.plane||this.points.size<3)return null;const e=this.points2D;if(!e||e.length===0)return null;const t=e.reduce((s,i)=>s.add(i),new Ce).divideScalar(e.length);return this.convertPointTo3D(t)}get value(){return Rs.convertUnits(this.rawValue,"m2",this.units,this.rounding)}get rawValue(){const e=this.points2D;return e?Math.abs(Nl.area(e)):0}get boundingBox(){if(this.points.size===0)return null;const e=new Ue;for(const t of this.points)e.expandByPoint(t);return e}get perimeter(){const e=this.points2D;if(!e||e.length<2)return 0;let t=0;for(let s=0;s<e.length;s++){const i=e[s],n=e[(s+1)%e.length];t+=i.distanceTo(n)}return t}set rounding(e){this._rounding=e}get rounding(){return this._rounding}set units(e){this._units=e}get units(){return this._units}isPointInPlane(e){if(!this.plane)return!0;const t=this.plane.distanceToPoint(e);return Math.abs(t)<this.tolerance}clone(){const e=new _i([...this.points]);return e.units=this.units,e.rounding=this.rounding,e.tolerance=this.tolerance,e}computePlane(){const[e,t,s]=this.points;if(!(e&&t&&s))return null;const i=new L().subVectors(t,e),n=new L().subVectors(s,e),r=new L().crossVectors(i,n).normalize();return this._plane=new ct().setFromNormalAndCoplanarPoint(r,e),this.plane}convertPointTo2D(e){if(!this.isPointInPlane(e)||!this.plane)return null;const t=this._coordinateSystem;if(!t)return null;const s=new L;this.plane.projectPoint(e,s);const i=s.dot(t.x),n=s.dot(t.y);return new Ce(i,n)}convertPointTo3D(e){if(!this.plane)return null;const t=this._coordinateSystem;if(!t)return null;const{x:s,y:i,normal:n}=t;return new L().addScaledVector(s,e.x).addScaledVector(i,e.y).addScaledVector(n,-this.plane.constant)}}class Pn{constructor(e){S(this,"_components"),S(this,"id",Ze.create()),S(this,"onItemsChanged",new K),S(this,"_items",{}),S(this,"_units","m3"),S(this,"_rounding",2),this._components=e}set items(e){this._items=e,this.onItemsChanged.trigger()}get items(){return this._items}set units(e){this._units=e}get units(){return this._units}set rounding(e){this._rounding=e}get rounding(){return this._rounding}async getRawValue(){return await this._components.get(Rs).getItemsVolume(this.items)}async getValue(){const e=await this.getRawValue();return Rs.convertUnits(e,"m3",this.units,this.rounding)}async getCenter(){return await this._components.get(mn).getCenter(this.items)}async getBox(){const e=this._components.get(mn);e.list.clear(),await e.addFromModelIdMap(this.items);const t=e.get();return e.list.clear(),t}clone(){const e=new Pn(this._components);return e.items=ve.clone(this.items),e}}function $u(a,e,t=2){const s=a.length;let i=ep(a,0,s,t,!0);const n=[];if(!i||i.next===i.prev)return n;let r,o,l;if(a.length>80*t){r=1/0,o=1/0;let h=-1/0,c=-1/0;for(let d=t;d<s;d+=t){const p=a[d],u=a[d+1];p<r&&(r=p),u<o&&(o=u),p>h&&(h=p),u>c&&(c=u)}l=Math.max(h-r,c-o),l=l!==0?32767/l:0}return gi(i,n,t,r,o,l,0),n}function ep(a,e,t,s,i){let n;if(i===up(a,e,t,s)>0)for(let r=e;r<t;r+=s)n=na(r/s|0,a[r],a[r+1],n);else for(let r=t-s;r>=e;r-=s)n=na(r/s|0,a[r],a[r+1],n);return n&&An(n,n.next)&&(vi(n),n=n.next),n}function mi(a,e){if(!a)return a;e||(e=a);let t=a,s;do if(s=!1,!t.steiner&&(An(t,t.next)||Ne(t.prev,t,t.next)===0)){if(vi(t),t=e=t.prev,t===t.next)break;s=!0}else t=t.next;while(s||t!==e);return e}function gi(a,e,t,s,i,n,r){if(!a)return;!r&&n&&rp(a,s,i,n);let o=a;for(;a.prev!==a.next;){const l=a.prev,h=a.next;if(n?sp(a,s,i,n):tp(a)){e.push(l.i,a.i,h.i),vi(a),a=h.next,o=h.next;continue}if(a=h,a===o){r?r===1?(a=ip(mi(a),e),gi(a,e,t,s,i,n,2)):r===2&&np(a,e,t,s,i,n):gi(mi(a),e,t,s,i,n,1);break}}}function tp(a){const e=a.prev,t=a,s=a.next;if(Ne(e,t,s)>=0)return!1;const i=e.x,n=t.x,r=s.x,o=e.y,l=t.y,h=s.y,c=Math.min(i,n,r),d=Math.min(o,l,h),p=Math.max(i,n,r),u=Math.max(o,l,h);let g=s.next;for(;g!==e;){if(g.x>=c&&g.x<=p&&g.y>=d&&g.y<=u&&ci(i,o,n,l,r,h,g.x,g.y)&&Ne(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function sp(a,e,t,s){const i=a.prev,n=a,r=a.next;if(Ne(i,n,r)>=0)return!1;const o=i.x,l=n.x,h=r.x,c=i.y,d=n.y,p=r.y,u=Math.min(o,l,h),g=Math.min(c,d,p),m=Math.max(o,l,h),v=Math.max(c,d,p),f=Tr(u,g,e,t,s),y=Tr(m,v,e,t,s);let _=a.prevZ,x=a.nextZ;for(;_&&_.z>=f&&x&&x.z<=y;){if(_.x>=u&&_.x<=m&&_.y>=g&&_.y<=v&&_!==i&&_!==r&&ci(o,c,l,d,h,p,_.x,_.y)&&Ne(_.prev,_,_.next)>=0||(_=_.prevZ,x.x>=u&&x.x<=m&&x.y>=g&&x.y<=v&&x!==i&&x!==r&&ci(o,c,l,d,h,p,x.x,x.y)&&Ne(x.prev,x,x.next)>=0))return!1;x=x.nextZ}for(;_&&_.z>=f;){if(_.x>=u&&_.x<=m&&_.y>=g&&_.y<=v&&_!==i&&_!==r&&ci(o,c,l,d,h,p,_.x,_.y)&&Ne(_.prev,_,_.next)>=0)return!1;_=_.prevZ}for(;x&&x.z<=y;){if(x.x>=u&&x.x<=m&&x.y>=g&&x.y<=v&&x!==i&&x!==r&&ci(o,c,l,d,h,p,x.x,x.y)&&Ne(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function ip(a,e){let t=a;do{const s=t.prev,i=t.next.next;!An(s,i)&&vl(s,t,t.next,i)&&_n(s,i)&&_n(i,s)&&(e.push(s.i,t.i,i.i),vi(t),vi(t.next),t=a=i),t=t.next}while(t!==a);return mi(t)}function np(a,e,t,s,i,n){let r=a;do{let o=r.next.next;for(;o!==r.prev;){if(r.i!==o.i&&lp(r,o)){let l=dp(r,o);r=mi(r,r.next),l=mi(l,l.next),gi(r,e,t,s,i,n,0),gi(l,e,t,s,i,n,0);return}o=o.next}r=r.next}while(r!==a)}function rp(a,e,t,s){let i=a;do i.z===0&&(i.z=Tr(i.x,i.y,e,t,s)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==a);i.prevZ.nextZ=null,i.prevZ=null,op(i)}function op(a){let e,t=1;do{let s=a,i;a=null;let n=null;for(e=0;s;){e++;let r=s,o=0;for(let h=0;h<t&&(o++,r=r.nextZ,!!r);h++);let l=t;for(;o>0||l>0&&r;)o!==0&&(l===0||!r||s.z<=r.z)?(i=s,s=s.nextZ,o--):(i=r,r=r.nextZ,l--),n?n.nextZ=i:a=i,i.prevZ=n,n=i;s=r}n.nextZ=null,t*=2}while(e>1);return a}function Tr(a,e,t,s,i){return a=(a-t)*i|0,e=(e-s)*i|0,a=(a|a<<8)&16711935,a=(a|a<<4)&252645135,a=(a|a<<2)&858993459,a=(a|a<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,a|e<<1}function ap(a,e,t,s,i,n,r,o){return(i-r)*(e-o)>=(a-r)*(n-o)&&(a-r)*(s-o)>=(t-r)*(e-o)&&(t-r)*(n-o)>=(i-r)*(s-o)}function ci(a,e,t,s,i,n,r,o){return!(a===r&&e===o)&&ap(a,e,t,s,i,n,r,o)}function lp(a,e){return a.next.i!==e.i&&a.prev.i!==e.i&&!hp(a,e)&&(_n(a,e)&&_n(e,a)&&cp(a,e)&&(Ne(a.prev,a,e.prev)||Ne(a,e.prev,e))||An(a,e)&&Ne(a.prev,a,a.next)>0&&Ne(e.prev,e,e.next)>0)}function Ne(a,e,t){return(e.y-a.y)*(t.x-e.x)-(e.x-a.x)*(t.y-e.y)}function An(a,e){return a.x===e.x&&a.y===e.y}function vl(a,e,t,s){const i=rn(Ne(a,e,t)),n=rn(Ne(a,e,s)),r=rn(Ne(t,s,a)),o=rn(Ne(t,s,e));return!!(i!==n&&r!==o||i===0&&nn(a,t,e)||n===0&&nn(a,s,e)||r===0&&nn(t,a,s)||o===0&&nn(t,e,s))}function nn(a,e,t){return e.x<=Math.max(a.x,t.x)&&e.x>=Math.min(a.x,t.x)&&e.y<=Math.max(a.y,t.y)&&e.y>=Math.min(a.y,t.y)}function rn(a){return a>0?1:a<0?-1:0}function hp(a,e){let t=a;do{if(t.i!==a.i&&t.next.i!==a.i&&t.i!==e.i&&t.next.i!==e.i&&vl(t,t.next,a,e))return!0;t=t.next}while(t!==a);return!1}function _n(a,e){return Ne(a.prev,a,a.next)<0?Ne(a,e,a.next)>=0&&Ne(a,a.prev,e)>=0:Ne(a,e,a.prev)<0||Ne(a,a.next,e)<0}function cp(a,e){let t=a,s=!1;const i=(a.x+e.x)/2,n=(a.y+e.y)/2;do t.y>n!=t.next.y>n&&t.next.y!==t.y&&i<(t.next.x-t.x)*(n-t.y)/(t.next.y-t.y)+t.x&&(s=!s),t=t.next;while(t!==a);return s}function dp(a,e){const t=Pr(a.i,a.x,a.y),s=Pr(e.i,e.x,e.y),i=a.next,n=e.prev;return a.next=e,e.prev=a,t.next=i,i.prev=t,s.next=t,t.prev=s,n.next=s,s.prev=n,s}function na(a,e,t,s){const i=Pr(a,e,t);return s?(i.next=s.next,i.prev=s,s.next.prev=i,s.next=i):(i.prev=i,i.next=i),i}function vi(a){a.next.prev=a.prev,a.prev.next=a.next,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ)}function Pr(a,e,t){return{i:a,x:e,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function up(a,e,t,s){let i=0;for(let n=e,r=t-s;n<t;n+=s)i+=(a[r]-a[n])*(a[n+1]+a[r+1]),r=n;return i}class yl extends Jt{constructor(e){const t=document.createElement("div");t.style.backgroundColor="blue",t.style.color="white",t.style.padding="6px",t.style.borderRadius="6px",t.style.boxShadow="0px 4px 6px rgba(0, 0, 0, 0.6)",t.style.zIndex="-10",super(e,t),S(this,"_value",0),S(this,"_units","m2"),S(this,"_worldUnits","m2"),S(this,"_color",new fe),S(this,"_textColor",new fe),S(this,"_rounding",2),this.three.renderOrder=1,t.textContent=this.formattedValue}set value(e){this._value=e,this.three.element.textContent=this.formattedValue}get value(){return this._value}set units(e){this._units=e,this.three.element.textContent=this.formattedValue}get units(){return this._units}set worldUnits(e){this._worldUnits=e,this.three.element.textContent=this.formattedValue}get worldUnits(){return this._worldUnits}set color(e){this._color=e;const t=`#${e.getHexString()}`;this.three.element.style.backgroundColor=t}get color(){return this._color}set textColor(e){this._textColor=e;const t=`#${e.getHexString()}`;this.three.element.style.color=t}get textColor(){return this._textColor}set rounding(e){this._rounding=e,this.three.element.textContent=this.formattedValue}get rounding(){return this._rounding}get formattedValue(){const e=Rs.convertUnits(this.value,this.worldUnits,this.units,this.rounding);return`${ss.valueFormatter?ss.valueFormatter(e):e.toFixed(this.rounding)} ${this.units}`}}class pp{constructor(e,t,s=new _i){S(this,"_root",new yi),S(this,"_components"),S(this,"_material",new pn({color:"red",transparent:!0,opacity:.5,side:Ft,depthTest:!1})),S(this,"_visible",!0),S(this,"_color",new fe),S(this,"label"),S(this,"three",new ie),S(this,"world"),S(this,"area"),S(this,"_triggerUpdate",()=>this.update()),this._components=e,this.world=t,this.area=s,this.world.scene.three.add(this.three),this.label=new yl(t),this._root.renderOrder=2,this.visible=!0,this.update(),s.points.onItemAdded.add(this._triggerUpdate),s.points.onItemDeleted.add(this._triggerUpdate),s.points.onCleared.add(this._triggerUpdate)}set material(e){this._material.dispose(),this._material=e,this.three.material=e}get material(){return this._material}set visible(e){this._visible=e,this.label.visible=e;const t=this.label.three;e?(this._root.add(t,this.three),this.world.scene.three.add(this._root)):(t.removeFromParent(),this._root.removeFromParent())}get visible(){return this._visible}set rounding(e){this.label.rounding=e}get rounding(){return this.label.rounding}set units(e){this.label.units=e}get units(){return this.label.units}set color(e){this._color=e,this.label.color=e,this._material.color.set(e)}get color(){return this._color}applyPlanesVisibility(e){if(!this.label.wasVisible)return;let t=!1;const s=this.area.center;if(s){for(const i of e)if(i.distanceToPoint(s)<0){t=!0;break}}this.label.three.visible=!t}updateMesh(){if(this.area.points.size<3)return;const e=this.area.points2D;if(!e||e.length<3)return;const t=e.flatMap(r=>[r.x,r.y]),s=$u(t),i=[];for(const r of e){const o=this.area.convertPointTo3D(r);o&&i.push(o.x,o.y,o.z)}this.three.geometry&&this.three.geometry.dispose();const n=new rt;n.setAttribute("position",new es(i,3)),n.setIndex(s),this.three.geometry=n,this.three.material=this.material}update(){if(this.updateMesh(),this.area.rawValue===0)this.label.visible=!1;else{this.label.value=this.area.rawValue,this.label.visible=!0;const e=this.area.center;e&&this.label.three.position.copy(e)}}dispose(){this.label.dispose(),this._components.get(It).destroy(this._root,!0,!0),this.area.points.clear()}}const fp={length:"m",area:"m2",volume:"m3"};class _l{constructor(e,t,s=new Pn(e)){S(this,"_root",new yi),S(this,"_components"),S(this,"_material",new pn({color:"red",transparent:!0,opacity:.75,side:Ft,depthTest:!1})),S(this,"_visible",!0),S(this,"_color",new fe),S(this,"label"),S(this,"world"),S(this,"volume"),S(this,"meshes",[]),this._components=e,this.world=t,this.volume=s,this.label=new yl(t),this._root.renderOrder=2,this.visible=!0,this.update(),this.volume.onItemsChanged.add(()=>this.update())}set material(e){this._material.dispose(),this._material=e;for(const t of this.meshes)t.material=e}get material(){return this._material}set visible(e){this._visible=e,this.label.visible=e;for(const t of this.meshes)e?this.world.scene.three.add(t):t.removeFromParent()}get visible(){return this._visible}set rounding(e){this.label.rounding=e}get rounding(){return this.label.rounding}set units(e){this.label.units=e}get units(){return this.label.units}set color(e){this._color=e,this.label.color=e,this._material.color.set(e)}get color(){return this._color}applyPlanesVisibility(e){if(!this.label.wasVisible)return;let t=!1;for(const s of this.meshes){for(const i of e)if(i.distanceToPoint(s.position)<0){t=!0;break}this.label.three.visible=!t}}async updateMesh(){this.cleanMeshes();const e=this._components.get(vn),t=await e.get(this.volume.items,{material:this.material});this.meshes=e.getMeshesFromResult(t);for(const s of this.meshes)this.world.scene.three.add(s)}async update(){this.updateMesh();const e=await this.volume.getRawValue();this.label.visible=e!==0,this.label.value=e;const t=await this.volume.getCenter();t&&this.label.three.position.copy(t)}cleanMeshes(){const e=this._components.get(It);for(const t of this.meshes)e.destroy(t,!0,!0);this._components.get(vn).remove(),this.meshes=[]}dispose(){this.label.dispose(),this.cleanMeshes(),this.volume.items={}}}class ss extends xe{constructor(e,t){super(e),S(this,"list",new Le),S(this,"onDisposed",new K),S(this,"snappings",[it.LINE,it.POINT,it.FACE]),S(this,"lines",new Le),S(this,"fills",new Le),S(this,"labels",new Le),S(this,"volumes",new Le),S(this,"delay",300),S(this,"_world",null),S(this,"measureType"),S(this,"onPointerStop",new K),S(this,"onPointerMove",new K),S(this,"onStateChanged",new K),S(this,"pointerStopTimeout",null),S(this,"onMove",()=>{this.enabled&&(this._vertexPicker.updatePointer(),this.pointerStopTimeout!==null&&clearTimeout(this.pointerStopTimeout),this.pointerStopTimeout=window.setTimeout(()=>{this.onPointerStop.trigger()},this.delay),this.onPointerMove.trigger())}),S(this,"onKeydown",s=>{this.enabled&&s.key==="Escape"&&this.cancelCreation()}),S(this,"onEnabledChange",new K),S(this,"_enabled",!1),S(this,"onVisibilityChange",new K),S(this,"_visible",!0),S(this,"_units"),S(this,"_rounding",2),S(this,"_linesEndpointElement",gl()),S(this,"_linesMaterial",new la({color:"#0000FF",depthTest:!1})),S(this,"_fillsMaterial",new pn({color:2392594,side:Ft,transparent:!0,opacity:.3,depthTest:!1})),S(this,"_volumesMaterial",new pn({color:2392594,side:Ft,transparent:!0,opacity:.3,depthTest:!1})),S(this,"_color",new fe),S(this,"_vertexPicker",new Ku(this.components)),S(this,"create",s=>{}),S(this,"endCreation",s=>{}),S(this,"cancelCreation",()=>{}),S(this,"delete",s=>{}),this.measureType=t,this._units=fp[this.measureType],this.lines.onBeforeDelete.add(s=>s.dispose()),this.fills.onBeforeDelete.add(s=>s.dispose()),this.labels.onBeforeDelete.add(s=>s.dispose()),this.volumes.onBeforeDelete.add(s=>s.dispose()),this.list.onCleared.add(()=>{this.lines.clear(),this.fills.clear(),this.labels.clear(),this.volumes.clear()})}set world(e){this._world=e,this._vertexPicker.world=e}get world(){return this._world}get unitsList(){let e=[];return this.measureType==="length"?e=["mm","cm","m","km"]:this.measureType==="area"?e=["mm2","cm2","m2","km2"]:e=["mm3","cm3","m3","km3"],e}setEvents(e){if(!this.world)throw new Error("Measurement: you must specify a world first!");if(this.world.isDisposing)return;if(!this.world.renderer)throw new Error("Measurement: the world needs a renderer!");const t=this.world.renderer.three.domElement.parentElement;t&&(t.removeEventListener("pointermove",this.onMove),window.removeEventListener("keydown",this.onKeydown),e&&(t.addEventListener("pointermove",this.onMove),window.addEventListener("keydown",this.onKeydown)))}set enabled(e){this._enabled=e,this._vertexPicker.enabled=e,this.setEvents(e),this.cancelCreation(),this.onEnabledChange.trigger(e),this.onStateChanged.trigger(["enabled"])}get enabled(){return this._enabled}set visible(e){this._visible=e;for(const t of this.lines)t.visible=e;for(const t of this.fills)t.visible=e;for(const t of this.volumes)t.visible=e;this.onVisibilityChange.trigger(e),this.onStateChanged.trigger(["visibility"])}get visible(){return this._visible}set units(e){this._units=e;let t;e.endsWith("2")?t="area":e.endsWith("3")?t="volume":t="length";for(const s of this.list)(s instanceof $t||s instanceof _i||s instanceof Pn)&&(s.units=e);if(t==="length")for(const s of this.lines)s.units=e;else if(t==="area")for(const s of this.fills)s.units=e;else if(t==="volume")for(const s of this.volumes)s.units=e;this.onStateChanged.trigger(["units"])}get units(){return this._units}set rounding(e){this._rounding=e;for(const t of this.list)"rounding"in t&&typeof t.rounding=="number"&&(t.rounding=e);for(const t of this.lines)t.rounding=e;for(const t of this.fills)t.rounding=e;for(const t of this.volumes)t.rounding=e;this.onStateChanged.trigger(["rounding"])}get rounding(){return this._rounding}set linesEndpointElement(e){this._linesEndpointElement=e;for(const t of this.lines)t.endpointElement=e}get linesEndpointElement(){return this._linesEndpointElement}set linesMaterial(e){this._linesMaterial.dispose(),this._linesMaterial=e;for(const t of this.lines)t.material=e}get linesMaterial(){return this._linesMaterial}set fillsMaterial(e){this._fillsMaterial.dispose(),this._fillsMaterial=e;for(const t of this.fills)t.material=e}get fillsMaterial(){return this._fillsMaterial}set volumesMaterial(e){this._volumesMaterial.dispose(),this._volumesMaterial=e;for(const t of this.volumes)t.material=e}get volumesMaterial(){return this._volumesMaterial}set color(e){this._color=e,this._linesMaterial.color.set(e),this._fillsMaterial.color.set(e),this._volumesMaterial.color.set(e);for(const t of this.lines)t.color=e;for(const t of this.fills)t.color=e;for(const t of this.volumes)t.color=e;this.onStateChanged.trigger(["color"])}get color(){return this._color}get pickerMode(){return this._vertexPicker.mode}set pickerMode(e){this._vertexPicker.mode=e}get snapDistance(){return this._vertexPicker.maxDistance}set snapDistance(e){this._vertexPicker.maxDistance=e}dispose(){this._vertexPicker.dispose(),this.list.clear(),this.linesMaterial.dispose(),this.fillsMaterial.dispose(),this.volumesMaterial.dispose(),this.onDisposed.trigger()}applyPlanesVisibility(e){for(const t of this.lines)t.applyPlanesVisibility(e);for(const t of this.fills)t.applyPlanesVisibility(e);for(const t of this.volumes)t.applyPlanesVisibility(e)}createLineElement(e,t=null){if(!this.world)throw new Error("Measurement: world is need!");return new yn(this.components,this.world,{line:e,startNormal:t??void 0,lineMaterial:this.linesMaterial,endpointElement:this.linesEndpointElement},this.rounding,this.units)}createFillElement(e){if(!this.world)throw new Error("Measurement: world is need!");const t=new pp(this.components,this.world,e);return t.rounding=this.rounding,(this.units.endsWith("2")?"area":void 0)==="area"&&(t.units=this.units),t}createVolumeElement(e){if(!this.world)throw new Error("Measurement: world is need!");const t=new _l(this.components,this.world,e);return t.rounding=this.rounding,(this.units.endsWith("3")?"volume":void 0)==="volume"&&(t.units=this.units),t}addLineElementsFromPoints(e){for(let t=0;t<e.length;t++){const s=e[t],i=e[(t+1)%e.length],n=new $t(s,i),r=this.createLineElement(n);r.label.visible=!1,this.lines.add(r)}}getLineBoxes(){const e=[];for(const t of this.lines)e.push(t.boundingBox);return e}getFillBoxes(){const e=[];for(const t of this.fills)e.push(t.three);return e}async getVolumeBoxes(){const e=[];for(const t of this.volumes)e.push(t.meshes);return e}}S(ss,"valueFormatter",null);const mp=class wl extends ss{constructor(e){super(e,"area"),S(this,"pickTolerance",.1),S(this,"tolerance",.005),S(this,"modes",["free","square","face"]),S(this,"_mode","free"),S(this,"_temp",{isDragging:!1,area:new _i,lines:new Le,point:new L}),S(this,"_lineToAreaMap",new WeakMap),S(this,"computeLineElements",()=>{this._temp.lines.clear();const t=[...this._temp.area.points];if(this._temp.area.isPointInPlane(this._temp.point)&&t.push(this._temp.point),!(t.length<2||!this.world))for(let s=0;s<t.length;s++){const i=t[s],n=t[(s+1)%t.length],r=new $t(i,n),o=this.createLineElement(r);this._temp.lines.add(o)}}),S(this,"create",async()=>{if(!this.enabled)return;if(!this.world)throw new Error("Area Measurement: world is not defined!");const t=await this._vertexPicker.get({snappingClasses:this.snappings});if(!(t&&t.point))return;if(this.mode==="face"){const n=t.facePoints;if(!n)return;const r=[];for(let o=0;o<n.length-2;o+=3){const l=n[o],h=n[o+1],c=n[o+2];r.push(new L(l,h,c))}this._temp.area.points.add(...r),this.endCreation();return}const{area:s,point:i}=this._temp;if(this._temp.isDragging||(s.tolerance=this.tolerance,s.points.clear(),this._temp.isDragging=!0),s.points.size===0&&i.copy(t.point),s.points.add(i.clone()),this.mode==="square"&&s.points.size===2&&t.normal){const[n,r]=s.points,o=new L().subVectors(r,n),l=o.clone(),h=o.clone().negate();Math.abs(o.y)>=.1?(l.y=0,h.y=0):(l.x=0,h.x=0);const c=n.clone().add(l),d=r.clone().add(h);s.points.clear(),s.points.add(n,c,r,d),this.endCreation()}}),S(this,"endCreation",()=>{this.enabled&&(this._temp.isDragging=!1,this._temp.area.points.size>=3&&this.list.add(this._temp.area.clone()),this._temp.area.points.clear(),this._temp.lines.clear())}),S(this,"cancelCreation",()=>{this.enabled&&(this._temp.isDragging=!1,this._temp.area.points.clear(),this._temp.lines.clear())}),S(this,"delete",()=>{if(!this.enabled||this.list.size===0||!this.world)return;const t=this.getFillBoxes(),s=this.components.get(et).get(this.world).castRayToObjects(t);if(!s)return;const i=[...this.fills].find(r=>r.three===s.object);if(!i)return;const n=i.area;this.fills.delete(i),this.list.delete(n),this.components.get(It).destroy(s.object)}),e.add(wl.uuid,this),this.initHandlers(),this.color=new fe("#6528d7")}get mode(){return this._mode}set mode(e){this._mode=e,this.cancelCreation(),this.onStateChanged.trigger(["mode"])}initHandlers(){this.onVisibilityChange.add(()=>{for(const e of this.lines)e.label.visible=!1}),this.list.onItemAdded.add(e=>{if(!this.world)return;const t=this.createFillElement(e);t.color=this.color,this.fills.add(t),this.addLineElementsFromPointsForArea([...e.points],e)}),this.list.onBeforeDelete.add(e=>{const t=[...this.fills].find(i=>i.area===e);t&&this.fills.delete(t);const s=[];for(const i of this.lines)this._lineToAreaMap.get(i)===e&&s.push(i);for(const i of s)this.lines.delete(i),this._lineToAreaMap.delete(i)}),this.onPointerStop.add(()=>this.updatePreview()),this._temp.lines.onItemAdded.add(e=>e.label.visible=!1),this._temp.lines.onBeforeDelete.add(e=>e.dispose()),this._temp.area.points.onItemAdded.add(()=>{this.computeLineElements()}),this._temp.area.points.onItemDeleted.add(()=>{this._temp.lines.clear()}),this.onStateChanged.add(e=>{e.includes("rounding")&&(this._temp.area.rounding=this.rounding),e.includes("units")&&(this._temp.area.units=this.units)})}async updatePreview(){if(!this.enabled||!this.world)throw new Error("Measurement is not enabled or world is not defined!");const e=await this._vertexPicker.get({snappingClasses:this.snappings});if(!(e&&e.point&&this._temp.isDragging))return;const t=e.point.clone(),{plane:s}=this._temp.area;if(s){const i=s.distanceToPoint(t);if(Math.abs(i)<.1){const n=new L;s.projectPoint(t,n),t.copy(n)}}this._temp.point.copy(t),this.computeLineElements()}addLineElementsFromPointsForArea(e,t){for(let s=0;s<e.length;s++){const i=e[s],n=e[(s+1)%e.length],r=new $t(i,n),o=this.createLineElement(r);o.label.visible=!1,this.lines.add(o),this._lineToAreaMap.set(o,t)}}};S(mp,"uuid","09b78c1f-0ff1-4630-a818-ceda3d878c75");const gp=class bl extends ss{constructor(e){super(e,"length"),S(this,"_temp",{isDragging:!1,line:new $t}),S(this,"modes",["free","edge"]),S(this,"_mode","free"),S(this,"create",async()=>{if(this.enabled){if(!this._temp.isDragging){await this.initPreview();return}this.endCreation()}}),S(this,"endCreation",()=>{this.enabled&&this._temp.dimension&&(this.list.add(this._temp.line.clone()),this.mode==="free"&&(this._temp.dimension.dispose(),this._temp.dimension=void 0,this._temp.isDragging=!1,this._temp.startNormal=void 0))}),S(this,"cancelCreation",()=>{var t;this.enabled&&(this._temp.isDragging=!1,this._temp.dimension&&((t=this._temp.dimension)==null||t.dispose(),this._temp.dimension=void 0))}),S(this,"delete",()=>{if(!this.enabled||this.list.size===0||!this.world)return;const t=this.getLineBoxes(),s=this.components.get(et).get(this.world).castRayToObjects(t);if(!s)return;const i=[...this.lines].find(n=>n.boundingBox===s.object);i&&this.list.delete(i.line)}),e.add(bl.uuid,this),this.initHandlers()}get mode(){return this._mode}set mode(e){this._mode=e,this.cancelCreation(),e==="edge"&&this.initPreview(),this.onStateChanged.trigger(["mode"])}get isDragging(){return this._temp.isDragging}initHandlers(){this.list.onItemAdded.add(e=>{const t=this.createLineElement(e,this._temp.startNormal);t.createBoundingBox(),this.lines.add(t)}),this.list.onBeforeDelete.add(e=>{const t=[...this.lines].find(s=>s.line===e);t&&this.lines.delete(t)}),this.onPointerStop.add(()=>this.updatePreviewLine()),this.onEnabledChange.add(e=>{e&&this.mode==="edge"&&this.initPreview()})}async initPreview(){if(!this.world)throw new Error("Measurement: world is need!");const e=await this._vertexPicker.get({snappingClasses:this.snappings});if(this.mode==="free"){if(!(e!=null&&e.point))return;const t=e.point;this._temp.line.set(t,t.clone()),this._temp.isDragging=!0,this._temp.dimension=this.createLineElement(this._temp.line),this._temp.startNormal=e.normal??void 0}else if(this.mode==="edge"){const t=e==null?void 0:e.snappedEdgeP1,s=e==null?void 0:e.snappedEdgeP2,i=t||new L,n=i||s;this._temp.line.set(i,n),this._temp.isDragging=!0,this._temp.dimension=this.createLineElement(this._temp.line),this._temp.dimension.visible=!!(t&&s)}}async updatePreviewLine(){if(!this.world)throw new Error("Measurement: world is need!");const e=await this._vertexPicker.get({snappingClasses:this.snappings});if(this.mode==="free"){if(!(e!=null&&e.point)||(this._temp.line.end.copy(e.point),!this._temp.dimension))return;this._temp.dimension.end=this._temp.line.end}else if(this.mode==="edge"){const t=e==null?void 0:e.snappedEdgeP1,s=e==null?void 0:e.snappedEdgeP2;if(this._temp.dimension&&(this._temp.dimension.visible=!!(t&&s)),!(t&&s)||(this._temp.line.start.copy(t),this._temp.line.end.copy(s),!this._temp.dimension))return;this._temp.dimension.start=this._temp.line.start,this._temp.dimension.end=this._temp.line.end}}};S(gp,"uuid","2f9bcacf-18a9-4be6-a293-e898eae64ea1");const vp=class xl extends ss{constructor(e){super(e,"volume"),S(this,"_temp",{}),S(this,"onPreviewInitialized",new K),S(this,"modes",["free"]),S(this,"_mode","free"),S(this,"_previousHovererState",!1),S(this,"create",async()=>{if(!this.enabled)return;const t=await this._vertexPicker.get();t&&(this._temp.preview||await this.initPreview(),this._temp.preview.volume.items=ve.join([this._temp.preview.volume.items,{[t.fragments.modelId]:new Set([t.localId])}]))}),S(this,"endCreation",()=>{if(!this._temp.preview||ve.isEmpty(this._temp.preview.volume.items))return;const t=this._temp.preview.volume.clone();this.list.add(t),this._temp.preview.dispose(),delete this._temp.preview}),S(this,"cancelCreation",()=>{var t;(t=this._temp.preview)==null||t.dispose(),delete this._temp.preview}),S(this,"delete",async()=>{if(this.list.size===0||!this.world)return;const t=await this.getVolumeBoxes(),s=this.components.get(et).get(this.world);for(const i of t){const n=s.castRayToObjects(i);if(!n)continue;const r=[...this.volumes].find(o=>o.meshes.some(l=>l===n.object));if(!r)return;this.list.delete(r.volume)}}),e.add(xl.uuid,this),this.initHandlers()}get mode(){return this._mode}set mode(e){this._mode=e,this.cancelCreation(),this.onStateChanged.trigger(["mode"])}initHandlers(){this.list.onItemAdded.add(e=>{const t=this.createVolumeElement(e);t.color=this.color,t.rounding=this.rounding,t.units=this.units,this.volumes.add(t)}),this.list.onBeforeDelete.add(e=>{const t=[...this.volumes].find(s=>s.volume===e);t&&this.volumes.delete(t)}),this.onStateChanged.add(e=>{if(e.includes("color")){if(!this._temp.preview)return;this._temp.preview.color=this.color}if(e.includes("units")){if(!this._temp.preview)return;this._temp.preview.units=this.units}if(e.includes("rounding")){if(!this._temp.preview)return;this._temp.preview.rounding=this.rounding}if(e.includes("enabled")){const t=this.components.get(Yu);t.world=this.world,this.enabled?(this._previousHovererState=t.enabled,t.enabled=!0):(t.clear(),t.enabled=this._previousHovererState),t.hover()}})}async initPreview(){if(this.enabled){if(!this.world)throw new Error("Measurement: world is need!");this._temp.preview=new _l(this.components,this.world),this._temp.preview.color=this.color,this._temp.preview.rounding=this.rounding,this._temp.preview.units=this.units,this.onPreviewInitialized.trigger(this._temp.preview)}}};S(vp,"uuid","01f885ab-ec4e-4e6c-a853-9dfc0d6766ed");export{xr as S,tr as a,_p as s};
